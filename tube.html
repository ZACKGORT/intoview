<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>intoview:tube v3</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #050505;
      --card-bg: #111111;
      --ink: #ffffff;
      --ink-dim: #888888;
      --accent: #FF0000;
      --neon-green: #22c55e;
      --neon-orange: #f97316;
      --neon-red: #ef4444;
      --neon-blue: #3b82f6;
      --youtube-red: #FF0000;
      --glass-bg: rgba(20, 20, 20, 0.85);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-blur: 16px;
      --nav-height: 80px;
      --header-height: 100px;
      --font-mono: 'JetBrains Mono', monospace;
      --font-sans: 'Inter', sans-serif;
      --edge-blur-amount: 4px;
      --vignette-strength: 0.6;
      --vignette-size: 20%;
    }
    
    [data-theme="light"] {
      --bg-color: #ffffff;
      --card-bg: #ffffff;
      --ink: #000000;
      --ink-dim: #666666;
      --accent: #FF0000;
      --glass-bg: rgba(0, 0, 0, 0.03);
      --glass-border: rgba(0, 0, 0, 0.15);
      --neon-green: #006400;
      --neon-orange: #ff6600;
      --neon-red: #cc0000;
      --neon-blue: #0066cc;
      --vignette-strength: 0;
      --edge-blur-amount: 0px;
    }
    
    [data-theme="light"] .logo-cube .f-face {
      --bg-color: #0a0a0a;
      --card-bg: #1a1a1a;
      --ink: #ffffff;
      --ink-dim: #cccccc;
      --accent: #ff8da1;
      --rose-primary: #ff8da1;
      --rose-secondary: #ff6b8b;
      --retro-blue: #00d4ff;
      --retro-yellow: #ffeb3b;
      --retro-purple: #e91e63;
      --glass-bg: rgba(255, 141, 161, 0.05);
      --glass-border: rgba(255, 141, 161, 0.1);
    }
    
    [data-theme="light"] .logo-text {
      color: #000000;
      text-shadow: none;
    }
    
    [data-theme="light"] .logo:hover .logo-text {
      transform: scale(1.05);
      filter: none;
    }
    
    [data-theme="light"] .logo-cube .fab-cube {
      animation: spin 6s linear infinite;
    }
    
    [data-theme="rose"] {
      --bg-color: #0a0a0a;
      --card-bg: #1a1a1a;
      --ink: #ffffff;
      --ink-dim: #cccccc;
      --accent: #ff8da1;
      --rose-primary: #ff8da1;
      --rose-secondary: #ff6b8b;
      --retro-blue: #00d4ff;
      --retro-yellow: #ffeb3b;
      --retro-purple: #e91e63;
      --glass-bg: rgba(255, 141, 161, 0.05);
      --glass-border: rgba(255, 141, 161, 0.2);
    }
    
    [data-theme="theater"] {
      --bg-color: #000000;
      --card-bg: #0a0a0a;
      --ink: #e0e0e0;
      --ink-dim: #666666;
      --accent: #ff0000;
      --glass-bg: rgba(0, 0, 0, 0.9);
      --glass-border: rgba(255, 0, 0, 0.2);
      --vignette-strength: 0.8;
      --neon-green: #00ff00;
      --neon-orange: #ff8800;
      --neon-red: #ff0000;
      --neon-blue: #0088ff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: var(--font-sans);
      background: var(--bg-color);
      color: var(--ink);
      overflow: hidden;
      position: relative;
      min-height: 100vh;
      overscroll-behavior: none;
    }
    
    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 12px 20px;
      color: var(--ink);
      font-weight: 500;
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      max-width: 300px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      backdrop-filter: blur(10px);
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    .toast.info {
      border-left: 4px solid var(--neon-blue);
    }
    
    .toast.error {
      border-left: 4px solid var(--neon-red);
    }
    
    .toast.success {
      border-left: 4px solid var(--neon-green);
    }
    
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      box-shadow: inset 0 0 60px rgba(0,0,0,0.5);
      backdrop-filter: blur(var(--edge-blur-amount));
      -webkit-backdrop-filter: blur(var(--edge-blur-amount));
      mask-image: linear-gradient(to bottom, black 0%, transparent 10%, transparent 90%, black 100%),
                  linear-gradient(to right, black 0%, transparent 10%, transparent 90%, black 100%);
      mask-composite: source-in;
      pointer-events: none;
      z-index: 10;
    }
    
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(
        circle at center,
        transparent 40%,
        rgba(0, 0, 0, var(--vignette-strength)) 100%
      );
      pointer-events: none;
      z-index: 200;
    }
    
    [data-theme="rose"] body::after {
        background: radial-gradient(
        circle at center,
        transparent 40%,
        rgba(50, 0, 20, var(--vignette-strength)) 100%
      );
    }
    
    [data-theme="light"] body::after {
        background: radial-gradient(
        circle at center,
        transparent 40%,
        rgba(0, 0, 0, 0.3) 100%
      );
    }
    
    ::-webkit-scrollbar { 
      width: 6px; 
      height: 6px; 
    }
    
    ::-webkit-scrollbar-track { 
      background: transparent; 
    }
    
    ::-webkit-scrollbar-thumb { 
      background: var(--glass-border); 
      border-radius: 3px; 
    }
    
    ::-webkit-scrollbar-thumb:hover { 
      background: var(--ink-dim); 
    }
    
    .text-green { color: var(--neon-green); }
    .text-orange { color: var(--neon-orange); }
    .text-red { color: var(--neon-red); }
    .text-blue { color: var(--neon-blue); }
    .text-rose { color: var(--rose-primary); }
    
    [data-theme="rose"] .text-green { color: var(--retro-blue); }
    [data-theme="rose"] .text-orange { color: var(--retro-yellow); }
    [data-theme="rose"] .text-red { color: var(--rose-secondary); }
    [data-theme="rose"] .text-blue { color: var(--retro-purple); }
    
    /* --- Layout Structure --- */
    .app-header {
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      height: var(--header-height);
      display: flex; 
      flex-direction: column; 
      justify-content: center;
      padding: 10px 0; 
      z-index: 9999;
      background: linear-gradient(to bottom, var(--bg-color) 80%, transparent);
      pointer-events: none;
      box-sizing: border-box;
    }
    
    .header-top {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 0 20px; 
        width: 100%; 
        pointer-events: auto;
        min-height: 60px;
        flex-shrink: 0;
    }
    
    .logo-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .logo-cube {
      width: 32px;
      height: 32px;
      position: relative;
      perspective: 600px;
    }
    
    .logo-cube .fab-cube {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transform: rotateX(-25deg) rotateY(-45deg);
      animation: spin 6s linear infinite;
    }
    
    .logo-cube .f-face {
      position: absolute;
      width: 16px;
      height: 16px;
      left: 8px;
      top: 8px;
      background: rgba(255, 0, 0, 0.15);
      border: 2px solid var(--accent);
      box-shadow: 0 0 10px var(--accent), inset 0 0 8px var(--accent);
      backface-visibility: visible;
      transition: all 0.3s;
      animation: cycle-colors-logo 10s linear infinite;
    }
    
    .logo-text { 
      font-size: 12px; 
      color: rgba(255, 255, 255, 0.7); 
    }
    
    .logo-cube .f-face:nth-child(1) { transform: rotateY(0deg) translateZ(8px); }
    .logo-cube .f-face:nth-child(2) { transform: rotateY(90deg) translateZ(8px); }
    .logo-cube .f-face:nth-child(3) { transform: rotateY(180deg) translateZ(8px); }
    .logo-cube .f-face:nth-child(4) { transform: rotateY(-90deg) translateZ(8px); }
    .logo-cube .f-face:nth-child(5) { transform: rotateX(90deg) translateZ(8px); }
    .logo-cube .f-face:nth-child(6) { transform: rotateX(-90deg) translateZ(8px); }
    
    @keyframes spin {
      to { transform: rotateX(-25deg) rotateY(315deg); }
    }
    
    @keyframes cycle-colors-logo {
      0% {
        background: rgba(255, 0, 0, 0.15);
        border-color: #FF0000;
        box-shadow: 0 0 10px #FF0000, inset 0 0 8px #FF0000;
      }
      20% {
        background: rgba(59, 130, 246, 0.15);
        border-color: #3b82f6;
        box-shadow: 0 0 10px #3b82f6, inset 0 0 8px #3b82f6;
      }
      40% {
        background: rgba(34, 197, 94, 0.15);
        border-color: #22c55e;
        box-shadow: 0 0 10px #22c55e, inset 0 0 8px #22c55e;
      }
      60% {
        background: rgba(249, 115, 22, 0.15);
        border-color: #f97316;
        box-shadow: 0 0 10px #f97316, inset 0 0 8px #f97316;
      }
      80% {
        background: rgba(239, 68, 68, 0.15);
        border-color: #ef4444;
        box-shadow: 0 0 10px #ef4444, inset 0 0 8px #ef4444;
      }
      100% {
        background: rgba(255, 0, 0, 0.15);
        border-color: #FF0000;
        box-shadow: 0 0 10px #FF0000, inset 0 0 8px #FF0000;
      }
    }
    
    [data-theme="rose"] .logo-cube .f-face {
      animation: cycle-colors-logo-rose 10s linear infinite;
    }
    
    @keyframes cycle-colors-logo-rose {
      0% {
        background: rgba(255, 141, 161, 0.15);
        border-color: var(--rose-primary);
        box-shadow: 0 0 10px var(--rose-primary), inset 0 0 8px var(--rose-primary);
      }
      33% {
        background: rgba(255, 107, 139, 0.15);
        border-color: var(--rose-secondary);
        box-shadow: 0 0 10px var(--rose-secondary), inset 0 0 8px var(--rose-secondary);
      }
      66% {
        background: rgba(0, 212, 255, 0.15);
        border-color: var(--retro-blue);
        box-shadow: 0 0 10px var(--retro-blue), inset 0 0 8px var(--retro-blue);
      }
      100% {
        background: rgba(255, 141, 161, 0.15);
        border-color: var(--rose-primary);
        box-shadow: 0 0 10px var(--rose-primary), inset 0 0 8px var(--rose-primary);
      }
    }
    
    .logo:hover .logo-cube .fab-cube {
      animation-play-state: paused;
    }
    
    .logo:hover .logo-text {
      transform: scale(1.05);
      filter: drop-shadow(0 0 8px var(--accent));
    }
    
    /* Header Search Styles */
    .header-search {
      display: flex;
      flex: 1;
      max-width: 600px;
      margin: 0 20px;
    }
    
    .header-search-wrapper {
      display: flex;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      overflow: hidden;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .header-search-wrapper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.1);
    }
    
    .header-search input {
      flex: 1;
      background: transparent;
      border: none;
      padding: 10px 16px;
      color: var(--ink);
      font-size: 14px;
      outline: none;
      width: 100%;
    }
    
    .header-search input::placeholder {
      color: var(--ink-dim);
      opacity: 0.7;
    }
    
    .header-search button {
      background: transparent;
      border: none;
      border-left: 1px solid var(--glass-border);
      padding: 0 20px;
      color: var(--ink-dim);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
    }
    
    .header-search button:hover {
      color: var(--ink);
      background: rgba(255, 255, 255, 0.05);
    }
    
    .header-search button:active {
      background: rgba(255, 255, 255, 0.1);
    }
    
    /* Desktop Search */
    .desktop-search {
      display: flex;
      flex: 1;
      max-width: 600px;
      margin: 0 20px;
    }
    
    /* Mobile search button */
    .mobile-search-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      background: transparent;
      border: none;
      color: var(--ink-dim);
      font-size: 20px;
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .mobile-search-btn:hover {
      background: var(--glass-border);
      color: var(--ink);
    }
    
    /* Mobile Full-Screen Search Overlay */
    .mobile-search-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      z-index: 10000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .mobile-search-overlay.active {
      display: flex;
      flex-direction: column;
      opacity: 1;
    }
    
    .mobile-search-header {
      display: flex;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .mobile-search-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      margin-right: 16px;
      cursor: pointer;
      padding: 8px;
    }
    
    .mobile-search-input-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 25px;
      padding: 12px 20px;
    }
    
    .mobile-search-input {
      flex: 1;
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      outline: none;
    }
    
    .mobile-search-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .mobile-search-results {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .header-left { 
      display: flex; 
      align-items: center;
      gap: 12px;
    }
    
    .header-center { 
      flex: 1; 
      max-width: 600px; 
      margin: 0 20px; 
    }
    
    .header-right { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
    }
    
    .notifications-btn { 
      position: relative; 
      background: transparent; 
      border: none; 
      color: var(--ink-dim); 
      font-size: 20px; 
      cursor: pointer; 
    }
    
    .notification-badge { 
      position: absolute; 
      top: -2px; 
      right: -2px; 
      background: var(--accent); 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
    }
    
    .profile-dropdown { 
      position: relative; 
    }
    
    .profile-btn { 
      background: transparent; 
      border: 1px solid var(--glass-border); 
      border-radius: 50%; 
      width: 32px; 
      height: 32px; 
      color: var(--ink); 
      cursor: pointer; 
    }
    
    .profile-menu { 
      display: none; 
      position: absolute; 
      top: 40px; 
      right: 0; 
      background: var(--card-bg); 
      border: 1px solid var(--glass-border); 
      border-radius: 12px; 
      padding: 8px 0; 
      min-width: 160px; 
      box-shadow: 0 8px 24px rgba(0,0,0,0.3); 
    }
    
    .profile-menu.active { 
      display: block; 
    }
    
    .profile-menu-item { 
      padding: 8px 16px; 
      cursor: pointer; 
      transition: background 0.2s; 
      display: flex; 
      gap: 8px; 
    }
    
    .profile-menu-item:hover { 
      background: var(--glass-bg); 
    }
    
    .profile-menu-divider { 
      border-top: 1px solid var(--glass-border); 
      margin: 4px 0; 
    }
    
    .create-new-btn { 
      background: var(--accent); 
      color: #fff; 
      border: none; 
      border-radius: 100px; 
      padding: 2px 8px; 
      display: flex; 
      gap: 4px; 
      align-items: center; 
      cursor: pointer; 
    }
    
    .header-buttons { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      margin-left: auto; 
    }
    
    .theme-btn {
        background: transparent; 
        border: none; 
        color: var(--ink-dim);
        cursor: pointer; 
        padding: 8px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center;
        transition: all 0.3s ease;
    }
    
    .theme-btn:hover { 
      color: var(--ink); 
      background: var(--glass-border); 
      transform: scale(1.1); 
    }
    
    .theme-btn:active { 
      background: var(--glass-border); 
      color: var(--ink); 
      transform: scale(0.95); 
    }
    
    .category-bar {
      display: flex; 
      gap: 8px; 
      overflow-x: auto; 
      padding: 10px 20px;
      pointer-events: auto; 
      scrollbar-width: none;
      justify-content: flex-start;
      height: 60px;
      align-items: center;
      flex-shrink: 0;
      margin-top: auto;
      background: linear-gradient(to bottom, var(--bg-color) 20%, transparent);
    }
    
    .category-bar::-webkit-scrollbar { 
      display: none; 
    }
    
    .pill {
      padding: 4px 12px; 
      border-radius: 20px; 
      font-size: 11px; 
      font-weight: 600;
      background: var(--glass-bg); 
      border: 1px solid var(--glass-border);
      color: var(--ink-dim); 
      white-space: nowrap; 
      cursor: pointer; 
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .pill.active { 
      background: var(--ink); 
      color: var(--bg-color); 
      border-color: var(--ink); 
    }
    
    .pill.add-btn { 
      border-style: dashed; 
    }
    
    [data-theme="rose"] .pill.active {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
      border-color: var(--rose-primary);
      box-shadow: 0 0 12px rgba(255, 141, 161, 0.5);
    }
    
    /* ====== VIEW CONTAINER FIXES ====== */
    .view-container {
      position: absolute; 
      top: var(--header-height);
      bottom: var(--nav-height);
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      opacity: 0; 
      pointer-events: none;
      transition: opacity 0.3s ease;
      -webkit-overflow-scrolling: touch;
      box-sizing: border-box;
    }
    
    .view-container.active { 
      opacity: 1; 
      pointer-events: auto; 
      z-index: 1000;
    }
    
    /* Specific fixes for each view */
    #gridContainer { 
      overflow-y: auto; 
      padding: 16px 16px 120px 16px; 
      box-sizing: border-box;
    }
    
    #listContainer {
      padding: 20px;
      overflow-y: auto;
    }
    
    #columnsContainer {
      display: flex;
      flex-direction: column;
      padding: 0;
    }
    
    #historyContainer {
      padding: 20px;
    }
    
    #scatterContainer {
      overflow: hidden;
      touch-action: none;
    }
    
    .kanban-container {
      position: absolute;
      inset: 0;
      top: var(--header-height);
      bottom: var(--nav-height);
      display: flex;
      overflow: hidden;
      z-index: 1;
    }
    
    .kanban-column {
      display: flex;
      flex-direction: column;
      min-width: 300px;
      background: rgba(255, 255, 255, 0.01);
      border-right: 1px solid var(--glass-border);
      transition: all 0.3s ease;
      position: relative;
    }
    
    .kanban-column:first-child {
      min-width: 400px;
      flex: 1;
    }
    
    .kanban-column:last-child {
      border-right: none;
    }
    
    .column-header {
      padding: 16px;
      background: var(--glass-bg);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .column-title {
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--ink-dim);
    }
    
    .column-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .column-resize {
      position: absolute;
      right: -3px;
      top: 0;
      bottom: 0;
      width: 6px;
      cursor: col-resize;
      background: transparent;
      transition: background 0.2s;
    }
    
    .column-resize:hover {
      background: var(--accent);
    }
    
    .grid-wrapper {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      padding-bottom: 40px;
    }
    
    @media(min-width: 600px) { 
      .grid-wrapper { 
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
      } 
    }
    
    .video-card {
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s, background 0.2s, box-shadow 0.3s ease;
      cursor: pointer;
      z-index: 100;
    }
    
    .video-card:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }
    
    [data-theme="rose"] .video-card:hover {
      box-shadow: 0 8px 24px rgba(255, 141, 161, 0.3);
    }
    
    .video-card:active { 
      transform: scale(0.98); 
      background: var(--glass-border); 
    }
    
    .video-thumbnail {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      background: linear-gradient(45deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      overflow: hidden;
    }
    
    .video-thumbnail img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .video-card:hover .video-thumbnail img {
      transform: scale(1.05);
    }
    
    .video-duration {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-family: var(--font-mono);
      font-weight: 600;
    }
    
    .video-status {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-unwatched {
      background: var(--neon-blue);
      color: white;
    }
    
    .status-in-progress {
      background: var(--neon-orange);
      color: white;
    }
    
    .status-completed {
      background: var(--neon-green);
      color: white;
    }
    
    .status-saved {
      background: var(--accent);
      color: white;
    }
    
    .status-archived {
      background: var(--ink-dim);
      color: white;
    }
    
    .video-info {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .video-title {
      font-weight: 600;
      font-size: 14px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .video-channel {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--ink-dim);
    }
    
    .channel-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--glass-border);
    }
    
    .video-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--ink-dim);
      border-top: 1px solid var(--glass-border);
      padding-top: 8px;
    }
    
    .video-views {
      font-family: var(--font-mono);
    }
    
    .video-actions {
      display: flex;
      gap: 8px;
    }
    
    .action-icon {
      width: 28px; 
      height: 28px; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      border-radius: 6px; 
      background: rgba(255,255,255,0.05); 
      cursor: pointer;
      color: var(--ink-dim); 
      transition: 0.2s;
      font-size: 12px; 
      font-weight: 700;
    }
    
    .action-icon:hover { 
      background: var(--accent); 
      color: #fff; 
    }
    
    [data-theme="rose"] .action-icon:hover {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
    }
    
    .scatter-canvas {
      position: absolute; 
      inset: 0; 
      overflow: hidden;
      transform-origin: 0 0; 
      transition: transform 0.3s ease;
      cursor: grab;
    }
    
    .scatter-canvas.panning {
      cursor: grabbing;
    }
    
    .scatter-card {
      position: absolute;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 12px;
      cursor: move;
      user-select: none;
      transition: transform 0.2s, box-shadow 0.3s, left 0.3s ease, top 0.3s ease;
      z-index: 100;
      width: 200px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      touch-action: none;
    }
    
    .scatter-card:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    
    .scatter-card.is-dragging {
      transform: scale(1.05);
      box-shadow: 0 12px 32px rgba(0,0,0,0.4);
      z-index: 2000;
      opacity: 0.95;
    }
    
    .scatter-card.dimmed {
      opacity: 0.3;
      filter: grayscale(0.7);
    }
    
    .scatter-thumbnail {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      background: #1a1a1a;
      margin-bottom: 8px;
      overflow: hidden;
    }
    
    .scatter-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .scatter-controls {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 12px;
      backdrop-filter: blur(10px);
    }
    
    .scatter-controls button {
      background: transparent;
      border: none;
      color: var(--ink-dim);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 16px;
      width: 36px;
      height: 36px;
    }
    
    .scatter-controls button:hover {
      color: var(--ink);
      background: var(--glass-border);
      transform: scale(1.1);
    }
    
    .scatter-controls .divider {
      height: 1px;
      background: var(--glass-border);
      margin: 8px 0;
      width: 100%;
    }
    
    .scatter-search-container {
      position: fixed;
      top: calc(var(--header-height) + 20px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 8px 16px;
      backdrop-filter: blur(10px);
      min-width: 300px;
      max-width: 500px;
      width: 90%;
    }
    
    .scatter-search-input {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--ink);
      font-size: 14px;
      outline: none;
      padding: 4px 0;
    }
    
    .scatter-search-input::placeholder {
      color: var(--ink-dim);
    }
    
    .scatter-view-info {
      position: fixed;
      bottom: calc(var(--nav-height) + 20px);
      left: 20px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 8px 16px;
      font-size: 12px;
      color: var(--ink-dim);
      backdrop-filter: blur(10px);
      z-index: 1000;
    }
    
    .list-table {
      width: 100%; 
      border-collapse: collapse; 
      font-size: 14px;
    }
    
    .list-table th {
      text-align: left; 
      padding: 12px; 
      background: var(--glass-bg);
      font-weight: 600; 
      text-transform: uppercase; 
      font-size: 12px;
      border-bottom: 2px solid var(--glass-border);
    }
    
    .list-table td { 
      padding: 12px; 
      border-bottom: 1px solid var(--glass-border); 
    }
    
    .list-table tr:hover { 
      background: var(--glass-bg); 
    }
    
    .list-thumbnail { 
      width: 80px; 
      height: 45px; 
      border-radius: 4px; 
      object-fit: cover; 
    }
    
    /* ====== LIST VIEW STYLES ====== */
    .list-view {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .list-view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--glass-border);
    }
    
    .list-view-header h3 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .list-view-sort select {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--ink);
      font-size: 14px;
      min-width: 150px;
    }
    
    .list-view-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .list-view-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .list-view-item:hover {
      background: var(--glass-bg);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .list-item-thumbnail {
      width: 160px;
      height: 90px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      position: relative;
    }
    
    .list-item-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .list-item-duration {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-family: var(--font-mono);
    }
    
    .list-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .list-item-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.3;
    }
    
    .list-item-channel {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--ink-dim);
    }
    
    .list-item-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    
    .list-item-description {
      font-size: 12px;
      color: var(--ink-dim);
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .list-item-meta {
      display: flex;
      gap: 8px;
      font-size: 11px;
      color: var(--ink-dim);
      flex-wrap: nowrap;
    }
    
    .list-item-actions {
      display: flex;
      gap: 8px;
      flex-direction: column;
      justify-content: center;
      margin-left: auto;
    }
    
    .list-action-btn {
      width: 32px;
      height: 32px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 6px;
      color: var(--ink-dim);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .list-action-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .list-view-pagination {
      margin-top: 32px;
      text-align: center;
    }
    
    .pagination-btn {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 12px 24px;
      color: var(--ink);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .pagination-btn:hover {
      background: var(--glass-border);
      transform: translateY(-2px);
    }
    
    .bottom-nav {
      position: fixed; 
      bottom: 0; 
      left: 0; 
      right: 0; 
      height: var(--nav-height);
      background: linear-gradient(to top, var(--bg-color) 40%, transparent);
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 16px;
      padding: 0 20px; 
      z-index: 9999; 
      pointer-events: none;
    }
    
    .bottom-nav-inner {
      display: flex; 
      gap: 12px; 
      align-items: center; 
      pointer-events: auto;
      background: var(--glass-bg); 
      border: 1px solid var(--glass-border);
      border-radius: 24px; 
      padding: 8px 20px; 
      backdrop-filter: blur(16px);
    }
    
    .nav-btn {
      background: transparent; 
      border: none; 
      color: var(--ink-dim);
      cursor: pointer; 
      padding: 10px; 
      border-radius: 50%;
      display: flex; 
      align-items: center; 
      justify-content: center;
      transition: all 0.2s; 
      font-size: 18px; 
      width: 44px; 
      height: 44px;
      position: relative;
    }
    
    .nav-btn.active { 
      color: var(--accent); 
      background: rgba(255, 0, 0, 0.1); 
    }
    
    .nav-btn:hover { 
      color: var(--ink); 
      transform: scale(1.1); 
    }
    
    .nav-btn:active { 
      transform: scale(0.95); 
    }
    
    .pocket-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background: var(--accent);
      color: white;
      font-size: 10px;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    
    .scatter-pocket.just-added {
      animation: pulse 0.5s ease-in-out 3;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .detail-panel {
      position: fixed; 
      top: var(--header-height); 
      right: -100%;
      width: 600px; 
      height: calc(100vh - var(--header-height));
      background: var(--card-bg); 
      border: 1px solid var(--glass-border);
      transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      z-index: 8888; 
      display: none;
      flex-direction: column;
      border-radius: 0;
    }
    
    .detail-panel.side-panel {
      right: -600px;
      width: 600px;
      border-left: 1px solid var(--glass-border);
      border-right: none;
      border-top: none;
      border-bottom: none;
    }
    
    .detail-panel.side-panel.active { 
      right: 0; 
      display: flex;
    }
    
    .detail-panel.full-viewport {
      right: -100%;
      width: 100%;
      top: var(--header-height);
      height: calc(85vh - var(--header-height));
      left: 0;
      margin: 0 auto;
      max-width: 1200px;
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    
    .detail-panel.full-viewport.active { 
      right: 0; 
      transform: translateX(-50%);
      left: 50%;
      display: flex;
    }
    
    .detail-close {
      position: absolute; 
      top: 16px; 
      right: 16px; 
      z-index: 9999;
      background: var(--glass-bg); 
      border: 1px solid var(--glass-border);
      border-radius: 50%; 
      width: 32px; 
      height: 32px; 
      display: flex;
      align-items: center; 
      justify-content: center; 
      cursor: pointer;
      color: var(--ink-dim); 
      transition: all 0.2s;
    }
    
    .detail-close:hover { 
      color: var(--ink); 
      background: var(--glass-border); 
    }
    
    .video-mode-toggle {
      position: absolute; 
      top: 16px; 
      left: 16px; 
      z-index: 9999;
      background: var(--glass-bg); 
      border: 1px solid var(--glass-border);
      border-radius: 20px; 
      padding: 6px 12px; 
      display: flex;
      align-items: center; 
      gap: 8px; 
      cursor: pointer;
      color: var(--ink-dim); 
      font-size: 12px; 
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .video-mode-toggle:hover { 
      color: var(--ink); 
      background: var(--glass-border); 
      transform: scale(1.05);
    }
    
    .detail-content {
      flex: 1; 
      overflow-y: auto; 
      padding: 20px;
      padding-top: 60px;
    }
    
    .detail-panel.full-viewport .video-player {
      width: 100%; 
      aspect-ratio: 16/9; 
      background: #000; 
      border-radius: 12px;
      margin-bottom: 20px; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      color: var(--ink-dim); 
      font-size: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .video-player {
      width: 100%; 
      aspect-ratio: 16/9; 
      background: #000; 
      border-radius: 12px;
      margin-bottom: 16px; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      color: var(--ink-dim); 
      font-size: 18px;
    }
    
    .search-overlay {
      position: fixed; 
      top: 0;
      right: -100%;
      width: 575px;
      height: 100vh;
      padding: 0 2em 0 2.5em;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 9999;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; 
      flex-direction: column;
      border-left: 1px solid var(--glass-border);
      box-shadow: -10px 0 30px rgba(0,0,0,0.3);
    }
    
    .search-overlay.active { 
      right: 0;
    }
    
    .search-container {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    
    .search-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: var(--glass-bg);
      border-bottom: 1px solid var(--glass-border);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .search-title {
      font-weight: 700;
      font-size: 24px;
      margin: 0;
    }
    
    .close-search {
      background: transparent;
      border: none;
      font-size: 28px;
      color: var(--ink-dim);
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .close-search:hover {
      background: var(--glass-border);
      color: var(--ink);
      transform: scale(1.1);
    }
    
    .search-input-container {
      padding: 20px;
      background: var(--glass-bg);
      border-bottom: 1px solid var(--glass-border);
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 50px 12px 16px;
      font-size: 16px;
      background: var(--card-bg);
      border: 2px solid var(--glass-border);
      border-radius: 12px;
      color: var(--ink);
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
    }
    
    .voice-search-btn {
      position: absolute;
      right: 36px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--ink-dim);
      padding: 8px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
    }
    
    .voice-search-btn:hover {
      color: var(--accent);
      transform: translateY(-50%) scale(1.1);
    }
    
    .search-results {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .bento-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .bento-item {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .bento-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--neon-blue), var(--neon-green));
      transform: scaleX(0);
      transition: transform 0.3s;
    }
    
    .bento-item:hover::before {
      transform: scaleX(1);
    }
    
    .bento-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.2);
      border-color: var(--accent);
    }
    
    .bento-item.large {
      grid-column: span 2;
    }
    
    .bento-item.medium {
      grid-column: span 1;
    }
    
    .bento-item.small {
      grid-column: span 1;
    }
    
    .discovery-section {
      margin-bottom: 32px;
    }
    
    .section-title {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .discovery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    
    .discovery-item {
      padding: 16px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .discovery-item:hover {
      background: var(--glass-border);
      transform: translateX(4px);
    }
    
    .trending-badge {
      background: var(--accent);
      color: #000;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      animation: trending-pulse 2s infinite;
    }
    
    @keyframes trending-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .ai-placeholder {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      margin: 32px 0;
      position: relative;
      overflow: hidden;
    }
    
    .ai-placeholder::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      animation: ai-shimmer 3s infinite;
    }
    
    @keyframes ai-shimmer {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }
    
    .filters-section {
      margin: 32px 0;
      padding: 24px;
      background: var(--glass-bg);
      border-radius: 16px;
      border: 1px solid var(--glass-border);
    }
    
    .filter-group {
      margin-bottom: 20px;
    }
    
    .filter-group:last-child {
      margin-bottom: 0;
    }
    
    .filter-group-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--ink-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .filter-pills {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
    }
    
    .filter-pill {
      padding: 8px 16px;
      border-radius: 20px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .filter-pill:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .filter-pill.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }
    
    .filter-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--glass-border);
    }
    
    .filter-toggle:last-child {
      border-bottom: none;
    }
    
    .toggle-switch {
      width: 48px;
      height: 24px;
      background: var(--glass-border);
      border-radius: 24px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .toggle-slider {
      width: 20px;
      height: 20px;
      background: var(--ink);
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s;
    }
    
    .toggle-switch.active {
      background: var(--accent);
    }
    
    .toggle-switch.active .toggle-slider {
      left: 26px;
      background: #000;
    }
    
    .context-menu {
      position: fixed; 
      display: none; 
      background: var(--card-bg);
      border: 1px solid var(--glass-border); 
      border-radius: 12px;
      padding: 8px 0; 
      min-width: 180px; 
      z-index: 9999;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    .context-menu.active { 
      display: block; 
    }
    
    .ctx-header {
      padding: 8px 16px; 
      font-weight: 600; 
      font-size: 12px;
      text-transform: uppercase; 
      color: var(--ink-dim); 
      border-bottom: 1px solid var(--glass-border);
      margin-bottom: 4px;
    }
    
    .ctx-item {
      padding: 10px 16px; 
      cursor: pointer; 
      transition: background 0.2s; 
      font-size: 14px;
    }
    
    .ctx-item:hover { 
      background: var(--glass-bg); 
    }
    
    .skeleton {
      background: linear-gradient(90deg, var(--glass-bg) 25%, var(--glass-border) 50%, var(--glass-bg) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
    }
    
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .hidden { 
      display: none !important; 
    }
    
    .fade-in { 
      animation: fadeIn 0.3s ease; 
    }
    
    @keyframes fadeIn { 
      from { opacity: 0; } 
      to { opacity: 1; } 
    }
    
    .slide-up { 
      animation: slideUp 0.3s ease; 
    }
    
    @keyframes slideUp { 
      from { transform: translateY(20px); opacity: 0; } 
      to { transform: translateY(0); opacity: 1; } 
    }
    
    .modal-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.8); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      opacity: 0; 
      pointer-events: none; 
      transition: opacity 0.3s; 
      z-index: 9999; 
    }
    
    .modal-overlay.active { 
      opacity: 1; 
      pointer-events: auto; 
    }
    
    .modal { 
      background: var(--card-bg); 
      border: 1px solid var(--glass-border); 
      border-radius: 16px; 
      padding: 20px; 
      width: 90%; 
      max-width: 400px; 
    }
    
    .modal-header { 
      font-weight: 600; 
      margin-bottom: 16px; 
    }
    
    .modal-content { 
      display: flex; 
      flex-direction: column; 
      gap: 8px; 
    }
    
    .modal-option { 
      display: flex; 
      gap: 12px; 
      padding: 12px; 
      border-radius: 12px; 
      background: var(--glass-bg); 
      cursor: pointer; 
      transition: background 0.2s; 
    }
    
    .modal-option:hover { 
      background: var(--glass-border); 
    }
    
    .modal-option-icon { 
      font-size: 24px; 
    }
    
    .modal-option-text { 
      display: flex; 
      flex-direction: column; 
    }
    
    .modal-option-title { 
      font-weight: 600; 
    }
    
    .modal-option-desc { 
      font-size: 13px; 
      color: var(--ink-dim); 
    }
    
    .modal-close { 
      width: 100%; 
      margin-top: 16px; 
      background: transparent; 
      border: 1px solid var(--glass-border); 
      border-radius: 12px; 
      padding: 12px; 
      color: var(--ink); 
      cursor: pointer; 
    }
    
    .sort-bar { display: flex; gap: 8px; padding: 10px; flex-wrap: nowrap; }
    
    .joystick-container {
      position: fixed;
      bottom: 120px;
      right: 20px;
      z-index: 999;
      display: none;
    }
    
    .joystick-container.active {
      display: block;
    }
    
    .youtube-joystick-fab {
      width: 60px;
      height: 60px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      backdrop-filter: blur(10px);
      transition: all 0.2s;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .youtube-joystick-fab.pressed {
      transform: scale(0.95);
      background: var(--glass-border);
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    
    .youtube-joystick-handle {
      font-size: 24px;
      transition: transform 0.1s;
    }
    
    .youtube-direction-indicators {
      position: absolute;
      inset: -20px;
    }
    
    .youtube-direction-indicator {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      box-shadow: 0 0 10px var(--accent);
    }
    
    .youtube-direction-indicator.active {
      opacity: 1;
      transform: scale(1.2);
    }
    
    .youtube-indicator-up { top: 0; left: 50%; transform: translateX(-50%) scale(0.8); }
    .youtube-indicator-right { top: 50%; right: 0; transform: translateY(-50%) scale(0.8); }
    .youtube-indicator-down { bottom: 0; left: 50%; transform: translateX(-50%) scale(0.8); }
    .youtube-indicator-left { top: 50%; left: 0; transform: translateY(-50%) scale(0.8); }
    
    /* Mobile styles for list view */
    @media (max-width: 768px) {
      .list-item-thumbnail {
        width: 120px;
        height: 68px;
      }
      
      .list-view-item {
        padding: 12px;
        gap: 12px;
      }
      
      .list-item-title {
        font-size: 13px;
        -webkit-line-clamp: 1;
      }
      
      .list-item-description {
        display: none;
      }
      
      .list-item-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        flex-direction: row;
      }
      
      .list-action-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }
    }
    
    /* ====== MOBILE RESPONSIVE DESIGN ====== */
    @media (max-width: 768px) {
      :root {
        --nav-height: 70px;
        --header-height: 130px;
      }
      
      .app-header {
        height: var(--header-height);
        background: linear-gradient(to bottom, var(--bg-color) 90%, transparent);
        padding-top: env(safe-area-inset-top);
        justify-content: flex-start;
      }
      
      .header-top {
        height: 70px;
        padding: 0 16px;
        flex-wrap: nowrap;
        gap: 12px;
      }
      
      .header-center {
        display: none;
      }
      
      .header-right {
        gap: 4px;
      }
      
      .create-new-btn span:last-child {
        display: none;
      }
      
      .create-new-btn span:first-child {
        font-size: 20px;
        padding: 8px;
      }
      
      .mobile-search-btn {
        display: flex;
      }
      
      .header-left {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .logo-wrapper {
        flex-shrink: 0;
      }
      
      .header-right {
        flex-shrink: 0;
      }
      
      .category-bar {
        height: 60px;
        padding: 12px 16px;
        align-items: center;
        background: linear-gradient(to bottom, var(--bg-color) 30%, transparent);
        padding-left: calc(16px + env(safe-area-inset-left));
        padding-right: calc(16px + env(safe-area-inset-right));
      }
      
      .pill {
        min-height: 36px;
        min-width: 70px;
        padding: 8px 16px;
        font-size: 12px;
        margin: 2px;
      }
      
      .view-container {
        top: var(--header-height) !important;
        height: calc(100vh - var(--header-height) - var(--nav-height)) !important;
      }
      
      .kanban-container {
        top: var(--header-height) !important;
        height: calc(100vh - var(--header-height) - var(--nav-height)) !important;
      }
      
      #scatterContainer {
        top: var(--header-height) !important;
        height: calc(100vh - var(--header-height) - var(--nav-height)) !important;
      }
      
      .detail-panel {
        top: var(--header-height) !important;
        height: calc(100vh - var(--header-height)) !important;
      }
      
      #gridContainer {
        padding-top: 8px;
        padding-bottom: 100px;
      }
      
      .search-overlay {
        width: 100%;
        right: -100%;
        border-left: none;
        border-radius: 0;
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
      
      .search-header {
        padding: 16px 20px;
      }
      
      .search-title {
        font-size: 20px;
      }
      
      .search-input-container {
        padding: 20px;
      }
      
      .search-input {
        font-size: 18px;
        padding: 16px 50px 16px 20px;
        min-height: 44px;
      }
      
      .voice-search-btn {
        right: 32px;
        font-size: 18px;
      }
      
      .search-results {
        padding: 20px;
      }
      
      .bento-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .bento-item.large,
      .bento-item.medium,
      .bento-item.small {
        grid-column: span 1;
      }
      
      .discovery-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .discovery-item {
        padding: 12px;
        font-size: 13px;
        min-height: 44px;
      }
      
      .filters-section {
        padding: 20px;
        margin: 20px 0;
      }
      
      .filter-pills {
        gap: 6px;
      }
      
      .filter-pill {
        padding: 6px 12px;
        font-size: 12px;
      }
      
      .close-search {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: var(--glass-bg);
        border-radius: 50%;
      }
      
      button, .pill, .nav-btn, .action-icon {
        min-height: 44px;
        min-width: 44px;
      }
      
      .bottom-nav {
        padding-bottom: env(safe-area-inset-bottom);
      }
      
      .scatter-card {
        width: 160px;
        padding: 10px;
      }
      
      .scatter-thumbnail {
        height: 70px;
      }
      
      .scatter-controls {
        right: 10px;
        top: auto;
        transform: none;
        flex-direction: row;
        flex-wrap: wrap;
        width: auto;
        gap: 6px;
        padding: 10px;
      }
      
      .scatter-controls .divider {
        display: none;
      }
      
      .scatter-controls button {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .scatter-search-container {
        top: calc(var(--header-height) + 10px);
        width: 85%;
        min-width: auto;
      }
      
      .joystick-container {
        bottom: 100px;
        right: 16px;
      }
      
      .youtube-joystick-fab {
        width: 56px;
        height: 56px;
      }
      
      .youtube-joystick-fab.mobile-active {
        background: rgba(255, 0, 0, 0.1);
        border: 2px solid var(--accent);
      }
    }
    
    @media (max-width: 480px) {
      :root {
        --header-height: 140px;
      }
      
      .header-top {
        height: 65px;
      }
      
      .category-bar {
        height: 75px;
        flex-wrap: nowrap;
        justify-content: flex-start;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 8px 16px;
      }
      
      .pill {
        min-height: 32px;
        min-width: 80px;
        font-size: 10px;
        margin: 2px;
      }
      
      .logo-text {
        display: none;
      }
      
      .theme-btn, .notifications-btn, .profile-btn {
        width: 36px;
        height: 36px;
        padding: 6px;
      }
      
      .search-header {
        padding: 12px 16px;
      }
      
      .search-title {
        font-size: 18px;
      }
      
      .search-input-container {
        padding: 16px;
      }
      
      .search-input {
        font-size: 16px;
        padding: 14px 45px 14px 16px;
      }
      
      .voice-search-btn {
        right: 28px;
        font-size: 16px;
      }
      
      .search-results {
        padding: 16px;
      }
      
      .section-title {
        font-size: 16px;
      }
      
      .discovery-item {
        padding: 10px;
        font-size: 12px;
      }
      
      .scatter-card {
        width: 140px;
        padding: 8px;
      }
      
      .scatter-thumbnail {
        height: 60px;
      }
    }
    
    @media (min-width: 769px) {
      .joystick-container {
        display: none !important;
      }
      
      .joystick-container.active {
        display: block !important;
      }
    }
    
    @supports (-webkit-touch-callout: none) {
      .view-container {
        height: -webkit-fill-available;
      }
      
      .kanban-container {
        height: -webkit-fill-available;
      }
    }
  </style>
</head>

<body>
  <!-- Enhanced Header -->
  <header class="app-header">
    <div class="header-top">
      <div class="header-left">
        <div class="logo">
          <div class="logo-wrapper">
            <div class="logo-cube">
              <div class="fab-cube">
                <div class="f-face"></div>
                <div class="f-face"></div>
                <div class="f-face"></div>
                <div class="f-face"></div>
                <div class="f-face"></div>
                <div class="f-face"></div>
              </div>
            </div>
            <div class="logo-text"> <strong>NewTube</strong></div>
          </div>
        </div>
        <!-- Mobile Search Button -->
        <button class="mobile-search-btn" onclick="openMobileSearch()" aria-label="Search">
          
        </button>
      </div>
    
      <div class="header-center">
        <!-- Desktop Search (always visible) -->
        <div class="header-search desktop-search">
          <div class="header-search-wrapper">
            <input type="text" 
                   placeholder="Search videos..." 
                   id="headerSearch"
                   onkeyup="if(event.key === 'Enter') performSearch()"
                   aria-label="Search videos">
            <button onclick="performSearch()" aria-label="Search">
              
            </button>
          </div>
        </div>
        
        <!-- Mobile Search Button (visible on mobile) -->
        <button class="mobile-search-btn" onclick="openMobileSearch()" aria-label="Search">
          
        </button>
      </div>
    
      <div class="header-right">
        <button class="notifications-btn" onclick="toggleNotifications()" aria-label="Notifications">
          <span></span>
          <div class="notification-badge"></div>
        </button>
      
        <div class="profile-dropdown">
          <button class="profile-btn" onclick="toggleProfileMenu()" aria-label="User menu">U</button>
          <div class="profile-menu" id="profileMenu">
            <div class="profile-menu-item" onclick="navigateTo('settings')"> Settings</div>
            <div class="profile-menu-item" onclick="navigateTo('history')"> History</div>
            <div class="profile-menu-item" onclick="navigateTo('playlists')"> Playlists</div>
            <div class="profile-menu-divider"></div>
            <div class="profile-menu-item" onclick="navigateTo('help')"> Help</div>
            <div class="profile-menu-item" onclick="navigateTo('signout')"> Sign Out</div>
          </div>
        </div>
      
        <button class="create-new-btn" onclick="openCreateModal()" aria-label="Create new">
          <span>+</span>
          <span>Create New</span>
        </button>
      
        <div class="header-buttons">
            <button class="theme-btn" onclick="cycleTheme()" title="Cycle Theme" aria-label="Change theme">
                <span id="themeIcon"></span>
            </button>
        </div>
      </div>
    </div>
  
    <!-- Category Filter Bar -->
    <div class="category-bar" id="categoryBar">
      <div class="pill active" data-category="all">All</div>
      <div class="pill" data-category="music">Music</div>
      <div class="pill" data-category="gaming">Gaming</div>
      <div class="pill" data-category="education">Education</div>
      <div class="pill" data-category="tech">Technology</div>
      <div class="pill" data-category="entertainment">Entertainment</div>
      <div class="pill add-btn" onclick="addCustomCategory()">+ Add</div>
    </div>
  </header>

  <!-- Grid Container -->
  <div id="gridContainer" class="view-container active">
    <div class="grid-wrapper" id="gridWrapper">
      <!-- Video cards will be inserted here -->
    </div>
  </div>

  <!-- List View Container -->
  <div id="listContainer" class="view-container">
    <div class="list-view" id="listViewWrapper">
      <!-- List items will be inserted here -->
    </div>
  </div>

  <!-- Columns (Kanban) Container -->
  <div id="columnsContainer" class="view-container columns-container">
    <!-- Columns will be dynamically generated -->
  </div>
  
  <!-- Scatter Container -->
  <div id="scatterContainer" class="view-container">
    <div class="scatter-search-container">
      <input type="text" 
             class="scatter-search-input" 
             id="scatterSearchInput"
             placeholder="Search in scatter view..."
             onkeyup="filterScatterVideos(this.value)">
    </div>
    <div class="scatter-canvas" id="scatterCanvas">
      <!-- Scatter cards here -->
    </div>
    <div class="scatter-view-info" id="scatterInfo">
      <span id="scatterCount">0 videos</span> | <span id="scatterZoom">100%</span>
    </div>
    <!-- Scatter Controls - Right Rail -->
    <div class="scatter-controls" id="scatterControls">
      <button class="theme-btn" onclick="collectNodes()" title="Arrange as Grid">
        
      </button>
      <button class="theme-btn" onclick="cascadeNodes()" title="Arrange as Cascade">
        
      </button>
      <button class="theme-btn" onclick="spreadNodes()" title="Spread Randomly">
        
      </button>
      <div style="height: 1px; background: var(--glass-border); margin: 8px 0;"></div>
      <button class="theme-btn" onclick="zoomIn()" title="Zoom In">
        +
      </button>
      <button class="theme-btn" onclick="resetView()" title="Reset View">
        
      </button>
      <button class="theme-btn" onclick="zoomOut()" title="Zoom Out">
        -
      </button>
      <div style="height: 1px; background: var(--glass-border); margin: 8px 0;"></div>
      <button class="theme-btn" onclick="sortScatterByStatus()" title="Sort by Status">
        
      </button>
      <button class="theme-btn" onclick="sortScatterByCategory()" title="Sort by Category">
        
      </button>
    </div>
  </div>
  
  <!-- History Container -->
  <div id="historyContainer" class="view-container">
    <div class="sort-bar">
      <div class="pill active" data-sort="lastWatched">Last Watched</div>
      <div class="pill" data-sort="uploadDate">Upload Date</div>
      <div class="pill" data-sort="views">Views</div>
    </div>
    <table class="list-table">
      <thead>
        <tr>
          <th>Thumbnail</th>
          <th>Title</th>
          <th>Channel</th>
          <th>Duration</th>
          <th>Views</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <!-- Rows here -->
      </tbody>
    </table>
  </div>

  <!-- Search Overlay - Full Viewport -->
  <div class="search-overlay" id="searchOverlay">
    <div class="search-container">
      <!-- Search Header -->
      <div class="search-header">
        <h2 class="search-title">Search</h2>
        <button class="close-search" onclick="closeSearchOverlay()"></button>
      </div>
    
      <!-- Search Input -->
      <div class="search-input-container">
        <input type="text" class="search-input" id="mainSearchInput" 
               placeholder="Search for videos, channels, or topics..." 
               onkeyup="updateSearchSuggestions(this.value)">
        <button class="voice-search-btn" onclick="startVoiceSearch()"></button>
      </div>
    
      <!-- Search Results - Bento Grid -->
      <div id="searchResults" style="display: none;">
        <h3 class="section-title">Search Results</h3>
        <div class="bento-grid" id="searchResultsGrid">
          <!-- Search results will be populated here -->
        </div>
        
        <!-- AI Integration Placeholder -->
        <div class="ai-placeholder" id="aiSmartSearch">
          <h3> AI Smart Search</h3>
          <p>Coming Soon: Intelligent video discovery powered by AI</p>
          <small>This feature will understand context and provide personalized recommendations</small>
        </div>
        
        <!-- Recommended Section -->
        <h3 class="section-title">Recommended For You</h3>
        <div class="bento-grid" id="recommendedGrid">
          <!-- Recommended items will be populated here -->
        </div>
      </div>
      
      <!-- Discovery Sections (shown when no search) -->
      <div id="discoverySections">
        <div class="discovery-section">
          <h3 class="section-title">Your Search History</h3>
          <div class="discovery-grid">
            <div class="discovery-item" onclick="searchFor('Tech reviews 2024')">
               Tech reviews 2024
            </div>
            <div class="discovery-item" onclick="searchFor('Gaming livestreams')">
               Gaming livestreams
            </div>
            <div class="discovery-item" onclick="searchFor('Cooking tutorials')">
               Cooking tutorials
            </div>
            <div class="discovery-item" onclick="searchFor('Music playlists')">
               Music playlists
            </div>
          </div>
        </div>
        
        <div class="discovery-section">
          <h3 class="section-title">Suggested for You</h3>
            <div class="discovery-grid">
            <div class="discovery-item" onclick="searchFor('AI technology trends')">
               AI technology trends
            </div>
            <div class="discovery-item" onclick="searchFor('Workout routines')">
               Workout routines
            </div>
            <div class="discovery-item" onclick="searchFor('Book recommendations')">
               Book recommendations
            </div>
            <div class="discovery-item" onclick="searchFor('Travel guides')">
               Travel guides
            </div>
          </div>
        </div>
        
        <div class="discovery-section">
          <h3 class="section-title">
            Trending Today
            <span class="trending-badge">HOT</span>
          </h3>
          <div class="discovery-grid">
            <div class="discovery-item" onclick="searchFor('New movie trailers')">
               New movie trailers
            </div>
            <div class="discovery-item" onclick="searchFor('Viral challenges')">
               Viral challenges
            </div>
            <div class="discovery-item" onclick="searchFor('Breaking news')">
               Breaking news
            </div>
            <div class="discovery-item" onclick="searchFor('Celebrity interviews')">
               Celebrity interviews
            </div>
          </div>
        </div>
        
        <!-- Original Filters -->
        <div class="filters-section">
          <h3 class="section-title">Search Filters</h3>
        
          <div class="filter-group">
            <h4 class="filter-group-title">Upload Date</h4>
            <div class="filter-pills">
              <div class="filter-pill" onclick="toggleFilter(this)">Any time</div>
              <div class="filter-pill" onclick="toggleFilter(this)">Last hour</div>
              <div class="filter-pill" onclick="toggleFilter(this)">Today</div>
              <div class="filter-pill" onclick="toggleFilter(this)">This week</div>
              <div class="filter-pill" onclick="toggleFilter(this)">This month</div>
              <div class="filter-pill" onclick="toggleFilter(this)">This year</div>
            </div>
          </div>
        
          <div class="filter-group">
            <h4 class="filter-group-title">Duration</h4>
            <div class="filter-pills">
              <div class="filter-pill" onclick="toggleFilter(this)">Any duration</div>
              <div class="filter-pill" onclick="toggleFilter(this)">Under 4 minutes</div>
              <div class="filter-pill" onclick="toggleFilter(this)">4-20 minutes</div>
              <div class="filter-pill" onclick="toggleFilter(this)">Over 20 minutes</div>
            </div>
          </div>
        
          <div class="filter-group">
            <h4 class="filter-group-title">Features</h4>
            <div class="filter-pills">
              <div class="filter-pill" onclick="toggleFilter(this)">Live</div>
              <div class="filter-pill" onclick="toggleFilter(this)">4K</div>
              <div class="filter-pill" onclick="toggleFilter(this)">HDR</div>
              <div class="filter-pill" onclick="toggleFilter(this)">Subtitles/CC</div>
              <div class="filter-pill" onclick="toggleFilter(this)">Creative Commons</div>
            </div>
          </div>
        
          <div class="filter-group">
            <h4 class="filter-group-title">Sort By</h4>
            <div class="filter-pills">
              <div class="filter-pill active" onclick="toggleFilter(this)">Relevance</div>
              <div class="filter-pill" onclick="toggleFilter(this)">Upload date</div>
              <div class="filter-pill" onclick="toggleFilter(this)">View count</div>
              <div class="filter-pill" onclick="toggleFilter(this)">Rating</div>
            </div>
          </div>
        
          <div class="filter-group">
            <h4 class="filter-group-title">Content Options</h4>
            <div class="filter-toggle">
              <span>Include closed captions</span>
              <div class="toggle-switch" onclick="toggleSwitch(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
            <div class="filter-toggle">
              <span>Include playlists</span>
              <div class="toggle-switch" onclick="toggleSwitch(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
            <div class="filter-toggle">
              <span>Include movies</span>
              <div class="toggle-switch" onclick="toggleSwitch(this)">
                <div class="toggle-slider"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create New Modal -->
  <div class="modal-overlay" id="createModal">
    <div class="modal">
      <div class="modal-header">Create New</div>
      <div class="modal-content">
        <div class="modal-option" onclick="createItem('playlist')">
          <div class="modal-option-icon"></div>
          <div class="modal-option-text">
            <div class="modal-option-title">Playlist</div>
            <div class="modal-option-desc">Create a new video playlist</div>
          </div>
        </div>
        <div class="modal-option" onclick="createItem('collection')">
          <div class="modal-option-icon"></div>
          <div class="modal-option-text">
            <div class="modal-option-title">Collection</div>
            <div class="modal-option-desc">Organize videos into collections</div>
          </div>
        </div>
        <div class="modal-option" onclick="createItem('upload')">
          <div class="modal-option-icon"></div>
          <div class="modal-option-text">
            <div class="modal-option-title">Upload Video</div>
            <div class="modal-option-desc">Upload a new video</div>
          </div>
        </div>
        <div class="modal-option" onclick="createItem('live')">
          <div class="modal-option-icon"></div>
          <div class="modal-option-text">
            <div class="modal-option-title">Go Live</div>
            <div class="modal-option-desc">Start a live stream</div>
          </div>
        </div>
      </div>
      <button class="modal-close" onclick="closeCreateModal()">Cancel</button>
    </div>
  </div>
  
  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="nav-btn active" data-mode="feed" onclick="switchMode('feed')"></button>
      <button class="nav-btn" data-mode="list" onclick="switchMode('list')"></button>
      <button class="nav-btn" data-mode="columns" onclick="switchMode('columns')"></button>
      <button class="nav-btn scatter-pocket" data-mode="scatter" onclick="openScatterView()">
        
        <span class="pocket-badge" id="scatterBadge" style="display: none;">0</span>
      </button>
      <button class="nav-btn" data-mode="history" onclick="switchMode('history')"></button>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu"></div>
  
  <!-- Detail Panel -->
  <div class="detail-panel side-panel" id="detailPanel">
    <button class="detail-close" onclick="closeDetailPanel()"></button>
    <button class="video-mode-toggle" onclick="toggleVideoMode()">
      <span id="videoModeIcon"></span>
      <span id="videoModeText">Full Screen</span>
    </button>
    <div class="detail-content" id="detailContent"></div>
  </div>

  <!-- Mobile Full-Screen Search Overlay -->
  <div class="mobile-search-overlay" id="mobileSearchOverlay">
    <div class="mobile-search-header">
      <button class="mobile-search-close" onclick="closeMobileSearch()"></button>
      <div class="mobile-search-input-wrapper">
        <input 
          type="text" 
          class="mobile-search-input" 
          id="mobileSearchInput"
          placeholder="Search for videos, channels, or topics..."
          onkeyup="if(event.key === 'Enter') mobilePerformSearch()"
          aria-label="Search videos"
        >
      </div>
    </div>
    <div class="mobile-search-results" id="mobileSearchResults">
      <!-- Mobile search results will be displayed here -->
    </div>
  </div>

  <script>
    // ====== GLOBAL STATE ======
    let config = {
      currentView: 'feed',
      currentCategory: 'all',
      currentTheme: 'dark',
      searchQuery: '',
      kanbanViewMode: 'columns'
    };
    let videos = [];
    let collections = [];
    let scatterCollections = [];
    let currentVideo = null;
    let scatter = {
      transform: { x: 0, y: 0, scale: 1 },
      panning: false,
      dragging: false,
      pinchStart: 0,
      lastPan: { x: 0, y: 0 }
    };
    let isMobile = false;
    let globalTouchStartX = 0;
    let globalTouchStartY = 0;
    let isDragging = false;
    let draggedCard = null;
    let dragOffset = { x: 0, y: 0 };
    let videoOverlayMode = 'side-panel';
    let resizeTimeout;
    let scatterSearchQuery = '';
    
    // Column scrolling variables
    let columnTouchStartY = 0;
    let columnTouchScrollElement = null;
    
    // ====== MOBILE DETECTION & INIT ======
    function detectMobile() {
      isMobile = window.innerWidth <= 768 || 
                 ('ontouchstart' in window) || 
                 (navigator.maxTouchPoints > 0);
      updateMobileSearchVisibility();
    }
    
    function updateMobileSearchVisibility() {
      const headerCenter = document.querySelector('.header-center');
      const mobileSearchBtn = document.querySelector('.mobile-search-btn');
      
      if (isMobile) {
        if (headerCenter) headerCenter.style.display = 'none';
        if (mobileSearchBtn) mobileSearchBtn.style.display = 'flex';
      } else {
        if (headerCenter) headerCenter.style.display = 'block';
        if (mobileSearchBtn) mobileSearchBtn.style.display = 'none';
      }
    }
    
    function openMobileSearch() {
      const overlay = document.getElementById("mobileSearchOverlay");
      overlay.classList.add("active");
      
      setTimeout(() => {
        document.getElementById("mobileSearchInput").focus();
      }, 100);
      
      document.addEventListener("keydown", handleMobileSearchEscape);
    }
    
    function closeMobileSearch() {
      const overlay = document.getElementById("mobileSearchOverlay");
      overlay.classList.remove("active");
      document.getElementById("mobileSearchInput").value = "";
      
      document.removeEventListener("keydown", handleMobileSearchEscape);
    }
    
    function handleMobileSearchEscape(e) {
      if (e.key === "Escape") {
        closeMobileSearch();
      }
    }
    
    function mobilePerformSearch() {
      const searchInput = document.getElementById("mobileSearchInput");
      const searchValue = searchInput ? searchInput.value.trim() : "";
      
      if (searchValue) {
        config.searchQuery = searchValue;
        
        showSearchResults(searchValue);
        
        const searchOverlay = document.getElementById("searchOverlay");
        if (!searchOverlay.classList.contains("active")) {
          toggleSearchOverlay();
          
          const overlayInput = document.getElementById("mainSearchInput");
          if (overlayInput) {
            overlayInput.value = searchValue;
          }
        }
        
        closeMobileSearch();
        switchMode("feed");
      }
    }
    
    // ====== HEADER SEARCH FUNCTIONS ======
    function performSearch() {
      const headerInput = document.getElementById('headerSearch');
      const searchValue = headerInput ? headerInput.value.trim() : '';
      
      if (searchValue) {
        config.searchQuery = searchValue;
        
        showSearchResults(searchValue);
        
        const searchOverlay = document.getElementById('searchOverlay');
        if (!searchOverlay.classList.contains('active')) {
          toggleSearchOverlay();
          
          const overlayInput = document.getElementById('mainSearchInput');
          if (overlayInput) {
            overlayInput.value = searchValue;
          }
        }
        
        if (headerInput) {
          headerInput.value = '';
        }
      }
    }
    
    // ====== UTILITY FUNCTIONS ======
    function formatDuration(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hrs > 0) {
        return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function formatViews(views) {
      if (views >= 1000000) {
        return (views / 1000000).toFixed(1) + 'M';
      }
      if (views >= 1000) {
        return (views / 1000).toFixed(1) + 'K';
      }
      return views.toString();
    }
    
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays} days ago`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
      if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
      return `${Math.floor(diffDays / 365)} years ago`;
    }
    
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // ====== ENHANCED MOCK DATA ======
    function generateMockVideos() {
      const categories = ['Music', 'Gaming', 'Education', 'News', 'Sports', 'Comedy', 'Science', 'Tech', 'DIY', 'Food'];
      const subcategories = {
        'Music': ['Pop', 'Rock', 'Hip Hop', 'Electronic', 'Classical', 'Jazz', 'Indie', 'R&B'],
        'Gaming': ['FPS', 'RPG', 'Strategy', 'MOBA', 'Indie', 'Mobile', 'Retro', 'Simulation'],
        'Education': ['Science', 'History', 'Math', 'Language', 'Technology', 'Business', 'Art', 'Philosophy'],
        'News': ['Politics', 'Technology', 'Entertainment', 'Business', 'Science', 'Health', 'World', 'Local'],
        'Sports': ['Football', 'Basketball', 'Tennis', 'Golf', 'Fitness', 'Extreme', 'Olympics', 'Motorsports'],
        'Comedy': ['Stand-up', 'Sketch', 'Improv', 'Parody', 'Satire', 'Dark Comedy', 'Observational'],
        'Science': ['Physics', 'Biology', 'Astronomy', 'Chemistry', 'Psychology', 'Geology', 'Ecology'],
        'Tech': ['Programming', 'AI', 'Hardware', 'Software', 'Gadgets', 'Cybersecurity', 'Blockchain', 'IoT'],
        'DIY': ['Woodworking', 'Crafts', 'Home Improvement', 'Electronics', 'Gardening', 'Cooking', 'Fashion'],
        'Food': ['Cooking', 'Baking', 'Restaurant Reviews', 'Nutrition', 'Vegan', 'Desserts', 'Barbecue', 'Fast Food']
      };
      
      const channelNames = [
        'TechTalk Daily', 'Music Masters', 'Gaming Universe', 'Learn With Me', 
        'News Central', 'Sports Zone', 'Comedy Club', 'Science Explorers',
        'DIY Pro', 'Foodie Adventures', 'Creative Corner', 'Digital Dreams',
        'Artistic Flow', 'Business Insights', 'Health & Wellness', 'Travel Tales',
        'Fashion Forward', 'Car Enthusiasts', 'Movie Buffs', 'Book Lovers'
      ];
      
      const titleTemplates = [
        'The Ultimate Guide to {topic}',
        '{topic} Explained Simply',
        'Amazing {topic} Techniques Revealed',
        'Top 10 {topic} Tips You Need to Know',
        'How to Master {topic} in 30 Days',
        'The Science Behind {topic}',
        '{topic}: A Complete Beginner\'s Guide',
        'Advanced {topic} Strategies',
        'The Future of {topic}',
        '{topic} Secrets Professionals Use'
      ];
      
      const mockVideos = [];
      
      for (let i = 1; i <= 120; i++) {
        const category = categories[Math.floor(Math.random() * categories.length)];
        const subcategory = subcategories[category][Math.floor(Math.random() * subcategories[category].length)];
        const status = Math.random() > 0.6 ? 'watched' : (Math.random() > 0.7 ? 'saved' : 'unwatched');
        
        let duration;
        const durationType = Math.random();
        if (durationType < 0.3) {
          duration = Math.floor(Math.random() * 240) + 60;
        } else if (durationType < 0.8) {
          duration = Math.floor(Math.random() * 900) + 300;
        } else {
          duration = Math.floor(Math.random() * 2400) + 1200;
        }
        
        let views;
        const popularity = Math.random();
        if (popularity < 0.6) {
          views = Math.floor(Math.random() * 100000) + 1000;
        } else if (popularity < 0.9) {
          views = Math.floor(Math.random() * 900000) + 100000;
        } else {
          views = Math.floor(Math.random() * 9000000) + 1000000;
        }
        
        const likes = Math.floor(views * (Math.random() * 0.08 + 0.02));
        const channelIndex = Math.floor(Math.random() * channelNames.length);
        
        let uploadDate;
        const age = Math.random();
        if (age < 0.3) {
          uploadDate = Date.now() - (Math.random() * 7 * 24 * 60 * 60 * 1000);
        } else if (age < 0.7) {
          uploadDate = Date.now() - (Math.random() * 30 * 24 * 60 * 60 * 1000);
        } else if (age < 0.9) {
          uploadDate = Date.now() - (Math.random() * 90 * 24 * 60 * 60 * 1000);
        } else {
          uploadDate = Date.now() - (Math.random() * 365 * 24 * 60 * 60 * 1000);
        }
        
        const titleTemplate = titleTemplates[Math.floor(Math.random() * titleTemplates.length)];
        
        let columnType;
        if (status === 'saved') {
          columnType = 'watchlist';
        } else if (status === 'watched') {
          columnType = 'history';
        } else if (category === 'Tech' || category === 'Science' || category === 'Education') {
          columnType = 'learning';
        } else if (Math.random() > 0.7) {
          columnType = 'trending';
        } else {
          columnType = 'recommended';
        }
        
        mockVideos.push({
          id: i,
          title: titleTemplate.replace('{topic}', `${subcategory} ${category}`),
          subtitle: `${category}  ${subcategory}`,
          channel: {
            name: channelNames[channelIndex],
            id: `channel_${1000 + channelIndex}`,
            avatar: `https://i.pravatar.cc/150?img=${Math.floor(Math.random() * 70) + 1}`,
            verified: Math.random() > 0.5,
            subscribers: Math.floor(Math.random() * 1000000) + 1000
          },
          thumbnail: `https://picsum.photos/seed/${category}${i}/320/180?${Date.now()}`,
          duration: duration,
          uploadDate: uploadDate,
          views: views,
          likes: likes,
          comments: Math.floor(views * (Math.random() * 0.01 + 0.001)),
          category: category,
          subcategory: subcategory,
          tags: [category.toLowerCase(), subcategory.toLowerCase()],
          status: status,
          columnType: columnType,
          
          inScatter: Math.random() > 0.8,
          scatterPosition: { 
            x: Math.random() * 1200 + 100, 
            y: Math.random() * 800 + 100 
          },
          
          watched: status === 'watched',
          watchProgress: status === 'watched' ? Math.random() * 0.2 + 0.8 : (Math.random() > 0.7 ? Math.random() * 0.5 : 0),
          lastWatched: status === 'watched' ? Date.now() - (Math.random() * 30 * 24 * 60 * 60 * 1000) : null,
          watchCount: status === 'watched' ? Math.floor(Math.random() * 5) + 1 : 0,
          
          savedByUser: status === 'saved',
          likedByUser: Math.random() > 0.7,
          subscribedToChannel: Math.random() > 0.8,
          
          quality: ['360p', '480p', '720p', '1080p', '4K'][Math.floor(Math.random() * 5)],
          hasCaptions: Math.random() > 0.3,
          isLive: Math.random() > 0.9,
          isPremiere: Math.random() > 0.95,
          
          description: `In this video, we explore everything about ${subcategory} ${category}. Join us for an in-depth look at this fascinating topic.`
        });
      }
      
      mockVideos.slice(0, 15).forEach(video => {
        video.isTrending = true;
        video.trendingPosition = Math.floor(Math.random() * 15) + 1;
      });
      
      mockVideos.slice(15, 30).forEach(video => {
        video.isRecommended = true;
        video.recommendedReason = ['Based on your watch history', 'Popular in your region', 'Trending now'][Math.floor(Math.random() * 3)];
      });
      
      return mockVideos;
    }
    
    function generateMockCollections() {
      return [
        { 
          id: 1, 
          name: 'Watch Tonight', 
          description: 'Videos to watch later tonight',
          color: '#ff6b6b', 
          videoIds: Array.from({length: 8}, (_, i) => i + 1),
          layout: 'grid',
          createdAt: Date.now() - (7 * 24 * 60 * 60 * 1000),
          updatedAt: Date.now() - (2 * 24 * 60 * 60 * 1000),
          isPrivate: false,
          coverImage: 'https://picsum.photos/seed/watchtonight/400/225'
        },
        { 
          id: 2, 
          name: 'Learning Queue', 
          description: 'Educational content to learn from',
          color: '#4ecdc4', 
          videoIds: Array.from({length: 12}, (_, i) => i + 20),
          layout: 'cascade',
          createdAt: Date.now() - (14 * 24 * 60 * 60 * 1000),
          updatedAt: Date.now() - (1 * 24 * 60 * 60 * 1000),
          isPrivate: false,
          coverImage: 'https://picsum.photos/seed/learning/400/225'
        }
      ];
    }
    
    function initScatterCollections() {
      scatterCollections = [
        {
          id: 'learning',
          name: 'Learning Queue',
          color: '#3b82f6',
          position: { x: 100, y: 100 },
          videos: []
        },
        {
          id: 'inspiration',
          name: 'Inspiration',
          color: '#22c55e',
          position: { x: 400, y: 100 },
          videos: []
        },
        {
          id: 'watch-tonight',
          name: 'Watch Tonight',
          color: '#ef4444',
          position: { x: 700, y: 100 },
          videos: []
        }
      ];
    }
    
    // ====== INITIALIZATION ======
    function init() {
      detectMobile();
      videos = generateMockVideos();
      collections = generateMockCollections();
      initScatterCollections();
      loadState();
      
      // Set default kanban view mode for mobile
      if (isMobile && (!config.kanbanViewMode || config.kanbanViewMode === 'columns')) {
        config.kanbanViewMode = 'rows';
      }
      
      renderCategories();
      renderCurrentView();
      setupEventListeners();
      setupTouchGestures();
      
      updateScatterBadge();
      window.addEventListener('resize', handleResize);
    }
    
    function setupEventListeners() {
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        
        switch(e.key.toLowerCase()) {
          case 'f': switchMode('feed'); break;
          case 'l': switchMode('list'); break;
          case 's': switchMode('scatter'); break;
          case 'c': switchMode('columns'); break;
          case 'h': switchMode('history'); break;
          case '/': 
            e.preventDefault(); 
            toggleSearchOverlay();
            break;
          case 'escape': 
            closeSearchOverlay();
            closeAllOverlays(); 
            break;
        }
      });
      
      document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(e);
      });
      
      document.addEventListener('click', () => {
        document.getElementById('contextMenu').classList.remove('active');
      });
      
      document.addEventListener('click', (e) => {
        const searchOverlay = document.getElementById('searchOverlay');
        const searchBtn = document.querySelector('.nav-btn[data-mode="search"]');
        
        if (searchOverlay.classList.contains('active') && 
            !searchOverlay.contains(e.target) && 
            e.target !== searchBtn && 
            !searchBtn.contains(e.target)) {
          closeSearchOverlay();
        }
      });
      
      if (isMobile) {
        setupMobileTouchListeners();
      }
      
      // Scatter canvas pan and zoom setup
      setupScatterCanvas();
    }
    
    function handleResize() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        detectMobile();
        renderCurrentView();
      }, 250);
    }
    
    // ====== VIEW MANAGEMENT ======
    function switchMode(mode) {
      if (mode === 'search') {
        toggleSearchOverlay();
        return;
      }
      
      if (mode === 'scatter') {
        openScatterView();
        return;
      }
      
      if (config.currentView === 'scatter') {
        cleanupScatterListeners();
      }
      
      config.currentView = mode;
      
      // Update navigation buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const activeBtn = document.querySelector(`.nav-btn[data-mode="${mode}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
      }
      
      renderCurrentView();
      saveState();
    }
    
    function renderCurrentView() {
      // Hide all view containers
      const viewContainers = document.querySelectorAll('.view-container');
      viewContainers.forEach(container => {
        container.classList.remove('active');
      });
      
      // Show current view container
      switch(config.currentView) {
        case 'feed':
          document.getElementById('gridContainer').classList.add('active');
          renderGridView();
          break;
        case 'list':
          document.getElementById('listContainer').classList.add('active');
          renderListView();
          break;
        case 'scatter':
          document.getElementById('scatterContainer').classList.add('active');
          renderScatterView();
          break;
        case 'history':
          document.getElementById('historyContainer').classList.add('active');
          renderHistoryView();
          break;
        case 'columns':
          document.getElementById('columnsContainer').classList.add('active');
          renderColumnsView();
          break;
      }
    }
    
    // ====== CATEGORY FILTERING ======
    function renderCategories() {
      const categories = ['all', ...new Set(videos.map(v => v.category))];
      const categoryBar = document.getElementById('categoryBar');
      
      categoryBar.innerHTML = categories.map(cat => `
        <div class="pill ${config.currentCategory === cat ? 'active' : ''}"
             onclick="selectCategory('${cat}')">
          ${cat === 'all' ? 'All' : cat}
        </div>
      `).join('') + '<div class="pill add-btn" onclick="addCustomCategory()">+ Custom</div>';
    }
    
    function selectCategory(category) {
      config.currentCategory = category;
      renderCategories();
      renderCurrentView();
      saveState();
    }
    
    function filterVideos() {
      let filtered = videos;
      
      if (config.currentCategory !== 'all') {
        filtered = filtered.filter(v => v.category === config.currentCategory);
      }
      
      if (config.searchQuery) {
        filtered = filtered.filter(v =>
          v.title.toLowerCase().includes(config.searchQuery.toLowerCase()) ||
          v.channel.name.toLowerCase().includes(config.searchQuery.toLowerCase())
        );
      }
      
      return filtered;
    }
    
    // ====== GRID VIEW (FEED) ======
    function renderGridView() {
      const wrapper = document.getElementById('gridWrapper');
      if (!wrapper) return;
      
      const filtered = filterVideos();
      
      wrapper.innerHTML = filtered.map(video => createVideoCard(video)).join('');
    }
    
    function createVideoCard(video) {
      const duration = formatDuration(video.duration);
      const views = formatViews(video.views);
      
      return `
        <div class="video-card" 
             data-video-id="${video.id}" 
             role="button"
             tabindex="0"
             aria-label="Video: ${video.title}, Channel: ${video.channel.name}, Duration: ${duration}"
             onkeydown="if(event.key === 'Enter') openVideoDetail(${video.id})"
             oncontextmenu="showVideoContextMenu(event, ${video.id})">
          <div class="video-thumbnail">
            <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
            <div class="video-duration">${duration}</div>
            <div class="video-status status-${video.status}">${video.status.replace('-', ' ')}</div>
          </div>
          <div class="video-info">
            <div class="video-title">${video.title}</div>
            <div class="video-channel">
              <div class="channel-avatar">
                <img src="${video.channel.avatar}" alt="${video.channel.name}" width="24" height="24">
              </div>
              <span>${video.channel.name}</span>
            </div>
            <div class="video-meta">
              <span class="video-views">${views} views</span>
              <div class="video-actions">
                <button class="action-icon" onclick="toggleSave(${video.id}); event.stopPropagation();" title="Save">
                  ${video.status === 'saved' ? '' : ''}
                </button>
                <button class="action-icon" onclick="shareVideo(${video.id}); event.stopPropagation();" title="Share">
                  
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // ====== LIST VIEW ======
    function renderListView() {
      const wrapper = document.getElementById('listViewWrapper');
      if (!wrapper) return;
      
      const filtered = filterVideos();
      
      wrapper.innerHTML = `
        <div class="list-view-header">
          <h3>All Videos (${filtered.length})</h3>
          <div class="list-view-sort">
            <select id="listSortSelect" onchange="sortListView(this.value)">
              <option value="title">Sort by Title</option>
              <option value="date">Sort by Date</option>
              <option value="views">Sort by Views</option>
              <option value="duration">Sort by Duration</option>
            </select>
          </div>
        </div>
        
        <div class="list-view-content" id="listViewContent">
          <!-- Videos will be loaded here -->
        </div>
        
        <div class="list-view-pagination">
          <button class="pagination-btn" onclick="loadMoreListItems()">
            Load More Videos
          </button>
        </div>
      `;
      
      loadListViewItems();
    }
    
    function loadListViewItems() {
      const content = document.getElementById('listViewContent');
      if (!content) return;
      
      const filtered = filterVideos();
      
      content.innerHTML = filtered.map(video => `
        <div class="list-view-item" data-video-id="${video.id}" onclick="openVideoDetail(${video.id})">
          <div class="list-item-thumbnail">
            <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
            <div class="list-item-duration">${formatDuration(video.duration)}</div>
          </div>
          <div class="list-item-info">
            <div class="list-item-title">${video.title}</div>
            <div class="list-item-channel">
              <img src="${video.channel.avatar}" alt="${video.channel.name}" class="list-item-avatar">
              <span>${video.channel.name}</span>
              ${video.channel.verified ? '<span class="verified-badge"></span>' : ''}
            </div>
            <div class="list-item-description">${video.description.substring(0, 100)}...</div>
            <div class="list-item-meta">
              <span>${formatViews(video.views)} views</span>
              <span></span>
              <span>${formatDate(video.uploadDate)}</span>
              <span></span>
              <span>${video.category}</span>
              <span></span>
              <span>${formatDuration(video.duration)}</span>
            </div>
          </div>
          <div class="list-item-actions">
            <button class="list-action-btn" onclick="toggleSave(${video.id}); event.stopPropagation();">
              ${video.status === 'saved' ? '' : ''}
            </button>
            <button class="list-action-btn" onclick="shareVideo(${video.id}); event.stopPropagation();">
              
            </button>
          </div>
        </div>
      `).join('');
    }
    
    function sortListView(sortBy) {
      switch(sortBy) {
        case 'title':
          videos.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'date':
          videos.sort((a, b) => b.uploadDate - a.uploadDate);
          break;
        case 'views':
          videos.sort((a, b) => b.views - a.views);
          break;
        case 'duration':
          videos.sort((a, b) => b.duration - a.duration);
          break;
      }
      
      loadListViewItems();
      showToast(`Sorted by ${sortBy}`);
    }
    
    function loadMoreListItems() {
      showToast('Loading more videos...', 'info');
      setTimeout(() => {
        showToast('More videos loaded!', 'success');
      }, 1000);
    }
    
    // ====== KANBAN/COLUMN VIEW ======
    function renderColumnsView() {
      const columnsContainer = document.getElementById('columnsContainer');
      
      // Add toggle button for columns/rows
      columnsContainer.innerHTML = `
        <div class="kanban-toggle" style="display: flex; justify-content: flex-end; padding: 16px 20px; border-bottom: 1px solid var(--glass-border);">
          <button class="toggle-layout-btn" onclick="toggleKanbanLayout()" style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 8px 16px; color: var(--ink); cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px;">
            <span id="layoutIcon">${config.kanbanViewMode === 'columns' ? '' : ''}</span>
            <span>Switch to ${config.kanbanViewMode === 'columns' ? 'Rows' : 'Columns'}</span>
          </button>
        </div>
        <div id="kanbanContent" style="flex: 1; overflow: auto;">
          <!-- Content will be rendered here -->
        </div>
      `;
      
      renderKanbanContent();
    }
    
    function renderKanbanContent() {
      const content = document.getElementById('kanbanContent');
      if (!content) return;
      
      if (config.kanbanViewMode === 'columns') {
        renderKanbanColumns(content);
      } else {
        renderKanbanRows(content);
      }
    }
    
    function renderKanbanColumns(container) {
      container.innerHTML = `
        <div class="kanban-view" style="display: flex; width: 100%; height: 100%; overflow-x: auto;">
          <div class="column" id="recommendedColumn" style="min-width: 300px; border-right: 1px solid var(--glass-border);">
            <div class="column-header">
              <div class="column-title"> Recommended</div>
              <div class="column-count" id="recommendedCount">0</div>
            </div>
            <div class="column-content" id="recommendedContent" style="overflow-y: auto; height: calc(100% - 60px);">
              <!-- Videos will be loaded here -->
            </div>
          </div>
          
          <div class="column" id="trendingColumn" style="min-width: 300px; border-right: 1px solid var(--glass-border);">
            <div class="column-header">
              <div class="column-title"> Trending</div>
              <div class="column-count" id="trendingCount">0</div>
            </div>
            <div class="column-content" id="trendingContent" style="overflow-y: auto; height: calc(100% - 60px);">
              <!-- Videos will be loaded here -->
            </div>
          </div>
          
          <div class="column" id="learningColumn" style="min-width: 300px; border-right: 1px solid var(--glass-border);">
            <div class="column-header">
              <div class="column-title"> Learning</div>
              <div class="column-count" id="learningCount">0</div>
            </div>
            <div class="column-content" id="learningContent" style="overflow-y: auto; height: calc(100% - 60px);">
              <!-- Videos will be loaded here -->
            </div>
          </div>
          
          <div class="column" id="watchlistColumn" style="min-width: 300px; border-right: 1px solid var(--glass-border);">
            <div class="column-header">
              <div class="column-title"> Watchlist</div>
              <div class="column-count" id="watchlistCount">0</div>
            </div>
            <div class="column-content" id="watchlistContent" style="overflow-y: auto; height: calc(100% - 60px);">
              <!-- Videos will be loaded here -->
            </div>
          </div>
          
          <div class="column" id="historyColumn" style="min-width: 300px;">
            <div class="column-header">
              <div class="column-title"> History</div>
              <div class="column-count" id="historyCount">0</div>
            </div>
            <div class="column-content" id="historyContent" style="overflow-y: auto; height: calc(100% - 60px);">
              <!-- Videos will be loaded here -->
            </div>
          </div>
        </div>
      `;
      
      populateColumn('recommended', 'Recommended for you');
      populateColumn('trending', 'Trending now');
      populateColumn('learning', 'Educational content');
      populateColumn('watchlist', 'Your saved videos');
      populateColumn('history', 'Recently watched');
      setupColumnScrolling();
    }
    
    function renderKanbanRows(container) {
      container.innerHTML = `
        <div class="kanban-rows" style="padding: 20px; display: flex; flex-direction: column; gap: 24px;">
          <div class="kanban-row" id="recommendedRow">
            <div class="row-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--glass-border);">
              <div class="row-title" style="font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                 Recommended
                <span class="row-count" id="recommendedRowCount" style="font-size: 12px; color: var(--ink-dim);">0</span>
              </div>
              <button class="row-expand" onclick="expandRow('recommended')" style="background: transparent; border: none; color: var(--ink-dim); cursor: pointer; font-size: 20px;">
                
              </button>
            </div>
            <div class="row-content" id="recommendedRowContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
              <!-- Videos will be loaded here -->
            </div>
          </div>
          
          <div class="kanban-row" id="trendingRow">
            <div class="row-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--glass-border);">
              <div class="row-title" style="font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                 Trending
                <span class="row-count" id="trendingRowCount" style="font-size: 12px; color: var(--ink-dim);">0</span>
              </div>
              <button class="row-expand" onclick="expandRow('trending')" style="background: transparent; border: none; color: var(--ink-dim); cursor: pointer; font-size: 20px;">
                
              </button>
            </div>
            <div class="row-content" id="trendingRowContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
              <!-- Videos will be loaded here -->
            </div>
          </div>
          
          <div class="kanban-row" id="learningRow">
            <div class="row-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--glass-border);">
              <div class="row-title" style="font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                 Learning
                <span class="row-count" id="learningRowCount" style="font-size: 12px; color: var(--ink-dim);">0</span>
              </div>
              <button class="row-expand" onclick="expandRow('learning')" style="background: transparent; border: none; color: var(--ink-dim); cursor: pointer; font-size: 20px;">
                
              </button>
            </div>
            <div class="row-content" id="learningRowContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
              <!-- Videos will be loaded here -->
            </div>
          </div>
          
          <div class="kanban-row" id="watchlistRow">
            <div class="row-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--glass-border);">
              <div class="row-title" style="font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                 Watchlist
                <span class="row-count" id="watchlistRowCount" style="font-size: 12px; color: var(--ink-dim);">0</span>
              </div>
              <button class="row-expand" onclick="expandRow('watchlist')" style="background: transparent; border: none; color: var(--ink-dim); cursor: pointer; font-size: 20px;">
                
              </button>
            </div>
            <div class="row-content" id="watchlistRowContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
              <!-- Videos will be loaded here -->
            </div>
          </div>
          
          <div class="kanban-row" id="historyRow">
            <div class="row-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--glass-border);">
              <div class="row-title" style="font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                 History
                <span class="row-count" id="historyRowCount" style="font-size: 12px; color: var(--ink-dim);">0</span>
              </div>
              <button class="row-expand" onclick="expandRow('history')" style="background: transparent; border: none; color: var(--ink-dim); cursor: pointer; font-size: 20px;">
                
              </button>
            </div>
            <div class="row-content" id="historyRowContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
              <!-- Videos will be loaded here -->
            </div>
          </div>
        </div>
      `;
      
      populateRow('recommended', 'Recommended for you');
      populateRow('trending', 'Trending now');
      populateRow('learning', 'Educational content');
      populateRow('watchlist', 'Your saved videos');
      populateRow('history', 'Recently watched');
    }
    
    function toggleKanbanLayout() {
      config.kanbanViewMode = config.kanbanViewMode === 'columns' ? 'rows' : 'columns';
      renderKanbanContent();
      updateLayoutToggleButton();
      saveState();
      showToast(`Switched to ${config.kanbanViewMode} layout`);
    }
    
    function updateLayoutToggleButton() {
      const layoutIcon = document.getElementById('layoutIcon');
      const toggleBtn = document.querySelector('.toggle-layout-btn span:last-child');
      
      if (layoutIcon) {
        layoutIcon.textContent = config.kanbanViewMode === 'columns' ? '' : '';
      }
      
      if (toggleBtn) {
        toggleBtn.textContent = `Switch to ${config.kanbanViewMode === 'columns' ? 'Rows' : 'Columns'}`;
      }
    }
    
    // ====== SEARCH OVERLAY FUNCTIONS ======
    function toggleSearchOverlay() {
      const searchOverlay = document.getElementById('searchOverlay');
      const isActive = searchOverlay.classList.toggle('active');
      
      if (isActive) {
        document.body.classList.add('search-active');
        document.getElementById('mainSearchInput').focus();
        document.getElementById('discoverySections').style.display = 'block';
        document.getElementById('searchResults').style.display = 'none';
      } else {
        document.body.classList.remove('search-active');
        document.getElementById('mainSearchInput').value = '';
        config.searchQuery = '';
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('discoverySections').style.display = 'block';
      }
    }
    
    function closeSearchOverlay() {
      const overlay = document.getElementById('searchOverlay');
      overlay.classList.remove('active');
      document.getElementById('mainSearchInput').value = '';
      config.searchQuery = '';
      document.body.classList.remove('search-active');
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('discoverySections').style.display = 'block';
    }
    
    function showSearchResults(query) {
      const resultsGrid = document.getElementById('searchResultsGrid');
      const recommendedGrid = document.getElementById('recommendedGrid');
      const discoverySections = document.getElementById('discoverySections');
      const searchResults = document.getElementById('searchResults');
      
      if (!query.trim()) {
        if (discoverySections) discoverySections.style.display = 'block';
        if (searchResults) searchResults.style.display = 'none';
        return;
      }
      
      const searchResultsVideos = videos.filter(v =>
        v.title.toLowerCase().includes(query.toLowerCase()) ||
        v.channel.name.toLowerCase().includes(query.toLowerCase()) ||
        v.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
      ).slice(0, 12);
      
      const recommendedVideos = videos
        .filter(v => !searchResultsVideos.some(r => r.id === v.id))
        .slice(0, 8);
      
      if (resultsGrid) {
        resultsGrid.innerHTML = searchResultsVideos.map((video, index) => {
          const size = index % 4 === 0 ? 'large' : (index % 3 === 0 ? 'medium' : 'small');
          return `
            <div class="bento-item ${size}" onclick="openVideoDetail(${video.id})">
              <div style="display: flex; gap: 12px; height: 100%;">
                <img src="${video.thumbnail}" alt="${video.title}" 
                     style="width: ${size === 'large' ? '120px' : '80px'}; 
                            height: ${size === 'large' ? '80px' : '60px'};
                            border-radius: 8px; object-fit: cover;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; margin-bottom: 4px; font-size: ${size === 'large' ? '16px' : '14px'}">
                    ${video.title.substring(0, size === 'large' ? 60 : 40)}...
                  </div>
                  <div style="font-size: 12px; color: var(--ink-dim);">
                    ${video.channel.name}  ${formatViews(video.views)} views
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      if (recommendedGrid) {
        recommendedGrid.innerHTML = recommendedVideos.map((video, index) => {
          const size = index % 4 === 0 ? 'large' : 'small';
          return `
            <div class="bento-item ${size}" onclick="openVideoDetail(${video.id})">
              <div style="font-weight: 600; margin-bottom: 8px;">${video.title.substring(0, 50)}...</div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <img src="${video.channel.avatar}" alt="${video.channel.name}" 
                     style="width: 24px; height: 24px; border-radius: 50%;">
                <span style="font-size: 12px; color: var(--ink-dim);">${video.channel.name}</span>
              </div>
            </div>
          `;
        }).join('');
      }
      
      if (discoverySections) discoverySections.style.display = 'none';
      if (searchResults) searchResults.style.display = 'block';
      
      const searchContainer = document.querySelector('.search-container');
      if (searchContainer) {
        searchContainer.scrollTop = 0;
      }
    }
    
    function updateSearchSuggestions(query) {
      if (query.length > 0) {
        showSearchResults(query);
      } else {
        const discoverySections = document.getElementById('discoverySections');
        const searchResults = document.getElementById('searchResults');
        
        if (discoverySections) discoverySections.style.display = 'block';
        if (searchResults) searchResults.style.display = 'none';
      }
    }
    
    function searchFor(term) {
      document.getElementById('mainSearchInput').value = term;
      updateSearchSuggestions(term);
      showSearchResults(term);
    }
    
    function startVoiceSearch() {
      showToast('Voice search activated - say your query', 'info');
    }
    
    // ====== COLUMN FUNCTIONS ======
    function populateColumn(columnType, fallbackTitle) {
      const columnContent = document.getElementById(`${columnType}Content`);
      const columnCount = document.getElementById(`${columnType}Count`);
      
      if (!columnContent) return;
      
      let columnVideos = getVideosByCategory(columnType);
      
      if (columnCount) {
        columnCount.textContent = columnVideos.length;
      }
      
      if (columnVideos.length > 0) {
        columnContent.innerHTML = columnVideos.map(video => `
          <div class="column-video-card" data-video-id="${video.id}" onclick="openVideoDetail(${video.id})" style="display: flex; gap: 12px; padding: 12px; border-bottom: 1px solid var(--glass-border); cursor: pointer; transition: background 0.2s;">
            <div class="column-video-thumbnail" style="width: 80px; height: 45px; border-radius: 4px; overflow: hidden; flex-shrink: 0; position: relative;">
              <img src="${video.thumbnail}" alt="${video.title}" loading="lazy" style="width: 100%; height: 100%; object-fit: cover;">
              <div class="column-video-duration" style="position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 2px 4px; border-radius: 2px; font-size: 10px; bottom: 4px; right: 4px;">${formatDuration(video.duration)}</div>
            </div>
            <div class="column-video-info" style="flex: 1; min-width: 0;">
              <div class="column-video-title" style="font-weight: 600; font-size: 12px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${video.title}</div>
              <div class="column-video-channel" style="font-size: 11px; color: var(--ink-dim); margin-bottom: 4px;">${video.channel.name}</div>
              <div class="column-video-meta" style="font-size: 10px; color: var(--ink-dim); display: flex; gap: 4px;">
                <span>${formatViews(video.views)} views</span>
                <span></span>
                <span>${formatDate(video.uploadDate)}</span>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        columnContent.innerHTML = `
          <div class="empty-column-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center; color: var(--ink-dim);">
            <div class="empty-icon" style="font-size: 48px; margin-bottom: 16px;">${getColumnIcon(columnType)}</div>
            <p style="margin-bottom: 16px;">No ${fallbackTitle.toLowerCase()} yet</p>
            <button class="btn-secondary" onclick="discoverMore('${columnType}')" style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 8px 16px; color: var(--ink); cursor: pointer; transition: all 0.2s;">
              Discover ${fallbackTitle}
            </button>
          </div>
        `;
      }
    }
    
    function populateRow(rowType, fallbackTitle) {
      const rowContent = document.getElementById(`${rowType}RowContent`);
      const rowCount = document.getElementById(`${rowType}RowCount`);
      
      if (!rowContent) return;
      
      let rowVideos = getVideosByCategory(rowType);
      
      if (rowCount) {
        rowCount.textContent = rowVideos.length;
      }
      
      if (rowVideos.length > 0) {
        rowContent.innerHTML = rowVideos.map(video => `
          <div class="row-video-card" data-video-id="${video.id}" onclick="openVideoDetail(${video.id})" style="background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s;">
            <div class="row-video-thumbnail" style="width: 100%; padding-bottom: 56.25%; position: relative; background: #1a1a1a;">
              <img src="${video.thumbnail}" alt="${video.title}" loading="lazy" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
              <div class="row-video-duration" style="position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.8); color: white; padding: 2px 4px; border-radius: 2px; font-size: 10px; font-family: var(--font-mono);">${formatDuration(video.duration)}</div>
            </div>
            <div class="row-video-info" style="padding: 8px;">
              <div class="row-video-title" style="font-weight: 600; font-size: 12px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${video.title}</div>
              <div class="row-video-channel" style="font-size: 10px; color: var(--ink-dim);">${video.channel.name}</div>
            </div>
          </div>
        `).join('');
      } else {
        rowContent.innerHTML = `
          <div class="empty-row-state" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--ink-dim);">
            <div style="font-size: 32px; margin-bottom: 12px;">${getColumnIcon(rowType)}</div>
            <p style="margin-bottom: 16px;">No ${fallbackTitle.toLowerCase()} yet</p>
            <button class="btn-secondary" onclick="discoverMore('${rowType}')" style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 8px 16px; color: var(--ink); cursor: pointer; font-size: 12px;">
              Discover ${fallbackTitle}
            </button>
          </div>
        `;
      }
    }
    
    function getVideosByCategory(category) {
      switch(category) {
        case 'recommended':
          return videos.filter(v => 
            v.columnType === 'recommended' || 
            (v.isRecommended && !v.watched)
          ).slice(0, 15);
        case 'trending':
          return videos.filter(v => 
            v.columnType === 'trending' || 
            v.isTrending
          ).sort((a, b) => b.views - a.views).slice(0, 12);
        case 'learning':
          return videos.filter(v => 
            v.columnType === 'learning' || 
            ['Education', 'Science', 'Tech'].includes(v.category)
          ).slice(0, 10);
        case 'watchlist':
          return videos.filter(v => 
            v.columnType === 'watchlist' || 
            v.status === 'saved'
          ).slice(0, 8);
        case 'history':
          return videos.filter(v => 
            v.columnType === 'history' || 
            v.watched
          ).sort((a, b) => (b.lastWatched || 0) - (a.lastWatched || 0)).slice(0, 10);
        default:
          return videos.slice(0, 8);
      }
    }
    
    function getColumnIcon(columnType) {
      const icons = {
        'recommended': '',
        'trending': '',
        'learning': '',
        'watchlist': '',
        'history': ''
      };
      return icons[columnType] || '';
    }
    
    function expandRow(rowType) {
      showToast(`Expanding ${rowType} row...`, 'info');
    }
    
    function discoverMore(category) {
      switch(category) {
        case 'trending':
          searchFor('trending videos');
          break;
        case 'learning':
          searchFor('educational content');
          break;
        default:
          searchFor(category);
      }
    }
    
    // ====== COLUMN SCROLLING SETUP ======
    function setupColumnScrolling() {
      const columnContents = document.querySelectorAll('.column-content');
      
      columnContents.forEach(content => {
        content.removeEventListener('wheel', handleColumnScroll);
        content.addEventListener('wheel', handleColumnScroll, { passive: false });
        
        content.removeEventListener('touchstart', startColumnTouchScroll);
        content.removeEventListener('touchmove', handleColumnTouchScroll);
        content.removeEventListener('touchend', endColumnTouchScroll);
        
        content.addEventListener('touchstart', startColumnTouchScroll, { passive: true });
        content.addEventListener('touchmove', handleColumnTouchScroll, { passive: false });
        content.addEventListener('touchend', endColumnTouchScroll, { passive: true });
      });
    }
    
    function handleColumnScroll(e) {
      e.preventDefault();
      const content = e.currentTarget;
      const scrollAmount = e.deltaY > 0 ? 100 : -100;
      
      content.scrollBy({
        top: scrollAmount,
        behavior: 'smooth'
      });
    }
    
    function startColumnTouchScroll(e) {
      columnTouchStartY = e.touches[0].clientY;
      columnTouchScrollElement = e.currentTarget;
    }
    
    function handleColumnTouchScroll(e) {
      if (!columnTouchScrollElement) return;
      
      e.preventDefault();
      const touchY = e.touches[0].clientY;
      const deltaY = columnTouchStartY - touchY;
      
      columnTouchScrollElement.scrollTop += deltaY * 1.5;
      columnTouchStartY = touchY;
    }
    
    function endColumnTouchScroll() {
      columnTouchScrollElement = null;
    }
    
    // ====== HISTORY VIEW ======
    function renderHistoryView() {
      const tbody = document.getElementById('historyBody');
      if (!tbody) return;
      
      const historyVideos = videos.filter(v => v.lastWatched).sort((a, b) => b.lastWatched - a.lastWatched);
      
      tbody.innerHTML = historyVideos.map(video => `
        <tr onclick="openVideoDetail(${video.id})" style="cursor: pointer; transition: background 0.2s;">
          <td><img src="${video.thumbnail}" alt="${video.title}" class="list-thumbnail"></td>
          <td>${video.title}</td>
          <td>${video.channel.name}</td>
          <td>${formatDuration(video.duration)}</td>
          <td>${formatViews(video.views)}</td>
          <td>${formatDate(video.lastWatched)}</td>
        </tr>
      `).join('');
    }
    
    // ====== SCATTER VIEW ======
    function renderScatterView() {
      const filtered = getFilteredScatterVideos();
      renderScatter(filtered);
      updateScatterInfo();
      setupScatterCanvas();
    }
    
    function getFilteredScatterVideos() {
      let filtered = videos.filter(v => v.inScatter);
      
      if (scatterSearchQuery) {
        filtered = filtered.filter(v =>
          v.title.toLowerCase().includes(scatterSearchQuery.toLowerCase()) ||
          v.channel.name.toLowerCase().includes(scatterSearchQuery.toLowerCase()) ||
          v.category.toLowerCase().includes(scatterSearchQuery.toLowerCase())
        );
      }
      
      return filtered;
    }
    
    function filterScatterVideos(query) {
      scatterSearchQuery = query;
      renderScatterView();
    }
    
    function renderScatter(filtered) {
      const canvas = document.getElementById('scatterCanvas');
      if (!canvas) return;
      
      canvas.innerHTML = '';
      
      filtered.forEach(video => {
        const card = createScatterCard(video);
        canvas.appendChild(card);
      });
      
      // Apply filtering dimming
      const allCards = canvas.querySelectorAll('.scatter-card');
      const allVideos = [...videos];
      
      allCards.forEach(card => {
        const videoId = card.dataset.videoId;
        if (filtered.some(v => v.id === videoId)) {
          card.classList.remove('dimmed');
        } else {
          card.classList.add('dimmed');
        }
      });
      
      applyScatterTransform();
    }
    
    function createScatterCard(video) {
      const card = document.createElement('div');
      card.className = 'scatter-card';
      card.style.left = `${video.scatterPosition.x}px`;
      card.style.top = `${video.scatterPosition.y}px`;
      card.dataset.videoId = video.id;
      
      // Add status indicator
      let statusColor;
      switch(video.status) {
        case 'saved': statusColor = 'var(--accent)'; break;
        case 'watched': statusColor = 'var(--neon-green)'; break;
        case 'in-progress': statusColor = 'var(--neon-orange)'; break;
        default: statusColor = 'var(--neon-blue)';
      }
      
      card.innerHTML = `
        <div class="scatter-thumbnail">
          <img src="${video.thumbnail}" alt="${video.title}">
          <div style="position: absolute; top: 4px; left: 4px; width: 8px; height: 8px; border-radius: 50%; background: ${statusColor};"></div>
        </div>
        <div class="video-title" style="font-size: 12px; font-weight: 600;">${video.title.substring(0, 30)}...</div>
        <div class="video-channel" style="font-size: 11px; color: var(--ink-dim);">${video.channel.name}</div>
        <div class="video-duration" style="font-size: 11px; font-family: var(--font-mono); color: var(--ink-dim);">${formatDuration(video.duration)}</div>
      `;
      
      // Add drag and touch handlers
      card.addEventListener('pointerdown', (e) => startScatterDrag(e, card));
      card.addEventListener('dblclick', () => openVideoDetail(video.id));
      card.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showVideoContextMenu(e, video.id);
      });
      
      return card;
    }
    
    function cleanupScatterListeners() {
      const canvas = document.getElementById('scatterCanvas');
      if (canvas) {
        canvas.innerHTML = '';
      }
      stopScatterDragging();
    }
    
    function openScatterView() {
      config.currentView = 'scatter';
      
      // Hide all view containers
      const viewContainers = document.querySelectorAll('.view-container');
      viewContainers.forEach(container => {
        container.classList.remove('active');
      });
      
      // Show scatter container
      const scatterContainer = document.getElementById('scatterContainer');
      scatterContainer.classList.add('active');
      
      renderScatterView();
      updateNavButtons();
      
      if (isFirstScatterVisit()) {
        showScatterWelcome();
      }
    }
    
    // ====== SCATTER ARRANGEMENTS ======
    function collectNodes() {
      const filtered = getFilteredScatterVideos();
      const canvas = document.getElementById('scatterCanvas');
      const viewportWidth = canvas.clientWidth;
      const viewportHeight = canvas.clientHeight;
      
      const isMobileView = isMobile || window.innerWidth <= 768;
      const columns = isMobileView ? 2 : 5;
      const rows = Math.ceil(filtered.length / columns);
      
      const cardWidth = isMobileView ? 160 : 200;
      const cardHeight = isMobileView ? 120 : 150;
      const horizontalPadding = isMobileView ? 20 : 50;
      const verticalPadding = isMobileView ? 20 : 100;
      
      const gridWidth = columns * cardWidth + (columns - 1) * horizontalPadding;
      const gridHeight = rows * cardHeight + (rows - 1) * verticalPadding;
      
      const startX = (viewportWidth - gridWidth) / 2;
      const startY = (viewportHeight - gridHeight) / 2;
      
      filtered.forEach((video, index) => {
        const row = Math.floor(index / columns);
        const col = index % columns;
        
        const x = startX + col * (cardWidth + horizontalPadding);
        const y = startY + row * (cardHeight + verticalPadding);
        
        video.scatterPosition = { x, y };
      });
      
      fitToBounds();
      renderScatter(filtered);
      saveState();
      showToast('Arranged as grid');
    }
    
    function cascadeNodes() {
      const filtered = getFilteredScatterVideos();
      const canvas = document.getElementById('scatterCanvas');
      const viewportWidth = canvas.clientWidth;
      const viewportHeight = canvas.clientHeight;
      
      const isMobileView = isMobile || window.innerWidth <= 768;
      const maxCardsPerColumn = isMobileView ? 8 : 15;
      const cardWidth = isMobileView ? 160 : 200;
      const cardHeight = isMobileView ? 120 : 150;
      const offset = isMobileView ? 15 : 20;
      
      const columns = Math.ceil(filtered.length / maxCardsPerColumn);
      const totalWidth = columns * cardWidth + (columns - 1) * offset;
      const startX = (viewportWidth - totalWidth) / 2;
      const startY = (viewportHeight - Math.min(filtered.length, maxCardsPerColumn) * offset) / 2;
      
      filtered.forEach((video, index) => {
        const column = Math.floor(index / maxCardsPerColumn);
        const positionInColumn = index % maxCardsPerColumn;
        
        const x = startX + column * (cardWidth + offset);
        const y = startY + positionInColumn * offset;
        
        video.scatterPosition = { x, y };
      });
      
      fitToBounds();
      renderScatter(filtered);
      saveState();
      showToast('Arranged as cascade');
    }
    
    function spreadNodes() {
      const filtered = getFilteredScatterVideos();
      const canvas = document.getElementById('scatterCanvas');
      const viewportWidth = canvas.clientWidth;
      const viewportHeight = canvas.clientHeight;
      
      filtered.forEach(video => {
        const x = Math.random() * (viewportWidth - 200) + 50;
        const y = Math.random() * (viewportHeight - 150) + 50;
        video.scatterPosition = { x, y };
      });
      
      fitToBounds();
      renderScatter(filtered);
      saveState();
      showToast('Spread randomly');
    }
    
    function fitToBounds() {
      const filtered = getFilteredScatterVideos();
      if (filtered.length === 0) return;
      
      const canvas = document.getElementById('scatterCanvas');
      const bounds = { minX: Infinity, minY: Infinity, maxX: -Infinity, maxY: -Infinity };
      
      filtered.forEach(video => {
        bounds.minX = Math.min(bounds.minX, video.scatterPosition.x);
        bounds.minY = Math.min(bounds.minY, video.scatterPosition.y);
        bounds.maxX = Math.max(bounds.maxX, video.scatterPosition.x + 200);
        bounds.maxY = Math.max(bounds.maxY, video.scatterPosition.y + 150);
      });
      
      const contentW = bounds.maxX - bounds.minX;
      const contentH = bounds.maxY - bounds.minY;
      
      const vpW = canvas.clientWidth;
      const vpH = canvas.clientHeight;
      
      const scaleX = vpW / contentW;
      const scaleY = vpH / contentH;
      const newScale = Math.min(scaleX, scaleY, 1) * 0.9;
      
      scatter.transform.scale = newScale;
      
      const centerX = (vpW - contentW * newScale) / 2 - bounds.minX * newScale;
      const centerY = (vpH - contentH * newScale) / 2 - bounds.minY * newScale;
      
      scatter.transform.x = centerX;
      scatter.transform.y = centerY;
      
      applyScatterTransform();
      updateScatterInfo();
    }
    
    function applyScatterTransform() {
      const canvas = document.getElementById('scatterCanvas');
      if (canvas) {
        canvas.style.transform = `translate(${scatter.transform.x}px, ${scatter.transform.y}px) scale(${scatter.transform.scale})`;
      }
    }
    
    function zoomIn() {
      scatter.transform.scale = Math.min(3, scatter.transform.scale + 0.2);
      applyScatterTransform();
      updateScatterInfo();
      saveState();
    }
    
    function zoomOut() {
      scatter.transform.scale = Math.max(0.25, scatter.transform.scale - 0.2);
      applyScatterTransform();
      updateScatterInfo();
      saveState();
    }
    
    function resetView() {
      scatter.transform = { x: 0, y: 0, scale: 1 };
      applyScatterTransform();
      updateScatterInfo();
      saveState();
      showToast('View reset');
    }
    
    function updateScatterInfo() {
      const count = document.getElementById('scatterCount');
      const zoom = document.getElementById('scatterZoom');
      
      if (count) {
        const filtered = getFilteredScatterVideos();
        count.textContent = `${filtered.length} videos`;
      }
      
      if (zoom) {
        zoom.textContent = `${Math.round(scatter.transform.scale * 100)}%`;
      }
    }
    
    // ====== SCATTER DRAG AND DROP ======
    function startScatterDrag(e, card) {
      if (config.currentView !== 'scatter') return;
      
      scatter.dragging = true;
      draggedCard = card;
      draggedCard.classList.add('is-dragging');
      
      const rect = card.getBoundingClientRect();
      const canvasRect = document.getElementById('scatterCanvas').getBoundingClientRect();
      const invScale = 1 / scatter.transform.scale;
      
      dragOffset.x = ((e.clientX - rect.left) * invScale);
      dragOffset.y = ((e.clientY - rect.top) * invScale);
      
      draggedCard.style.zIndex = '2000';
      
      document.addEventListener('pointermove', handleScatterDrag);
      document.addEventListener('pointerup', stopScatterDragging);
      document.addEventListener('pointercancel', stopScatterDragging);
    }
    
    function handleScatterDrag(e) {
      if (!scatter.dragging || !draggedCard) return;
      
      const canvas = document.getElementById('scatterCanvas');
      const canvasRect = canvas.getBoundingClientRect();
      const invScale = 1 / scatter.transform.scale;
      
      let x = ((e.clientX - canvasRect.left - dragOffset.x) * invScale);
      let y = ((e.clientY - canvasRect.top - dragOffset.y) * invScale);
      
      // Grid snapping (20px increments)
      x = Math.round(x / 20) * 20;
      y = Math.round(y / 20) * 20;
      
      draggedCard.style.left = `${x}px`;
      draggedCard.style.top = `${y}px`;
    }
    
    function stopScatterDragging() {
      if (draggedCard) {
        draggedCard.classList.remove('is-dragging');
        draggedCard.style.zIndex = '';
        
        // Save position to video data
        const videoId = parseInt(draggedCard.dataset.videoId);
        const video = videos.find(v => v.id === videoId);
        if (video) {
          video.scatterPosition.x = parseFloat(draggedCard.style.left);
          video.scatterPosition.y = parseFloat(draggedCard.style.top);
        }
      }
      
      scatter.dragging = false;
      draggedCard = null;
      
      document.removeEventListener('pointermove', handleScatterDrag);
      document.removeEventListener('pointerup', stopScatterDragging);
      document.removeEventListener('pointercancel', stopScatterDragging);
      
      saveState();
    }
    
    // ====== SCATTER CANVAS PAN AND ZOOM ======
    function setupScatterCanvas() {
      const canvas = document.getElementById('scatterCanvas');
      if (!canvas) return;
      
      let panStart = { x: 0, y: 0 };
      
      // Pan functionality
      canvas.addEventListener('pointerdown', (e) => {
        if (!e.target.closest('.scatter-card')) {
          scatter.panning = true;
          panStart.x = e.clientX - scatter.transform.x;
          panStart.y = e.clientY - scatter.transform.y;
          canvas.classList.add('panning');
          e.preventDefault();
        }
      });
      
      canvas.addEventListener('pointermove', (e) => {
        if (scatter.panning) {
          scatter.transform.x = e.clientX - panStart.x;
          scatter.transform.y = e.clientY - panStart.y;
          applyScatterTransform();
        }
      });
      
      document.addEventListener('pointerup', () => {
        if (scatter.panning) {
          scatter.panning = false;
          canvas.classList.remove('panning');
          saveState();
          updateScatterInfo();
        }
      });
      
      // Wheel zoom
      canvas.addEventListener('wheel', (e) => { 
        e.preventDefault(); 
        const delta = e.deltaY < 0 ? 0.2 : -0.2;
        scatter.transform.scale = Math.max(0.25, Math.min(3, scatter.transform.scale + delta));
        applyScatterTransform();
        updateScatterInfo();
        saveState();
      }, { passive: false });
      
      // Touch pinch zoom for mobile
      let touchStartDistance = 0;
      
      canvas.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          touchStartDistance = Math.hypot(
            touch1.clientX - touch2.clientX,
            touch1.clientY - touch2.clientY
          );
          scatter.pinchStart = scatter.transform.scale;
          e.preventDefault();
        }
      }, { passive: false });
      
      canvas.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2 && touchStartDistance) {
          const touch1 = e.touches[0];
          const touch2 = e.touches[1];
          const currentDistance = Math.hypot(
            touch1.clientX - touch2.clientX,
            touch1.clientY - touch2.clientY
          );
          const scaleChange = currentDistance / touchStartDistance;
          scatter.transform.scale = Math.max(0.25, Math.min(3, scatter.pinchStart * scaleChange));
          applyScatterTransform();
          e.preventDefault();
        }
      }, { passive: false });
      
      canvas.addEventListener('touchend', () => {
        touchStartDistance = 0;
        scatter.pinchStart = 0;
        saveState();
        updateScatterInfo();
      }, { passive: true });
    }
    
    // ====== VIDEO DETAIL PANEL ======
    function openVideoDetail(videoId) {
      const video = videos.find(v => v.id === videoId);
      if (!video) return;
      
      currentVideo = video;
      const panel = document.getElementById('detailPanel');
      const content = document.getElementById('detailContent');
      
      content.innerHTML = `
        <div class="video-player">
           Video Player Placeholder<br>
          <small>${video.title}</small>
        </div>
        <h2 style="margin-bottom: 8px;">${video.title}</h2>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <div class="channel-avatar">
            <img src="${video.channel.avatar}" alt="${video.channel.name}" width="40" height="40" style="border-radius: 50%;">
          </div>
          <div>
            <div style="font-weight: 600;">${video.channel.name}</div>
            <div style="font-size: 13px; color: var(--ink-dim);">${formatViews(video.views)} views  ${formatDate(video.uploadDate)}</div>
          </div>
        </div>
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <button class="action-icon" style="padding: 8px 16px; width: auto;"> Like</button>
          <button class="action-icon" style="padding: 8px 16px; width: auto;"> Dislike</button>
          <button class="action-icon" style="padding: 8px 16px; width: auto;" onclick="shareVideo(${video.id})">
             Share
          </button>
          <button class="action-icon" style="padding: 8px 16px; width: auto;" onclick="toggleSave(${video.id})">
            ${video.status === 'saved' ? ' Saved' : ' Save'}
          </button>
        </div>
        <div style="padding-top: 16px; border-top: 1px solid var(--glass-border);">
          <h3 style="margin-bottom: 8px;">Description</h3>
          <p style="color: var(--ink-dim); line-height: 1.6;">${video.description}</p>
        </div>
        <div style="margin-top: 24px;">
          <h3>Comments</h3>
          <div style="color: var(--ink-dim);">Comments section would go here...</div>
        </div>
      `;
      
      const modeIcon = document.getElementById('videoModeIcon');
      const modeText = document.getElementById('videoModeText');
      
      if (videoOverlayMode === 'side-panel') {
        modeIcon.textContent = '';
        modeText.textContent = 'Full Screen';
      } else {
        modeIcon.textContent = '';
        modeText.textContent = 'Side Panel';
      }
      
      panel.classList.add('active');
    }
    
    function closeDetailPanel() {
      document.getElementById('detailPanel').classList.remove('active');
      currentVideo = null;
    }
    
    function toggleVideoMode() {
      const panel = document.getElementById('detailPanel');
      const modeIcon = document.getElementById('videoModeIcon');
      const modeText = document.getElementById('videoModeText');
      
      if (videoOverlayMode === 'side-panel') {
        videoOverlayMode = 'full-viewport';
        panel.classList.remove('side-panel');
        panel.classList.add('full-viewport');
        modeIcon.textContent = '';
        modeText.textContent = 'Side Panel';
        showToast('Switched to full viewport mode');
      } else {
        videoOverlayMode = 'side-panel';
        panel.classList.remove('full-viewport');
        panel.classList.add('side-panel');
        modeIcon.textContent = '';
        modeText.textContent = 'Full Screen';
        showToast('Switched to side panel mode');
      }
      
      if (panel.classList.contains('active')) {
        panel.classList.remove('active');
        setTimeout(() => panel.classList.add('active'), 50);
      }
      
      saveState();
    }
    
    // ====== CONTEXT MENUS ======
    function showContextMenu(event) {
      event.preventDefault();
      const menu = document.getElementById('contextMenu');
      
      if (event.target.closest('.video-card') || event.target.closest('.scatter-card')) {
        return;
      } else if (event.target.closest('#scatterCanvas')) {
        showScatterContextMenu(event);
      } else {
        menu.innerHTML = `
          <div class="ctx-header">Actions</div>
          <div class="ctx-item" onclick="toggleSearchOverlay()"> Search Videos</div>
          <div class="ctx-item" onclick="switchMode('feed')"> Feed View</div>
          <div class="ctx-item" onclick="switchMode('list')"> List View</div>
          <div class="ctx-item" onclick="switchMode('scatter')"> Scatter View</div>
          <div class="ctx-item" onclick="switchMode('columns')"> Kanban View</div>
          <div class="ctx-item" onclick="switchMode('history')"> History</div>
        `;
      }
      
      menu.style.left = `${event.clientX}px`;
      menu.style.top = `${event.clientY}px`;
      menu.classList.add('active');
    }
    
    function showVideoContextMenu(event, videoId) {
      event.preventDefault();
      event.stopPropagation();
      
      const video = videos.find(v => v.id === videoId);
      const menu = document.getElementById('contextMenu');
      
      menu.innerHTML = `
        <div class="ctx-header">${video.channel.name}</div>
        <div class="ctx-item" onclick="openVideoDetail(${videoId})"> Play Now</div>
        <div class="ctx-item" onclick="toggleSave(${videoId})">${video.status === 'saved' ? ' Unsave' : ' Save Video'}</div>
        
        <div class="ctx-divider"></div>
        <div class="ctx-item scatter-action" onclick="addToScatter(${videoId})">
           Add to Scatter Map
        </div>
        ${video.inScatter ? `
        <div class="ctx-item scatter-action" onclick="removeFromScatter(${videoId})">
           Remove from Scatter
        </div>
        ` : ''}
        
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="shareVideo(${videoId})"> Share</div>
        <div class="ctx-item text-red" onclick="removeVideo(${videoId})"> Remove</div>
      `;
      
      menu.style.left = `${event.clientX}px`;
      menu.style.top = `${event.clientY}px`;
      menu.classList.add('active');
    }
    
    function showScatterContextMenu(event) {
      const menu = document.getElementById('contextMenu');
      
      menu.innerHTML = `
        <div class="ctx-header">Canvas Actions</div>
        <div class="ctx-item" onclick="collectNodes()"> Collect (Grid)</div>
        <div class="ctx-item" onclick="cascadeNodes()"> Cascade (Stack)</div>
        <div class="ctx-item" onclick="spreadNodes()"> Spread Randomly</div>
        <div class="ctx-item" onclick="sortScatterByStatus()"> Sort by Status</div>
        <div class="ctx-item" onclick="sortScatterByCategory()"> Sort by Category</div>
        <div class="ctx-item" onclick="resetView()"> Reset View</div>
      `;
      
      menu.style.left = `${event.clientX}px`;
      menu.style.top = `${event.clientY}px`;
      menu.classList.add('active');
    }
    
    // ====== VIDEO ACTIONS ======
    function toggleSave(videoId) {
      const video = videos.find(v => v.id === videoId);
      if (!video) return;
      
      if (video.status === 'saved') {
        video.status = 'unwatched';
      } else {
        video.status = 'saved';
      }
      
      renderCurrentView();
      saveState();
      showToast(video.status === 'saved' ? 'Video saved!' : 'Video unsaved');
    }
    
    function shareVideo(videoId) {
      const video = videos.find(v => v.id === videoId);
      if (!video) return;
      
      const url = `https://youtube.com/watch?v=${videoId}`;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Link copied to clipboard!');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    }
    
    function changeVideoStatus(videoId, status) {
      const video = videos.find(v => v.id === videoId);
      if (!video) return;
      
      video.status = status;
      if (status === 'in-progress' || status === 'completed') {
        video.lastWatched = Date.now();
      }
      renderCurrentView();
      saveState();
      showToast(`Status changed to ${status.replace('-', ' ')}`);
    }
    
    function removeVideo(videoId) {
      if (confirm('Remove this video?')) {
        videos = videos.filter(v => v.id !== videoId);
        renderCurrentView();
        saveState();
        showToast('Video removed');
      }
    }
    
    // ====== SCATTER POCKET FUNCTIONS ======
    function addToScatter(videoId) {
      const video = videos.find(v => v.id === videoId);
      if (!video) return;
      
      if (!video.inScatter) {
        video.inScatter = true;
        video.scatterAddedAt = Date.now();
        video.scatterPosition = getNextAvailablePosition();
        
        updateScatterBadge();
        highlightScatterButton();
        showToast('Added to Scatter Map', 'success');
      }
      
      saveState();
    }
    
    function removeFromScatter(videoId) {
      const video = videos.find(v => v.id === videoId);
      if (!video) return;
      
      video.inScatter = false;
      updateScatterBadge();
      if (config.currentView === 'scatter') {
        renderScatterView();
      }
      saveState();
      showToast('Removed from Scatter Map');
    }
    
    function updateScatterBadge() {
      const count = videos.filter(v => v.inScatter).length;
      const badge = document.getElementById('scatterBadge');
      if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? 'flex' : 'none';
      }
      
      const scatterBtn = document.querySelector('.scatter-pocket');
      if (scatterBtn) {
        if (count > 0) {
          scatterBtn.classList.add('has-items');
        } else {
          scatterBtn.classList.remove('has-items');
        }
      }
    }
    
    function highlightScatterButton() {
      const btn = document.querySelector('.scatter-pocket');
      if (btn) {
        btn.classList.add('just-added');
        setTimeout(() => btn.classList.remove('just-added'), 1000);
      }
    }
    
    function getNextAvailablePosition() {
      const existingPositions = videos
        .filter(v => v.inScatter && v.scatterPosition)
        .map(v => v.scatterPosition);
      
      const gridSize = 150;
      const cols = 8;
      
      for (let i = 0; i < 100; i++) {
        const x = (i % cols) * gridSize + 50;
        const y = Math.floor(i / cols) * gridSize + 50;
        
        if (!existingPositions.some(pos => pos.x === x && pos.y === y)) {
          return { x, y };
        }
      }
      
      return { x: 50, y: 50 };
    }
    
    function isFirstScatterVisit() {
      return !localStorage.getItem('scatterVisited');
    }
    
    function showScatterWelcome() {
      localStorage.setItem('scatterVisited', 'true');
      showToast('Welcome to your Scatter Map! Your saved videos will appear here.', 'info');
    }
    
    // ====== SCATTER SORTING ======
    function sortScatterByStatus() {
      const filtered = getFilteredScatterVideos();
      
      // Group by status
      const statusGroups = {
        'saved': [],
        'watched': [],
        'in-progress': [],
        'unwatched': []
      };
      
      filtered.forEach(video => {
        if (!statusGroups[video.status]) {
          statusGroups['unwatched'].push(video);
        } else {
          statusGroups[video.status].push(video);
        }
      });
      
      // Arrange in columns
      const statusOrder = ['saved', 'watched', 'in-progress', 'unwatched'];
      let currentX = 50;
      const columnWidth = 250;
      
      statusOrder.forEach(status => {
        const videosInStatus = statusGroups[status];
        if (videosInStatus.length > 0) {
          videosInStatus.forEach((video, index) => {
            video.scatterPosition = {
              x: currentX,
              y: 50 + index * 160
            };
          });
          currentX += columnWidth;
        }
      });
      
      fitToBounds();
      renderScatter(filtered);
      saveState();
      showToast('Sorted by status');
    }
    
    function sortScatterByCategory() {
      const filtered = getFilteredScatterVideos();
      
      // Group by category
      const categoryGroups = {};
      filtered.forEach(video => {
        if (!categoryGroups[video.category]) {
          categoryGroups[video.category] = [];
        }
        categoryGroups[video.category].push(video);
      });
      
      // Arrange in columns
      const categories = Object.keys(categoryGroups);
      let currentX = 50;
      const columnWidth = 250;
      
      categories.forEach(category => {
        const videosInCategory = categoryGroups[category];
        videosInCategory.forEach((video, index) => {
          video.scatterPosition = {
            x: currentX,
            y: 50 + index * 160
          };
        });
        currentX += columnWidth;
      });
      
      fitToBounds();
      renderScatter(filtered);
      saveState();
      showToast('Sorted by category');
    }
    
    // ====== TOUCH GESTURES ======
    function setupTouchGestures() {
      const views = ['feed', 'list', 'scatter', 'columns', 'history'];
      let swipeStartX = 0;
      let swipeEndX = 0;
      
      document.addEventListener('touchstart', (e) => {
        swipeStartX = e.changedTouches[0].screenX;
      }, { passive: true });
      
      document.addEventListener('touchend', (e) => {
        swipeEndX = e.changedTouches[0].screenX;
        const diffX = swipeEndX - swipeStartX;
        
        if (Math.abs(diffX) > 50) {
          const currentIndex = views.indexOf(config.currentView);
          let newIndex;
          
          if (diffX > 0) {
            newIndex = currentIndex > 0 ? currentIndex - 1 : views.length - 1;
          } else {
            newIndex = currentIndex < views.length - 1 ? currentIndex + 1 : 0;
          }
          
          switchMode(views[newIndex]);
        }
      }, { passive: true });
    }
    
    function setupMobileTouchListeners() {
      let touchStartTime = 0;
      
      document.addEventListener('touchstart', (e) => {
        touchStartTime = Date.now();
        const card = e.target.closest('.video-card, .list-view-item, .grid-list-item');
        
        if (card) {
          globalTouchStartX = e.touches[0].clientX;
          globalTouchStartY = e.touches[0].clientY;
          
          card.touchTimeout = setTimeout(() => {
            const videoId = card.dataset.videoId;
            if (videoId) {
              showVideoContextMenu(e, parseInt(videoId));
            }
          }, 500);
        }
      }, { passive: true });
      
      document.addEventListener('touchend', (e) => {
        const card = e.target.closest('.video-card, .list-view-item, .grid-list-item');
        
        if (card && card.touchTimeout) {
          clearTimeout(card.touchTimeout);
          
          const touchDuration = Date.now() - touchStartTime;
          const touchEndX = e.changedTouches[0].clientX;
          const touchEndY = e.changedTouches[0].clientY;
          const diffX = Math.abs(touchEndX - globalTouchStartX);
          const diffY = Math.abs(touchEndY - globalTouchStartY);
          
          if (touchDuration < 300 && diffX < 10 && diffY < 10) {
            const videoId = card.dataset.videoId;
            if (videoId) {
              openVideoDetail(parseInt(videoId));
            }
          }
        }
      }, { passive: true });
    }
    
    // ====== THEME MANAGEMENT ======
    function cycleTheme() {
      const themes = ['dark', 'light', 'rose', 'theater'];
      const currentIndex = themes.indexOf(config.currentTheme);
      const nextIndex = (currentIndex + 1) % themes.length;
      config.currentTheme = themes[nextIndex];
      
      document.body.setAttribute('data-theme', config.currentTheme);
      
      const themeIcons = {
        'dark': '',
        'light': '',
        'rose': '',
        'theater': ''
      };
      
      document.getElementById('themeIcon').textContent = themeIcons[config.currentTheme] || '';
      saveState();
    }
    
    function toggleView() {
      if (config.currentView === 'feed') {
        switchMode('list');
      } else if (config.currentView === 'list') {
        switchMode('feed');
      } else if (config.currentView === 'columns') {
        toggleKanbanLayout();
      }
    }
    
    // ====== MODAL FUNCTIONS ======
    function openCreateModal() {
      document.getElementById('createModal').classList.add('active');
    }
    
    function closeCreateModal() {
      document.getElementById('createModal').classList.remove('active');
    }
    
    function createItem(type) {
      closeCreateModal();
      showToast(`Creating ${type}...`, 'info');
    }
    
    function toggleProfileMenu() {
      document.getElementById('profileMenu').classList.toggle('active');
    }
    
    function toggleNotifications() {
      showToast('No new notifications', 'info');
    }
    
    function navigateTo(page) {
      showToast(`Navigating to ${page}...`, 'info');
      document.getElementById('profileMenu').classList.remove('active');
    }
    
    // ====== FILTER FUNCTIONS ======
    function toggleFilter(element) {
      element.parentElement.querySelectorAll('.filter-pill').forEach(pill => {
        pill.classList.remove('active');
      });
      element.classList.add('active');
    }
    
    function toggleSwitch(element) {
      element.classList.toggle('active');
    }
    
    // ====== STATE MANAGEMENT ======
    function saveState() {
      const state = {
        config: config,
        
        // Only save position overrides (sparse)
        videoPositions: videos
          .filter(v => v.scatterPosition)
          .map(v => ({ id: v.id, pos: v.scatterPosition })),
        
        // Only save user actions
        userActions: videos
          .filter(v => v.saved || v.inScatter || v.watched)
          .map(v => ({ 
            id: v.id, 
            saved: v.saved, 
            inScatter: v.inScatter,
            watched: v.watched 
          })),
        
        scatter: scatter,
        videoOverlayMode: videoOverlayMode
      };
      localStorage.setItem('newtube_state', JSON.stringify(state));
    }
    
    function loadState() {
      const saved = localStorage.getItem('newtube_state');
      if (saved) {
        try {
          const state = JSON.parse(saved);
          config = state.config || config;
          scatter = state.scatter || { transform: { x: 0, y: 0, scale: 1 }, panning: false, dragging: false, pinchStart: 0 };
          videoOverlayMode = state.videoOverlayMode || 'side-panel';
          config.kanbanViewMode = state.kanbanViewMode || 'columns';
          
          // Apply saved positions
          if (state.videoPositions) {
            state.videoPositions.forEach(({ id, pos }) => {
              const video = videos.find(v => v.id === id);
              if (video) {
                video.scatterPosition = pos;
              }
            });
          }
          
          // Apply user actions
          if (state.userActions) {
            state.userActions.forEach(({ id, saved, inScatter, watched }) => {
              const video = videos.find(v => v.id === id);
              if (video) {
                if (saved !== undefined) video.saved = saved;
                if (inScatter !== undefined) video.inScatter = inScatter;
                if (watched !== undefined) video.watched = watched;
              }
            });
          }
          
          document.body.setAttribute('data-theme', config.currentTheme);
        } catch (e) {
          console.error('Failed to load state:', e);
        }
      }
    }
    
    function closeAllOverlays() {
      document.getElementById('searchOverlay').classList.remove('active');
      document.getElementById('createModal').classList.remove('active');
      document.getElementById('detailPanel').classList.remove('active');
      document.getElementById('contextMenu').classList.remove('active');
      document.getElementById('profileMenu').classList.remove('active');
    }
    
    function addCustomCategory() {
      const category = prompt('Enter new category name:');
      if (category && category.trim()) {
        showToast(`Category "${category}" added!`, 'info');
      }
    }
    
    function updateNavButtons() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      if (config.currentView === 'scatter') {
        document.querySelector('.scatter-pocket')?.classList.add('active');
      } else {
        document.querySelector(`.nav-btn[data-mode="${config.currentView}"]`)?.classList.add('active');
      }
    }
    
    // ====== INITIALIZE ======
    document.addEventListener('DOMContentLoaded', () => {
      init();
    });
  </script>
</body>
</html>
