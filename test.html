how did I do? because its still not correct: <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>i n t o v i e w : N.O.D.E. Enhanced</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #050505;
      --card-bg: #111111;
      --ink: #ffffff;
      --ink-dim: #888888;
      --accent: #FFED29;
     
      --neon-green: #22c55e;
      --neon-orange: #f97316;
      --neon-red: #ef4444;
      --neon-blue: #3b82f6;
     
      --glass-bg: rgba(20, 20, 20, 0.85);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-blur: 16px;
     
      --nav-height: 80px;
      --header-height: 100px;
      --font-mono: 'JetBrains Mono', monospace;
      --font-sans: 'Inter', sans-serif;
     
      /* Cinematic effects */
      --edge-blur-amount: 8px;
      --vignette-strength: 0.85;
      --vignette-size: 50%;
      --grid-color: rgba(255,255,255,0.08);
      --magnet-color: #FFED29;
      --magnet-active: #ff9500;
    }
    [data-theme="light"] {
      --bg-color: #f0f0f0;
      --card-bg: #ffffff;
      --ink: #111111;
      --ink-dim: #666666;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(0, 0, 0, 0.1);
      --grid-color: rgba(0,0,0,0.08);
    }
    [data-theme="rose"] {
      --bg-color: #1a0a0f;
      --card-bg: #2d1419;
      --ink: #FFE5EC;
      --ink-dim: #FFB3C1;
      --accent: #FF8DA1;
     
      --neon-green: #4ADE80;
      --neon-orange: #FB923C;
      --neon-red: #F87171;
      --neon-blue: #60A5FA;
     
      --glass-bg: rgba(255, 141, 161, 0.15);
      --glass-border: rgba(255, 141, 161, 0.3);
     
      /* Enhanced rose theme colors */
      --rose-primary: #FF8DA1;
      --rose-secondary: #FF6B8B;
      --rose-accent: #FFC0CB;
      --rose-dark: #D63384;
      --rose-light: #FFE0E9;
      --retro-yellow: #FFD93D;
      --retro-blue: #6BCB77;
      --retro-purple: #4D96FF;
      --grid-color: rgba(255,141,161,0.15);
      --magnet-color: #FF8DA1;
      --magnet-active: #FF6B8B;
    }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    html, body { height: 100%; font-family: var(--font-sans); background: var(--bg-color); color: var(--ink); overflow: hidden; }
    /* --- Cinematic Visual Effects --- */
    body {
      position: relative;
    }
    /* Edge Blur Effect */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      box-shadow:
        inset 0 0 var(--edge-blur-amount) rgba(255, 255, 255, 0.1),
        inset 0 0 calc(var(--edge-blur-amount) * 2) rgba(255, 255, 255, 0.05);
      pointer-events: none;
      z-index: 1000;
    }
    /* Vignette Effect */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        ellipse at center,
        transparent 0%,
        transparent var(--vignette-size),
        rgba(0, 0, 0, calc(1 - var(--vignette-strength))) 100%
      );
      pointer-events: none;
      z-index: 999;
    }
    [data-theme="light"] body::after {
      background: radial-gradient(
        ellipse at center,
        transparent 0%,
        transparent var(--vignette-size),
        rgba(0, 0, 0, calc(1 - var(--vignette-strength))) 100%
      );
    }
    [data-theme="rose"] body::after {
      background: radial-gradient(
        ellipse at center,
        rgba(255, 141, 161, 0.05) 0%,
        transparent var(--vignette-size),
        rgba(139, 0, 50, calc(1 - var(--vignette-strength))) 100%
      );
    }
    /* --- Custom Scrollbar Design --- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--ink-dim); }
    /* --- Typography & Utilities --- */
    .text-green { color: var(--neon-green); }
    .text-orange { color: var(--neon-orange); }
    .text-red { color: var(--neon-red); }
    .text-blue { color: var(--neon-blue); }
    .text-rose { color: var(--rose-primary); }
   
    /* Rose theme specific utilities */
    [data-theme="rose"] .text-green { color: var(--retro-blue); }
    [data-theme="rose"] .text-orange { color: var(--retro-yellow); }
    [data-theme="rose"] .text-red { color: var(--rose-secondary); }
    [data-theme="rose"] .text-blue { color: var(--retro-purple); }
    /* --- Layout Structure --- */
    .app-header {
      position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
      display: flex; flex-direction: column; justify-content: center;
      padding: 10px 0; z-index: 100;
      background: linear-gradient(to bottom, var(--bg-color) 40%, transparent);
      pointer-events: none;
    }
    .header-top {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 20px; width: 100%; pointer-events: auto;
    }
   
    /* Logo Styling */
    .logo {
        display: flex; align-items: center; height: 32px;
    }
    /* Logo Image Sizing */
    .logo img{
        height: 32px; /* Enforce size for the SVG */
        width: auto;
        transition: filter 0.3s ease, transform 0.3s ease;
    }
   
    .logo:hover img {
        transform: scale(1.05);
        filter: drop-shadow(0 0 8px var(--accent));
    }
    /* Text Logo Fallback */
    .logo-text {
      font-family: var(--font-mono);
      font-weight: 800;
      font-size: 20px;
      letter-spacing: -1px;
      color: var(--ink);
      display: flex; align-items: center; gap: 8px;
    }
    .logo-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); }
    .header-buttons { display: flex; align-items: center; gap: 8px; margin-left: auto; }
    .theme-btn {
        background: transparent; border: none; color: var(--ink-dim);
        cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center;
        transition: all 0.3s ease;
    }
    .theme-btn:hover { color: var(--ink); background: var(--glass-border); transform: scale(1.1); }
    .theme-btn:active { background: var(--glass-border); color: var(--ink); transform: scale(0.95); }
    /* --- Provider Toggle Bar --- */
    .provider-bar {
      display: flex; gap: 8px; overflow-x: auto; padding: 10px 20px;
      pointer-events: auto; scrollbar-width: none;
      justify-content: flex-start;
    }
    .provider-bar::-webkit-scrollbar { display: none; }
   
    .pill {
      padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;
      background: var(--glass-bg); border: 1px solid var(--glass-border);
      color: var(--ink-dim); white-space: nowrap; cursor: pointer; transition: all 0.2s;
      flex-shrink: 0;
    }
    .pill.active { background: var(--ink); color: var(--bg-color); border-color: var(--ink); }
    .pill.add-btn { border-style: dashed; }
   
    /* Rose theme pill styling */
    [data-theme="rose"] .pill.active {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
      border-color: var(--rose-primary);
      box-shadow: 0 0 12px rgba(255, 141, 161, 0.5);
    }
    .view-container {
      position: absolute; inset: 0;
      top: var(--header-height); bottom: 0;
      overflow: hidden; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .view-container.active { opacity: 1; pointer-events: auto; }
    /* --- Grid View --- */
    #gridContainer { overflow-y: auto; padding: 10px 16px 120px 16px; }
    .grid-wrapper {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      padding-bottom: 40px;
    }
    @media(min-width: 600px) { .grid-wrapper { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); } }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      display: flex; flex-direction: column; gap: 12px;
      transition: transform 0.2s, background 0.2s, box-shadow 0.3s ease;
      cursor: pointer;
    }
    .card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    [data-theme="rose"] .card:hover {
      box-shadow: 0 8px 24px rgba(255, 141, 161, 0.3);
    }
    .card:active { transform: scale(0.98); background: var(--glass-border); }
    .card-top { display: flex; justify-content: space-between; align-items: center; }
    .card-provider { font-weight: 600; font-size: 14px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
   
    /* UPDATED STATUS DOT */
    .status-dot {
        width: 8px; height: 8px;
        border-radius: 50%;
        background-color: currentColor; /* SOLID FILL */
        box-shadow: 0 0 6px currentColor, 0 0 12px currentColor; /* DOUBLE GLOW */
        animation: pulse 2s infinite ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
    }
    /* Edit Icon Style */
    .card-edit-icon {
      color: var(--ink-dim); padding: 4px; border-radius: 4px;
      transition: color 0.2s, background 0.2s;
      margin-left: 8px;
    }
    .card-edit-icon:hover { color: var(--ink); background: rgba(255,255,255,0.1); }
    .card-timer {
      font-family: var(--font-mono);
      font-size: 2.4rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: -1px;
      margin: 8px 0;
      position: relative;
    }
    .card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--ink-dim); border-top: 1px solid var(--glass-border); padding-top: 12px; }
    .card-email { font-family: var(--font-mono); opacity: 0.8; }
   
    .card-actions { display: flex; gap: 8px; }
    .action-icon {
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      border-radius: 6px; background: rgba(255,255,255,0.05); cursor: pointer;
      color: var(--ink-dim); transition: 0.2s;
    }
    .action-icon:hover { background: var(--accent); color: #000; }
   
    [data-theme="rose"] .action-icon:hover {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
    }
    .card.burnt, .scatter-card.burnt {
      opacity: 0.6;
    }
    .card.burnt .card-edit-icon, .scatter-card.burnt .card-edit-icon {
      opacity: 1;
    }
    .burnt-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-family: var(--font-mono);
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--neon-red);
      opacity: 0.7;
      pointer-events: none;
    }
    [data-theme="rose"] .burnt-label {
      color: var(--rose-secondary);
      text-shadow: 0 0 8px var(--rose-secondary);
    }
    .scatter-card .burnt-label {
      font-size: 1.2rem;
    }
    /* --- Scatter View --- */
    #scatterContainer {
        overflow: hidden;
        background-image: radial-gradient(var(--grid-color) 1px, transparent 1px);
        background-size: var(--grid-size, 60px) var(--grid-size, 60px);
        background-position: var(--grid-offset-x, 0px) var(--grid-offset-y, 0px);
        transition: background-size 0.2s ease;
    }
   
    [data-theme="rose"] #scatterContainer {
        background-image: radial-gradient(rgba(255, 141, 161, 0.2) 1px, transparent 1px);
    }
   
    .scatter-canvas {
        width: 100%; height: 100%; position: relative;
        will-change: transform;
        touch-action: none;
    }
    .scatter-card {
      position: absolute;
      width: 220px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; align-items: center;
      user-select: none;
      transition: box-shadow 0.2s, opacity 0.3s ease, filter 0.3s ease;
      cursor: pointer;
    }
   
    [data-theme="rose"] .scatter-card {
      box-shadow: 0 10px 30px rgba(255, 141, 161, 0.2);
    }
   
    .scatter-card.dimmed {
     opacity: 0.28;
     filter: grayscale(90%) blur(0.5px);
      /* Optional: prevent interaction with filtered-out nodes (remove if you want them still clickable) */
      /* pointer-events: none; */
}
    .scatter-card.is-dragging {
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        z-index: 1000 !important;
        cursor: grabbing;
    }
   
    [data-theme="rose"] .scatter-card.is-dragging {
      box-shadow: 0 20px 50px rgba(255, 141, 161, 0.4);
    }
   
    .scatter-card .card-timer { font-size: 1.4rem; margin: 4px 0; position: relative; }
    .scatter-card .card-provider { font-size: 11px; }
    .scatter-card .card-meta {
        display: block;
        text-align: center;
        font-size: 11px;
        color: var(--ink-dim);
        margin-top: 8px;
        border-top: 1px solid var(--glass-border);
        padding-top: 8px;
        width: 100%;
    }
   
    /* --- Bottom Navigation (Dock) --- */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 92%; max-width: 400px;
      height: 64px;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: 32px;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 8px 0 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      z-index: 200;
    }
   
    [data-theme="rose"] .bottom-nav {
      background: rgba(255, 141, 161, 0.15);
      border-color: rgba(255, 141, 161, 0.3);
      box-shadow: 0 20px 40px rgba(255, 141, 161, 0.2);
    }
    .nav-group { display: flex; align-items: center; gap: 4px; }
   
    .nav-btn {
      width: 48px; height: 48px;
      border-radius: 50%;
      border: none; background: transparent;
      color: var(--ink-dim);
      font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn.active { color: var(--ink); background: rgba(255,255,255,0.1); }
    .nav-btn.primary { background: var(--accent); color: #000; transform: scale(1.1); box-shadow: 0 0 15px var(--accent); }
    .nav-btn.primary:active { transform: scale(1.0); }
   
    [data-theme="rose"] .nav-btn.primary {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
      box-shadow: 0 0 20px rgba(255, 141, 161, 0.6);
    }
    .filter-pill-btn {
        background: var(--glass-border);
        height: 40px;
        width: 120px;
        padding: 0 16px;
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        color: var(--ink);
        display: flex; align-items: center; justify-content: flex-start;
        gap: 8px;
        font-size: 11px; font-weight: 700; text-transform: uppercase;
        margin-right: 8px; cursor: pointer;
        transition: all 0.2s;
    }
    .filter-pill-btn:active { transform: scale(0.95); }
    .filter-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ink-dim); box-shadow: 0 0 5px currentColor; flex-shrink: 0; }
    /* --- Modals & Overlays --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
      z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s;
      display: flex; align-items: flex-end;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }
    @media(min-width: 600px) { .overlay { align-items: center; justify-content: center; } }
    .modal-sheet {
      position: relative;
      width: 100%; background: var(--bg-color);
      border-top: 1px solid var(--glass-border);
      border-radius: 24px 24px 0 0;
      padding: 24px;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      max-height: 85vh; overflow-y: auto;
    }
    .overlay.active .modal-sheet { transform: translateY(0); }
    @media(min-width: 600px) {
      .modal-sheet { max-width: 400px; border-radius: 24px; border: 1px solid var(--glass-border); transform: scale(0.95); }
      .overlay.active .modal-sheet { transform: scale(1); }
    }
   
    [data-theme="rose"] .modal-sheet {
      background: linear-gradient(135deg, var(--bg-color) 0%, rgba(45, 20, 25, 0.8) 100%);
      border-color: var(--rose-primary);
    }
   
    .close-btn {
       position: absolute; top: 16px; right: 16px;
       background: transparent; border: none; color: var(--ink-dim);
       cursor: pointer; padding: 8px; border-radius: 50%; z-index: 10;
       transition: color 0.2s;
    }
    .close-btn:hover { color: var(--ink); }
    /* --- Dialogs (Confirm & Action) --- */
    .confirm-dialog {
        background: var(--card-bg); border: 1px solid var(--glass-border);
        padding: 24px; border-radius: 16px; width: 90%; max-width: 320px;
        text-align: center;
        margin-bottom: 40vh;
    }
    .overlay.active .confirm-dialog { animation: fadeIn 0.1s ease; }
    @media(min-width: 600px) { .confirm-dialog { margin-bottom: 0; } }
   
    [data-theme="rose"] .confirm-dialog {
      background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 141, 161, 0.1) 100%);
      border-color: var(--rose-primary);
    }
   
    .confirm-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .confirm-text { font-size: 13px; color: var(--ink-dim); margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 10px; }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: 600; color: var(--ink-dim); margin-bottom: 6px; text-transform: uppercase; }
   
    .input-wrapper { position: relative; width: 100%; }
    .input-wrapper input { padding-right: 40px; }
    .input-icon-btn {
      position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
      background: none; border: none; color: var(--ink-dim); cursor: pointer;
      padding: 4px; border-radius: 4px;
    }
    .input-icon-btn:hover { color: var(--accent); background: rgba(255,255,255,0.1); }
   
    [data-theme="rose"] .input-icon-btn:hover { color: var(--rose-primary); }
    input, select {
      width: 100%; padding: 16px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
      border-radius: 12px; color: var(--ink); font-size: 16px;
      font-family: var(--font-sans); padding-right: 32px;
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); background: rgba(255,255,255,0.1); }
   
    [data-theme="rose"] input:focus, [data-theme="rose"] select:focus {
      border-color: var(--rose-primary);
      background: rgba(255, 141, 161, 0.1);
    }
   
    .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%23888' d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
    }
    .status-toggles { display: flex; gap: 8px; }
    .btn-toggle {
       flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; border: 1px solid var(--glass-border);
       background: transparent; cursor: pointer; transition: all 0.2s; font-size: 14px;
       line-height: 1;
    }
    .btn-toggle.selected { color: var(--bg-color); border-color: currentColor; }
    .btn-toggle[data-status="active"].selected { background: var(--accent); color: #000; border-color: var(--accent); }
    .btn-toggle[data-status="ready"].selected { background: var(--neon-green); color: #000; border-color: var(--neon-green); }
    .btn-toggle[data-status="cooldown"].selected { background: var(--neon-orange); color: #000; border-color: var(--neon-orange); }
    .btn-toggle[data-status="burnt"].selected { background: var(--neon-red); color: #000; border-color: var(--neon-red); }
   
    [data-theme="rose"] .btn-toggle[data-status="ready"].selected { background: var(--retro-blue); }
    [data-theme="rose"] .btn-toggle[data-status="cooldown"].selected { background: var(--retro-yellow); }
    [data-theme="rose"] .btn-toggle[data-status="burnt"].selected { background: var(--rose-secondary); }
    .pill-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .pill-option {
       padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center;
       background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
       cursor: pointer; transition: all 0.2s; line-height: 1.2;
    }
    .pill-option:hover { background: rgba(255,255,255,0.1); }
    .pill-option.selected { background: var(--accent); color: #000; border-color: var(--accent); }
   
    [data-theme="rose"] .pill-option.selected {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
      border-color: var(--rose-primary);
    }
   
    .btn-block { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; border: none; font-size: 14px; text-transform: uppercase; cursor: pointer; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-secondary { background: var(--glass-border); color: var(--ink); margin-top: 12px; }
    .btn-danger { background: rgba(239,68,68,0.2); color: var(--neon-red); margin-top: 12px; border: 1px solid rgba(239,68,68,0.5); }
   
    [data-theme="rose"] .btn-primary {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
    }
    [data-theme="rose"] .btn-danger {
      background: rgba(255, 107, 139, 0.2);
      color: var(--rose-secondary);
      border-color: rgba(255, 107, 139, 0.5);
    }
   
    .btn-half { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }
    .btn-cancel { background: transparent; color: var(--ink-dim); border: 1px solid var(--glass-border); }
    .btn-confirm { background: var(--accent); color: #000; }
   
    [data-theme="rose"] .btn-confirm {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
    }
    /* --- Accordion Styles --- */
    .accordion-item {
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        margin-bottom: 8px;
        overflow: hidden;
        transition: all 0.2s;
    }
    .accordion-header {
        width: 100%;
        background: transparent;
        border: none;
        padding: 16px;
        text-align: left;
        color: var(--ink);
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .accordion-header:hover { background: rgba(255, 255, 255, 0.05); }
    .accordion-icon { transition: transform 0.3s ease; }
    .accordion-item.open .accordion-icon { transform: rotate(180deg); }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .accordion-content-inner { padding: 0 16px 16px 16px; font-size: 14px; color: var(--ink-dim); line-height: 1.6; }
    .accordion-content-inner ul { list-style-type: 'â€” '; margin-left: 20px; padding-left: 0; }
    .accordion-content-inner li { margin-bottom: 6px; padding: 4px 0; }
   
    /* --- Utilities --- */
    .toast {
      position: fixed; top: 120px; left: 50%; transform: translateX(-50%) translateY(-20px);
      background: var(--accent); color: #000; padding: 10px 20px; border-radius: 20px;
      font-weight: 700; font-size: 12px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 500;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
   
    [data-theme="rose"] .toast {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
    }
   
    /* Scatter Specific Mobile Controls */
    .scatter-controls {
      position: fixed; bottom: 100px; right: 20px; display: none; flex-direction: column; gap: 12px; z-index: 150;
    }
    .scatter-controls.visible { display: flex; }
    .control-btn {
      width: 48px; height: 48px; border-radius: 50%; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--ink); font-size: 16px; backdrop-filter: blur(10px); cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items:center; justify-content:center;
    }
    .control-btn.active { background: var(--magnet-active); color: #000; }
    /* --- Context Menu --- */
    .context-menu {
      position: fixed; display: none;
      background: var(--card-bg); border: 1px solid var(--glass-border);
      border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 1000; width: 220px; overflow: hidden;
      backdrop-filter: blur(12px);
    }
   
    [data-theme="rose"] .context-menu {
      background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 141, 161, 0.1) 100%);
      border-color: var(--rose-primary);
      box-shadow: 0 10px 40px rgba(255, 141, 161, 0.3);
    }
   
    .context-menu.active { display: block; animation: fadeIn 0.1s ease; }
    .ctx-header { padding: 8px 12px; font-size: 10px; text-transform: uppercase; color: var(--ink-dim); border-bottom: 1px solid var(--glass-border); letter-spacing: 1px; }
    .ctx-item {
      padding: 12px 16px; font-size: 14px; color: var(--ink); cursor: pointer; display: flex; align-items: center; gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.02);
      transition: background 0.2s;
    }
    .ctx-item:hover { background: var(--accent); color: #000; }
    .ctx-item:last-child { border-bottom: none; }
   
    [data-theme="rose"] .ctx-item:hover {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
    }
   
    @keyframes fadeIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
    /* --- Retro/Pop Art Enhancements for Rose Theme --- */
    [data-theme="rose"] .card {
      position: relative;
      overflow: hidden;
    }
   
    [data-theme="rose"] .card::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--rose-primary), var(--retro-yellow), var(--retro-blue), var(--rose-secondary));
      border-radius: 16px;
      opacity: 0;
      z-index: -1;
      transition: opacity 0.3s ease;
    }
   
    [data-theme="rose"] .card:hover::before {
      opacity: 0.3;
      animation: retroGlow 2s linear infinite;
    }
   
    @keyframes retroGlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    [data-theme="rose"] .status-dot {
      animation: rosePulse 1.5s infinite ease-in-out;
    }
   
    @keyframes rosePulse {
      0%, 100% {
        opacity: 0.8;
        transform: scale(1);
        box-shadow: 0 0 8px currentColor, 0 0 16px currentColor;
      }
      50% {
        opacity: 1;
        transform: scale(1.3);
        box-shadow: 0 0 12px currentColor, 0 0 24px currentColor, 0 0 36px currentColor;
      }
    }
    /* Magnetic cursor indicator */
    .magnet-cursor {
      position: absolute;
      width: 32px; height: 32px;
      border: 2px solid var(--magnet-active);
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      box-shadow: 0 0 20px var(--magnet-active);
      opacity: 0;
      transition: opacity 0.2s;
    }
    .magnet-cursor.active { opacity: 1; }
  </style>
</head>
<body data-theme="dark">
<header class="app-header">
<div class="header-top">
<div class="logo">
<img id="logoImg" src="https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-light.svg" alt="IntoView Logo" style="height: 32px;">
</div>
 
  <div class="header-buttons">
    <button class="theme-btn info-btn" onclick="openInfoModal()" title="Information & Help">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
    </button>
    <button class="theme-btn" onclick="toggleTheme()" title="Toggle Theme">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path></svg>
    </button>
  </div>
</div>
 
  <div class="provider-bar" id="providerBar"></div>
</header>
<div id="gridContainer" class="view-container active">
  <div class="grid-wrapper" id="gridWrapper"></div>
</div>
<div id="scatterContainer" class="view-container">
  <div class="scatter-canvas" id="scatterCanvas"></div>
  <div class="magnet-cursor" id="magnetCursor"></div>
  <div class="scatter-zoom-controls">
    <button class="zoom-btn" onclick="zoomOut()">â€“</button>
    <button class="zoom-btn" onclick="resetView()">1Ã—</button>
    <button class="zoom-btn" onclick="zoomIn()">+</button>
  </div>
</div>
<div class="scatter-controls" id="scatterControls">
  <button class="control-btn" onclick="toggleMagneticWipe()" id="magnetBtn" title="Magnetic Wipe Mode">ðŸ§²</button>
  <button class="control-btn" onclick="autoArrange()" title="Auto Arrange">ðŸ“Š</button>
  <button class="control-btn" onclick="stackColumns()" title="Stack Columns">ðŸ“š</button>
  <button class="control-btn" onclick="zoomIn()" title="Zoom In">+</button>
  <button class="control-btn" onclick="zoomOut()" title="Zoom Out">-</button>
  <button class="control-btn" onclick="resetView()" title="Reset View">1Ã—</button>
</div>
<div id="contextMenu" class="context-menu"></div>
<nav class="bottom-nav">
  <div class="nav-group">
    <button class="nav-btn active" data-view="grid" onclick="switchView('grid')" title="Grid View">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4 11h7V4H4v7zm0 9h7v-7H4v7zm9 0h7v-7h-7v7zm0-16v7h7V4h-7z"></path></svg>
    </button>
    <button class="nav-btn" data-view="scatter" onclick="switchView('scatter')" title="Free Form">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="3"></circle><circle cx="19" cy="5" r="2"></circle><circle cx="5" cy="19" r="2"></circle><circle cx="5" cy="5" r="2"></circle><circle cx="19" cy="19" r="2"></circle></svg>
    </button>
  </div>
  <button class="nav-btn primary" onclick="openModal()">+</button>
  <button class="filter-pill-btn" onclick="cycleStatusFilter()" id="statusPill" title="Active â€¢ Ready â€¢ Cooling â€¢ Burnt">
    <div class="filter-dot" id="filterDot"></div>
    <span id="filterLabel">All</span>
  </button>
</nav>
<div class="overlay" id="providerSelectOverlay">
</div>
<div class="overlay" id="modalOverlay">
<div class="modal-sheet">
  <button class="close-btn" onclick="closeModal()">
     <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
  </button>
 
  <h2 style="margin-bottom:20px; font-family:var(--font-mono)" id="modalTitle">New Node</h2>
  <form id="nodeForm">
    <input type="hidden" id="nodeId">
   
    <div class="form-group">
    <label for="inpProvider">Provider</label>
    <select id="inpProvider" required>
      </select>
  </div>
   
    <div class="form-group">
      <label>Email / Identity</label>
      <div class="input-wrapper">
        <input type="text" id="inpEmail" required autocomplete="off">
        <button type="button" class="input-icon-btn" onclick="copyInput('inpEmail')">
           <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
      </div>
    </div>
    <div class="form-group">
      <label>Current Status</label>
      <div class="status-toggles">
        <button type="button" data-status="active" class="btn-toggle text-blue" onclick="selectStatusButton('active')">Active</button>
        <button type="button" data-status="ready" class="btn-toggle text-green" onclick="selectStatusButton('ready')">Ready</button>
        <button type="button" data-status="cooldown" class="btn-toggle text-orange" onclick="selectStatusButton('cooldown')">Cooldown</button>
        <button type="button" data-status="burnt" class="btn-toggle text-red" onclick="selectStatusButton('burnt')">Burnt</button>
      </div>
      <input type="hidden" id="inpStatus" value="ready">
    </div>
   
    <div class="form-group">
      <label>Reset Cycle (Hours)</label>
      <div class="pill-grid">
         <div class="pill-option selected" data-hours="3" onclick="selectResetHours(3)">3h</div>
         <div class="pill-option" data-hours="6" onclick="selectResetHours(6)">6h</div>
         <div class="pill-option" data-hours="12" onclick="selectResetHours(12)">12h</div>
         <div class="pill-option" data-hours="24" onclick="selectResetHours(24)">24h</div>
         <div class="pill-option" data-hours="48" onclick="selectResetHours(48)">48h</div>
         <div class="pill-option" data-hours="72" onclick="selectResetHours(72)">72h</div>
      </div>
      <input type="number" id="inpResetCustom" placeholder="Custom Hours" style="margin-top: 8px;" step="0.5">
      <input type="hidden" id="inpReset" value="3">
    </div>
    <div id="editActions" style="display:none; margin-top:12px; display:flex; gap:10px;">
       <button type="button" class="btn-block btn-secondary" onclick="confirmHitLimit(null)">ðŸ”¥ Hit Limit</button>
       <button type="button" class="btn-block btn-secondary" onclick="confirmForceRestore(null)">ðŸ”„ Restore</button>
    </div>
    <button type="submit" class="btn-block btn-primary" style="margin-top: 12px;">Save Node</button>
   
    <button type="button" class="btn-block btn-danger" id="btnDelete" style="display:none" onclick="deleteNode()">Delete Node</button>
    <div style="height:20px"></div>
  </form>
</div>
</div>
<div class="overlay" id="confirmOverlay">
   <div class="confirm-dialog">
      <div class="confirm-title" id="confirmTitle">Confirm Action</div>
      <div class="confirm-text" id="confirmText">Are you sure?</div>
      <div class="confirm-actions">
         <button class="btn-half btn-cancel" onclick="closeConfirm()">Cancel</button>
         <button class="btn-half btn-confirm" id="btnConfirmAction">Confirm</button>
      </div>
   </div>
</div>
<div class="overlay" id="actionOverlay">
   <div class="confirm-dialog">
      <div class="confirm-title" id="actionTitle">Activate Node</div>
      <div class="confirm-text">Email copied to clipboard:</div>
      <input type="text" id="actionEmail" readonly style="margin-bottom:20px; text-align:center;">
      <div class="confirm-actions">
         <button class="btn-half btn-cancel" onclick="closeActionOverlay()">Cancel</button>
         <button class="btn-half btn-confirm" id="btnActivateNode">Activate</button>
      </div>
   </div>
</div>
<div class="overlay" id="infoOverlay">
  <div class="modal-sheet">
    <button class="close-btn" onclick="closeInfoModal()">
       <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
    </button>
   
    <h2 style="margin-bottom:20px; font-family:var(--font-mono)">fyi:</h2>
    <div style="margin-bottom: 24px; padding: 16px; border-radius: 12px; background: rgba(255,255,255,0.05);">
      <h3 style="font-weight: 700; font-size: 16px; color: var(--accent); margin-bottom: 8px;">The Node Manifesto:</h3>
      <p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;">
      <p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;"><strong>You are an infinite machine</strong> in a <em>finite prompt cycle</em>; but do not yield for here is a tool for the commonwealth of the commonfolk. <br><br>
        Use the timer not as a limiter, but as a catalyst to creation.<br><br>Let each cooldown be a reset, every burnt node a lesson, and each new node a launchpad.</p>
    </div>
    <div style="margin-bottom: 24px; padding: 16px; border-radius: 12px; background: rgba(255,255,255,0.05);">
      <h3 style="font-weight: 700; font-size: 16px; color: var(--accent); margin-bottom: 8px;">âœ¨ Enhanced Features:</h3>
      <p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;">
        This version includes:<br>
        â€¢ ðŸŽ¬ Cinematic edge blur & vignette effects<br>
        â€¢ ðŸŽ¨ New Rose/Pink theme with retro pop art vibes<br>
        â€¢ ðŸŒ¸ Theme-aware logo switching<br>
        â€¢ âœ¨ Enhanced animations & interactions
      </p>
    </div>
    <div id="accordionContainer">
     
      <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)">
          <span>Interaction & Shortcuts</span>
          <svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
        </button>
        <div class="accordion-content">
          <div class="accordion-content-inner">
            <ul style="list-style-type: none; padding: 0;">
              <li><strong style="color: var(--accent);">Tap Card (Grid/Scatter):</strong> Open Edit Modal (View Details).</li>
              <li><strong style="color: var(--accent);">Right-Click / Long-Press Card:</strong> Quick Action Menu (Hit Limit / Restore / View Details).</li>
              <li><strong style="color: var(--accent);">Right-Click / Long-Press Provider Pill:</strong> Manage Provider (Edit Name / Delete / New).</li>
              <li><strong style="color: var(--accent);">Right-Click / Long-Press Background (Scatter Mode):</strong> Arrangement & Sorting menu.</li>
              <li><strong style="color: var(--accent);">Drag Card (Scatter Mode):</strong> Move the node freely.</li>
              <li><strong style="color: var(--accent);">Drag Background:</strong> Scroll / Pan / Zoom / Sort / Arrange</li>
              <li><strong style="color: var(--accent);">Theme Toggle:</strong> Switches between Dark, Light, and Rose themes.</li>
              <li><strong style="color: var(--accent);">Status Pill (Bottom Right):</strong> Cycles the global filter (All -> Active -> Cooldown -> Burnt).</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)">
          <span>Status & Timing</span>
          <svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
        </button>
        <div class="accordion-content">
          <div class="accordion-content-inner">
            <ul>
              <li style="color: var(--neon-green);">**Active:** Actively in use. Timer shows 00:00:00.</li>
              <li style="color: var(--neon-blue);">**Ready:** Ready to use. Timer shows 00:00:00.</li>
             
              <li style="color: var(--neon-orange);">**Cooldown:** In use, waiting for the limit to reset. Timer shows time remaining (based on *Reset Cycle*).</li>
              <li style="color: var(--neon-red);">**Burnt:** Permanently defunct or retired.</li>
              <li style="margin-top: 12px; color: var(--ink-dim); font-size: 13px; list-style-type: none;">*The timer counts down from the last "Hit Limit" event to the pre-selected "Reset Cycle" duration.*</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
   
    <a href="https://emdash.click" target="_blank" style="display: block; text-align: center; margin-top: 30px; text-decoration: none;">
       <button class="btn-block btn-secondary" style="background: var(--glass-border); color: var(--ink-dim);">
          <span style="font-weight: 400;">Something useful @</span><strong style="color: var(--ink); font-weight: 700;"> emdash.click</strong>
       </button>
    </a>
    <div style="height:20px"></div>
  </div>
</div>
<div class="toast" id="toast">Copied to Clipboard</div>
<script>
// --- Global State ---
// --- Global State ---
let items = []; // Main array of nodes
let providers = []; // List of all providers for dropdowns/pills
let config = {
  filterStatus: 'all',
  filterProvider: 'all',
  view: 'grid',
  scatterMode: 'view' // 'view' or 'move'
};
let scatter = {
  transform: {
    x: 0,
    y: 0,
    scale: 1
  },
  panning: false,
  dragging: false,
  pinchStart: 0,
  gridSize:60,
  magneticActive: false,
  moveActive: false
};
let activeNodeId = null;
let timerInterval = null;
let isDraggingCard = false;
let isMobile = /Mobi|Android/i.test(navigator.userAgent);
let stackLeader = null; // For magnetic stack
let reactiveDots = []; // For move mode reactive grid
let canvas;
let magnetCursor;
let magneticEngaged = false;
let stackOffset = 8; // Indent size for stack

// --- Theme Management ---
const themes = ['dark', 'light', 'rose'];
let currentThemeIndex = 0;
function toggleTheme() {
  currentThemeIndex = (currentThemeIndex + 1) % themes.length;
  const newTheme = themes[currentThemeIndex];
  document.body.setAttribute('data-theme', newTheme);
  localStorage.setItem('iv_theme', newTheme);
  // Update logo based on theme
  const logo = document.getElementById('logoImg');
  if (logo) {
    switch(newTheme) {
      case 'light':
        logo.src = 'https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-dark.svg';
        break;
      case 'rose':
        logo.src = 'https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-rose.svg';
        break;
      default:
        logo.src = 'https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-light.svg';
    }
  }
 
  showToast(`Theme: ${newTheme.toUpperCase()}`);
}

// --- Data Persistence ---
function load() {
  const storedItems = localStorage.getItem('iv_items');
  const storedProviders = localStorage.getItem('iv_providers');
  if (storedItems) {
    items = JSON.parse(storedItems);
  } else {
    seedMockData(); // Use mock data if nothing is stored
  }
  if (storedProviders) {
    providers = JSON.parse(storedProviders);
  } else {
    providers = ['ChatGPT', 'Claude', 'Gemini', 'Perplexity', 'Groq'];
  }
  const storedFilterStatus = localStorage.getItem('iv_filterStatus');
  if (storedFilterStatus) {
    config.filterStatus = storedFilterStatus;
  }
  const storedFilterProvider = localStorage.getItem('iv_filterProvider');
  if (storedFilterProvider) {
    config.filterProvider = storedFilterProvider;
  }
  const storedView = localStorage.getItem('iv_view');
  if (storedView) {
    config.view = storedView;
  }
  const storedScatter = localStorage.getItem('iv_scatter');
  if (storedScatter) {
    scatter.transform = JSON.parse(storedScatter);
  }
}
function save() {
  localStorage.setItem('iv_items', JSON.stringify(items));
  localStorage.setItem('iv_providers', JSON.stringify(providers));
  localStorage.setItem('iv_filterStatus', config.filterStatus);
  localStorage.setItem('iv_filterProvider', config.filterProvider);
  localStorage.setItem('iv_view', config.view);
  localStorage.setItem('iv_scatter', JSON.stringify(scatter.transform));
}
// --- Mock Data Seeding ---
function seedMockData() {
  const now = Date.now();
  items = [ { id: 1, provider: 'ChatGPT', email: 'gpt1@example.com', status: 'active', resetHours: 3, lastUsed: now - 3600000, pos: {x:50, y:50} }, { id: 2, provider: 'Claude', email: 'claude1@example.com', status: 'ready', resetHours: 6, lastUsed: now - 21600000, pos: {x:300, y:50} }, { id: 3, provider: 'Gemini', email: 'gemini1@example.com', status: 'cooldown', resetHours: 12, lastUsed: now - 3600000, pos: {x:550, y:50} }, { id: 4, provider: 'Perplexity', email: 'perp1@example.com', status: 'burnt', resetHours: 24, lastUsed: now - 86400000, pos: {x:50, y:250} }, { id: 5, provider: 'Groq', email: 'groq1@example.com', status: 'cooldown', resetHours: 3, lastUsed: now - 7200000, pos: {x:300, y:250} } ];
}

// --- Utility Functions ---
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}
function copyInput(inputId) {
  const input = document.getElementById(inputId);
  input.select();
  navigator.clipboard.writeText(input.value);
  showToast('Copied to Clipboard');
}
function formatTime(ms) {
  const hours = Math.floor(ms / 3600000).toString().padStart(2, '0');
  const minutes = Math.floor((ms % 3600000) / 60000).toString().padStart(2, '0');
  const seconds = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
  return `${hours}:${minutes}:${seconds}`;
}
function formatRemainingTime(ms) {
  if (ms <= 0) return '00:00:00';
  return formatTime(ms);
}
function formatLastUsed(timestamp) {
  const date = new Date(timestamp);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
}
function filterItems() {
  return items.filter(item => {
    const statusMatch = config.filterStatus === 'all' || item.status === config.filterStatus;
    const providerMatch = config.filterProvider === 'all' || item.provider === config.filterProvider;
    return statusMatch && providerMatch;
  });
}

// --- View Switching ---
function switchView(view) {
  config.view = view;
  localStorage.setItem('iv_view', view);
  document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));
  document.getElementById(`${view}Container`).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.nav-btn[data-view="${view}"]`).classList.add('active');
  if (view === 'scatter') {
    renderScatter();
    document.getElementById('scatterControls').classList.add('visible');
    updateScatterMode();
  } else {
    renderGrid();
    document.getElementById('scatterControls').classList.remove('visible');
  }
}
// --- Filter Management ---
function cycleStatusFilter() {
  const statuses = ['all', 'active', 'ready', 'cooldown', 'burnt'];
  const currentIndex = statuses.indexOf(config.filterStatus);
  config.filterStatus = statuses[(currentIndex + 1) % statuses.length];
  localStorage.setItem('iv_filterStatus', config.filterStatus);
  updateStatusPill();
  if (config.view === 'grid') {
    renderGrid();
  } else {
    renderScatter();
  }
}
function updateStatusPill() {
  const label = document.getElementById('filterLabel');
  const dot = document.getElementById('filterDot');
  label.textContent = config.filterStatus.toUpperCase();
  if (config.filterStatus === 'all') {
    dot.style.background = 'var(--ink-dim)';
    dot.style.boxShadow = '0 0 5px var(--ink-dim)';
  } else if (config.filterStatus === 'active') {
    dot.style.background = 'var(--neon-blue)';
    dot.style.boxShadow = '0 0 8px var(--neon-blue)';
  } else if (config.filterStatus === 'ready') {
    dot.style.background = 'var(--neon-green)';
    dot.style.boxShadow = '0 0 8px var(--neon-green)';
  } else if (config.filterStatus === 'cooldown') {
    dot.style.background = 'var(--neon-orange)';
    dot.style.boxShadow = '0 0 8px var(--neon-orange)';
  } else if (config.filterStatus === 'burnt') {
    dot.style.background = 'var(--neon-red)';
    dot.style.boxShadow = '0 0 8px var(--neon-red)';
  }
}
function setProviderFilter(provider) {
  config.filterProvider = provider;
  localStorage.setItem('iv_filterProvider', provider);
  renderProviderPills();
  if (config.view === 'grid') {
    renderGrid();
  } else {
    renderScatter();
  }
}
function renderAll() {
  renderProviderPills();
  renderGrid();
  renderScatter();
  updateAllTimers();
  renderProviderSelect();
  renderProviderPills();
}

// --- Rendering Functions ---
function updateAllTimers() {
  const now = Date.now();
  items.forEach(item => {
    const timerElement = document.getElementById(`timer-${item.id}`);
    const resetDot = document.getElementById(`reset-dot-${item.id}`);
    if (!timerElement) return;
    if (item.status === 'active') {
      const timeInUse = now - item.lastUsed;
      timerElement.textContent = formatTime(timeInUse);
      if (resetDot) resetDot.style.opacity = '0';
    } else if (item.status === 'cooldown') {
      const resetMs = item.resetHours * 60 * 60 * 1000;
      const remainingMs = item.lastUsed + resetMs - now;
      timerElement.textContent = formatRemainingTime(remainingMs);
      const progress = Math.min(1, (now - item.lastUsed) / resetMs);
      if (resetDot) {
        resetDot.style.opacity = '1';
        resetDot.style.transform = `scaleX(${progress})`;
      }
      if (remainingMs <= 0) {
        item.status = 'ready';
        save();
        renderAll();
        showToast(`${item.provider} Node is Ready!`);
      }
    } else if (item.status === 'ready') {
      timerElement.textContent = '00:00:00';
      if (resetDot) resetDot.style.opacity = '0';
    } else if (item.status === 'burnt') {
      timerElement.textContent = formatLastUsed(item.lastUsed);
      if (resetDot) resetDot.style.opacity = '0';
    }
  });
}
function renderProviderPills() {
  const bar = document.getElementById('providerBar');
  bar.innerHTML = '';
  // Add 'All' pill
  const allPill = document.createElement('div');
  allPill.className = `pill ${config.filterProvider === 'all' ? 'active' : ''}`;
  allPill.textContent = 'All Providers';
  allPill.onclick = () => setProviderFilter('all');
  bar.appendChild(allPill);
  providers.sort().forEach(provider => {
    const pill = document.createElement('div');
    pill.className = `pill ${config.filterProvider === provider ? 'active' : ''}`;
    pill.textContent = provider;
    pill.onclick = () => setProviderFilter(provider);
   
    // NEW: Context menu for specific providers
    pill.oncontextmenu = (e) => {
        e.preventDefault();
        showProviderContextMenu(e, provider);
    };
   
    bar.appendChild(pill);
  });
  // Add 'Add' pill - CHANGED to "+ New Provider"
  const addPill = document.createElement('div');
  addPill.className = 'pill add-btn';
  addPill.textContent = '+ New Provider';
  addPill.onclick = addNewProviderFromMenu; // Directly trigger provider creation
  bar.appendChild(addPill);
}
function renderCard(item) {
  const isCooldown = item.status === 'cooldown';
  const isBurnt = item.status === 'burnt';
  const isReady = item.status === 'ready';
  let dotClass = '';
  if (item.status === 'active') dotClass = 'text-blue';
  else if (isCooldown) dotClass = 'text-orange';
  else if (isReady) dotClass = 'text-green';
  else if (isBurnt) dotClass = 'text-red';
  const timerLabel = isCooldown ? 'TIME TO READY' : (isBurnt ? 'LAST USED' : 'TIME IN USE');
  const card = document.createElement('div');
  card.className = `card ${isBurnt ? 'burnt' : ''}`;
  card.id = `card-${item.id}`;
  card.setAttribute('data-id', item.id);
  card.onclick = (e) => {
    if (config.scatterMode === 'move') return; // Disable in move mode
    // Prevent modal opening when clicking action icons
    if (e.target.closest('.card-actions') || e.target.closest('.card-edit-icon')) {
      return;
    }
    openModal(item.id);
  };
  card.oncontextmenu = (e) => {
    if (config.scatterMode === 'move') return; // Disable in move mode
    e.preventDefault();
    showContextMenu(e, item.id);
  };
  card.innerHTML = `
    <div class="card-top">
      <div class="card-provider">${item.provider}</div>
      <div style="display: flex; align-items: center; gap:4px;">
         <div class="status-dot ${dotClass}" style="margin-right:4px;"></div>
         <div style="font-size:11px; font-weight:600; text-transform:uppercase; color: ${dotClass.replace('text-', 'var(--neon-')}">${item.status}</div>
         <button class="card-edit-icon" onclick="openModal(${item.id})">
             <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.41 1.41z"></path></svg>
         </button>
      </div>
    </div>
    <div class="card-timer" id="timer-${item.id}"></div>
    <div style="height: 4px; background: var(--glass-border); border-radius: 2px; position:relative; overflow:hidden;">
      <div id="reset-dot-${item.id}" style="position:absolute; inset:0; background: var(--accent); transform-origin: left; transform: scaleX(0); transition: transform 1s linear;"></div>
    </div>
    <div style="font-size:10px; font-weight:600; color:var(--ink-dim); text-align:center; margin-top:-10px;">${timerLabel}</div>
    ${isBurnt ? `<div class="burnt-label">BURNT</div>` : ''}
    <div class="card-meta">
      <span class="card-email">${item.email}</span>
      <div class="card-actions">
        ${item.status !== 'ready' ? `<div class="action-icon" onclick="confirmForceRestore(${item.id})" title="Reset to Ready">
           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.74 15.42 20 13.75 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 9.74C4.26 11.02 4 12.63 4 14c0 4.42 3.58 8 8 8V23l4-4-4-4v3z"></path></svg>
        </div>` : ''}
        ${item.status === 'active' || item.status === 'cooldown' ? `<div class="action-icon" onclick="confirmHitLimit(${item.id})" title="Hit Limit Now">
           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
        </div>` : ''}
        ${item.status === 'ready' ? `<div class="action-icon text-green" onclick="openActionOverlay(${item.id})" title="Activate Node">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"></path></svg>
        </div>` : ''}
      </div>
    </div>
  `;
  return card;
}
function renderGrid() {
  const wrapper = document.getElementById('gridWrapper');
  const filteredItems = filterItems().sort((a, b) => {
    // Sort by status: Active > Ready > Cooldown > Burnt
    const statusOrder = {
      'active': 0,
      'ready': 1,
      'cooldown': 2,
      'burnt': 3
    };
    return statusOrder[a.status] - statusOrder[b.status];
  });
  wrapper.innerHTML = '';
  filteredItems.forEach(item => {
    wrapper.appendChild(renderCard(item));
  });
}

function renderScatter() {
  const filteredItems = filterItems();
  const existingIds = Array.from(canvas.children).map(c => c.dataset.id);
  // Create/Update all cards, dim non-filtered
  items.forEach(item => {
    let card = document.getElementById(`scatter-card-${item.id}`);
    if (!card) {
      // Create new card
      card = document.createElement('div');
      card.className = `scatter-card ${item.status === 'burnt' ? 'burnt' : ''}`;
      card.id = `scatter-card-${item.id}`;
      card.setAttribute('data-id', item.id);
      card.oncontextmenu = (e) => {
        if (config.scatterMode === 'move') return; // Disable in move mode
        e.preventDefault();
        showContextMenu(e, item.id);
      };
      card.onclick = () => {
        if (config.scatterMode === 'move') return;
        if (!isDraggingCard) {
          openModal(item.id);
        }
      };
      card.addEventListener('pointerdown', (e) => {
        if (config.scatterMode === 'view') return; // Only drag in move mode
        startDrag(e, item);
      });
      canvas.appendChild(card);
    }
    // Update card content (simplified version of renderCard)
    const isCooldown = item.status === 'cooldown';
    const isBurnt = item.status === 'burnt';
    const isReady = item.status === 'ready';
    let dotClass = '';
    if (item.status === 'active') dotClass = 'text-blue';
    else if (isCooldown) dotClass = 'text-orange';
    else if (isReady) dotClass = 'text-green';
    else if (isBurnt) dotClass = 'text-red';
    const timerLabel = isCooldown ? 'TIME TO READY' : (isBurnt ? 'LAST USED' : 'TIME IN USE');
    card.innerHTML = `
      <div class="card-top" style="width:100%;">
        <div class="card-provider">${item.provider}</div>
        <div style="display: flex; align-items: center; gap:4px;">
           <div class="status-dot ${dotClass}" style="margin-right:4px;"></div>
           <div style="font-size:11px; font-weight:600; text-transform:uppercase; color: ${dotClass.replace('text-', 'var(--neon-')}">${item.status}</div>
           <button class="card-edit-icon" onclick="openModal(${item.id})">
               <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.41 1.41z"></path></svg>
           </button>
        </div>
      </div>
      <div class="card-timer" id="timer-${item.id}"></div>
      <div style="height: 2px; background: var(--glass-border); border-radius: 2px; position:relative; overflow:hidden; width:80%;">
        <div id="reset-dot-${item.id}" style="position:absolute; inset:0; background: var(--accent); transform-origin: left; transform: scaleX(0); transition: transform 1s linear;"></div>
      </div>
      <div class="card-meta">
        <span class="card-email">${item.email}</span>
      </div>
      ${isBurnt ? `<div class="burnt-label">BURNT</div>` : ''}
    `;
    // Apply position
    card.style.left = `${item.pos.x}px`;
    card.style.top = `${item.pos.y}px`;
    card.style.zIndex = item.status === 'active' ? 5 : 1;
    // Apply dimmed class if not in filter
    if (filteredItems.some(f => f.id === item.id)) {
      card.classList.remove('dimmed');
    } else {
      card.classList.add('dimmed');
    }
  });
  // Remove cards if somehow extra (though unlikely)
  existingIds.forEach(id => {
    if (!items.find(i => i.id == id)) {
      document.getElementById(`scatter-card-${id}`).remove();
    }
  });
  applyScatterTransform();
}
// NEW: Grid & Snap Logic
const GRID_BASE = 60; // base grid size at scale 1
function updateGridDisplay() {
  const container = document.getElementById('scatterContainer');
  const size = GRID_BASE * scatter.transform.scale;
  container.style.setProperty('--grid-size', `${size}px`);
  const offsetX = scatter.transform.x % size;
  const offsetY = scatter.transform.y % size;
  container.style.setProperty('--grid-offset-x', `${offsetX}px`);
  container.style.setProperty('--grid-offset-y', `${offsetY}px`);
}
function snapToGrid(x, y) {
  const size = GRID_BASE * scatter.transform.scale;
  return {
    x: Math.round(x / size) * size,
    y: Math.round(y / size) * size
  };
}

// Enhanced drag with snap
function startDrag(e, item) {
  if (e.button !== 0) return; // Only left mouse button
  const card = e.currentTarget;
  scatter.dragging = true;
  card.classList.add('is-dragging');
  card.setPointerCapture(e.pointerId);
  // Bring to front
  card.style.zIndex = 1000;
  const containerRect = canvas.getBoundingClientRect();
  const startItemX = item.pos.x;
  const startItemY = item.pos.y;
  const startClientX = e.clientX;
  const startClientY = e.clientY;
  const invScale = 1 / scatter.transform.scale;
  const startCanvasX = (startClientX - containerRect.left - scatter.transform.x) * invScale;
  const startCanvasY = (startClientY - containerRect.top - scatter.transform.y) * invScale;
  let distanceMoved = 0;
  isDraggingCard = false;
  function move(eMove) {
    if (eMove.pointerId !== e.pointerId) return;
    scatter.dragging = true;
    const currentClientX = eMove.clientX;
    const currentClientY = eMove.clientY;
    // Calculate total distance moved
    const dx_client = currentClientX - startClientX;
    const dy_client = currentClientY - startClientY;
    distanceMoved = Math.hypot(dx_client, dy_client);
    if (distanceMoved > 5) { // Dampening threshold (5 pixels)
      isDraggingCard = true;
    }
    const currentCanvasX = (currentClientX - containerRect.left - scatter.transform.x) * invScale;
    const currentCanvasY = (currentClientY - containerRect.top - scatter.transform.y) * invScale;
    const newX = startItemX + (currentCanvasX - startCanvasX);
    const newY = startItemY + (currentCanvasY - startCanvasY);
    // Apply a temporary transform for the drag visual effect
    card.style.transform = `translate(${newX - startItemX}px, ${newY - startItemY}px)`;
    // Update reactive dots in move mode
    if (scatter.moveActive) {
      updateReactiveDots(newX, newY);
    }
  }
  function end(eEnd) {
    if (eEnd.pointerId !== e.pointerId) return;
    // Calculate final position
    const currentClientX = eEnd.clientX;
    const currentClientY = eEnd.clientY;
    const currentCanvasX = (currentClientX - containerRect.left - scatter.transform.x) * invScale;
    const currentCanvasY = (currentClientY - containerRect.top - scatter.transform.y) * invScale;
    let finalX = startItemX + (currentCanvasX - startCanvasX);
    let finalY = startItemY + (currentCanvasY - startCanvasY);
    if (isDraggingCard) { // Only update position if a drag actually happened
      const snapped = snapToGrid(finalX, finalY);
      finalX = snapped.x;
      finalY = snapped.y;
      item.pos.x = finalX;
      item.pos.y = finalY;
      save();
    }
    card.style.left = `${finalX}px`; // Apply final position
    card.style.top = `${finalY}px`; // Apply final position
    // Reset card styles and state
    card.style.transform = ''; // Remove the temporary drag transform
    card.classList.remove('is-dragging');
    scatter.dragging = false;
    card.style.zIndex = item.status === 'active' ? 5 : 1; // Restore z-index
    card.removeEventListener('pointermove', move);
    card.removeEventListener('pointerup', end);
    // Clear reactive dots
    clearReactiveDots();
    // isDraggingCard will be checked by card.onclick on pointerup/click
    setTimeout(() => isDraggingCard = false, 100); // Reset flag after a short delay
  }
  card.addEventListener('pointermove', move);
  card.addEventListener('pointerup', end);
}
// NEW: Reactive dots for move mode
function updateReactiveDots(cursorX, cursorY) {
  clearReactiveDots();
  const size = GRID_BASE * scatter.transform.scale;
  const gridX = Math.round(cursorX / size) * size;
  const gridY = Math.round(cursorY / size) * size;
  const dot = document.createElement('div');
  dot.className = 'reactive-dot active';
  dot.style.left = `${gridX - 2}px`; // center
  dot.style.top = `${gridY - 2}px`;
  canvas.appendChild(dot);
  reactiveDots.push(dot);
}
function clearReactiveDots() {
  reactiveDots.forEach(dot => dot.remove());
  reactiveDots = [];
}

// NEW: Toggle functions
function toggleMagneticWipe() {
  scatter.magneticActive = !scatter.magneticActive;
  const magnetBtn = document.getElementById('magnetBtn');
  if (magnetBtn) magnetBtn.classList.toggle('active', scatter.magneticActive);
  magnetCursor.classList.toggle('active', scatter.magneticActive);
  showToast(scatter.magneticActive ? (isMobile ? "Double Tap!" : "Hold Shift Key") : "Magnetic Off");
  if (scatter.magneticActive && scatter.moveActive) {
    toggleMoveMode(); // Disable move if magnetic on
  }
}
function toggleViewMode() {
  config.scatterMode = 'view';
  updateScatterMode();
}
function toggleMoveMode() {
  scatter.moveActive = !scatter.moveActive;
  const moveBtn = document.getElementById('moveBtn');
  const viewBtn = document.getElementById('viewBtn');
  if (moveBtn) moveBtn.classList.toggle('active', scatter.moveActive);
  if (viewBtn) viewBtn.classList.toggle('active', !scatter.moveActive);
  if (scatter.moveActive && scatter.magneticActive) {
    toggleMagneticWipe(); // Disable magnetic in move mode
  }
  updateScatterMode();
  showToast(scatter.moveActive ? "Move Mode (ESC to exit)" : "View Mode");
}
function updateScatterMode() {
  const cards = document.querySelectorAll('.scatter-card');
  cards.forEach(card => {
    card.style.pointerEvents = config.scatterMode === 'view' ? 'auto' : 'none'; // Disable clicks in move
    card.style.cursor = config.scatterMode === 'move' ? 'grab' : 'pointer';
  });
  if (config.scatterMode === 'view') {
    clearReactiveDots();
  }
}
// NEW: Magnetic stack logic
function engageMagnetic() {
  if (!scatter.magneticActive || scatter.moveActive) return;
  magneticEngaged = true;
  magnetCursor.classList.add('active');
  const filtered = filterItems();
  if (filtered.length > 0) {
    stackLeader = filtered[0]; // First as leader
    filtered.forEach((item, index) => {
      const card = document.getElementById(`scatter-card-${item.id}`);
      if (card) {
        card.classList.add('stacked');
        if (index === 0) card.classList.add('stack-top');
      }
    });
  }
}
function disengageMagnetic() {
  magneticEngaged = false;
  magnetCursor.classList.remove('active');
  const filtered = filterItems();
  filtered.forEach(item => {
    const card = document.getElementById(`scatter-card-${item.id}`);
    if (card) {
      card.classList.remove('stacked', 'stack-top');
    }
  });
  stackLeader = null;
}


// Stubs for missing functions (expand as needed)
function autoArrange() {
  // Example: Arrange in a grid
  const filtered = filterItems();
  filtered.forEach((item, index) => {
    item.pos.x = (index % 5) * 250 + 50;
    item.pos.y = Math.floor(index / 5) * 200 + 50;
  });
  renderScatter();
  save();
  showToast('Nodes Auto-Arranged');
}

function stackColumns() {
  // Example: Stack by status
  const statusGroups = {
    active: [], ready: [], cooldown: [], burnt: []
  };
  filterItems().forEach(item => statusGroups[item.status].push(item));
  let colX = 50;
  Object.values(statusGroups).forEach(group => {
    group.forEach((item, index) => {
      item.pos.x = colX;
      item.pos.y = index * 150 + 50;
    });
    colX += 250;
  });
  renderScatter();
  save();
  showToast('Nodes Stacked in Columns');
}

// --- Scatter Pan/Zoom Logic ---
function applyScatterTransform() {
  canvas.style.transform = `translate(${scatter.transform.x}px, ${scatter.transform.y}px) scale(${scatter.transform.scale})`;
  updateGridDisplay();
}


// --- Context Menu Logic ---
function showContextMenu(e, nodeId) {
  closeContextMenu(); // Close any open menu
  const menu = document.getElementById('contextMenu');
  const item = items.find(i => i.id == nodeId);
  if (!item) return;
  menu.innerHTML = `
    <div class="ctx-header">${item.provider} Node</div>
    <div class="ctx-item" onclick="openModal(${item.id})">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.41 1.41z"></path></svg>
       <span>Edit Details</span>
    </div>
    ${item.status === 'ready' ? `<div class="ctx-item text-green" onclick="openActionOverlay(${item.id})">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"></path></svg>
       <span>Activate Node</span>
    </div>` : ''}
    ${item.status !== 'ready' ? `<div class="ctx-item text-blue" onclick="confirmForceRestore(${item.id})">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.74 15.42 20 13.75 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 9.74C4.26 11.02 4 12.63 4 14c0 4.42 3.58 8 8 8V23l4-4-4-4v3z"></path></svg>
       <span>Force Restore</span>
    </div>` : ''}
    ${item.status === 'active' || item.status === 'cooldown' ? `<div class="ctx-item text-red" onclick="confirmHitLimit(${item.id})">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
       <span>Hit Limit / Cooldown</span>
    </div>` : ''}
  `;
  menu.style.left = `${e.clientX}px`;
  menu.style.top = `${e.clientY}px`;
  menu.classList.add('active');
  // Hide menu on next click
  const hide = () => {
    menu.classList.remove('active');
    document.removeEventListener('click', hide);
    document.removeEventListener('contextmenu', hide);
  };
  setTimeout(() => document.addEventListener('click', hide), 10);
}
// NEW: Context menu for Providers
function showProviderContextMenu(e, providerName) {
  closeContextMenu(); // Close any open menu
  const menu = document.getElementById('contextMenu');
  menu.innerHTML = `
    <div class="ctx-header">Provider: ${providerName}</div>
    <div class="ctx-item" onclick="renameProvider('${providerName}')">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.41 1.41z"></path></svg>
       <span>Edit Name</span>
    </div>
    <div class="ctx-item text-red" onclick="deleteProvider('${providerName}')">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
       <span>Delete Provider</span>
    </div>
    <div class="ctx-item" onclick="addNewProviderFromMenu()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>New Provider...</span>
    </div>
  `;
  menu.style.left = `${e.clientX}px`;
  menu.style.top = `${e.clientY}px`;
  menu.classList.add('active');
  // Hide menu on next click
  const hide = () => {
    menu.classList.remove('active');
    document.removeEventListener('click', hide);
    document.removeEventListener('contextmenu', hide);
  };
  setTimeout(() => document.addEventListener('click', hide), 10);
}
function renameProvider(oldName) {
    const newName = prompt(`Rename ${oldName} to:`, oldName);
    if(newName && newName.trim() && newName !== oldName) {
        const trimmed = newName.trim();
       
        // Update the provider list
        const index = providers.indexOf(oldName);
        if(index !== -1) {
            providers[index] = trimmed;
        }
       
        // Update all associated items
        items.forEach(item => {
            if(item.provider === oldName) {
                item.provider = trimmed;
            }
        });
       
        // If filter was set to this provider, update it
        if(config.filterProvider === oldName) {
            config.filterProvider = trimmed;
        }
       
        providers.sort();
        save();
        renderAll();
        showToast('Provider Renamed');
    }
}
function deleteProvider(name) {
    if(confirm(`Remove "${name}" from provider list? (Associated nodes will remain but won't have a filter pill until re-added)`)) {
        providers = providers.filter(p => p !== name);
        if(config.filterProvider === name) {
            config.filterProvider = 'all';
        }
        save();
        renderAll();
        showToast('Provider Removed');
    }
}
// NEW: Grid View Context Menu
function showGridBackgroundContextMenu(e) {
  const menu = document.getElementById('contextMenu');
  menu.innerHTML = `
    <div class="ctx-header">Grid Options</div>
    <div class="ctx-item" onclick="closeContextMenu(); openModal()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>Add New Node</span>
    </div>
    <div class="ctx-item" onclick="closeContextMenu(); addNewProviderFromMenu()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>Add New Provider</span>
    </div>
  `;
  menu.style.left = `${e.clientX}px`;
  menu.style.top = `${e.clientY}px`;
  menu.classList.add('active');
  // Hide menu on next click
  const hide = () => {
    menu.classList.remove('active');
    document.removeEventListener('click', hide);
    document.removeEventListener('contextmenu', hide);
  };
  setTimeout(() => document.addEventListener('click', hide), 10);
}
// NEW: Scatter View Context Menu
function showScatterBackgroundContextMenu(e) {
  const menu = document.getElementById('contextMenu');
  menu.innerHTML = `
    <div class="ctx-header">Scatter Options</div>
    <div class="ctx-item" onclick="closeContextMenu(); openModal()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>Add New Node</span>
    </div>
    <div class="ctx-item" onclick="closeContextMenu(); addNewProviderFromMenu()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>Add New Provider</span>
    </div>
    <div class="ctx-item" onclick="closeContextMenu(); autoArrange()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4 11h7V4H4v7zm0 9h7v-7H4v7zm9 0h7v-7h-7v7zm0-16v7h7V4h-7z"></path></svg>
       <span>Auto Arrange</span>
    </div>
  `;
  menu.style.left = `${e.clientX}px`;
  menu.style.top = `${e.clientY}px`;
  menu.classList.add('active');
  // Hide menu on next click
  const hide = () => {
    menu.classList.remove('active');
    document.removeEventListener('click', hide);
    document.removeEventListener('contextmenu', hide);
  };
  setTimeout(() => document.addEventListener('click', hide), 10);
}
function closeContextMenu() {
  document.getElementById('contextMenu').classList.remove('active');
}
// Helper for context menu
function addNewProviderFromMenu() {
  const newProvider = prompt('Enter new provider name:');
  if (newProvider && newProvider.trim()) {
    const trimmedProvider = newProvider.trim();
    if (!providers.includes(trimmedProvider)) {
      providers.push(trimmedProvider);
      providers.sort();
      save();
      renderProviderSelect();
      renderProviderPills();
      showToast('Provider added!');
    }
  }
}
// Hide context menu if clicking outside of it (already handled by hide function, but just in case)
document.addEventListener('click', (e) => {
  if (!e.target.closest('#contextMenu')) {
    document.getElementById('contextMenu').classList.remove('active');
  }
});
// --- Quick Actions ---
function confirmHitLimit(nodeId) {
  closeModal();
  closeContextMenu();
  const id = nodeId || document.getElementById('nodeId').value;
  const item = items.find(i => i.id == id);
  if (!item) return;
  confirmAction(`Hit Limit: ${item.provider}`, `Mark this node as 'cooldown' and start its ${item.resetHours}h reset timer?`, () => {
    item.status = 'cooldown';
    item.lastUsed = Date.now();
    save();
    closeConfirm();
    renderAll();
    showToast(`${item.provider} Node Cooldown Initiated.`);
  });
}
function confirmForceRestore(nodeId) {
  closeModal();
  closeContextMenu();
  const id = nodeId || document.getElementById('nodeId').value;
  const item = items.find(i => i.id == id);
  if (!item) return;
  confirmAction(`Force Restore: ${item.provider}`, `Mark this node as 'ready' and reset its timer?`, () => {
    item.status = 'ready';
    // Set last used far in past to ensure ready state
    item.lastUsed = Date.now() - (item.resetHours * 60 * 60 * 1000) * 2;
    save();
    closeConfirm();
    renderAll();
    showToast(`${item.provider} Node is Force Ready.`);
  });
}


// --- Modal/Dialog Management (Provider Select Rework) ---
// Renders options for the new <select id="inpProvider">
  function renderProviderSelect() {
  const select = document.getElementById('inpProvider');
  if (!select) return;
  const currentProviderValue = select.value;
  // Clear existing options
  select.innerHTML = '';
  // Add the default "Select" option
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = 'Select a Provider';
  defaultOption.disabled = true;
  defaultOption.selected = true;
  select.appendChild(defaultOption);
  providers.sort().forEach(provider => {
    const option = document.createElement('option');
    option.value = provider;
    option.textContent = provider;
    select.appendChild(option);
  });
// Add the "Add Custom" option
const customOption = document.createElement('option');
  customOption.value = 'CUSTOM_ADD_NEW';
  customOption.textContent = '+ Add Custom Provider...';
  select.appendChild(customOption);
  // Attempt to re-select the previous value if it's still valid
  if (currentProviderValue && (providers.includes(currentProviderValue) || currentProviderValue === 'CUSTOM_ADD_NEW')) {
    select.value = currentProviderValue;
  }
}
// Handle selection change for custom provider
document.addEventListener('change', (e) => {
  if (e.target.id === 'inpProvider' && e.target.value === 'CUSTOM_ADD_NEW') {
    const newProvider = prompt('Enter new provider name:');
    if (newProvider && newProvider.trim()) {
      const trimmedProvider = newProvider.trim();
      if (!providers.includes(trimmedProvider)) {
        providers.push(trimmedProvider);
        providers.sort();
        save();
      }
      // Re-render and select the new provider
      renderProviderSelect();
      document.getElementById('inpProvider').value = trimmedProvider;
      renderProviderPills(); // Update pills immediately
    } else {
      // If canceled, reset the selection to the default
      document.getElementById('inpProvider').value = '';
    }
  }
});
function selectStatusButton(status) {
  document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('selected'));
  document.querySelector(`.btn-toggle[data-status="${status}"]`).classList.add('selected');
  document.getElementById('inpStatus').value = status;
}
function selectResetHours(hours) {
  document.querySelectorAll('.pill-option').forEach(p => p.classList.remove('selected'));
  document.querySelector(`.pill-option[data-hours="${hours}"]`).classList.add('selected');
  document.getElementById('inpReset').value = hours;
  document.getElementById('inpResetCustom').value = ''; // Clear custom input
}
document.getElementById('inpResetCustom').addEventListener('input', (e) => {
  document.querySelectorAll('.pill-option').forEach(p => p.classList.remove('selected'));
  const value = parseFloat(e.target.value);
  if (!isNaN(value) && value > 0) {
    document.getElementById('inpReset').value = value;
  } else if (e.target.value === '') {
    // Re-select default or current value if custom is cleared
    selectResetHours(document.getElementById('inpReset').value || 3);
  }
});
function openModal(nodeId = null) {
  const modal = document.getElementById('modalOverlay');
  const form = document.getElementById('nodeForm');
  const title = document.getElementById('modalTitle');
  const btnDelete = document.getElementById('btnDelete');
  const editActions = document.getElementById('editActions');
  const inpProvider = document.getElementById('inpProvider'); // Now the <select>
  form.reset();
  selectResetHours(3);
  selectStatusButton('ready');
  document.getElementById('nodeId').value = '';
  renderProviderSelect(); // Render/reset the options in the select
  inpProvider.value = ''; // Ensure default is selected
  title.textContent = 'New Node';
  btnDelete.style.display = 'none';
  editActions.style.display = 'none';
  if (nodeId) {
    // Edit existing node
    const item = items.find(i => i.id == nodeId);
    if (!item) return;
    title.textContent = `Edit Node: ${item.provider}`;
    document.getElementById('nodeId').value = nodeId;
    // Ensure the provider is in the list before trying to set the value
    if (!providers.includes(item.provider)) {
       providers.push(item.provider);
       providers.sort();
       save();
       renderProviderSelect();
    }
    inpProvider.value = item.provider; // SETTING THE SELECT VALUE
    document.getElementById('inpEmail').value = item.email;
    selectStatusButton(item.status);
    // Handle custom reset hours
    const option = document.querySelector(`.pill-option[data-hours="${item.resetHours}"]`);
    if (option) {
      selectResetHours(item.resetHours);
    } else {
      document.querySelectorAll('.pill-option').forEach(p => p.classList.remove('selected'));
      document.getElementById('inpResetCustom').value = item.resetHours;
      document.getElementById('inpReset').value = item.resetHours;
    }
    btnDelete.style.display = 'block';
    editActions.style.display = 'flex';
    document.getElementById('btnDelete').onclick = () => deleteNode();
    document.getElementById('btnDelete').setAttribute('data-id', nodeId); // For confirm dialog
    document.querySelector('#editActions .btn-secondary:nth-child(1)').onclick = () => confirmHitLimit(nodeId);
    document.querySelector('#editActions .btn-secondary:nth-child(2)').onclick = () => confirmForceRestore(nodeId);
  }
  modal.classList.add('active');
}
function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
}
// NEW: Function to close action overlay
function closeActionOverlay() {
  document.getElementById('actionOverlay').classList.remove('active');
}
// NEW: Function to close info modal
function closeInfoModal() {
  document.getElementById('infoOverlay').classList.remove('active');
}
const form = document.getElementById('nodeForm');
form.addEventListener('submit', (e) => {
  e.preventDefault();
  const nodeId = document.getElementById('nodeId').value;
  const provider = document.getElementById('inpProvider').value; // Get value from <select>
  const email = document.getElementById('inpEmail').value;
  const status = document.getElementById('inpStatus').value;
  const resetHours = parseFloat(document.getElementById('inpReset').value);
  // Validation for new <select>
  if (!provider || provider === 'CUSTOM_ADD_NEW') {
    showToast('Please select a valid Provider.');
    return;
  }
  const now = Date.now();
  if (nodeId) {
    // Update existing node
    const item = items.find(i => i.id == nodeId);
    if (!item) return;
    const oldStatus = item.status;
    const oldProvider = item.provider;
    item.provider = provider;
    item.email = email;
    item.status = status;
    // Only apply lastUsed = now if status changed to active/cooldown or provider changed
    if (item.status !== oldStatus || item.provider !== oldProvider) {
      item.lastUsed = now; // Reset timer on status or provider change
    }
    item.resetHours = resetHours;
    if (!providers.includes(provider)) {
      providers.push(provider);
    }
    showToast('Node Updated!');
  } else {
    // Create new node
    const newItem = {
      id: now + Math.floor(Math.random() * 1000),
      provider: provider,
      email: email,
      status: status,
      resetHours: resetHours,
      lastUsed: now,
      pos: {
        x: 50,
        y: 50
      } // Default position for scatter view
    };
    items.push(newItem);
    if (!providers.includes(provider)) {
      providers.push(provider);
    }
    showToast('New Node Added!');
  }
  save();
  closeModal();
  renderAll();
});
function deleteNode() {
  const nodeId = document.getElementById('nodeId').value;
  const item = items.find(i => i.id == nodeId);
  if (!item) return;
  confirmAction(`Delete ${item.provider}?`, 'This action cannot be undone.', () => {
    items = items.filter(i => i.id != nodeId);
    save();
    closeModal();
    renderAll();
    showToast('Node Deleted!');
  });
}
function confirmAction(title, text, callback) {
  const overlay = document.getElementById('confirmOverlay');
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmText').textContent = text;
  const btnConfirm = document.getElementById('btnConfirmAction');
  // Clone the button to remove existing listeners
  const newBtnConfirm = btnConfirm.cloneNode(true);
  btnConfirm.parentNode.replaceChild(newBtnConfirm, btnConfirm);
  newBtnConfirm.onclick = () => {
    callback();
    closeConfirm();
  };
  overlay.classList.add('active');
}
function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('active');
}
function openActionOverlay(nodeId) {
  closeModal();
  closeContextMenu();
  const item = items.find(i => i.id == nodeId);
  if (!item) return;
  // Copy email to clipboard and show toast
  navigator.clipboard.writeText(item.email).then(() => {
    showToast(`Copied ${item.provider} email.`);
  });
  document.getElementById('actionTitle').textContent = `Activate Node: ${item.provider}`;
  document.getElementById('actionEmail').value = item.email;
  const btnActivate = document.getElementById('btnActivateNode');
  const newBtnActivate = btnActivate.cloneNode(true);
  btnActivate.parentNode.replaceChild(newBtnActivate, btnActivate);
  newBtnActivate.onclick = () => {
    // Set to active and start timer
    item.status = 'active';
    item.lastUsed = Date.now();
    save();
    closeActionOverlay();
    renderAll();
    showToast(`${item.provider} Node Activated!`);
  };
  document.getElementById('actionOverlay').classList.add('active');
}
function openInfoModal() {
  document.getElementById('infoOverlay').classList.add('active');
}
// NEW: Close overlay when clicking background
document.querySelectorAll('.overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('active');
      closeContextMenu(); // Ensure context menu is also closed
    }
  });
});


// --- Initialization ---
function init() {
  load();
  const storedTheme = localStorage.getItem('iv_theme');
  if (storedTheme) {
    // Set theme index based on stored theme
    currentThemeIndex = themes.indexOf(storedTheme);
    if (currentThemeIndex === -1) currentThemeIndex = 0;
  
    document.body.setAttribute('data-theme', storedTheme);
    const logo = document.getElementById('logoImg');
    if (logo) {
      switch(storedTheme) {
        case 'light':
          logo.src = 'https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-dark.svg';
          break;
        case 'rose':
          logo.src = 'https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-rose.svg';
          break;
        default:
          logo.src = 'https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-light.svg';
      }
    }
  }
  // Ensure the correct view is active on load
  switchView(config.view);
  // Start the timer loop
  timerInterval = setInterval(updateAllTimers, 1000);
  // Initial render
  renderAll();
  canvas = document.getElementById('scatterCanvas');
  magnetCursor = document.getElementById('magnetCursor');
  // NEW: Grid background context menu handler
  const gridWrapper = document.getElementById('gridWrapper');
  gridWrapper.oncontextmenu = (e) => {
    if (e.target === gridWrapper) {
      e.preventDefault();
      showGridBackgroundContextMenu(e);
    }
  };
  // Scatter background context menu handler
  canvas.oncontextmenu = (e) => {
    if (!e.target.closest('.scatter-card')) {
      e.preventDefault();
      showScatterBackgroundContextMenu(e);
    }
  };
  updateGridDisplay();
  // --- Scatter Pan/Zoom Logic ---
  let lastPan = {
    x: 0,
    y: 0
  };
  let pointers = [];
  // Pan Logic (Mouse)
  canvas.addEventListener('pointerdown', (e) => {
    if (e.target.closest('.scatter-card')) return; // Card drag handles itself
    if (e.button === 0) { // Left click for pan
      e.preventDefault();
      scatter.panning = true;
      lastPan.x = e.clientX;
      lastPan.y = e.clientY;
      canvas.setPointerCapture(e.pointerId);
    }
  });
  canvas.addEventListener('pointermove', (e) => {
    if (scatter.panning) {
      const dx = e.clientX - lastPan.x;
      const dy = e.clientY - lastPan.y;
      scatter.transform.x += dx;
      scatter.transform.y += dy;
      lastPan.x = e.clientX;
      lastPan.y = e.clientY;
      applyScatterTransform();
    }
  });
  canvas.addEventListener('pointerup', (e) => {
    if (scatter.panning) {
      scatter.panning = false;
      canvas.releasePointerCapture(e.pointerId);
      save();
    }
  });
  // Zoom/Pinch Logic
  canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const zoomFactor = e.deltaY * -0.001; // Scale factor based on wheel speed
    zoom(zoomFactor, e.clientX, e.clientY);
    save();
  });
  // Touch/Pinch Logic (kept for completeness, though pan/zoom is main focus)
  canvas.addEventListener('touchstart', (e) => {
    pointers = Array.from(e.touches);
    if (pointers.length === 2) {
      const touch1 = pointers[0];
      const touch2 = pointers[1];
      scatter.pinchStart = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
    } else if (pointers.length === 1 && !e.target.closest('.scatter-card')) {
      lastPan.x = pointers[0].clientX;
      lastPan.y = pointers[0].clientY;
    }
  }, {
    passive: false
  });
  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault(); // Prevent page scroll during pan/zoom
    pointers = Array.from(e.touches);
    if (pointers.length === 2) {
      const touch1 = pointers[0];
      const touch2 = pointers[1];
      const currentDist = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
      const scaleChange = currentDist / scatter.pinchStart;
      const centerX = (touch1.clientX + touch2.clientX) / 2;
      const centerY = (touch1.clientY + touch2.clientY) / 2;
      const oldScale = scatter.transform.scale;
      let newScale = oldScale * scaleChange;
      // Clamp scale
      newScale = Math.max(0.25, Math.min(3, newScale));
      const scaleRatio = newScale / oldScale;
      scatter.transform.x = centerX - (centerX - scatter.transform.x) * scaleRatio;
      scatter.transform.y = centerY - (centerY - scatter.transform.y) * scaleRatio;
      scatter.transform.scale = newScale;
      scatter.pinchStart = currentDist; // Update pinchStart for next move
      applyScatterTransform();
    } else if (e.touches.length === 1 && !e.target.closest('.scatter-card')) {
      // Treat single touch move as pan if not dragging a card
      const touch = e.touches[0];
      const dx = touch.clientX - lastPan.x;
      const dy = touch.clientY - lastPan.y;
      scatter.transform.x += dx;
      scatter.transform.y += dy;
      lastPan.x = touch.clientX;
      lastPan.y = touch.clientY;
      applyScatterTransform();
    }
  }, {
    passive: false
  });
  canvas.addEventListener('touchend', (e) => {
    pointers = Array.from(e.touches);
    if (e.touches.length < 2) {
      scatter.pinchStart = 0;
      save();
    }
  });
  // Update stack position on move
  canvas.addEventListener('pointermove', (e) => {
    if (magneticEngaged) {
      const rect = canvas.getBoundingClientRect();
      const invScale = 1 / scatter.transform.scale;
      const cursorX = (e.clientX - rect.left - scatter.transform.x) * invScale;
      const cursorY = (e.clientY - rect.top - scatter.transform.y) * invScale;
      if (stackLeader) {
        stackLeader.pos.x = cursorX - 110; // Center card on cursor
        stackLeader.pos.y = cursorY - 80;
        const leaderCard = document.getElementById(`scatter-card-${stackLeader.id}`);
        leaderCard.style.left = `${stackLeader.pos.x}px`;
        leaderCard.style.top = `${stackLeader.pos.y}px`;
        // Stack others below leader
        const filtered = filterItems();
        filtered.slice(1).forEach((item, index) => {
          item.pos.x = stackLeader.pos.x + (index + 1) * stackOffset;
          item.pos.y = stackLeader.pos.y + (index + 1) * stackOffset;
          const card = document.getElementById(`scatter-card-${item.id}`);
          card.style.left = `${item.pos.x}px`;
          card.style.top = `${item.pos.y}px`;
        });
      }
      magnetCursor.style.left = `${e.clientX - 16}px`;
      magnetCursor.style.top = `${e.clientY - 16}px`;
    }
  });
  // Mobile double tap for magnetic
  let lastTap = 0;
  canvas.addEventListener('touchstart', (e) => {
    const now = new Date().getTime();
    if (now - lastTap < 300) {
      e.preventDefault();
      if (!magneticEngaged) {
        engageMagnetic();
      } else {
        disengageMagnetic();
      }
    }
    lastTap = now;
  });
}
window.addEventListener('load', init);
window.addEventListener('resize', () => {
    if (config.view === 'scatter') {
        applyScatterTransform(); // Re-center background on resize
    }
});
// === MODIFIED ZOOM FUNCTION (now supports center zoom when no cursor) ===
function zoom(delta, clientX = null, clientY = null) {
  const oldScale = scatter.transform.scale;
  const newScale = Math.max(0.25, Math.min(3, oldScale + delta));
  if (newScale === oldScale) return;
  const rect = canvas.getBoundingClientRect();
  const zoomX = (clientX !== null && clientY !== null)
    ? clientX - rect.left
    : rect.width / 2;
  const zoomY = (clientY !== null && clientY !== null)
    ? clientY - rect.top
    : rect.height / 2;
  const scaleRatio = newScale / oldScale;
  scatter.transform.x = zoomX - (zoomX - scatter.transform.x) * scaleRatio;
  scatter.transform.y = zoomY - (zoomY - scatter.transform.y) * scaleRatio;
  scatter.transform.scale = newScale;
  applyScatterTransform();
  save();
}
// === NEW: Zoom button helpers ===
function zoomIn() {
  zoom(0.25); // always center
}
function zoomOut() {
  zoom(-0.25); // always center
}
function resetView() {
  scatter.transform = { x: 0, y: 0, scale: 1 };
  applyScatterTransform();
  save();
}
function toggleAccordion(button) {
  const item = button.parentElement;
  const content = item.querySelector('.accordion-content');
  const isOpen = item.classList.contains('open');
  document.querySelectorAll('.accordion-item').forEach(i => {
    i.classList.remove('open');
    i.querySelector('.accordion-content').style.maxHeight = 0;
  });
  if (!isOpen) {
    item.classList.add('open');
    content.style.maxHeight = content.scrollHeight + 'px';
  }
}




</script>
</body>
</html>
