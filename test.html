<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>i n t o v i e w : N.O.D.E. Enhanced</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #050505;
      --card-bg: #111111;
      --ink: #ffffff;
      --ink-dim: #888888;
      --accent: #FFED29;
      
      --neon-green: #22c55e;
      --neon-orange: #f97316;
      --neon-red: #ef4444;
      --neon-blue: #3b82f6;
      
      --glass-bg: rgba(20, 20, 20, 0.85);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-blur: 16px;
      
      --nav-height: 80px;
      --header-height: 100px;
      --font-mono: 'JetBrains Mono', monospace;
      --font-sans: 'Inter', sans-serif;
      
      /* Cinematic effects */
      --edge-blur-amount: 8px;
      --vignette-strength: 0.85;
      --vignette-size: 50%;
    }

    [data-theme="light"] {
      --bg-color: #f0f0f0;
      --card-bg: #ffffff;
      --ink: #111111;
      --ink-dim: #666666;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(0, 0, 0, 0.1);
    }

    [data-theme="rose"] {
      --bg-color: #1a0a0f;
      --card-bg: #2d1419;
      --ink: #FFE5EC;
      --ink-dim: #FFB3C1;
      --accent: #FF8DA1;
      
      --neon-green: #4ADE80;
      --neon-orange: #FB923C;
      --neon-red: #F87171;
      --neon-blue: #60A5FA;
      
      --glass-bg: rgba(255, 141, 161, 0.15);
      --glass-border: rgba(255, 141, 161, 0.3);
      
      /* Enhanced rose theme colors */
      --rose-primary: #FF8DA1;
      --rose-secondary: #FF6B8B;
      --rose-accent: #FFC0CB;
      --rose-dark: #D63384;
      --rose-light: #FFE0E9;
      --retro-yellow: #FFD93D;
      --retro-blue: #6BCB77;
      --retro-purple: #4D96FF;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    html, body { height: 100%; font-family: var(--font-sans); background: var(--bg-color); color: var(--ink); overflow: hidden; }

    /* --- Cinematic Visual Effects --- */
    body {
      position: relative;
    }

    /* Edge Blur Effect */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      box-shadow: 
        inset 0 0 var(--edge-blur-amount) rgba(255, 255, 255, 0.1),
        inset 0 0 calc(var(--edge-blur-amount) * 2) rgba(255, 255, 255, 0.05);
      pointer-events: none;
      z-index: 1000;
    }

    /* Vignette Effect */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        ellipse at center,
        transparent 0%,
        transparent var(--vignette-size),
        rgba(0, 0, 0, calc(1 - var(--vignette-strength))) 100%
      );
      pointer-events: none;
      z-index: 999;
    }

    [data-theme="light"] body::after {
      background: radial-gradient(
        ellipse at center,
        transparent 0%,
        transparent var(--vignette-size),
        rgba(0, 0, 0, calc(1 - var(--vignette-strength))) 100%
      );
    }

    [data-theme="rose"] body::after {
      background: radial-gradient(
        ellipse at center,
        rgba(255, 141, 161, 0.05) 0%,
        transparent var(--vignette-size),
        rgba(139, 0, 50, calc(1 - var(--vignette-strength))) 100%
      );
    }

    /* --- Custom Scrollbar Design --- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--ink-dim); }

    /* --- Typography & Utilities --- */
    .text-green { color: var(--neon-green); }
    .text-orange { color: var(--neon-orange); }
    .text-red { color: var(--neon-red); }
    .text-blue { color: var(--neon-blue); }
    .text-rose { color: var(--rose-primary); }
    
    /* Rose theme specific utilities */
    [data-theme="rose"] .text-green { color: var(--retro-blue); }
    [data-theme="rose"] .text-orange { color: var(--retro-yellow); }
    [data-theme="rose"] .text-red { color: var(--rose-secondary); }
    [data-theme="rose"] .text-blue { color: var(--retro-purple); }

    /* --- Layout Structure --- */
    .app-header {
      position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
      display: flex; flex-direction: column; justify-content: center;
      padding: 10px 0; z-index: 100;
      background: linear-gradient(to bottom, var(--bg-color) 40%, transparent);
      pointer-events: none;
    }
    .header-top { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 0 20px; width: 100%; pointer-events: auto; 
    }
    
    /* Logo Styling */
    .logo { 
        display: flex; align-items: center; height: 32px; 
    }
    /* Logo Image Sizing */
    .logo img{
        height: 32px; /* Enforce size for the SVG */
        width: auto;
        transition: filter 0.3s ease, transform 0.3s ease;
    }
    
    .logo:hover img {
        transform: scale(1.05);
        filter: drop-shadow(0 0 8px var(--accent));
    }

    /* Text Logo Fallback */
    .logo-text {
      font-family: var(--font-mono);
      font-weight: 800;
      font-size: 20px;
      letter-spacing: -1px;
      color: var(--ink);
      display: flex; align-items: center; gap: 8px;
    }
    .logo-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); }

    .header-buttons { display: flex; align-items: center; gap: 8px; margin-left: auto; }

    .theme-btn {
        background: transparent; border: none; color: var(--ink-dim);
        cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center;
        transition: all 0.3s ease;
    }
    .theme-btn:hover { color: var(--ink); background: var(--glass-border); transform: scale(1.1); }
    .theme-btn:active { background: var(--glass-border); color: var(--ink); transform: scale(0.95); }

    /* --- Provider Toggle Bar --- */
    .provider-bar {
      display: flex; gap: 8px; overflow-x: auto; padding: 10px 20px;
      pointer-events: auto; scrollbar-width: none;
      justify-content: flex-start; 
    }
    .provider-bar::-webkit-scrollbar { display: none; }
    
    .pill {
      padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;
      background: var(--glass-bg); border: 1px solid var(--glass-border);
      color: var(--ink-dim); white-space: nowrap; cursor: pointer; transition: all 0.2s;
      flex-shrink: 0; 
    }
    .pill.active { background: var(--ink); color: var(--bg-color); border-color: var(--ink); }
    .pill.add-btn { border-style: dashed; }
    
    /* Rose theme pill styling */
    [data-theme="rose"] .pill.active {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
      border-color: var(--rose-primary);
      box-shadow: 0 0 12px rgba(255, 141, 161, 0.5);
    }

    .view-container {
      position: absolute; inset: 0;
      top: var(--header-height); bottom: 0;
      overflow: hidden; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .view-container.active { opacity: 1; pointer-events: auto; }

    /* --- Grid View --- */
    #gridContainer { overflow-y: auto; padding: 10px 16px 120px 16px; }
    .grid-wrapper {
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 16px; 
      padding-bottom: 40px;
    }
    @media(min-width: 600px) { .grid-wrapper { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); } }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      display: flex; flex-direction: column; gap: 12px;
      transition: transform 0.2s, background 0.2s, box-shadow 0.3s ease;
      cursor: pointer;
    }
    .card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    [data-theme="rose"] .card:hover {
      box-shadow: 0 8px 24px rgba(255, 141, 161, 0.3);
    }
    .card:active { transform: scale(0.98); background: var(--glass-border); }

    .card-top { display: flex; justify-content: space-between; align-items: center; }
    .card-provider { font-weight: 600; font-size: 14px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
    
    /* UPDATED STATUS DOT */
    .status-dot { 
        width: 8px; height: 8px; 
        border-radius: 50%; 
        background-color: currentColor; /* SOLID FILL */
        box-shadow: 0 0 6px currentColor, 0 0 12px currentColor; /* DOUBLE GLOW */
        animation: pulse 2s infinite ease-in-out; 
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
    }

    /* Edit Icon Style */
    .card-edit-icon {
      color: var(--ink-dim); padding: 4px; border-radius: 4px;
      transition: color 0.2s, background 0.2s;
      margin-left: 8px;
    }
    .card-edit-icon:hover { color: var(--ink); background: rgba(255,255,255,0.1); }

    .card-timer {
      font-family: var(--font-mono);
      font-size: 2.4rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: -1px;
      margin: 8px 0;
      position: relative;
    }

    .card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--ink-dim); border-top: 1px solid var(--glass-border); padding-top: 12px; }
    .card-email { font-family: var(--font-mono); opacity: 0.8; }
    
    .card-actions { display: flex; gap: 8px; }
    .action-icon { 
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; 
      border-radius: 6px; background: rgba(255,255,255,0.05); cursor: pointer;
      color: var(--ink-dim); transition: 0.2s;
    }
    .action-icon:hover { background: var(--accent); color: #000; }
    
    [data-theme="rose"] .action-icon:hover {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
    }

    .card.burnt, .scatter-card.burnt {
      opacity: 0.6;
    }

    .card.burnt .card-edit-icon, .scatter-card.burnt .card-edit-icon {
      opacity: 1;
    }

    .burnt-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-family: var(--font-mono);
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--neon-red);
      opacity: 0.7;
      pointer-events: none;
    }

    [data-theme="rose"] .burnt-label {
      color: var(--rose-secondary);
      text-shadow: 0 0 8px var(--rose-secondary);
    }

    .scatter-card .burnt-label {
      font-size: 1.2rem;
    }

    /* --- Scatter View --- */
    #scatterContainer { 
        overflow: hidden; 
        background-image: radial-gradient(var(--glass-border) 1px, transparent 1px);
        background-size: 40px 40px;
    }
    
    [data-theme="rose"] #scatterContainer {
        background-image: radial-gradient(rgba(255, 141, 161, 0.2) 1px, transparent 1px);
    }
    
    .scatter-canvas { 
        width: 100%; height: 100%; position: relative; 
        will-change: transform; 
        touch-action: none; 
    }
    .scatter-card {
      position: absolute;
      width: 220px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; align-items: center;
      user-select: none;
      transition: box-shadow 0.2s;
      cursor: pointer;
    }
    
    [data-theme="rose"] .scatter-card {
      box-shadow: 0 10px 30px rgba(255, 141, 161, 0.2);
    }
    
    .scatter-card.is-dragging {
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        z-index: 1000 !important;
        cursor: grabbing;
    }
    
    [data-theme="rose"] .scatter-card.is-dragging {
      box-shadow: 0 20px 50px rgba(255, 141, 161, 0.4);
    }
    
    .scatter-card .card-timer { font-size: 1.4rem; margin: 4px 0; position: relative; }
    .scatter-card .card-provider { font-size: 11px; }
    .scatter-card .card-meta { 
        display: block; 
        text-align: center; 
        font-size: 11px; 
        color: var(--ink-dim); 
        margin-top: 8px; 
        border-top: 1px solid var(--glass-border); 
        padding-top: 8px; 
        width: 100%; 
    }

    /* --- Bottom Navigation (Dock) --- */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 92%; max-width: 400px;
      height: 64px;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: 32px;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 8px 0 16px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      z-index: 200;
    }
    
    [data-theme="rose"] .bottom-nav {
      background: rgba(255, 141, 161, 0.15);
      border-color: rgba(255, 141, 161, 0.3);
      box-shadow: 0 20px 40px rgba(255, 141, 161, 0.2);
    }

    .nav-group { display: flex; align-items: center; gap: 4px; }
    
    .nav-btn {
      width: 48px; height: 48px;
      border-radius: 50%;
      border: none; background: transparent;
      color: var(--ink-dim);
      font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn.active { color: var(--ink); background: rgba(255,255,255,0.1); }
    .nav-btn.primary { background: var(--accent); color: #000; transform: scale(1.1); box-shadow: 0 0 15px var(--accent); }
    .nav-btn.primary:active { transform: scale(1.0); }
    
    [data-theme="rose"] .nav-btn.primary {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
      box-shadow: 0 0 20px rgba(255, 141, 161, 0.6);
    }

    .filter-pill-btn {
        background: var(--glass-border);
        height: 40px;
        width: 120px;
        padding: 0 16px;
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        color: var(--ink);
        display: flex; align-items: center; justify-content: flex-start;
        gap: 8px;
        font-size: 11px; font-weight: 700; text-transform: uppercase;
        margin-right: 8px; cursor: pointer;
        transition: all 0.2s;
    }
    .filter-pill-btn:active { transform: scale(0.95); }
    .filter-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ink-dim); box-shadow: 0 0 5px currentColor; flex-shrink: 0; }

    /* --- Modals & Overlays --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
      z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s;
      display: flex; align-items: flex-end;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }
    @media(min-width: 600px) { .overlay { align-items: center; justify-content: center; } }

    .modal-sheet {
      position: relative; 
      width: 100%; background: var(--bg-color);
      border-top: 1px solid var(--glass-border);
      border-radius: 24px 24px 0 0;
      padding: 24px;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      max-height: 85vh; overflow-y: auto;
    }
    .overlay.active .modal-sheet { transform: translateY(0); }
    @media(min-width: 600px) { 
      .modal-sheet { max-width: 400px; border-radius: 24px; border: 1px solid var(--glass-border); transform: scale(0.95); }
      .overlay.active .modal-sheet { transform: scale(1); }
    }
    
    [data-theme="rose"] .modal-sheet {
      background: linear-gradient(135deg, var(--bg-color) 0%, rgba(45, 20, 25, 0.8) 100%);
      border-color: var(--rose-primary);
    }
    
    .close-btn { 
       position: absolute; top: 16px; right: 16px; 
       background: transparent; border: none; color: var(--ink-dim); 
       cursor: pointer; padding: 8px; border-radius: 50%; z-index: 10;
       transition: color 0.2s;
    }
    .close-btn:hover { color: var(--ink); }

    /* --- Dialogs (Confirm & Action) --- */
    .confirm-dialog {
        background: var(--card-bg); border: 1px solid var(--glass-border);
        padding: 24px; border-radius: 16px; width: 90%; max-width: 320px;
        text-align: center;
        margin-bottom: 40vh; 
    }
    .overlay.active .confirm-dialog { animation: fadeIn 0.1s ease; }
    @media(min-width: 600px) { .confirm-dialog { margin-bottom: 0; } }
    
    [data-theme="rose"] .confirm-dialog {
      background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 141, 161, 0.1) 100%);
      border-color: var(--rose-primary);
    }
    
    .confirm-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .confirm-text { font-size: 13px; color: var(--ink-dim); margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 10px; }

    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: 600; color: var(--ink-dim); margin-bottom: 6px; text-transform: uppercase; }
    
    .input-wrapper { position: relative; width: 100%; }
    .input-wrapper input { padding-right: 40px; }
    .input-icon-btn {
      position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
      background: none; border: none; color: var(--ink-dim); cursor: pointer;
      padding: 4px; border-radius: 4px;
    }
    .input-icon-btn:hover { color: var(--accent); background: rgba(255,255,255,0.1); }
    
    [data-theme="rose"] .input-icon-btn:hover { color: var(--rose-primary); }

    input, select {
      width: 100%; padding: 16px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
      border-radius: 12px; color: var(--ink); font-size: 16px;
      font-family: var(--font-sans); padding-right: 32px; 
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); background: rgba(255,255,255,0.1); }
    
    [data-theme="rose"] input:focus, [data-theme="rose"] select:focus { 
      border-color: var(--rose-primary); 
      background: rgba(255, 141, 161, 0.1); 
    }
    
    .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%23888' d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
    }

    .status-toggles { display: flex; gap: 8px; }
    .btn-toggle {
       flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; border: 1px solid var(--glass-border); 
       background: transparent; cursor: pointer; transition: all 0.2s; font-size: 14px;
       line-height: 1;
    }
    .btn-toggle.selected { color: var(--bg-color); border-color: currentColor; }
    .btn-toggle[data-status="active"].selected { background: var(--accent); color: #000; border-color: var(--accent); }
    .btn-toggle[data-status="ready"].selected { background: var(--neon-green); color: #000; border-color: var(--neon-green); }
    .btn-toggle[data-status="cooldown"].selected { background: var(--neon-orange); color: #000; border-color: var(--neon-orange); }
    .btn-toggle[data-status="burnt"].selected { background: var(--neon-red); color: #000; border-color: var(--neon-red); }
    
    [data-theme="rose"] .btn-toggle[data-status="ready"].selected { background: var(--retro-blue); }
    [data-theme="rose"] .btn-toggle[data-status="cooldown"].selected { background: var(--retro-yellow); }
    [data-theme="rose"] .btn-toggle[data-status="burnt"].selected { background: var(--rose-secondary); }

    .pill-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .pill-option {
       padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center;
       background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
       cursor: pointer; transition: all 0.2s; line-height: 1.2;
    }
    .pill-option:hover { background: rgba(255,255,255,0.1); }
    .pill-option.selected { background: var(--accent); color: #000; border-color: var(--accent); }
    
    [data-theme="rose"] .pill-option.selected { 
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary)); 
      color: white; 
      border-color: var(--rose-primary); 
    }
    
    .btn-block { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; border: none; font-size: 14px; text-transform: uppercase; cursor: pointer; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-secondary { background: var(--glass-border); color: var(--ink); margin-top: 12px; }
    .btn-danger { background: rgba(239,68,68,0.2); color: var(--neon-red); margin-top: 12px; border: 1px solid rgba(239,68,68,0.5); }
    
    [data-theme="rose"] .btn-primary { 
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary)); 
      color: white; 
    }
    [data-theme="rose"] .btn-danger { 
      background: rgba(255, 107, 139, 0.2); 
      color: var(--rose-secondary); 
      border-color: rgba(255, 107, 139, 0.5); 
    }
    
    .btn-half { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }
    .btn-cancel { background: transparent; color: var(--ink-dim); border: 1px solid var(--glass-border); }
    .btn-confirm { background: var(--accent); color: #000; }
    
    [data-theme="rose"] .btn-confirm { 
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary)); 
      color: white; 
    }

    /* --- Accordion Styles --- */
    .accordion-item {
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        margin-bottom: 8px;
        overflow: hidden;
        transition: all 0.2s;
    }
    .accordion-header {
        width: 100%;
        background: transparent;
        border: none;
        padding: 16px;
        text-align: left;
        color: var(--ink);
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .accordion-header:hover { background: rgba(255, 255, 255, 0.05); }
    .accordion-icon { transition: transform 0.3s ease; }
    .accordion-item.open .accordion-icon { transform: rotate(180deg); }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .accordion-content-inner { padding: 0 16px 16px 16px; font-size: 14px; color: var(--ink-dim); line-height: 1.6; }
    .accordion-content-inner ul { list-style-type: 'â€”  '; margin-left: 20px; padding-left: 0; }
    .accordion-content-inner li { margin-bottom: 6px; padding: 4px 0; }
    
    /* --- Utilities --- */
    .toast {
      position: fixed; top: 120px; left: 50%; transform: translateX(-50%) translateY(-20px);
      background: var(--accent); color: #000; padding: 10px 20px; border-radius: 20px;
      font-weight: 700; font-size: 12px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 500;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    
    [data-theme="rose"] .toast {
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary));
      color: white;
    }
    
    /* Scatter Specific Mobile Controls */
    .scatter-controls {
      position: fixed; bottom: 100px; right: 20px; display: none; flex-direction: column; gap: 10px; z-index: 150;
    }
    .scatter-controls.visible { display: flex; }
    .control-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--ink); font-size: 16px; backdrop-filter: blur(10px); cursor: pointer; }

    /* --- Context Menu --- */
    .context-menu {
      position: fixed; display: none; 
      background: var(--card-bg); border: 1px solid var(--glass-border);
      border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 1000; width: 220px; overflow: hidden;
      backdrop-filter: blur(12px);
    }
    
    [data-theme="rose"] .context-menu {
      background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 141, 161, 0.1) 100%);
      border-color: var(--rose-primary);
      box-shadow: 0 10px 40px rgba(255, 141, 161, 0.3);
    }
    
    .context-menu.active { display: block; animation: fadeIn 0.1s ease; }
    .ctx-header { padding: 8px 12px; font-size: 10px; text-transform: uppercase; color: var(--ink-dim); border-bottom: 1px solid var(--glass-border); letter-spacing: 1px; }
    .ctx-item { 
      padding: 12px 16px; font-size: 14px; color: var(--ink); cursor: pointer; display: flex; align-items: center; gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.02);
      transition: background 0.2s;
    }
    .ctx-item:hover { background: var(--accent); color: #000; }
    .ctx-item:last-child { border-bottom: none; }
    
    [data-theme="rose"] .ctx-item:hover { 
      background: linear-gradient(135deg, var(--rose-primary), var(--rose-secondary)); 
      color: white; 
    }
    
    @keyframes fadeIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }

    /* --- Retro/Pop Art Enhancements for Rose Theme --- */
    [data-theme="rose"] .card {
      position: relative;
      overflow: hidden;
    }
    
    [data-theme="rose"] .card::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--rose-primary), var(--retro-yellow), var(--retro-blue), var(--rose-secondary));
      border-radius: 16px;
      opacity: 0;
      z-index: -1;
      transition: opacity 0.3s ease;
    }
    
    [data-theme="rose"] .card:hover::before {
      opacity: 0.3;
      animation: retroGlow 2s linear infinite;
    }
    
    @keyframes retroGlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    [data-theme="rose"] .status-dot {
      animation: rosePulse 1.5s infinite ease-in-out;
    }
    
    @keyframes rosePulse {
      0%, 100% { 
        opacity: 0.8; 
        transform: scale(1); 
        box-shadow: 0 0 8px currentColor, 0 0 16px currentColor; 
      }
      50% { 
        opacity: 1; 
        transform: scale(1.3); 
        box-shadow: 0 0 12px currentColor, 0 0 24px currentColor, 0 0 36px currentColor; 
      }
    }
  </style>

</head>
<body data-theme="dark">

<header class="app-header">
<div class="header-top">
<div class="logo">
<img id="logoImg" src="https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-light.svg" alt="IntoView Logo" style="height: 32px;">
</div>
  
  <div class="header-buttons">
    <button class="theme-btn info-btn" onclick="openInfoModal()" title="Information & Help">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
    </button>
    <button class="theme-btn" onclick="toggleTheme()" title="Toggle Theme">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path></svg>
    </button>
  </div>
</div>
  
  <div class="provider-bar" id="providerBar"></div>
</header>

<div id="gridContainer" class="view-container active">
  <div class="grid-wrapper" id="gridWrapper"></div>
</div>

<div id="scatterContainer" class="view-container">
  <div class="scatter-canvas" id="scatterCanvas"></div>
</div>

<div class="scatter-controls" id="scatterControls">
  <button class="control-btn" onclick="autoArrange()" id="wandBtn" title="Auto-Arrange">ðŸŽ¨</button>
  <button class="control-btn" onclick="zoom(0.1, window.innerWidth/2, window.innerHeight/2)" title="Zoom In">+</button>
  <button class="control-btn" onclick="zoom(-0.1, window.innerWidth/2, window.innerHeight/2)" title="Zoom Out">-</button>
</div>

<div id="contextMenu" class="context-menu"></div>

<nav class="bottom-nav">
  <div class="nav-group">
    <button class="nav-btn active" data-view="grid" onclick="switchView('grid')" title="Grid View">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4 11h7V4H4v7zm0 9h7v-7H4v7zm9 0h7v-7h-7v7zm0-16v7h7V4h-7z"></path></svg>
    </button>
    <button class="nav-btn" data-view="scatter" onclick="switchView('scatter')" title="Free Form">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="3"></circle><circle cx="19" cy="5" r="2"></circle><circle cx="5" cy="19" r="2"></circle><circle cx="5" cy="5" r="2"></circle><circle cx="19" cy="19" r="2"></circle></svg>
    </button>
  </div>

  <button class="nav-btn primary" onclick="openModal()">+</button>

  <button class="filter-pill-btn" onclick="cycleStatusFilter()" id="statusPill" title="Active â€¢ Ready â€¢ Cooling â€¢ Burnt">
    <div class="filter-dot" id="filterDot"></div>
    <span id="filterLabel">All</span>
  </button>
</nav>

<div class="overlay" id="providerSelectOverlay">
</div>

<div class="overlay" id="modalOverlay">
<div class="modal-sheet">
  <button class="close-btn" onclick="closeModal()">
     <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
  </button>
  
  <h2 style="margin-bottom:20px; font-family:var(--font-mono)" id="modalTitle">New Node</h2>
  <form id="nodeForm">
    <input type="hidden" id="nodeId">
    
    <div class="form-group">
    <label for="inpProvider">Provider</label>
    <select id="inpProvider" required>
      </select>
  </div>
    
    <div class="form-group">
      <label>Email / Identity</label>
      <div class="input-wrapper">
        <input type="text" id="inpEmail" required autocomplete="off">
        <button type="button" class="input-icon-btn" onclick="copyInput('inpEmail')">
           <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
      </div>
    </div>

    <div class="form-group">
      <label>Current Status</label>
      <div class="status-toggles">
        <button type="button" data-status="active" class="btn-toggle text-blue" onclick="selectStatusButton('active')">Active</button>
        <button type="button" data-status="ready" class="btn-toggle text-green" onclick="selectStatusButton('ready')">Ready</button>
        <button type="button" data-status="cooldown" class="btn-toggle text-orange" onclick="selectStatusButton('cooldown')">Cooldown</button>
        <button type="button" data-status="burnt" class="btn-toggle text-red" onclick="selectStatusButton('burnt')">Burnt</button>
      </div>
      <input type="hidden" id="inpStatus" value="ready">
    </div>
    
    <div class="form-group">
      <label>Reset Cycle (Hours)</label>
      <div class="pill-grid">
         <div class="pill-option selected" data-hours="3" onclick="selectResetHours(3)">3h</div>
         <div class="pill-option" data-hours="6" onclick="selectResetHours(6)">6h</div>
         <div class="pill-option" data-hours="12" onclick="selectResetHours(12)">12h</div>
         <div class="pill-option" data-hours="24" onclick="selectResetHours(24)">24h</div>
         <div class="pill-option" data-hours="48" onclick="selectResetHours(48)">48h</div>
         <div class="pill-option" data-hours="72" onclick="selectResetHours(72)">72h</div>
      </div>
      <input type="number" id="inpResetCustom" placeholder="Custom Hours" style="margin-top: 8px;" step="0.5">
      <input type="hidden" id="inpReset" value="3">
    </div>

    <div id="editActions" style="display:none; margin-top:12px; display:flex; gap:10px;">
       <button type="button" class="btn-block btn-secondary" onclick="confirmHitLimit(null)">ðŸ”¥ Hit Limit</button>
       <button type="button" class="btn-block btn-secondary" onclick="confirmForceRestore(null)">ðŸ”„ Restore</button>
    </div>

    <button type="submit" class="btn-block btn-primary" style="margin-top: 12px;">Save Node</button>
    
    <button type="button" class="btn-block btn-danger" id="btnDelete" style="display:none" onclick="deleteNode()">Delete Node</button>
    <div style="height:20px"></div>
  </form>
</div>
</div>

<div class="overlay" id="confirmOverlay">
   <div class="confirm-dialog">
      <div class="confirm-title" id="confirmTitle">Confirm Action</div>
      <div class="confirm-text" id="confirmText">Are you sure?</div>
      <div class="confirm-actions">
         <button class="btn-half btn-cancel" onclick="closeConfirm()">Cancel</button>
         <button class="btn-half btn-confirm" id="btnConfirmAction">Confirm</button>
      </div>
   </div>
</div>

<div class="overlay" id="actionOverlay">
   <div class="confirm-dialog">
      <div class="confirm-title" id="actionTitle">Activate Node</div>
      <div class="confirm-text">Email copied to clipboard:</div>
      <input type="text" id="actionEmail" readonly style="margin-bottom:20px; text-align:center;">
      <div class="confirm-actions">
         <button class="btn-half btn-cancel" onclick="closeActionOverlay()">Cancel</button>
         <button class="btn-half btn-confirm" id="btnActivateNode">Activate</button>
      </div>
   </div>
</div>

<div class="overlay" id="infoOverlay">
  <div class="modal-sheet">
    <button class="close-btn" onclick="closeInfoModal()">
       <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
    </button>
    
    <h2 style="margin-bottom:20px; font-family:var(--font-mono)">fyi:</h2>

    <div style="margin-bottom: 24px; padding: 16px; border-radius: 12px; background: rgba(255,255,255,0.05);">
      <h3 style="font-weight: 700; font-size: 16px; color: var(--accent); margin-bottom: 8px;">The Node Manifesto:</h3>
      <p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;">
      <p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;"><strong>You are an infinite machine</strong> in a <em>finite prompt cycle</em>; but do not yield for here is a tool for the commonwealth of the commonfolk. <br><br>
        Use the timer not as a limiter, but as a catalyst to creation.<br><br>Let each cooldown be a reset, every burnt node a lesson, and each new node a launchpad.</p>
    </div>

    <div style="margin-bottom: 24px; padding: 16px; border-radius: 12px; background: rgba(255,255,255,0.05);">
      <h3 style="font-weight: 700; font-size: 16px; color: var(--accent); margin-bottom: 8px;">âœ¨ Enhanced Features:</h3>
      <p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;">
        This version includes:<br>
        â€¢ ðŸŽ¬ Cinematic edge blur & vignette effects<br>
        â€¢ ðŸŽ¨ New Rose/Pink theme with retro pop art vibes<br>
        â€¢ ðŸŒ¸ Theme-aware logo switching<br>
        â€¢ âœ¨ Enhanced animations & interactions
      </p>
    </div>

    <div id="accordionContainer">
      
      <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)">
          <span>Interaction & Shortcuts</span>
          <svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
        </button>
        <div class="accordion-content">
          <div class="accordion-content-inner">
            <ul style="list-style-type: none; padding: 0;">
              <li><strong style="color: var(--accent);">Tap Card (Grid/Scatter):</strong> Open Edit Modal (View Details).</li>
              <li><strong style="color: var(--accent);">Right-Click / Long-Press Card:</strong> Quick Action Menu (Hit Limit / Restore / View Details).</li>
              <li><strong style="color: var(--accent);">Right-Click / Long-Press Provider Pill:</strong> Manage Provider (Edit Name / Delete / New).</li>
              <li><strong style="color: var(--accent);">Right-Click / Long-Press Background (Scatter Mode):</strong> Arrangement & Sorting menu.</li>
              <li><strong style="color: var(--accent);">Drag Card (Scatter Mode):</strong> Move the node freely.</li>
              <li><strong style="color: var(--accent);">Drag Background:</strong> Scroll / Pan / Zoom / Sort / Arrange</li>
              <li><strong style="color: var(--accent);">Theme Toggle:</strong> Switches between Dark, Light, and Rose themes.</li>
              <li><strong style="color: var(--accent);">Status Pill (Bottom Right):</strong> Cycles the global filter (All -> Active -> Cooldown -> Burnt).</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)">
          <span>Status & Timing</span>
          <svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
        </button>
        <div class="accordion-content">
          <div class="accordion-content-inner">
            <ul>
              <li style="color: var(--neon-green);">**Active:** Actively in use. Timer shows 00:00:00.</li>
              <li style="color: var(--neon-blue);">**Ready:** Ready to use. Timer shows 00:00:00.</li>
              
              <li style="color: var(--neon-orange);">**Cooldown:** In use, waiting for the limit to reset. Timer shows time remaining (based on *Reset Cycle*).</li>
              <li style="color: var(--neon-red);">**Burnt:** Permanently defunct or retired.</li>
              <li style="margin-top: 12px; color: var(--ink-dim); font-size: 13px; list-style-type: none;">*The timer counts down from the last "Hit Limit" event to the pre-selected "Reset Cycle" duration.*</li>
            </ul>
          </div>
        </div>
      </div>

    </div>
    
    <a href="https://emdash.click" target="_blank" style="display: block; text-align: center; margin-top: 30px; text-decoration: none;">
       <button class="btn-block btn-secondary" style="background: var(--glass-border); color: var(--ink-dim);">
          <span style="font-weight: 400;">Something useful @</span><strong style="color: var(--ink); font-weight: 700;"> emdash.click</strong>
       </button>
    </a>

    <div style="height:20px"></div>
  </div>
</div>


<div class="toast" id="toast">Copied to Clipboard</div>="toast" id="toast">Copied to Clipboard</div>


<script>
  // --- State & Config ---
  let items = [];
  let providers = [];
  let config = { filterStatus: 'all', filterProvider: 'all', view: 'scatter' };
  let scatter = { x: 0, y: 0, scale: 1 };
  let timerInterval = null;
  
  // --- Load / Save ---
  function load() {
    const sItems = localStorage.getItem('iv_items');
    const sProv = localStorage.getItem('iv_providers');
    const sView = localStorage.getItem('iv_view');
    const sTrans = localStorage.getItem('iv_scatterTransform');
    
    if (sItems) items = JSON.parse(sItems);
    else seedMockData();
    
    if (sProv) providers = JSON.parse(sProv);
    else providers = ['ChatGPT', 'Claude', 'Gemini', 'Perplexity', 'Midjourney'];
    
    if (sView) config.view = sView;
    if (sTrans) scatter = JSON.parse(sTrans);
  }
  
  function save() {
    localStorage.setItem('iv_items', JSON.stringify(items));
    localStorage.setItem('iv_providers', JSON.stringify(providers));
    localStorage.setItem('iv_view', config.view);
    localStorage.setItem('iv_scatterTransform', JSON.stringify(scatter));
  }
  
  function seedMockData() {
    const statuses = ['active', 'ready', 'cooldown', 'burnt'];
    for(let i=0; i<8; i++) {
      items.push({
        id: Date.now() + i,
        provider: providers[i % providers.length],
        email: `user_${i}@ai.com`,
        status: statuses[i%4],
        resetHours: 3,
        lastUsed: Date.now(),
        pos: { x: 50 + (i%3)*260, y: 100 + Math.floor(i/3)*180 }
      });
    }
  }
  
  // --- View Logic ---
  function switchView(viewName) {
    config.view = viewName;
    document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    
    document.getElementById(`${viewName}Container`).classList.add('active');
    document.querySelector(`.nav-btn[data-view="${viewName}"]`).classList.add('active');
    
    const ctrl = document.getElementById('scatterControls');
    if(viewName === 'scatter') {
        ctrl.classList.add('visible');
        renderScatter();
    } else {
        ctrl.classList.remove('visible');
        renderGrid();
    }
    save();
  }
  
  // --- Filtering Logic (Unified) ---
  function filterItems() {
    let res = items;
    if (config.filterStatus !== 'all') {
      res = res.filter(i => i.status === config.filterStatus);
    }
    if (config.filterProvider !== 'all') {
      res = res.filter(i => i.provider === config.filterProvider);
    }
    return res;
  }
  
  function cycleStatusFilter() {
    const s = ['all', 'active', 'ready', 'cooldown', 'burnt'];
    let idx = s.indexOf(config.filterStatus);
    config.filterStatus = s[(idx + 1) % s.length];
    
    updateFilterUI();
    config.view === 'grid' ? renderGrid() : renderScatter();
    showToast(`Filter: ${config.filterStatus.toUpperCase()}`);
  }
  
  function setProviderFilter(prov) {
    config.filterProvider = prov;
    renderProviderBar();
    config.view === 'grid' ? renderGrid() : renderScatter();
  }
  
  function updateFilterUI() {
      const dot = document.getElementById('filterDot');
      const label = document.getElementById('filterLabel');
      label.innerText = config.filterStatus.toUpperCase();
      
      const colors = { all: '#888', active: '#3b82f6', ready: '#22c55e', cooldown: '#f97316', burnt: '#ef4444' };
      dot.style.background = colors[config.filterStatus];
      dot.style.boxShadow = `0 0 8px ${colors[config.filterStatus]}`;
  }
  
  // --- Rendering ---
  function renderProviderBar() {
      const bar = document.getElementById('providerBar');
      bar.innerHTML = `<div class="pill ${config.filterProvider==='all'?'active':''}" onclick="setProviderFilter('all')">All</div>`;
      providers.forEach(p => {
          bar.innerHTML += `<div class="pill ${config.filterProvider===p?'active':''}" onclick="setProviderFilter('${p}')">${p}</div>`;
      });
      bar.innerHTML += `<div class="pill add-btn" onclick="addNewProvider()">+ New</div>`;
  }
  
  function getCardHTML(item) {
      const isReady = item.status === 'ready';
      const isCool = item.status === 'cooldown';
      const isBurnt = item.status === 'burnt';
      
      let colorClass = 'text-blue';
      if(isReady) colorClass = 'text-green';
      if(isCool) colorClass = 'text-orange';
      if(isBurnt) colorClass = 'text-red';
      
      return `
          <div class="card-top">
              <span class="card-provider">${item.provider}</span>
              <div style="display:flex; align-items:center; gap:6px">
                  <div class="status-dot ${colorClass}"></div>
                  <span style="font-size:10px; font-weight:700; opacity:0.7">${item.status.toUpperCase()}</span>
              </div>
          </div>
          <div class="card-timer" id="timer-${item.id}">00:00:00</div>
          <div class="card-meta">
              <span>${item.email}</span>
          </div>
      `;
  }
  
  function renderGrid() {
      const wrap = document.getElementById('gridWrapper');
      wrap.innerHTML = '';
      filterItems().forEach(item => {
          const el = document.createElement('div');
          el.className = `card ${item.status==='burnt'?'burnt':''}`;
          el.innerHTML = getCardHTML(item);
          el.onclick = () => openModal(item.id);
          wrap.appendChild(el);
      });
      updateTimers();
  }
  
  function renderScatter() {
      const canvas = document.getElementById('scatterCanvas');
      const filtered = filterItems();
      
      // Create map of existing elements
      const existing = new Map();
      Array.from(canvas.children).forEach(c => existing.set(c.dataset.id, c));
      
      // Clear canvas reference (we will append back)
      canvas.innerHTML = '';
      
      items.forEach(item => {
          let el = existing.get(String(item.id));
          if(!el) {
              el = document.createElement('div');
              el.className = 'scatter-card';
              el.dataset.id = item.id;
              // Attach drag handler
              el.addEventListener('pointerdown', (e) => startCardDrag(e, item, el));
              el.oncontextmenu = (e) => { e.preventDefault(); showContextMenu(e, item.id); };
          }
          
          // Update content and class
          el.className = `scatter-card ${filtered.includes(item) ? '' : 'dimmed'} ${item.status==='burnt'?'burnt':''}`;
          el.innerHTML = getCardHTML(item);
          
          // Position
          el.style.left = item.pos.x + 'px';
          el.style.top = item.pos.y + 'px';
          
          canvas.appendChild(el);
      });
      
      applyScatterTransform();
      updateTimers();
  }
  
  function applyScatterTransform() {
      const canvas = document.getElementById('scatterCanvas');
      canvas.style.transform = `translate(${scatter.x}px, ${scatter.y}px) scale(${scatter.scale})`;
  }
  
  // --- Smart Auto-Arrange ---
  function autoArrange() {
      const filtered = filterItems();
      if(filtered.length === 0) return;
      
      const viewportW = window.innerWidth;
      const cardW = 240; 
      const cardH = 160;
      const cols = Math.max(1, Math.floor((viewportW - 40) / cardW));
      
      // Group logic
      const groups = {
          'active': filtered.filter(i => i.status === 'active'),
          'ready': filtered.filter(i => i.status === 'ready'),
          'cooldown': filtered.filter(i => i.status === 'cooldown'),
          'burnt': filtered.filter(i => i.status === 'burnt')
      };
      
      let currentY = 120;
      const startX = 20;
      
      Object.values(groups).forEach(group => {
          if(group.length === 0) return;
          group.forEach((item, idx) => {
              const c = idx % cols;
              const r = Math.floor(idx / cols);
              item.pos.x = startX + (c * cardW);
              item.pos.y = currentY + (r * cardH);
          });
          currentY += (Math.ceil(group.length / cols) * cardH) + 40;
      });
      
      // Reset view to top-left
      scatter.x = 0; scatter.y = 0; scatter.scale = 1;
      save();
      renderScatter();
      showToast('Arranged & Centered');
  }
  
  // --- Interaction Engine (Pan/Zoom) ---
  const container = document.getElementById('scatterContainer');
  let pointers = new Map();
  let prevDiff = -1;
  let lastPan = { x:0, y:0 };
  
  container.addEventListener('pointerdown', ev => {
      if(ev.target.closest('.scatter-card')) return;
      container.setPointerCapture(ev.pointerId);
      pointers.set(ev.pointerId, { x: ev.clientX, y: ev.clientY });
      if(pointers.size === 1) lastPan = { x: ev.clientX, y: ev.clientY };
      if(pointers.size === 2) {
          const p = Array.from(pointers.values());
          prevDiff = Math.hypot(p[0].x - p[1].x, p[0].y - p[1].y);
      }
  });
  
  container.addEventListener('pointermove', ev => {
      if(!pointers.has(ev.pointerId)) return;
      pointers.set(ev.pointerId, { x: ev.clientX, y: ev.clientY });
      
      if(pointers.size === 1) {
          // Pan
          const dx = ev.clientX - lastPan.x;
          const dy = ev.clientY - lastPan.y;
          scatter.x += dx; scatter.y += dy;
          lastPan = { x: ev.clientX, y: ev.clientY };
          applyScatterTransform();
      } else if(pointers.size === 2) {
          // Pinch
          const p = Array.from(pointers.values());
          const curDiff = Math.hypot(p[0].x - p[1].x, p[0].y - p[1].y);
          const cx = (p[0].x + p[1].x)/2;
          const cy = (p[0].y + p[1].y)/2;
          
          if(prevDiff > 0) {
              const scaleFactor = curDiff / prevDiff;
              const newScale = Math.min(Math.max(scatter.scale * scaleFactor, 0.2), 4);
              const ratio = newScale / scatter.scale;
              scatter.x = cx - (cx - scatter.x) * ratio;
              scatter.y = cy - (cy - scatter.y) * ratio;
              scatter.scale = newScale;
              applyScatterTransform();
          }
          prevDiff = curDiff;
      }
  });
  
  container.addEventListener('pointerup', ev => {
      pointers.delete(ev.pointerId);
      container.releasePointerCapture(ev.pointerId);
      if(pointers.size === 1) {
          const p = pointers.values().next().value;
          lastPan = { x: p.x, y: p.y };
      }
      prevDiff = -1;
      save();
  });
  
  container.addEventListener('wheel', ev => {
      ev.preventDefault();
      const direction = ev.deltaY < 0 ? 1 : -1;
      const factor = 1 + (0.1 * direction);
      const newScale = Math.min(Math.max(scatter.scale * factor, 0.2), 4);
      
      const rect = container.getBoundingClientRect();
      const mx = ev.clientX - rect.left;
      const my = ev.clientY - rect.top;
      const ratio = newScale / scatter.scale;
      
      scatter.x = mx - (mx - scatter.x) * ratio;
      scatter.y = my - (my - scatter.y) * ratio;
      scatter.scale = newScale;
      
      applyScatterTransform();
      save();
  }, { passive: false });
  
  // --- Card Drag Logic ---
  function startCardDrag(e, item, el) {
      if(e.button !== 0) return;
      e.stopPropagation();
      el.setPointerCapture(e.pointerId);
      el.classList.add('is-dragging');
      el.style.zIndex = 1000;
      
      const startX = e.clientX;
      const startY = e.clientY;
      const initialPos = { ...item.pos };
      let hasMoved = false;
      
      function move(ev) {
          const dx = (ev.clientX - startX) / scatter.scale;
          const dy = (ev.clientY - startY) / scatter.scale;
          if(Math.hypot(dx, dy) > 5) hasMoved = true;
          
          item.pos.x = initialPos.x + dx;
          item.pos.y = initialPos.y + dy;
          el.style.left = item.pos.x + 'px';
          el.style.top = item.pos.y + 'px';
      }
      
      function stop(ev) {
          el.classList.remove('is-dragging');
          el.style.zIndex = '';
          el.removeEventListener('pointermove', move);
          el.removeEventListener('pointerup', stop);
          el.releasePointerCapture(ev.pointerId);
          
          if(!hasMoved) openModal(item.id); // Click detected
          else save();
      }
      
      el.addEventListener('pointermove', move);
      el.addEventListener('pointerup', stop);
  }
  
  // --- Timers ---
  function updateTimers() {
      const now = Date.now();
      items.forEach(item => {
          const el = document.getElementById(`timer-${item.id}`);
          if(!el) return;
          
          if(item.status === 'active') {
              el.innerText = formatTime(now - item.lastUsed);
          } else if(item.status === 'cooldown') {
              const resetTime = item.lastUsed + (item.resetHours * 3600000);
              const remain = resetTime - now;
              if(remain <= 0) {
                  item.status = 'ready';
                  save();
                  config.view === 'grid' ? renderGrid() : renderScatter();
                  showToast(`${item.provider} Ready`);
              } else {
                  el.innerText = formatTime(remain);
              }
          } else {
              el.innerText = "00:00:00";
          }
      });
  }
  function formatTime(ms) {
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600).toString().padStart(2,'0');
      const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
      const sec = (s%60).toString().padStart(2,'0');
      return `${h}:${m}:${sec}`;
  }
  
  // --- CRUD & Actions ---
  function openModal(id = null) {
      const form = document.getElementById('nodeForm');
      form.reset();
      document.getElementById('editActions').style.display = 'none';
      document.getElementById('btnDelete').style.display = 'none';
      document.getElementById('modalTitle').innerText = 'New Node';
      
      // Populate Providers
      const sel = document.getElementById('inpProvider');
      sel.innerHTML = '<option value="" disabled selected>Select Provider</option>';
      providers.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
      sel.innerHTML += '<option value="__NEW__">+ Add New...</option>';
      
      if(id) {
          const item = items.find(i => i.id == id);
          document.getElementById('nodeId').value = id;
          document.getElementById('inpProvider').value = item.provider;
          document.getElementById('inpEmail').value = item.email;
          document.getElementById('inpStatus').value = item.status;
          document.getElementById('inpReset').value = item.resetHours;
          document.getElementById('modalTitle').innerText = 'Edit Node';
          document.getElementById('editActions').style.display = 'flex';
          document.getElementById('btnDelete').style.display = 'block';
      }
      
      document.getElementById('modalOverlay').classList.add('active');
  }
  
  document.getElementById('inpProvider').addEventListener('change', (e) => {
      if(e.target.value === '__NEW__') {
          const p = prompt("New Provider Name:");
          if(p) {
              providers.push(p);
              save();
              renderProviderBar();
              openModal(document.getElementById('nodeId').value || null); // Re-render modal
          }
      }
  });
  
  document.getElementById('nodeForm').onsubmit = (e) => {
      e.preventDefault();
      const id = document.getElementById('nodeId').value;
      const provider = document.getElementById('inpProvider').value;
      const email = document.getElementById('inpEmail').value;
      const status = document.getElementById('inpStatus').value;
      const reset = parseFloat(document.getElementById('inpReset').value);
      
      if(!provider) return alert("Select Provider");
      
      if(id) {
          const item = items.find(i => i.id == id);
          item.provider = provider;
          item.email = email;
          if(item.status !== status) item.lastUsed = Date.now();
          item.status = status;
          item.resetHours = reset;
      } else {
          items.push({
              id: Date.now(),
              provider, email, status, resetHours: reset, lastUsed: Date.now(),
              pos: { x: 50, y: 150 }
          });
      }
      save();
      closeModal();
      config.view === 'grid' ? renderGrid() : renderScatter();
  };
  
  function deleteNode() {
      if(!confirm("Delete this node?")) return;
      const id = document.getElementById('nodeId').value;
      items = items.filter(i => i.id != id);
      save();
      closeModal();
      config.view === 'grid' ? renderGrid() : renderScatter();
  }
  
  function confirmHitLimit() {
      const id = document.getElementById('nodeId').value;
      const item = items.find(i => i.id == id);
      item.status = 'cooldown';
      item.lastUsed = Date.now();
      save();
      closeModal();
      config.view === 'grid' ? renderGrid() : renderScatter();
  }
  
  function confirmForceRestore() {
      const id = document.getElementById('nodeId').value;
      const item = items.find(i => i.id == id);
      item.status = 'ready';
      save();
      closeModal();
      config.view === 'grid' ? renderGrid() : renderScatter();
  }
  
  // --- Utils & Init ---
  function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }
  function openInfoModal() { document.getElementById('infoOverlay').classList.add('active'); }
  function closeInfoModal() { document.getElementById('infoOverlay').classList.remove('active'); }
  function addNewProvider() {
      const p = prompt("Provider Name:");
      if(p && !providers.includes(p)) {
          providers.push(p);
          save();
          renderProviderBar();
      }
  }
  function showToast(msg) {
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
  }
  function toggleTheme() {
      const b = document.body;
      const themes = ['dark', 'light', 'rose'];
      const cur = b.getAttribute('data-theme');
      const next = themes[(themes.indexOf(cur)+1)%3];
      b.setAttribute('data-theme', next);
      
      const img = document.getElementById('logoImg');
      if(next === 'light') img.src = 'https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-dark.svg';
      else if(next === 'rose') img.src = 'https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-rose.svg';
      else img.src = 'https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-light.svg';
  }
  
  // Boot
  window.onload = () => {
      load();
      renderProviderBar();
      updateFilterUI();
      switchView(config.view);
      timerInterval = setInterval(updateTimers, 1000);
  };
  </script>
</body>
</html>
