
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>intoview • note</title>
<link rel="icon" href="data:,"/>
<style>
/* ==========================================================
   Intoview • Mobile Design System — B&W Outlined Edition
   Applied to the multi-step camera → review → details → export flow
   (Keep camera framing/proportions/styling from previous working build)
   ========================================================== */

/* ---------- TOKEN VARIABLES (B&W) ---------- */
:root{
  /* Ink & Paper */
  --paper:#FFFFFF;       /* canvas */
  --ink:#111111;         /* primary stroke/text */
  --ink-2:#444444;       /* secondary text/lines */
  --ink-3:#777777;       /* muted helpers */

  /* Surfaces use paper; components rely on outlines only */
  --bg-0:var(--paper); --bg-1:var(--paper); --bg-2:var(--paper); --bg-3:var(--paper);
  --fg:var(--ink); --fg-2:var(--ink-2); --fg-3:var(--ink-3);

  /* Stroke weights */
  --rule:1.5px; --hair:1px;

  /* Radii — squared, light rounding */
  --r-xs:2px; --r-sm:4px; --r-md:4px; --r-lg:6px; --r-xl:8px; --r-pill:8px; /* no pills */

  /* Spacing (4pt base) */
  --s0:0; --s1:4px; --s2:8px; --s3:12px; --s4:16px; --s5:20px; --s6:24px; --s7:28px; --s8:32px; --s10:40px; --s12:48px;

  /* Size & Layout */
  --container-max: 720px;
  --touch:44px; --touch-lg:52px; --capture:72px;

  /* Typography (system) */
  --font-ui: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  --fs-xs:11px; --fs-sm:13px; --fs-md:15px; --fs-lg:17px; --fs-xl:20px; --fs-display:28px;
  --lh-tight:1.15; --lh-snug:1.28; --lh-normal:1.45;

  /* Motion — minimal */
  --ease: cubic-bezier(.2,.7,.2,1);
  --t-fast:100ms var(--ease); --t-base:150ms var(--ease); --t-slow:200ms var(--ease);
}

/* ---------- PAGE SHELL ---------- */
html,body{height:100%}
body{margin:0;background:var(--paper);color:var(--fg);
  font:400 var(--fs-md)/var(--lh-normal) var(--font-ui);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
.header{position:sticky;top:0;z-index:10;background:var(--paper);border-bottom:var(--hair) solid var(--ink-2)}
.header__inner{max-width:var(--container-max);margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
.title{font:700 var(--fs-xl)/var(--lh-tight) var(--font-ui)}
.subtitle{color:var(--fg-2);font-size:var(--fs-sm)}

.container{max-width:var(--container-max);margin:0 auto;padding:16px}
.section{margin:24px 0;border:var(--rule) solid var(--ink);border-radius:var(--r-sm);background:var(--paper)}
.section__hd{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:var(--hair) dashed var(--ink-2)}
.section__hd h2{margin:0;font:700 var(--fs-lg)/var(--lh-snug) var(--font-ui)}
.section__bd{padding:16px}
.badge{padding:6px 8px;border-radius:var(--r-xs);border:var(--hair) solid var(--ink-2);background:var(--paper);font:700 var(--fs-xs)/1 var(--font-mono);color:var(--fg-2)}
.row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.stack{display:grid;gap:12px}
.grid{display:grid;gap:12px}
.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}

/* ---------- COMPONENTS (OUTLINED) ---------- */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;min-height:44px;padding:0 16px;border-radius:var(--r-sm);
  border:var(--rule) solid var(--ink);background:transparent;color:var(--fg);
  font:700 var(--fs-md)/1 var(--font-ui);transition:background var(--t-base),color var(--t-base)}
.btn:active{transform:translateY(1px)}
.btn--solid{background:var(--ink);color:var(--paper)}
.btn--ghost{border:var(--hair) solid var(--ink-2);color:var(--fg)}
.btn--danger{border-color:var(--ink);}
.btn[disabled]{opacity:.5; pointer-events:none}
.btn--lg{min-height:52px;padding:0 20px;border-radius:var(--r-sm)}

.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{min-width:52px;height:36px;padding:0 10px;border-radius:var(--r-sm);display:inline-flex;align-items:center;justify-content:center;
  border:var(--hair) solid var(--ink-2);background:transparent;color:var(--fg)}
.chip[aria-pressed="true"]{border-color:var(--ink)}

.field{display:flex;flex-direction:column;gap:8px;max-width:100%}
.label{font:700 var(--fs-sm)/1 var(--font-ui);color:var(--fg)}
.input,.textarea{background:var(--paper);border:var(--rule) solid var(--ink);color:var(--fg);border-radius:var(--r-sm);padding:10px 12px}
.input:focus,.textarea:focus{outline:2px solid var(--ink);outline-offset:1px}
.textarea{min-height:96px;resize:vertical}
.helper{color:var(--fg-2);font-size:var(--fs-sm)}
.counter{color:var(--fg-2);font:700 var(--fs-sm)/1 var(--font-mono)}

.switch{position:relative;display:inline-flex;align-items:center;gap:10px;user-select:none}
.switch input{position:absolute;opacity:0}
.switch .track{width:44px;height:28px;border-radius:var(--r-sm);background:transparent;border:var(--rule) solid var(--ink)}
.switch .thumb{position:absolute;width:18px;height:18px;border-radius:var(--r-xs);background:transparent;border:var(--rule) solid var(--ink);transform:translate(4px,4px);transition:transform var(--t-base)}
.switch input:checked ~ .thumb{transform:translate(22px,4px)}
.switch .txt{font:700 var(--fs-sm)/1 var(--font-ui)}

/* ---------- CAMERA / VIEWFINDER (kept from working build) ---------- */
.card{border:var(--rule) solid var(--ink);border-radius:var(--r-sm);background:var(--paper)}
.vf{position:relative;aspect-ratio:4/3;width:100%;overflow:hidden;border-radius:var(--r-sm);border:var(--rule) solid var(--ink);background:#000}
video{width:100%;height:100%;object-fit:cover;display:block;filter:grayscale(1) contrast(1.07) brightness(.97)}
.mask{position:absolute;inset:0;pointer-events:none}
.mask .grid{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr 1fr;opacity:.6}
.mask .grid > div{border-right:var(--hair) solid var(--ink-2)}
.mask .grid > div:nth-child(3n){border-right:0}
.mask .grid:after{content:"";grid-column:1/-1;border-top:var(--hair) dashed var(--ink-2);align-self:center}
.level{position:absolute;left:12px;right:12px;bottom:12px;display:flex;justify-content:center}

/* ---------- PREVIEW / EXPORT SURFACES ---------- */
.preview{background:var(--paper);border:var(--rule) solid var(--ink);border-radius:var(--r-sm);aspect-ratio:4/3;width:100%;display:flex;align-items:center;justify-content:center;overflow:hidden}
.canvas-fit{width:100%;height:auto;max-height:72vh}

/* Steps */
.step{display:none}
.step.active{display:block}

/* Accessibility helpers */
.visually-hidden{position:absolute!important;clip:rect(1px,1px,1px,1px)!important;width:1px!important;height:1px!important;overflow:hidden!important;padding:0!important;border:0!important}

/* ---------- DARK THEME OVERRIDES ---------- */
html[data-theme="dark"]{
  --paper:#0B0B0C;
  --ink:#F3F3F5;
  --ink-2:#C9C9CF;
  --ink-3:#9A9AA2;
}
</style>
</head>
<body>
  <header class="header" role="banner">
    <div class="header__inner">
      <div>
        <div class="title">intoview • note</div>
        <div class="subtitle">B&W outlined UI • camera/export frame preserved</div>
      </div>
      <div class="row">
        <button class="btn btn--ghost" id="themeToggle" aria-pressed="false" title="Toggle theme">Theme: <span id="themeLabel">Light</span></button>
        <button class="btn btn--ghost" id="importPhotoTop">Import</button>
      </div>
    </div>
  </header>

  <main class="container" role="main">
    <!-- STEP 0: Start -->
    <section class="section step active" data-step="0" id="step0">
      <div class="section__hd">
        <h2>Start</h2>
        <span class="badge">Step 0</span>
      </div>
      <div class="section__bd">
        <div class="row" style="justify-content:space-between">
          <div class="subtitle">Camera opens instantly. Caption & export next.</div>
        </div>
        <div class="grid cols-2" style="margin-top:12px">
          <button class="btn btn--lg" id="startCamera">Open Camera</button>
          <button class="btn btn--lg btn--ghost" id="importPhoto">Import Photo</button>
        </div>
      </div>
    </section>

    <!-- STEP 1: Viewfinder -->
    <section class="section step" data-step="1" id="step1">
      <div class="section__hd">
        <h2>Viewfinder</h2>
        <span class="badge">Step 1</span>
      </div>
      <div class="section__bd">
        <div class="card" style="padding:12px">
          <div class="vf" id="vf">
            <video id="video" playsinline muted></video>
            <div class="mask">
              <div class="grid">
                <div></div><div></div><div></div>
                <div></div><div></div><div></div>
                <div></div><div></div><div></div>
              </div>
            </div>
            <div class="level"><canvas id="level" width="240" height="56" style="width:240px;height:56px"></canvas></div>
          </div>

          <div class="chips" role="group" aria-label="Aspect ratio" style="margin-top:12px">
            <button class="chip" id="r169" aria-pressed="false">16:9</button>
            <button class="chip" id="r43"  aria-pressed="true">4:3</button>
            <button class="chip" id="r11"  aria-pressed="false">1:1</button>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn btn--lg" id="capture">Capture</button>
            <button class="btn btn--lg btn--ghost" id="importAlt">Import</button>
          </div>
          <input type="file" accept="image/*" id="importHidden" style="display:none"/>
        </div>
      </div>
    </section>

    <!-- STEP 2: Review -->
    <section class="section step" data-step="2" id="step2">
      <div class="section__hd">
        <h2>Review</h2>
        <span class="badge">Step 2</span>
      </div>
      <div class="section__bd">
        <div class="preview"><canvas id="reviewCanvas" class="canvas-fit"></canvas></div>
        <div class="grid cols-2" style="margin-top:12px">
          <button class="btn btn--lg btn--ghost" id="retake">Retake</button>
          <button class="btn btn--lg" id="keep">Keep</button>
        </div>
      </div>
    </section>

    <!-- STEP 3: Details -->
    <section class="section step" data-step="3" id="step3">
      <div class="section__hd">
        <h2>Details</h2>
        <span class="badge">Step 3</span>
      </div>
      <div class="section__bd stack">
        <div class="field">
          <label class="label" for="title">Title (40 cap)</label>
          <input id="title" class="input" maxlength="40" placeholder="e.g., Walks with Wolfie, NYC"/>
          <div class="row" style="justify-content:space-between">
            <div class="helper">Optional GPS seed</div>
            <div class="counter" id="titleCount">0/40</div>
          </div>
        </div>
        <div class="field">
          <label class="label" for="caption">Note (100 cap)</label>
          <textarea id="caption" class="textarea" maxlength="100" placeholder="Write a note, not a novel.">A quick visual note</textarea>
          <div class="row" style="justify-content:flex-end"><div class="counter" id="capCount">0/100</div></div>
        </div>
        <div class="row" style="align-items:center">
          <label class="switch">
            <input type="checkbox" id="gpsToggle"/>
            <span class="track"></span><span class="thumb"></span><span class="txt">GPS</span>
          </label>
          <label class="switch">
            <input type="checkbox" id="monoBars" checked/>
            <span class="track"></span><span class="thumb"></span><span class="txt">Mono bars</span>
          </label>
        </div>
        <div class="grid cols-2" style="margin-top:12px">
          <button class="btn btn--lg btn--ghost" id="detailsBack">Back</button>
          <button class="btn btn--lg" id="toExport">Next</button>
        </div>
      </div>
    </section>

    <!-- STEP 4: Export -->
    <section class="section step" data-step="4" id="step4">
      <div class="section__hd">
        <h2>Export</h2>
        <span class="badge">Step 4</span>
      </div>
      <div class="section__bd">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <div class="subtitle">Export • <span id="expRatioTxt">4:3</span></div>
          <div class="chips" role="group" aria-label="Export ratio">
            <button class="chip" id="exp43" aria-pressed="true">4:3</button>
            <button class="chip" id="exp11" aria-pressed="false">1:1</button>
          </div>
        </div>
        <div class="preview">
          <canvas id="exportCanvas" class="canvas-fit"></canvas>
        </div>
        <div class="grid cols-2" style="margin-top:12px">
          <button class="btn btn--lg btn--ghost" id="exportBack">Back</button>
          <button class="btn btn--lg" id="exportBtn">Export PNG</button>
        </div>
      </div>
    </section>

    <!-- STEP 5: Done -->
    <section class="section step" data-step="5" id="step5">
      <div class="section__hd">
        <h2>Done</h2>
        <span class="badge">Step 5</span>
      </div>
      <div class="section__bd" style="display:grid;place-items:center">
        <div class="stack" style="text-align:center">
          <div class="badge">Saved / Exported</div>
          <div class="row" style="justify-content:center;margin-top:12px">
            <button class="btn btn--lg btn--ghost" id="newFromHere">New note</button>
            <button class="btn btn--lg" id="shareAction">Share</button>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  /* ============ Theme toggle ============ */
  const themeToggle = document.getElementById('themeToggle');
  const themeLabel  = document.getElementById('themeLabel');
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    const pressed = t === 'dark';
    themeToggle?.setAttribute('aria-pressed', String(pressed));
    if (themeLabel) themeLabel.textContent = pressed ? 'Dark' : 'Light';
    try { localStorage.setItem('iv_outline_theme', t); } catch {}
  }
  const savedTheme = (()=>{ try{ return localStorage.getItem('iv_outline_theme'); }catch{ return null } })();
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
  themeToggle?.addEventListener('click', ()=>{
    const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    applyTheme(next);
    drawReview(); drawExport();
  });

  /* ============ Step navigation ============ */
  const steps = [...document.querySelectorAll('.step')];
  let stepIndex = 0;
  function go(i){
    stepIndex = Math.max(0, Math.min(steps.length-1, i));
    steps.forEach((el, idx)=>el.classList.toggle('active', idx===stepIndex));
  }
  go(0);

  /* ============ Elements ============ */
  const $ = (s)=>document.querySelector(s);
  const video = $('#video');
  const levelCanvas = $('#level');
  const reviewCanvas = $('#reviewCanvas');
  const exportCanvas = $('#exportCanvas');
  const importHidden = $('#importHidden');
  const monoBars = $('#monoBars');
  const titleIn = $('#title');
  const captionIn = $('#caption');
  const titleCount = $('#titleCount');
  const capCount = $('#capCount');
  const gpsToggle = $('#gpsToggle');
  const expRatioTxt = $('#expRatioTxt');

  /* counters */
  function bindCount(el, out){
    if(!el||!out) return;
    const max = el.getAttribute('maxlength')|0;
    const update = ()=>{ out.textContent = `${el.value.length}/${max}` };
    el.addEventListener('input', update); update();
  }
  bindCount(titleIn, titleCount);
  bindCount(captionIn, capCount);

  /* ============ State ============ */
  let viewRatio = '4:3';
  let lastShot = null; // canvas
  let expRatio = '4:3';
  let gpsText = '';

  /* ============ Start actions ============ */
  $('#startCamera').addEventListener('click', initCameraAndGo);
  $('#importPhoto').addEventListener('click', ()=>importHidden.click());
  $('#importPhotoTop').addEventListener('click', ()=>importHidden.click());
  $('#importAlt').addEventListener('click', ()=>importHidden.click());
  importHidden.addEventListener('change', onImportFile);

  async function initCameraAndGo(){
    await initCamera();
    go(1);
  }

  async function initCamera(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' }, audio:false });
      video.srcObject = stream;
      await video.play();
      startLevel(levelCanvas);
    }catch(e){
      alert('Camera permission denied or unavailable. You can import a photo instead.');
      console.warn(e);
    }
  }

  /* aspect chips */
  const r169=$('#r169'), r43=$('#r43'), r11=$('#r11');
  function setChipPressed(el, pressed){ el.setAttribute('aria-pressed', String(pressed)); }
  function setViewRatio(r){
    viewRatio = r;
    setChipPressed(r169, r==='16:9');
    setChipPressed(r43,  r==='4:3');
    setChipPressed(r11,  r==='1:1');
  }
  r169.addEventListener('click', ()=>setViewRatio('16:9'));
  r43.addEventListener('click',  ()=>setViewRatio('4:3'));
  r11.addEventListener('click',  ()=>setViewRatio('1:1'));
  setViewRatio('4:3');

  /* capture / import */
  $('#capture').addEventListener('click', onCapture);
  function onImportFile(e){
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement('canvas');
      c.width = img.width; c.height = img.height;
      c.getContext('2d').drawImage(img, 0, 0);
      lastShot = c;
      drawReview();
      go(2);
    };
    img.src = URL.createObjectURL(file);
  }

  function onCapture(){
    if(!video.videoWidth) return;
    const vw = video.videoWidth, vh = video.videoHeight;
    const [rw, rh] = viewRatio.split(':').map(Number);
    const targ = rw/rh;
    let sw = vw, sh = Math.round(vw / targ);
    if (sh > vh){ sh = vh; sw = Math.round(vh * targ); }
    const sx = Math.floor((vw - sw)/2);
    const sy = Math.floor((vh - sh)/2);

    const c = document.createElement('canvas');
    c.width = sw; c.height = sh;
    c.getContext('2d').drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);
    lastShot = c;
    drawReview();
    go(2);
  }

  /* review */
  $('#retake').addEventListener('click', ()=>go(1));
  $('#keep').addEventListener('click', ()=>go(3));

  function drawReview(){
    if(!lastShot) return;
    const size = {w: 1200, h: 900};
    reviewCanvas.width = size.w; reviewCanvas.height = size.h;
    const ctx = reviewCanvas.getContext('2d');

    // paper background for preview surface
    const cs = getComputedStyle(document.documentElement);
    const paper = cs.getPropertyValue('--paper').trim() || '#FFFFFF';
    const ink = cs.getPropertyValue('--ink').trim() || '#111111';
    ctx.fillStyle = paper; ctx.fillRect(0,0,size.w,size.h);

    const inset=24;
    const area = {x: inset, y: inset, w: size.w - inset*2, h: size.h - inset*2};
    const iw = lastShot.width, ih = lastShot.height;
    const scale = Math.max(area.w/iw, area.h/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = area.x + (area.w - dw)/2;
    const dy = area.y + (area.h - dh)/2;
    ctx.save(); roundRect(ctx, area.x, area.y, area.w, area.h, 6); ctx.clip();
    ctx.drawImage(lastShot, dx, dy, dw, dh);
    // live preview shows grayscale (non-destructive)
    const imgData = ctx.getImageData(dx, dy, dw, dh);
    desaturate(imgData.data, false);
    ctx.putImageData(imgData, dx, dy);
    ctx.restore();

    ctx.strokeStyle = ink; ctx.lineWidth = 1.5;
    roundRect(ctx, area.x, area.y, area.w, area.h, 6); ctx.stroke();
  }

  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }

  /* details */
  $('#detailsBack').addEventListener('click', ()=>go(2));
  $('#toExport').addEventListener('click', ()=>{ drawExport(); go(4); });

  gpsToggle.addEventListener('change', async ()=>{
    if(!gpsToggle.checked){ gpsText=''; return; }
    if(!('geolocation' in navigator)){ gpsText='[gps unavailable]'; return; }
    try{
      const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{ enableHighAccuracy:false, timeout:8000 }));
      const { latitude, longitude } = pos.coords;
      const lat = latitude.toFixed(4), lon = longitude.toFixed(4);
      gpsText = `[ ${lat}° N ${lon}° W ]`;
    }catch(e){ gpsText='[gps denied]'; }
  });

  /* export */
  const exp43=$('#exp43'), exp11=$('#exp11');
  function setExpRatio(r){
    expRatio = r;
    expRatioTxt.textContent = r;
    setChipPressed(exp43, r==='4:3');
    setChipPressed(exp11, r==='1:1');
    drawExport();
  }
  exp43.addEventListener('click', ()=>setExpRatio('4:3'));
  exp11.addEventListener('click', ()=>setExpRatio('1:1'));
  setExpRatio('4:3');

  $('#exportBack').addEventListener('click', ()=>go(3));
  $('#exportBtn').addEventListener('click', doExport);

  function wrapText(ctx,text,x,y,maxWidth,lineHeight,align){
    const words = String(text||'').split(' ');
    let line = ''; const lines = [];
    for(let i=0;i<words.length;i++){
      const test = line + words[i] + ' ';
      if (ctx.measureText(test).width > maxWidth && i>0){ lines.push(line.trim()); line = words[i] + ' '; }
      else { line = test; }
    }
    lines.push(line.trim());
    ctx.textAlign = align || 'left';
    // draw upward from y baseline
    for(let i=0;i<lines.length;i++){
      ctx.fillText(lines[i], x, y - (lines.length-1-i)*lineHeight);
    }
  }

  function drawExport(){
    if(!lastShot) return;
    const size = (expRatio==='1:1') ? {w:1200,h:1200} : {w:1200,h:900};
    exportCanvas.width = size.w; exportCanvas.height = size.h;
    const ctx = exportCanvas.getContext('2d');

    // draw the final composition scaled down (same routine as hi-res export)
    drawComposition(ctx, size.w, size.h, false);
  }

  function doExport(){
    if(!lastShot) return;
    const W = 2400; // upscale for crisp output
    const H = (expRatio==='1:1') ? 2400 : 1800;
    const c = document.createElement('canvas'); c.width = W; c.height = H;
    const ctx = c.getContext('2d');
    drawComposition(ctx, W, H, true);
    c.toBlob((blob)=>{
      if(!blob) return;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `intoview-collector_${expRatio.replace(':','-')}_${Date.now()}.png`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      go(5);
    }, 'image/png', 0.96);
  }

  /* ====== Composition: keep black card, white border, hairlines, mono bars ====== */
  function drawComposition(cx, W, H, final){
    // Always black card, white hairlines/border (independent of theme)
    cx.fillStyle = '#000'; cx.fillRect(0,0,W,H);

    // Border (crisp hairline at 1 px)
    const hair = 1;
    cx.strokeStyle = '#fff'; cx.lineWidth = hair; cx.strokeRect(hair/2, hair/2, W-hair, H-hair);

    // Bars: target preview ~32px, export ~64px; scale to surface
    const barPx = final ? 64 : 32;
    const pad = final ? 16 : 12;  // inner text side padding
    const topBarH = barPx; const botBarH = barPx;

    // Inner image area
    const innerX = hair; const innerY = topBarH + hair;
    const innerW = W - hair*2; const innerH = H - (topBarH + botBarH) - hair*2;

    // Cover image in inner box (grayscale filmic curve)
    const iw = lastShot.width, ih = lastShot.height;
    const boxR = innerW/innerH, imgR = iw/ih;
    let dw=innerW, dh=innerH, dx=innerX, dy=innerY;
    if(imgR > boxR){ dh = innerH; dw = dh * imgR; dx = innerX + (innerW-dw)/2; }
    else { dw = innerW; dh = dw / imgR; dy = innerY + (innerH-dh)/2; }
    cx.drawImage(lastShot, dx, dy, dw, dh);
    const imgData = cx.getImageData(dx, dy, dw, dh);
    desaturate(imgData.data, false);
    cx.putImageData(imgData, dx, dy);

    // Hairlines above/below image
    cx.globalAlpha = .9; cx.fillStyle = '#fff';
    cx.fillRect(0, topBarH, W, hair);
    cx.fillRect(0, H - botBarH - hair, W, hair);
    cx.globalAlpha = 1;

    // Type on bars (mono 12 → 24 export; align to bar center)
    const mono = monoBars?.checked;
    const fontSize = final ? 24 : 12;
    cx.fillStyle = '#e6e6e6';
    cx.font = `${mono ? '700' : '600'} ${fontSize}px ${mono ? 'ui-monospace, SFMono-Regular, Menlo, Consolas, monospace' : 'system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif'}`;
    cx.textBaseline = 'middle';
    cx.textAlign = 'left';

    // Top-left: uppercase title
    const title = (titleIn.value.trim() || '[ title ]').toUpperCase();
    cx.fillText(title, innerX + pad, topBarH/2);

    // Top-right: GPS (optional)
    if (gpsToggle.checked && gpsText){
      rightText(cx, gpsText, W - (innerX + pad), topBarH/2);
    }

    // Bottom-left: caption (wrap if needed to max width minus 2*pad)
    const caption = captionIn.value.trim() || '[ short caption goes here ]';
    wrapText(cx, caption, innerX + pad, H - (botBarH/2), innerW - pad*2, Math.round(fontSize*1.2), 'left');

    // Bottom-right: timestamp
    const ts = new Date().toLocaleString([], { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
    rightText(cx, ts, W - (innerX + pad), H - (botBarH/2));
  }

  function rightText(ctx, text, x, y){
    const w = ctx.measureText(text).width; ctx.textAlign='left'; ctx.fillText(text, x - w, y);
  }

  function desaturate(data, hard){
    // Convert to grayscale with mild S-curve (hard threshold disabled)
    for(let i=0;i<data.length;i+=4){
      const r=data[i], g=data[i+1], b=data[i+2];
      let y = 0.2126*r + 0.7152*g + 0.0722*b; // luma
      y = y/255; y = Math.pow(y, 0.9); y = (y-0.5)*1.1 + 0.5; y = Math.max(0, Math.min(1, y));
      y = Math.round(y*255);
      data[i]=data[i+1]=data[i+2]=y;
    }
  }

  /* ============ Level gauge (outlined, mono) ============ */
  function startLevel(c){
    const ctx = c.getContext('2d');
    let roll = 0;
    function draw(){
      const w = 240, h = 56;
      const dpr = Math.max(1, devicePixelRatio||1);
      c.width = w*dpr; c.height = h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,w,h);

      // tokens
      const cs = getComputedStyle(document.documentElement);
      const paper = cs.getPropertyValue('--paper').trim() || '#FFFFFF';
      const ink = cs.getPropertyValue('--ink').trim() || '#111111';
      const ink2 = cs.getPropertyValue('--ink-2').trim() || '#444444';

      // frame
      ctx.fillStyle = paper; ctx.fillRect(0,0,w,h);
      ctx.strokeStyle = ink; ctx.lineWidth = 1.5;
      ctx.strokeRect(0.75,0.75,w-1.5,h-1.5);

      // liquid band
      const angle = -roll * Math.PI/180;
      const mid = h*0.55;
      ctx.save();
      ctx.translate(w/2, mid);
      ctx.rotate(angle);
      ctx.fillStyle = ink2;
      ctx.fillRect(-w, 0, w*2, h);
      ctx.restore();

      // bubble
      const bubbleR = 7;
      const bubbleX = w/2 + ((45 - (roll+45))/90)*80;
      const bubbleY = mid - 3;
      ctx.beginPath();
      ctx.arc(bubbleX, bubbleY, bubbleR, 0, Math.PI*2);
      ctx.fillStyle = paper; ctx.fill();
      ctx.strokeStyle = ink; ctx.lineWidth = 1;
      ctx.stroke();
    }
    function setRoll(val){ roll = Math.max(-45, Math.min(45, val)); draw(); }
    function onOrient(e){ setRoll(e.gamma||0); }
    function onMouse(e){ setRoll(((e.clientX/innerWidth)*2-1)*30); }
    if('DeviceOrientationEvent' in window){ window.addEventListener('deviceorientation', onOrient); }
    else { window.addEventListener('mousemove', onMouse); }
    draw();
  }

  /* ============ Nav helpers ============ */
  document.getElementById('newFromHere').addEventListener('click', ()=>{ captionIn.value='A quick visual note'; titleIn.value=''; bindCount(titleIn, titleCount); bindCount(captionIn, capCount); setExpRatio('4:3'); go(1); });
  document.getElementById('shareAction').addEventListener('click', async ()=>{ try{ await navigator.share({ title:'intoview • note', text:'Shared from intoview • note' }); }catch(e){} });

  /* expose for console */
  window.__go = go;
})();
</script>
</body>
</html>
