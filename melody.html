function layoutAll(){
  const vw = innerWidth, vh = innerHeight;
  const margin = Math.max(16, Math.min(48, Math.round(Math.min(vw,vh)*0.04)));
  const baseCell = num(css().getPropertyValue('--iso-cell-base'), 32);
  const baseCube = num(css().getPropertyValue('--cube-size-base'), 36);
  const MOBILE = vw < 520; // breakpoint: stack rows vertically on small screens

  // initialize at base scale
  document.documentElement.style.setProperty('--iso-cell', `${baseCell}px`);
  document.documentElement.style.setProperty('--cube-size', `${baseCube}px`);
  B = basis();

  const recH = parseInt(getComputedStyle(document.querySelector('.rec')).height) || 0;

  // ------- FIRST RENDER (unscaled) -------
  const rowLen = 5; // 5 notes per row
  const rowGap = MOBILE ? 9 : (vw < 560 ? 9 : 7); // a bit more vertical space on mobile

  // center within available space (above recorder bar)
  const centerIJ = snap(vw/2, (vh - recH)/2 - 10);
  const startI = centerIJ.I - Math.floor(rowLen/2);

  // top row J such that rows are vertically centered as a block
  const totalJSpan = rowGap * (4 - 1);
  const startJTop = centerIJ.J - totalJSpan/2;

  const start1 = { I: startI, J: startJTop + rowGap * 0 };
  const start2 = { I: startI, J: startJTop + rowGap * 1 };
  const start3 = { I: startI, J: startJTop + rowGap * 2 };
  const start4 = { I: startI, J: startJTop + rowGap * 3 };

  // render 4 horizontal rows (same on desktop & mobile)
  row1.innerHTML = row2.innerHTML = row3.innerHTML = row4.innerHTML = '';
  placeRow(row1, start1, row1Notes, 2.0);
  placeRow(row2, start2, row2Notes, 2.2);
  placeRow(row3, start3, row3Notes, 2.4);
  placeRow(row4, start4, row4Notes, 2.6);

  // ------- FIT PASS (scale to viewport), then re-render -------
  const b = measureBounds();
  const needW = vw - margin*2;
  const needH = vh - margin*2 - recH;
  const sW = needW / b.width;
  const sH = needH / b.height;
  const scale = Math.min(1, sW, sH);

  document.documentElement.style.setProperty('--iso-cell', `${baseCell*scale}px`);
  document.documentElement.style.setProperty('--cube-size', `${baseCube*scale}px`);
  B = basis();

  // recenter after scaling
  const center2 = snap(vw/2, (vh - recH)/2 - 10);
  const startI2 = center2.I - Math.floor(rowLen/2);
  const startJTop2 = center2.J - totalJSpan/2;

  const start1b = { I: startI2, J: startJTop2 + rowGap * 0 };
  const start2b = { I: startI2, J: startJTop2 + rowGap * 1 };
  const start3b = { I: startI2, J: startJTop2 + rowGap * 2 };
  const start4b = { I: startI2, J: startJTop2 + rowGap * 3 };

  row1.innerHTML = row2.innerHTML = row3.innerHTML = row4.innerHTML = '';
  placeRow(row1, start1b, row1Notes, 2.0);
  placeRow(row2, start2b, row2Notes, 2.2);
  placeRow(row3, start3b, row3Notes, 2.4);
  placeRow(row4, start4b, row4Notes, 2.6);

  window.dispatchEvent(new Event('resize'));
  window.dispatchEvent(new Event('iso:refresh'));
}
