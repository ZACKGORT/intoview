<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>intoview • note — collector edition (B&W, single file • fixed)</title>
<link rel="icon" href="data:,"/>
<style>
/* ==========================================================
   Intoview • Note — Collector Edition (Single File, Fixed)
   Focus: photo frame Title/Note/Meta in strict B&W
   ========================================================== */

/* ---------- TOKENS (B&W) ---------- */
:root{
  --paper:#FFFFFF;  --ink:#111111;  --ink-2:#444444;  --ink-3:#777777;
  --bg-0:var(--paper); --bg-1:var(--paper); --bg-2:var(--paper); --bg-3:var(--paper);
  --fg:var(--ink); --fg-2:var(--ink-2); --fg-3:var(--ink-3);
  --rule:1.5px; --hair:1px;
  --r-xs:2px; --r-sm:4px; --r-md:4px; --r-lg:6px; --r-xl:8px;
  --s0:0; --s1:4px; --s2:8px; --s3:12px; --s4:16px; --s5:20px; --s6:24px; --s7:28px; --s8:32px; --s10:40px; --s12:48px;
  --container-max: 720px;
  --touch:44px; --touch-lg:52px;
  --font-ui: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  --fs-xs:11px; --fs-sm:13px; --fs-md:15px; --fs-lg:17px; --fs-xl:20px; --fs-display:28px;
  --lh-tight:1.15; --lh-snug:1.28; --lh-normal:1.45;
  --ease: cubic-bezier(.2,.7,.2,1); --t-fast:100ms var(--ease); --t-base:150ms var(--ease);
}

/* ---------- PAGE ---------- */
html,body{height:100%}
body{margin:0;background:var(--paper);color:var(--fg);
  font:400 var(--fs-md)/var(--lh-normal) var(--font-ui);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
.header{position:sticky;top:0;z-index:10;background:var(--paper);border-bottom:var(--hair) solid var(--ink-2)}
.header__inner{max-width:var(--container-max);margin:0 auto;
  padding:12px calc(16px + env(safe-area-inset-right)) 12px calc(16px + env(safe-area-inset-left));
  display:flex;gap:12px;align-items:center;justify-content:space-between}
.title{font:800 var(--fs-xl)/var(--lh-tight) var(--font-ui)}
.subtitle{color:var(--fg-2);font-size:var(--fs-sm)}
.container{max-width:var(--container-max);margin:0 auto;
  padding:16px calc(16px + env(safe-area-inset-right)) calc(16px + env(safe-area-inset-bottom)) calc(16px + env(safe-area-inset-left))}
.section{margin:24px 0;border:var(--rule) solid var(--ink);border-radius:var(--r-sm);background:var(--paper)}
.section__hd{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:var(--hair) dashed var(--ink-2)}
.section__bd{padding:16px}
.badge{padding:6px 8px;border-radius:var(--r-xs);border:var(--hair) solid var(--ink-2);background:var(--paper);font:700 var(--fs-xs)/1 var(--font-mono);color:var(--fg-2)}
.row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* ---------- CONTROLS ---------- */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;min-height:44px;padding:0 16px;border-radius:var(--r-sm);
  border:var(--rule) solid var(--ink);background:transparent;color:var(--fg);
  font:800 var(--fs-md)/1 var(--font-ui);transition:transform var(--t-fast)}
.btn:active{transform:translateY(1px)}
.btn--ghost{border:var(--hair) solid var(--ink-2);}
.btn--lg{min-height:52px;padding:0 20px}

.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{min-width:52px;height:36px;padding:0 10px;border-radius:var(--r-sm);display:inline-flex;align-items:center;justify-content:center;
  border:var(--hair) solid var(--ink-2);background:transparent;color:var(--fg);font-weight:700}
.chip[aria-pressed="true"]{border-color:var(--ink)}

/* Fields */
.field{display:flex;flex-direction:column;gap:8px}
.label{font:800 var(--fs-sm)/1 var(--font-ui);color:var(--fg)}
.input,.textarea{background:var(--paper);border:var(--rule) solid var(--ink);color:var(--fg);border-radius:var(--r-sm);padding:10px 12px}
.input:focus,.textarea:focus{outline:2px solid var(--ink);outline-offset:1px}
.textarea{min-height:96px;resize:vertical}
.counter{color:var(--fg-2);font:700 var(--fs-sm)/1 var(--font-mono)}

/* Viewfinder */
.card{border:var(--rule) solid var(--ink);border-radius:var(--r-sm);background:var(--paper)}
.vf{position:relative;aspect-ratio:4/3;width:100%;overflow:hidden;border-radius:var(--r-sm);border:var(--rule) solid var(--ink);background:#000}
.vf.r11{aspect-ratio:1/1} .vf.r43{aspect-ratio:4/3} .vf.r169{aspect-ratio:16/9}
video{width:100%;height:100%;object-fit:cover;display:block}
.mask{position:absolute;inset:0;pointer-events:none}
.mask .grid{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:1fr 1fr 1fr;opacity:.6}
.mask .grid > div{border-right:var(--hair) solid var(--ink-2)}
.mask .grid > div:nth-child(3n){border-right:0}
.mask .grid:after{content:"";grid-column:1/-1;border-top:var(--hair) dashed var(--ink-2);align-self:center}
.level{position:absolute;left:12px;right:12px;bottom:12px;display:flex;justify-content:center}

/* Preview/Export canvases */
.preview{background:var(--paper);border:var(--rule) solid var(--ink);border-radius:var(--r-sm);aspect-ratio:4/3;width:100%;display:flex;align-items:center;justify-content:center;overflow:hidden}

/* Steps */
.step{display:none}
.step.active{display:block}

/* Toast */
.toast{position:fixed;left:50%;bottom:calc(12px + env(safe-area-inset-bottom));transform:translateX(-50%);
  background:var(--paper);color:var(--fg);border:var(--rule) solid var(--ink);border-radius:var(--r-sm);
  padding:10px 12px;font:700 var(--fs-sm)/1 var(--font-mono); z-index:1000;}

/* Accessibility */
.visually-hidden{position:absolute!important;clip:rect(1px,1px,1px,1px)!important;width:1px!important;height:1px!important;overflow:hidden!important;padding:0!important;border:0!important}

/* ---------- DARK THEME ---------- */
html[data-theme="dark"]{ --paper:#0B0B0C; --ink:#F3F3F5; --ink-2:#C9C9CF; --ink-3:#9A9AA2; }
</style>
</head>
<body>
<header class="header" role="banner">
  <div class="header__inner">
    <div>
      <div class="title">intoview • note</div>
      <div class="subtitle">Collector frame — camera → review → caption → export</div>
    </div>
    <div class="row">
      <button class="btn btn--ghost" id="themeToggle" aria-pressed="false" title="Toggle theme">Theme: <span id="themeLabel">Light</span></button>
      <button class="btn btn--ghost" id="importPhotoTop">Import</button>
    </div>
  </div>
</header>

<main class="container" role="main">
  <!-- STEP 0 -->
  <section class="section step active" data-step="0" id="step0">
    <div class="section__hd">
      <div class="row"><strong>Start</strong></div><span class="badge">Step 0</span>
    </div>
    <div class="section__bd">
      <div class="subtitle">Open the camera or import a photo. Title, note, and export follow.</div>
      <div class="grid2" style="margin-top:12px">
        <button class="btn btn--lg" id="startCamera">Open Camera</button>
        <button class="btn btn--lg btn--ghost" id="importPhoto">Import Photo</button>
      </div>
    </div>
  </section>

  <!-- STEP 1: Viewfinder -->
  <section class="section step" data-step="1" id="step1">
    <div class="section__hd">
      <div class="row"><strong>Viewfinder</strong></div><span class="badge">Step 1</span>
    </div>
    <div class="section__bd">
      <div class="card" style="padding:12px">
        <div class="vf r43" id="vf" role="img" aria-label="Live camera view with grid overlay">
          <video id="video" playsinline muted></video>
          <div class="mask" aria-hidden="true">
            <div class="grid">
              <div></div><div></div><div></div>
              <div></div><div></div><div></div>
              <div></div><div></div><div></div>
            </div>
          </div>
          <div class="level"><canvas id="level" width="240" height="56" style="width:240px;height:56px"></canvas></div>
        </div>
        <div class="chips" role="group" aria-label="Aspect ratio" style="margin-top:12px">
          <button class="chip" id="r169" aria-pressed="false">16:9</button>
          <button class="chip" id="r43"  aria-pressed="true">4:3</button>
          <button class="chip" id="r11"  aria-pressed="false">1:1</button>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn btn--lg" id="capture">Capture</button>
          <button class="btn btn--lg btn--ghost" id="importAlt">Import</button>
        </div>
        <input type="file" accept="image/*" id="importHidden" style="display:none"/>
      </div>
    </div>
  </section>

  <!-- STEP 2: Review -->
  <section class="section step" data-step="2" id="step2">
    <div class="section__hd">
      <div class="row"><strong>Review</strong></div><span class="badge">Step 2</span>
    </div>
    <div class="section__bd">
      <div class="preview"><canvas id="reviewCanvas" style="width:100%;height:auto;max-height:72vh"></canvas></div>
      <div class="grid2" style="margin-top:12px">
        <button class="btn btn--lg btn--ghost" id="retake">Retake</button>
        <button class="btn btn--lg" id="keep">Keep</button>
      </div>
    </div>
  </section>

  <!-- STEP 3: Caption (includes Title) -->
  <section class="section step" data-step="3" id="step3">
    <div class="section__hd">
      <div class="row"><strong>Details</strong></div><span class="badge">Step 3</span>
    </div>
    <div class="section__bd">
      <div class="field">
        <label class="label" for="titleInput">Title (40)</label>
        <input id="titleInput" class="input" maxlength="40" placeholder="TITLE"/>
        <div class="row" style="justify-content:flex-end"><div class="counter" id="titleCount">0/40</div></div>
      </div>
      <div class="field">
        <label class="label" for="caption">Note (140)</label>
        <textarea id="caption" class="textarea" maxlength="140" placeholder="Write a note, not a novel.">A quick visual note</textarea>
        <div class="row" style="justify-content:flex-end"><div class="counter" id="capCount">0/140</div></div>
      </div>
      <div class="grid2" style="margin-top:12px">
        <button class="btn btn--lg btn--ghost" id="captionBack">Back</button>
        <button class="btn btn--lg" id="toExport">Next</button>
      </div>
    </div>
  </section>

  <!-- STEP 4: Export -->
  <section class="section step" data-step="4" id="step4">
    <div class="section__hd">
      <div class="row"><strong>Export</strong></div><span class="badge">Step 4</span>
    </div>
    <div class="section__bd">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="subtitle">Export • <span id="expRatioTxt">4:3</span></div>
        <div class="chips" role="group" aria-label="Export ratio">
          <button class="chip" id="exp43" aria-pressed="true">4:3</button>
          <button class="chip" id="exp11" aria-pressed="false">1:1</button>
        </div>
      </div>
      <div class="preview"><canvas id="exportCanvas" style="width:100%;height:auto;max-height:72vh"></canvas></div>
      <div class="grid2" style="margin-top:12px">
        <button class="btn btn--lg btn--ghost" id="exportBack">Back</button>
        <button class="btn btn--lg" id="exportBtn">Export PNG</button>
      </div>
    </div>
  </section>

  <!-- STEP 5: Done -->
  <section class="section step" data-step="5" id="step5">
    <div class="section__hd"><div class="row"><strong>Done</strong></div><span class="badge">Step 5</span></div>
    <div class="section__bd center">
      <div class="row" style="flex-direction:column;align-items:center">
        <div class="badge">Saved / Exported</div>
        <div class="row" style="margin-top:12px">
          <button class="btn btn--lg btn--ghost" id="newFromHere">New note</button>
          <button class="btn btn--lg" id="shareAction">Share</button>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast" style="display:none" role="status" aria-live="polite"></div>

<script>
(function(){
  /* ---------- Helpers (single definitions, hoisted) ---------- */
  function $(s){ return document.querySelector(s); }
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function wrapText(ctx,text,x,y,maxWidth,lineHeight,align){ const words = String(text||"").split(" "); let line = ""; const lines = []; for(let i=0;i<words.length;i++){ const test = line + words[i] + " "; if (ctx.measureText(test).width > maxWidth && i>0){ lines.push(line.trim()); line = words[i] + " "; } else { line = test; } } lines.push(line.trim()); ctx.textAlign = align || 'left'; for(let i=0;i<lines.length;i++){ ctx.fillText(lines[i], x, y + i*lineHeight); } }
  function hair(ctx){ ctx.lineWidth = 1; }
  function rule(ctx){ ctx.lineWidth = 1.5; }
  function filmStrip(ctx, x, y, w, h, color){ ctx.strokeStyle = color; hair(ctx); ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x+w, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y+h); ctx.lineTo(x+w, y+h); ctx.stroke(); }
  function serial(){ return Date.now().toString(36).toUpperCase().slice(-6); }
  function toast(msg){ const t = $('#toast'); if(!t) return; t.textContent = msg; t.style.display='block'; clearTimeout(t._timer); t._timer = setTimeout(()=>{ t.style.display='none'; }, 2000); }

  /* ---------- Theme ---------- */
  const themeToggle = $('#themeToggle'), themeLabel = $('#themeLabel');
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    const pressed = t === 'dark';
    if (themeToggle) themeToggle.setAttribute('aria-pressed', String(pressed));
    if (themeLabel) themeLabel.textContent = pressed ? 'Dark' : 'Light';
    try { localStorage.setItem('iv_collector_theme', t); } catch {}
    // Redraw if canvases exist
    if (window.drawReview) window.drawReview();
    if (window.drawExport) window.drawExport();
  }
  const saved = (()=>{ try{ return localStorage.getItem('iv_collector_theme'); }catch{ return null } })();
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  applyTheme(saved || (prefersDark ? 'dark' : 'light'));
  themeToggle?.addEventListener('click', ()=>{
    const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    applyTheme(next);
  });

  /* ---------- Steps ---------- */
  const steps = [...document.querySelectorAll('.step')];
  let stepIndex = 0;
  function go(i){ stepIndex = Math.max(0, Math.min(steps.length-1, i)); steps.forEach((el, idx)=>el.classList.toggle('active', idx===stepIndex)); }
  window.__go = go; go(0);

  /* ---------- Elements & State ---------- */
  const vf = $('#vf'), video = $('#video'), levelCanvas = $('#level');
  const reviewCanvas = $('#reviewCanvas'), exportCanvas = $('#exportCanvas');
  const importHidden = $('#importHidden');
  const titleInput = $('#titleInput'), captionEl = $('#caption');
  const titleCount = $('#titleCount'), capCount = $('#capCount');
  const expRatioTxt = $('#expRatioTxt');

  function bindCount(el, out){
    if(!el||!out) return;
    const max = el.getAttribute('maxlength')|0;
    const update = ()=>{ out.textContent = `${el.value.length}/${max}` };
    el.addEventListener('input', update); update();
  }
  bindCount(titleInput, titleCount); bindCount(captionEl, capCount);

  let viewRatio = '4:3';
  let lastShot = null;
  let expRatio = '4:3';

  /* ---------- Start / Import ---------- */
  $('#startCamera')?.addEventListener('click', initCameraAndGo);
  $('#importPhoto')?.addEventListener('click', ()=>importHidden?.click());
  $('#importPhotoTop')?.addEventListener('click', ()=>importHidden?.click());
  $('#importAlt')?.addEventListener('click', ()=>importHidden?.click());
  importHidden?.addEventListener('change', onImportFile);

  async function initCameraAndGo(){ await initCamera(); go(1); }
  async function initCamera(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      await video.play();
      startLevel(levelCanvas);
    }catch(err){
      toast('Camera unavailable — try Import instead.');
      console.warn(err);
    }
  }

  function onImportFile(e){
    const file = e.target.files && e.target.files[0];
    if(!file){ toast('No file selected.'); return; }
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement('canvas');
      c.width = img.width; c.height = img.height;
      c.getContext('2d').drawImage(img, 0, 0);
      lastShot = c; drawReview(); go(2);
    };
    img.onerror = ()=> toast('Could not load image.');
    img.src = URL.createObjectURL(file);
  }

  /* ---------- Ratio chips ---------- */
  const r169=$('#r169'), r43=$('#r43'), r11=$('#r11');
  function setChip(el, pressed){ el?.setAttribute('aria-pressed', String(pressed)); }
  function setViewRatio(r){
    viewRatio = r;
    setChip(r169, r==='16:9'); setChip(r43, r==='4:3'); setChip(r11, r==='1:1');
    if(vf){ vf.classList.toggle('r169', r==='16:9'); vf.classList.toggle('r43', r==='4:3'); vf.classList.toggle('r11', r==='1:1'); }
  }
  r169?.addEventListener('click', ()=>setViewRatio('16:9'));
  r43 ?.addEventListener('click', ()=>setViewRatio('4:3'));
  r11 ?.addEventListener('click', ()=>setViewRatio('1:1'));
  setViewRatio('4:3');

  /* ---------- Capture ---------- */
  $('#capture')?.addEventListener('click', onCapture);
  function onCapture(){
    if(!video || !video.videoWidth){ toast('Camera not ready.'); return; }
    const vw = video.videoWidth, vh = video.videoHeight;
    const [rw, rh] = viewRatio.split(':').map(Number);
    const targ = rw/rh;
    let sw = vw, sh = Math.round(vw / targ);
    if (sh > vh){ sh = vh; sw = Math.round(vh * targ); }
    const sx = Math.floor((vw - sw)/2), sy = Math.floor((vh - sh)/2);
    const c = document.createElement('canvas'); c.width = sw; c.height = sh;
    c.getContext('2d').drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);
    lastShot = c; drawReview(); go(2);
  }

  /* ---------- Review ---------- */
  function drawReview(){
    if(!reviewCanvas || !lastShot) return;
    const size = {w: 1200, h: 900};
    reviewCanvas.width = size.w; reviewCanvas.height = size.h;
    const ctx = reviewCanvas.getContext('2d');
    const cs = getComputedStyle(document.documentElement);
    const paper = cs.getPropertyValue('--paper').trim() || '#FFFFFF';
    const ink = cs.getPropertyValue('--ink').trim() || '#111111';
    ctx.fillStyle = paper; ctx.fillRect(0,0,size.w,size.h);
    const inset=24;
    const area = {x: inset, y: inset, w: size.w - inset*2, h: size.h - inset*2};
    const iw = lastShot.width, ih = lastShot.height;
    const scale = Math.max(area.w/iw, area.h/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = area.x + (area.w - dw)/2, dy = area.y + (area.h - dh)/2;
    ctx.save(); roundRect(ctx, area.x, area.y, area.w, area.h, 6); ctx.clip(); ctx.drawImage(lastShot, dx, dy, dw, dh); ctx.restore();
    ctx.strokeStyle = ink; rule(ctx); roundRect(ctx, area.x+0.75, area.y+0.75, area.w-1.5, area.h-1.5, 6); ctx.stroke();
  }
  window.drawReview = drawReview;

  $('#retake')?.addEventListener('click', ()=>go(1));
  $('#keep')  ?.addEventListener('click', ()=>{
    if(!lastShot){ toast('Capture or import an image first.'); return; }
    go(3);
  });
  $('#captionBack')?.addEventListener('click', ()=>go(2));
  $('#toExport')   ?.addEventListener('click', ()=>{
    if(!lastShot){ toast('Capture or import an image first.'); return; }
    drawExport(); go(4);
  });

  /* ---------- Export ---------- */
  const exp43=$('#exp43'), exp11=$('#exp11');
  function setExpRatio(r){
    expRatio = r; if(expRatioTxt) expRatioTxt.textContent = r;
    exp43?.setAttribute('aria-pressed', String(r==='4:3'));
    exp11?.setAttribute('aria-pressed', String(r==='1:1'));
    drawExport();
  }
  exp43?.addEventListener('click', ()=>setExpRatio('4:3'));
  exp11?.addEventListener('click', ()=>setExpRatio('1:1'));
  setExpRatio('4:3');

  function drawExport(){
    if(!exportCanvas || !lastShot) return;
    const size = (expRatio==='1:1') ? {w:1200,h:1200} : {w:1200,h:900};
    exportCanvas.width = size.w; exportCanvas.height = size.h;
    const ctx = exportCanvas.getContext('2d');
    const cs = getComputedStyle(document.documentElement);
    const paper = cs.getPropertyValue('--paper').trim() || '#FFFFFF';
    const ink = cs.getPropertyValue('--ink').trim() || '#111111';
    const ink2 = cs.getPropertyValue('--ink-2').trim() || '#444444';

    ctx.fillStyle = paper; ctx.fillRect(0,0,size.w,size.h);

    const inset = 32, topH = 56, bottomH = 64, gap = 16;
    const bandW = size.w - inset*2;
    const imgArea = { x: inset, y: inset + topH + gap, w: bandW, h: size.h - inset*2 - topH - bottomH - gap*2 };

    // Image
    const iw = lastShot.width, ih = lastShot.height;
    const scale = Math.max(imgArea.w/iw, imgArea.h/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = imgArea.x + (imgArea.w - dw)/2, dy = imgArea.y + (imgArea.h - dh)/2;
    ctx.save(); roundRect(ctx, imgArea.x, imgArea.y, imgArea.w, imgArea.h, 6); ctx.clip(); ctx.drawImage(lastShot, dx, dy, dw, dh); ctx.restore();
    ctx.strokeStyle = ink; rule(ctx); roundRect(ctx, imgArea.x+0.75, imgArea.y+0.75, imgArea.w-1.5, imgArea.h-1.5, 6); ctx.stroke();

    // Top band
    hair(ctx); ctx.strokeStyle = ink2;
    ctx.beginPath(); ctx.moveTo(inset, inset + topH + 0.5); ctx.lineTo(inset + bandW, inset + topH + 0.5); ctx.stroke();
    ctx.fillStyle = ink; ctx.font = "800 20px " + getComputedStyle(document.body).fontFamily; ctx.textAlign = "left"; ctx.textBaseline = "alphabetic";
    const title = (titleInput?.value || "—").toUpperCase();
    ctx.fillText(title, inset + 12, inset + topH - 14);
    ctx.fillStyle = ink2; ctx.font = "700 14px " + getComputedStyle(document.body).fontFamily; ctx.textAlign = "right";
    ctx.fillText(expRatio, inset + bandW - 12, inset + topH - 14);

    // Film-strip nod
    filmStrip(ctx, imgArea.x, imgArea.y - 10, imgArea.w, 8, ink2);
    filmStrip(ctx, imgArea.x, imgArea.y + imgArea.h + 2, imgArea.w, 8, ink2);

    // Bottom band
    const bottomY = imgArea.y + imgArea.h + gap;
    hair(ctx); ctx.strokeStyle = ink2;
    ctx.beginPath(); ctx.moveTo(inset, bottomY + 0.5); ctx.lineTo(inset + bandW, bottomY + 0.5); ctx.stroke();

    // Note + Meta
    ctx.fillStyle = ink; ctx.font = "800 18px " + getComputedStyle(document.body).fontFamily; ctx.textAlign = "left"; ctx.textBaseline = "top";
    const noteMaxW = bandW * 0.66 - 12;
    wrapText(ctx, captionEl?.value, inset + 12, bottomY + 10, noteMaxW, 22, 'left');

    ctx.fillStyle = ink2; ctx.font = "700 14px " + getComputedStyle(document.body).fontFamily; ctx.textAlign = "right"; ctx.textBaseline = "alphabetic";
    const dt = new Date(); const dateStr = dt.toISOString().replace('T',' ').slice(0,16);
    const metaRight = `${dateStr}  •  NO. ${serial()}`;
    ctx.fillText(metaRight, inset + bandW - 12, bottomY + bottomH - 14);
  }
  window.drawExport = drawExport;

  function doExport(){
    if(!lastShot){ toast('Nothing to export yet.'); return; }
    const target = (expRatio==='1:1') ? {w:2400,h:2400} : {w:2400,h:1800};
    const c = document.createElement('canvas'); c.width = target.w; c.height = target.h;
    const ctx = c.getContext('2d');
    const cs = getComputedStyle(document.documentElement);
    const paper = cs.getPropertyValue('--paper').trim() || '#FFFFFF';
    const ink = cs.getPropertyValue('--ink').trim() || '#111111';
    const ink2 = cs.getPropertyValue('--ink-2').trim() || '#444444';

    ctx.fillStyle = paper; ctx.fillRect(0,0,target.w,target.h);

    const inset = 64, topH = 96, bottomH = 112, gap = 24;
    const bandW = target.w - inset*2;
    const imgArea = { x: inset, y: inset + topH + gap, w: bandW, h: target.h - inset*2 - topH - bottomH - gap*2 };

    // Image
    const iw = lastShot.width, ih = lastShot.height;
    const scale = Math.max(imgArea.w/iw, imgArea.h/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = imgArea.x + (imgArea.w - dw)/2, dy = imgArea.y + (imgArea.h - dh)/2;
    roundRect(ctx, imgArea.x, imgArea.y, imgArea.w, imgArea.h, 10); ctx.save(); ctx.clip(); ctx.drawImage(lastShot, dx, dy, dw, dh); ctx.restore();
    ctx.strokeStyle = ink; rule(ctx); roundRect(ctx, imgArea.x+0.75, imgArea.y+0.75, imgArea.w-1.5, imgArea.h-1.5, 10); ctx.stroke();

    // Top band
    hair(ctx); ctx.strokeStyle = ink2;
    ctx.beginPath(); ctx.moveTo(inset, inset + topH + 0.5); ctx.lineTo(inset + bandW, inset + topH + 0.5); ctx.stroke();
    ctx.fillStyle = ink; ctx.font = "800 28px " + getComputedStyle(document.body).fontFamily; ctx.textAlign = "left"; ctx.textBaseline = "alphabetic";
    const title = (titleInput?.value || "—").toUpperCase();
    ctx.fillText(title, inset + 16, inset + topH - 18);
    ctx.fillStyle = ink2; ctx.font = "700 16px " + getComputedStyle(document.body).fontFamily; ctx.textAlign = "right";
    ctx.fillText(expRatio, inset + bandW - 16, inset + topH - 18);

    // Film-strip nod
    filmStrip(ctx, imgArea.x, imgArea.y - 14, imgArea.w, 10, ink2);
    filmStrip(ctx, imgArea.x, imgArea.y + imgArea.h + 4, imgArea.w, 10, ink2);

    // Bottom band
    const bottomY = imgArea.y + imgArea.h + gap;
    hair(ctx); ctx.strokeStyle = ink2;
    ctx.beginPath(); ctx.moveTo(inset, bottomY + 0.5); ctx.lineTo(inset + bandW, bottomY + 0.5); ctx.stroke();

    // Note + Meta
    ctx.fillStyle = ink; ctx.font = "800 22px " + getComputedStyle(document.body).fontFamily; ctx.textAlign = "left"; ctx.textBaseline = "top";
    const noteMaxW = bandW * 0.68 - 16;
    wrapText(ctx, captionEl?.value, inset + 16, bottomY + 14, noteMaxW, 26, "left");

    ctx.fillStyle = ink2; ctx.font = "700 16px " + getComputedStyle(document.body).fontFamily; ctx.textAlign = "right"; ctx.textBaseline = "alphabetic";
    const dt = new Date(); const dateStr = dt.toISOString().replace('T',' ').slice(0,16);
    const metaRight = `${dateStr}  •  NO. ${serial()}`;
    ctx.fillText(metaRight, inset + bandW - 16, bottomY + bottomH - 20);

    c.toBlob((blob)=>{
      if(!blob){ toast('Export failed.'); return; }
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `intoview_note_${expRatio.replace(":","-")}_${Date.now()}.png`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      go(5);
    }, "image/png", 0.94);
  }

  $('#exportBack')?.addEventListener('click', ()=>go(3));
  $('#exportBtn') ?.addEventListener('click', doExport);
  $('#newFromHere')?.addEventListener('click', ()=>{ titleInput.value=''; captionEl.value='A quick visual note'; setViewRatio('4:3'); go(1); });
  $('#shareAction') ?.addEventListener('click', async ()=>{ try{ await navigator.share({ title:"intoview • note", text:"Shared from intoview • note" }); }catch(e){} });

  /* ---------- Liquid level (outlined) ---------- */
  function startLevel(c){
    if(!c) return;
    const ctx = c.getContext('2d'); let roll = 0;
    function draw(){
      const w = 240, h = 56, dpr = Math.max(1, devicePixelRatio||1);
      c.width = w*dpr; c.height = h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,w,h);
      const cs = getComputedStyle(document.documentElement);
      const paper = cs.getPropertyValue('--paper').trim() || '#FFFFFF';
      const ink = cs.getPropertyValue('--ink').trim() || '#111111';
      const ink2 = cs.getPropertyValue('--ink-2').trim() || '#444444';
      ctx.fillStyle = paper; ctx.fillRect(0,0,w,h); ctx.strokeStyle = ink; rule(ctx); ctx.strokeRect(0.75,0.75,w-1.5,h-1.5);
      const angle = -roll * Math.PI/180, mid = h*0.55;
      ctx.save(); ctx.translate(w/2, mid); ctx.rotate(angle); ctx.fillStyle = ink2; ctx.fillRect(-w, 0, w*2, h); ctx.restore();
      const r = 7, bx = w/2 + ((45 - (roll+45))/90)*80, by = mid - 3;
      ctx.beginPath(); ctx.arc(bx, by, r, 0, Math.PI*2); ctx.fillStyle = paper; ctx.fill(); hair(ctx); ctx.strokeStyle = ink; ctx.stroke();
    }
    function setRoll(v){ roll = Math.max(-45, Math.min(45, v)); draw(); }
    function onOrient(e){ setRoll(e.gamma||0); }
    function onMouse(e){ setRoll(((e.clientX/innerWidth)*2-1)*30); }
    if('DeviceOrientationEvent' in window){ window.addEventListener('deviceorientation', onOrient); } else { window.addEventListener('mousemove', onMouse); }
    draw();
  }

})();</script>
</body>
</html>
