<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>i n t o v i e w : N.O.D.E.</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #050505;
      --card-bg: #111111;
      --card-bg-rgb: 17, 17, 17;
      --ink: #ffffff;
      --ink-dim: #888888;
      --accent: #FFED29;
      
      --neon-green: #22c55e;
      --neon-orange: #f97316;
      --neon-red: #ef4444;
      --neon-blue: #3b82f6;
      
      --glass-bg: rgba(20, 20, 20, 0.85);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-blur: 16px;
      
      --nav-height: 80px;
      --header-height: 100px;
      --font-mono: 'JetBrains Mono', monospace;
      --font-sans: 'Inter', sans-serif;
    }

    [data-theme="light"] {
      --bg-color: #f0f0f0;
      --card-bg: #ffffff;
      --card-bg-rgb: 255, 255, 255;
      --ink: #111111;
      --ink-dim: #666666;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(0, 0, 0, 0.1);
    }

    [data-theme="rose"] {
      --bg-color: #87CEFA;
      --card-bg: #FFC0CB;
      --card-bg-rgb: 255, 192, 203;
      --ink: #000000;
      --ink-dim: #4B0082;
      --accent: #FFD700;
      
      --neon-green: #32CD32;
      --neon-orange: #FFA500;
      --neon-red: #FF4500;
      --neon-blue: #00BFFF;
      
      --glass-bg: rgba(255, 192, 203, 0.85);
      --glass-border: rgba(75, 0, 130, 0.1);
      --glass-blur: 16px;
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    html, body { height: 100%; font-family: var(--font-sans); background: var(--bg-color); color: var(--ink); overflow: hidden; }


        /* --- CINEMATIC VISUAL EFFECTS (Task 1) --- */
        .cinematic-fx {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 100;
        /* Vignette: Darkens corners */
        background: radial-gradient(circle at center, transparent 60%, rgba(0,0,0,0.4) 100%);
        /* Edge Blur: Subtle blur around the very edges */
        box-shadow: inset 0 0 100px rgba(0,0,0,0.75); 
    }
    
    /* Specific edge blur for supported browsers */
    @supports (backdrop-filter: blur(1px)) {
        .cinematic-fx::after {
            content: '';
            position: absolute;
            inset: 0;
            /* Mask creates a hole in the center, blurring only edges */
            -webkit-mask: radial-gradient(circle at center, transparent 70%, black 100%);
            mask: radial-gradient(circle at center, transparent 70%, black 100%);
            backdrop-filter: blur(4px);
        }
    }




    /* --- Custom Scrollbar Design --- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--ink-dim); }

    /* --- Typography & Utilities --- */
    .text-green { color: var(--neon-green); }
    .text-orange { color: var(--neon-orange); }
    .text-red { color: var(--neon-red); }
    .text-blue { color: var(--neon-blue); }
    
    /* --- Layout Structure --- */
    .app-header {
      position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
      display: flex; flex-direction: column; justify-content: center;
      padding: 10px 0; z-index: 100;
      background: linear-gradient(to bottom, var(--bg-color) 40%, transparent);
      pointer-events: none;
    }
    .header-top { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 0 20px; width: 100%; pointer-events: auto; 
    }
    
    /* Logo Styling */
    .logo { 
        display: flex; align-items: center; height: 32px; 
    }
    /* Logo Image Sizing */
    .logo svg {
        height: 32px; /* Enforce size for the SVG */
        width: auto;
    }

    /* Text Logo Fallback */
    .logo-text {
      font-family: var(--font-mono);
      font-weight: 800;
      font-size: 20px;
      letter-spacing: -1px;
      color: var(--ink);
      display: flex; align-items: center; gap: 8px;
    }
    .logo-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); }

    .header-buttons { display: flex; align-items: center; gap: 8px; margin-left: auto; }

    .theme-btn {
        background: transparent; border: none; color: var(--ink-dim);
        cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center;
    }
    .theme-btn:active { background: var(--glass-border); color: var(--ink); }

    /* --- Provider Toggle Bar --- */
    .provider-bar {
      display: flex; gap: 8px; overflow-x: auto; padding: 10px 20px;
      pointer-events: auto; scrollbar-width: none;
      justify-content: flex-start; 
    }
    .provider-bar::-webkit-scrollbar { display: none; }
    
    .pill {
      padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;
      background: var(--glass-bg); border: 1px solid var(--glass-border);
      color: var(--ink-dim); white-space: nowrap; cursor: pointer; transition: all 0.2s;
      flex-shrink: 0; 
    }
    .pill.active { background: var(--ink); color: var(--bg-color); border-color: var(--ink); }
    .pill.add-btn { border-style: dashed; }

    .view-container {
      position: absolute; inset: 0;
      top: var(--header-height); bottom: 0;
      overflow: hidden; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .view-container.active { opacity: 1; pointer-events: auto; }

    /* --- Grid View --- */
    #gridContainer { overflow-y: auto; padding: 10px 16px 120px 16px; }
    .grid-wrapper {
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 16px; 
      padding-bottom: 40px;
    }
    @media(min-width: 600px) { .grid-wrapper { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); } }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      display: flex; flex-direction: column; gap: 12px;
      transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
      cursor: pointer; /* Clickable */
    }
    .card:active { transform: scale(0.98); background: var(--glass-border); color: var(--ink); }

    #gridContainer .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      border-color: var(--accent);
    }

    .card-top { display: flex; justify-content: space-between; align-items: center; }
    .card-provider { font-weight: 600; font-size: 14px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
    
    /* UPDATED STATUS DOT */
    .status-dot { 
        width: 8px; height: 8px; 
        border-radius: 50%; 
        background-color: currentColor; /* SOLID FILL */
        box-shadow: 0 0 6px currentColor, 0 0 12px currentColor; /* DOUBLE GLOW */
        animation: pulse 2s infinite ease-in-out; 
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); box-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
    }

    /* Edit Icon Style */
    .card-edit-icon {
      color: var(--ink-dim); padding: 4px; border-radius: 4px;
      transition: color 0.2s, background 0.2s, opacity 0.2s, transform 0.2s;
      margin-left: 8px;
      opacity: 0.5;
    }
    .card-edit-icon:hover { color: var(--ink); background: rgba(255,255,255,0.1); opacity: 1; transform: scale(1.1); }

    .card-timer {
      font-family: var(--font-mono);
      font-size: 2.4rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: -1px;
      margin: 8px 0;
      position: relative;
    }

    .card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--ink-dim); border-top: 1px solid var(--glass-border); padding-top: 12px; }
    .card-email { font-family: var(--font-mono); opacity: 0.8; }
    
    .card-actions { display: flex; gap: 8px; }
    .action-icon { 
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; 
      border-radius: 6px; background: rgba(255,255,255,0.05); cursor: pointer;
      color: var(--ink-dim); transition: 0.2s;
    }
    .action-icon:hover { background: var(--accent); color: #000; }

    .card.burnt, .scatter-card.burnt {
      opacity: 0.6;
    }

    .card.burnt .card-edit-icon, .scatter-card.burnt .card-edit-icon {
      opacity: 1;
    }

    .burnt-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-family: var(--font-mono);
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--neon-red);
      opacity: 0.7;
      pointer-events: none;
    }

    .scatter-card .burnt-label {
      font-size: 1.2rem;
    }

    /* --- Scatter View --- */
    #scatterContainer { 
        overflow: hidden; 
        background-image: radial-gradient(var(--glass-border) 1px, transparent 1px);
        background-size: 40px 40px;
    }
    .scatter-canvas { 
        width: 100%; height: 100%; position: relative; 
        will-change: transform; 
        touch-action: none; 
    }
    .scatter-card {
      position: absolute;
      width: 220px;
      background: rgba(var(--card-bg-rgb), 0.85);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; align-items: center;
      user-select: none;
      transition: box-shadow 0.2s, opacity 0.2s;
      cursor: pointer;
      backdrop-filter: blur(8px);
      opacity: 0.85;
    }
    .scatter-card:hover {
      opacity: 0.95;
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }
    .scatter-card.dimmed {
      opacity: 0.15;
      filter: grayscale(1) blur(2px);
    }
    .scatter-card.is-dragging {
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        z-index: 1000 !important;
        cursor: grabbing;
    }
    .scatter-card .card-timer { font-size: 1.4rem; margin: 4px 0; position: relative; }
    .scatter-card .card-provider { font-size: 11px; }
    .scatter-card .card-meta { 
        display: block; 
        text-align: center; 
        font-size: 11px; 
        color: var(--ink-dim); 
        margin-top: 8px; 
        border-top: 1px solid var(--glass-border); 
        padding-top: 8px; 
        width: 100%; 
    }

    /* --- Bottom Navigation (Dock) --- */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 92%; max-width: 400px;
      height: 64px;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: 32px;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 8px 0 16px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      z-index: 200;
    }

    .nav-group { display: flex; align-items: center; gap: 4px; }
    
    .nav-btn {
      width: 48px; height: 48px;
      border-radius: 50%;
      border: none; background: transparent;
      color: var(--ink-dim);
      font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn.active { color: var(--ink); background: rgba(255,255,255,0.1); }
    .nav-btn.primary { background: var(--accent); color: #000; transform: scale(1.1); box-shadow: 0 0 15px var(--accent); }
    .nav-btn.primary:active { transform: scale(1.0); }

    .filter-pill-btn {
        background: var(--glass-border);
        height: 40px;
        width: 120px;
        padding: 0 16px;
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        color: var(--ink);
        display: flex; align-items: center; justify-content: flex-start;
        gap: 8px;
        font-size: 11px; font-weight: 700; text-transform: uppercase;
        margin-right: 8px; cursor: pointer;
        transition: all 0.2s;
    }
    .filter-pill-btn:active { transform: scale(0.95); }
    .filter-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ink-dim); box-shadow: 0 0 5px currentColor; flex-shrink: 0; }

    /* --- Modals & Overlays --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
      z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s;
      display: flex; align-items: flex-end;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }
    @media(min-width: 600px) { .overlay { align-items: center; justify-content: center; } }

    .modal-sheet {
      position: relative; 
      width: 100%; background: var(--bg-color);
      border-top: 1px solid var(--glass-border);
      border-radius: 24px 24px 0 0;
      padding: 24px;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      max-height: 85vh; overflow-y: auto;
    }
    .overlay.active .modal-sheet { transform: translateY(0); }
    @media(min-width: 600px) { 
      .modal-sheet { max-width: 400px; border-radius: 24px; border: 1px solid var(--glass-border); transform: scale(0.95); }
      .overlay.active .modal-sheet { transform: scale(1); }
    }
    
    .close-btn { 
       position: absolute; top: 16px; right: 16px; 
       background: transparent; border: none; color: var(--ink-dim); 
       cursor: pointer; padding: 8px; border-radius: 50%; z-index: 10;
       transition: color 0.2s;
    }
    .close-btn:hover { color: var(--ink); }

    /* --- Dialogs (Confirm & Action) --- */
    .confirm-dialog {
        background: var(--card-bg); border: 1px solid var(--glass-border);
        padding: 24px; border-radius: 16px; width: 90%; max-width: 320px;
        text-align: center;
        margin-bottom: 40vh; 
    }
    .overlay.active .confirm-dialog { animation: fadeIn 0.1s ease; }
    @media(min-width: 600px) { .confirm-dialog { margin-bottom: 0; } }
    
    .confirm-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .confirm-text { font-size: 13px; color: var(--ink-dim); margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 10px; }

    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: 600; color: var(--ink-dim); margin-bottom: 6px; text-transform: uppercase; }
    
    .input-wrapper { position: relative; width: 100%; }
    .input-wrapper input { padding-right: 40px; }
    .input-icon-btn {
      position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
      background: none; border: none; color: var(--ink-dim); cursor: pointer;
      padding: 4px; border-radius: 4px;
    }
    .input-icon-btn:hover { color: var(--accent); background: rgba(255,255,255,0.1); }

    input, select {
      width: 100%; padding: 16px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
      border-radius: 12px; color: var(--ink); font-size: 16px;
      font-family: var(--font-sans); padding-right: 32px; 
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); background: rgba(255,255,255,0.1); }
    
    .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%23888' d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
    }

    .status-toggles { display: flex; gap: 8px; }
    .btn-toggle {
       flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; border: 1px solid var(--glass-border); 
       background: transparent; cursor: pointer; transition: all 0.2s; font-size: 14px;
       line-height: 1;
    }
    .btn-toggle.selected { color: var(--bg-color); border-color: currentColor; }
    .btn-toggle[data-status="active"].selected { background: var(--accent); color: #000; border-color: var(--accent); }
    .btn-toggle[data-status="ready"].selected { background: var(--neon-green); color: #000; border-color: var(--neon-green); }
    .btn-toggle[data-status="cooldown"].selected { background: var(--neon-orange); color: #000; border-color: var(--neon-orange); }
    .btn-toggle[data-status="burnt"].selected { background: var(--neon-red); color: #000; border-color: var(--neon-red); }

    .pill-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .pill-option {
       padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center;
       background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
       cursor: pointer; transition: all 0.2s; line-height: 1.2;
    }
    .pill-option:hover { background: rgba(255,255,255,0.1); }
    .pill-option.selected { background: var(--accent); color: #000; border-color: var(--accent); }
    
    .btn-block { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; border: none; font-size: 14px; text-transform: uppercase; cursor: pointer; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-secondary { background: var(--glass-border); color: var(--ink); margin-top: 12px; }
    .btn-danger { background: rgba(239,68,68,0.2); color: var(--neon-red); margin-top: 12px; border: 1px solid rgba(239,68,68,0.5); }
    
    .btn-half { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }
    .btn-cancel { background: transparent; color: var(--ink-dim); border: 1px solid var(--glass-border); }
    .btn-confirm { background: var(--accent); color: #000; }

    /* --- Accordion Styles --- */
    .accordion-item {
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        margin-bottom: 8px;
        overflow: hidden;
        transition: all 0.2s;
    }
    .accordion-header {
        width: 100%;
        background: transparent;
        border: none;
        padding: 16px;
        text-align: left;
        color: var(--ink);
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .accordion-header:hover { background: rgba(255, 255, 255, 0.05); }
    .accordion-icon { transition: transform 0.3s ease; }
    .accordion-item.open .accordion-icon { transform: rotate(180deg); }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .accordion-content-inner { padding: 0 16px 16px 16px; font-size: 14px; color: var(--ink-dim); line-height: 1.6; }
    .accordion-content-inner ul { list-style-type: 'â€”  '; margin-left: 20px; padding-left: 0; }
    .accordion-content-inner li { margin-bottom: 6px; padding: 4px 0; }
    
    /* --- Utilities --- */
    .toast {
      position: fixed; top: 120px; left: 50%; transform: translateX(-50%) translateY(-20px);
      background: var(--accent); color: #000; padding: 10px 20px; border-radius: 20px;
      font-weight: 700; font-size: 12px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 500;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    
    /* Scatter Specific Mobile Controls */
    .scatter-controls {
      position: fixed; bottom: 100px; right: 20px; display: none; flex-direction: column; gap: 10px; z-index: 150;
    }
    .scatter-controls.visible { display: flex; }
    .control-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--ink); font-size: 16px; backdrop-filter: blur(10px); cursor: pointer; }

    /* --- Context Menu --- */
    .context-menu {
      position: fixed; display: none; 
      background: var(--card-bg); border: 1px solid var(--glass-border);
      border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 1000; width: 220px; overflow: hidden;
      backdrop-filter: blur(12px);
    }
    .context-menu.active { display: block; animation: fadeIn 0.1s ease; }
    .ctx-header { padding: 8px 12px; font-size: 10px; text-transform: uppercase; color: var(--ink-dim); border-bottom: 1px solid var(--glass-border); letter-spacing: 1px; }
    .ctx-item { 
      padding: 12px 16px; font-size: 14px; color: var(--ink); cursor: pointer; display: flex; align-items: center; gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.02);
    }
    .ctx-item:hover { background: var(--accent); color: #000; }
    .ctx-item:last-child { border-bottom: none; }
    
    @keyframes fadeIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }



  </style>
</head>
<body data-theme="dark">

<div class="cinematic-fx"></div>

<header class="app-header">
<div class="header-top">
<div class="logo">
    <img id="logoImg" src="https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-light.svg" alt="IntoView Logo" style="height: 32px;">
</div>
      
      <div class="header-buttons">
        <button class="theme-btn info-btn" onclick="openInfoModal()" title="Information & Help">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
        </button>
        <button class="theme-btn" onclick="toggleTheme()" title="Toggle Theme (Dark / Light / Rose)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path></svg>
        </button>
      </div>
    </div>
    
    <div class="provider-bar" id="providerBar"></div>
  </header>

  <div id="gridContainer" class="view-container active">
    <div class="grid-wrapper" id="gridWrapper"></div>
  </div>

  <div id="scatterContainer" class="view-container">
    <div class="scatter-canvas" id="scatterCanvas"></div>
  </div>

  <div class="scatter-controls" id="scatterControls">
    <button class="control-btn" onclick="autoArrange()" id="wandBtn" title="Auto-Arrange">ðŸª„</button>
    <button class="control-btn" onclick="zoom(0.1, window.innerWidth/2, window.innerHeight/2)" title="Zoom In">+</button>
    <button class="control-btn" onclick="zoom(-0.1, window.innerWidth/2, window.innerHeight/2)" title="Zoom Out">-</button>
  </div>

  <div id="contextMenu" class="context-menu"></div>

  <nav class="bottom-nav">
    <div class="nav-group">
      <button class="nav-btn active" data-view="grid" onclick="switchView('grid')" title="Grid View">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4 11h7V4H4v7zm0 9h7v-7H4v7zm9 0h7v-7h-7v7zm0-16v7h7V4h-7z"></path></svg>
      </button>
      <button class="nav-btn" data-view="scatter" onclick="switchView('scatter')" title="Free Form">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="3"></circle><circle cx="19" cy="5" r="2"></circle><circle cx="5" cy="19" r="2"></circle><circle cx="5" cy="5" r="2"></circle><circle cx="19" cy="19" r="2"></circle></svg>
      </button>
    </div>

    <button class="nav-btn primary" onclick="openModal()">+</button>

    <button class="filter-pill-btn" onclick="cycleStatusFilter()" id="statusPill" title="Active â€¢ Ready â€¢ Cooling â€¢ Burnt">
      <div class="filter-dot" id="filterDot"></div>
      <span id="filterLabel">All</span>
    </button>
  </nav>

  <div class="overlay" id="providerSelectOverlay">
  </div>

  <div class="overlay" id="modalOverlay">
  <div class="modal-sheet">
    <button class="close-btn" onclick="closeModal()">
       <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
    </button>
    
    <h2 style="margin-bottom:20px; font-family:var(--font-mono)" id="modalTitle">New Node</h2>
    <form id="nodeForm">
      <input type="hidden" id="nodeId">
      
      <div class="form-group">
      <label for="inpProvider">Provider</label>
      <select id="inpProvider" required>
        </select>
    </div>
      
      <div class="form-group">
        <label>Email / Identity</label>
        <div class="input-wrapper">
          <input type="text" id="inpEmail" required autocomplete="off">
          <button type="button" class="input-icon-btn" onclick="copyInput('inpEmail')">
             <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label>Current Status</label>
        <div class="status-toggles">
          <button type="button" data-status="active" class="btn-toggle text-blue" onclick="selectStatusButton('active')">Active</button>
          <button type="button" data-status="ready" class="btn-toggle text-green" onclick="selectStatusButton('ready')">Ready</button>
          <button type="button" data-status="cooldown" class="btn-toggle text-orange" onclick="selectStatusButton('cooldown')">Cooldown</button>
          <button type="button" data-status="burnt" class="btn-toggle text-red" onclick="selectStatusButton('burnt')">Burnt</button>
        </div>
        <input type="hidden" id="inpStatus" value="ready">
      </div>
      
      <div class="form-group">
        <label>Reset Cycle (Hours)</label>
        <div class="pill-grid">
           <div class="pill-option selected" data-hours="3" onclick="selectResetHours(3)">3h</div>
           <div class="pill-option" data-hours="6" onclick="selectResetHours(6)">6h</div>
           <div class="pill-option" data-hours="12" onclick="selectResetHours(12)">12h</div>
           <div class="pill-option" data-hours="24" onclick="selectResetHours(24)">24h</div>
           <div class="pill-option" data-hours="48" onclick="selectResetHours(48)">48h</div>
           <div class="pill-option" data-hours="72" onclick="selectResetHours(72)">72h</div>
        </div>
        <input type="number" id="inpResetCustom" placeholder="Custom Hours" style="margin-top: 8px;" step="0.5">
        <input type="hidden" id="inpReset" value="3">
      </div>

      <div id="editActions" style="display:none; margin-top:12px; display:flex; gap:10px;">
         <button type="button" class="btn-block btn-secondary" onclick="confirmHitLimit(null)">ðŸ”¥ Hit Limit</button>
         <button type="button" class="btn-block btn-secondary" onclick="confirmForceRestore(null)">ðŸ”„ Restore</button>
      </div>

      <button type="submit" class="btn-block btn-primary" style="margin-top: 12px;">Save Node</button>
      
      <button type="button" class="btn-block btn-danger" id="btnDelete" style="display:none" onclick="deleteNode()">Delete Node</button>
      <div style="height:20px"></div>
    </form>
  </div>
</div>

<div class="overlay" id="confirmOverlay">
   <div class="confirm-dialog">
      <div class="confirm-title" id="confirmTitle">Confirm Action</div>
      <div class="confirm-text" id="confirmText">Are you sure?</div>
      <div class="confirm-actions">
         <button class="btn-half btn-cancel" onclick="closeConfirm()">Cancel</button>
         <button class="btn-half btn-confirm" id="btnConfirmAction">Confirm</button>
      </div>
   </div>
</div>

<div class="overlay" id="actionOverlay">
   <div class="confirm-dialog">
      <div class="confirm-title" id="actionTitle">Activate Node</div>
      <div class="confirm-text">Email copied to clipboard:</div>
      <input type="text" id="actionEmail" readonly style="margin-bottom:20px; text-align:center;">
      <div class="confirm-actions">
         <button class="btn-half btn-cancel" onclick="closeActionOverlay()">Cancel</button>
         <button class="btn-half btn-confirm" id="btnActivateNode">Activate</button>
      </div>
   </div>
</div>

<div class="overlay" id="infoOverlay">
  <div class="modal-sheet">
    <button class="close-btn" onclick="closeInfoModal()">
       <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
    </button>
    
    <h2 style="margin-bottom:20px; font-family:var(--font-mono)">fyi:</h2>

    <div style="margin-bottom: 24px; padding: 16px; border-radius: 12px; background: rgba(255,255,255,0.05);">
      <h3 style="font-weight: 700; font-size: 16px; color: var(--accent); margin-bottom: 8px;">The Node Manifesto:</h3>
      <p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;">
      <p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;"><strong></p><p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;">You are an infinite machine</strong> in a <em>finite prompt cycle</em>; but do not yield for here is a tool for the commonwealth of the commonfolk. <br><br>
        Use the timer not as a limiter, but as a catalyst to creation.<br><br>Let each cooldown be a reset, every burnt node a lesson, and each new node a launchpad.</p>
    </div>


    <div id="accordionContainer">
      
      <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)">
          <span>Interaction & Shortcuts</span>
          <svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
        </button>
        <div class="accordion-content">
          <div class="accordion-content-inner">
            <ul style="list-style-type: none; padding: 0;">
              <li><strong style="color: var(--accent);">Tap Card (Grid/Scatter):</strong> Open Edit Modal (View Details).</li>
              <li><strong style="color: var(--accent);">Right-Click / Long-Press Card:</strong> Quick Action Menu (Hit Limit / Restore / View Details).</li>
              <li><strong style="color: var(--accent);">Right-Click / Long-Press Provider Pill:</strong> Manage Provider (Edit Name / Delete / New).</li>
              <li><strong style="color: var(--accent);">Right-Click / Long-Press Background (Scatter Mode):</strong> Arrangement & Sorting menu.</li>
              <li><strong style="color: var(--accent);">Drag Card (Scatter Mode):</strong> Move the node freely.</li>
              <li><strong style="color: var(--accent);">Drag Background:</strong> Scroll / Pan / Zoom / Sort / Arrange</li>
              <li><strong style="color: var(--accent);">Theme Toggle:</strong> Switches between Dark, Light, and Rose mode.</li>
              <li><strong style="color: var(--accent);">Status Pill (Bottom Right):</strong> Cycles the global filter (All -> Active -> Cooldown -> Burnt).</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="accordion-item">
        <button class="accordion-header" onclick="toggleAccordion(this)">
          <span>Status & Timing</span>
          <svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
        </button>
        <div class="accordion-content">
          <div class="accordion-content-inner">
            <ul>
              <li style="color: var(--neon-green);">**Active:** Actively in use. Timer shows 00:00:00.</li>
              <li style="color: var(--neon-blue);">**Ready:** Ready to use. Timer shows 00:00:00.</li>              
              <li style="color: var(--neon-orange);">**Cooldown:** In use, waiting for the limit to reset. Timer shows time remaining (based on *Reset Cycle*).</li>
              <li style="color: var(--neon-red);">**Burnt:** Permanently defunct or retired.</li>
              <li style="margin-top: 12px; color: var(--ink-dim); font-size: 13px; list-style-type: none;">*The timer counts down from the last "Hit Limit" event to the pre-selected "Reset Cycle" duration.*</li>
            </ul>
          </div>
        </div>
      </div>

    </div>
    
    <a href="https://emdash.click" target="_blank" style="display: block; text-align: center; margin-top: 30px; text-decoration: none;">
       <button class="btn-block btn-secondary" style="background: var(--glass-border); color: var(--ink-dim);">
          <span style="font-weight: 400;">Something useful @</span><strong style="color: var(--ink); font-weight: 700;"> emdash.click</strong>
       </button>
    </a>

    <div style="height:20px"></div>
  </div>
</div>


<div class="toast" id="toast">Copied to Clipboard</div>


<script>
// --- Global State ---
let items = []; // Main array of nodes
let providers = []; // List of all providers for dropdowns/pills
let config = {
  filterStatus: 'all',
  filterProvider: 'all',
  view: 'grid'
};
let scatter = {
  transform: {
    x: 0,
    y: 0,
    scale: 1
  },
  panning: false,
  dragging: false,
  pinchStart: 0,
};
let activeNodeId = null;
let timerInterval = null;
let isDraggingCard = false; // NEW: Flag to detect if a drag occurred

// Logos for each theme
const logos = {
  'dark': `<svg width="332" height="83" viewBox="0 0 332 83" fill="none" xmlns="http://www.w3.org/2000/svg">
<g filter="url(#filter0_f_572_380)">
<path d="M59.1719 68.1484L46.5859 75.3203V60.8359L59.1719 53.7344V68.1484Z" fill="url(#paint0_linear_572_380)"/>
<path d="M46.5156 46.5625L34 53.8047L46.5859 60.9766L59.1719 53.7344L46.5156 46.5625Z" fill="url(#paint1_linear_572_380)"/>
<path d="M34.0703 68.1484L46.5859 75.3203V60.9766L34 53.8047L34.0703 68.1484Z" fill="url(#paint2_linear_572_380)"/>
</g>
<g filter="url(#filter1_f_572_380)">
<path d="M84.3203 60.9414L65.4414 71.6992V49.9727L84.3203 39.3203V60.9414Z" fill="url(#paint3_linear_572_380)"/>
<path d="M65.3359 28.5625L46.5625 39.4258L65.4414 50.1836L84.3203 39.3203L65.3359 28.5625Z" fill="url(#paint4_linear_572_380)"/>
<path d="M46.668 60.9414L65.4414 71.6992V50.1836L46.5625 39.4258L46.668 60.9414Z" fill="url(#paint5_linear_572_380)"/>
</g>
<path d="M115.703 50.1719L90.5312 64.5156V35.5469L115.703 21.3438V50.1719Z" fill="url(#paint6_linear_572_380)"/>
<path d="M90.3906 7L65.3594 21.4844L90.5312 35.8281L115.703 21.3438L90.3906 7Z" fill="url(#paint7_linear_572_380)"/>
<path d="M65.5 50.1719L90.5312 64.5156V35.8281L65.3594 21.4844L65.5 50.1719Z" fill="url(#paint8_linear_572_380)"/>
<path d="M152.568 47.792V34.2377H155.071V47.792H152.568ZM148.753 48.0625V45.844H158.885V48.0625H148.753ZM148.753 36.4562V34.2377H154.056V36.4562H148.753ZM153.813 31.8569C153.38 31.8569 153.015 31.7081 152.717 31.4105C152.419 31.1039 152.271 30.7341 152.271 30.3013C152.271 29.8594 152.419 29.4896 152.717 29.192C153.015 28.8854 153.38 28.7321 153.813 28.7321C154.264 28.7321 154.633 28.8854 154.922 29.192C155.219 29.4896 155.368 29.8594 155.368 30.3013C155.368 30.7341 155.219 31.1039 154.922 31.4105C154.633 31.7081 154.264 31.8569 153.813 31.8569ZM167.21 48.0625V34.2377H169.713V37.0513L169.348 36.4291C169.492 35.9602 169.758 35.5363 170.146 35.1575C170.542 34.7788 171.029 34.4767 171.607 34.2512C172.193 34.0258 172.838 33.913 173.541 33.913C174.587 33.913 175.493 34.1159 176.26 34.5218C177.027 34.9186 177.617 35.5679 178.032 36.4697C178.447 37.3625 178.654 38.5439 178.654 40.0138V48.0625H176.152V39.9462C176.152 38.5754 175.85 37.615 175.245 37.0649C174.641 36.5148 173.902 36.2397 173.027 36.2397C172.405 36.2397 171.841 36.3524 171.336 36.5779C170.84 36.7943 170.443 37.1686 170.146 37.7007C169.857 38.2327 169.713 38.9632 169.713 39.8921V48.0625H167.21ZM193.553 48.3872C192.246 48.3872 191.308 48.0715 190.74 47.4402C190.172 46.8 189.888 45.9387 189.888 44.8566V36.4562H186.803V34.2377H189.888V29.7467L192.39 28.5292V34.2377H197.057V36.4562H192.39V44.1531C192.39 44.5409 192.444 44.8836 192.552 45.1812C192.661 45.4788 192.859 45.7088 193.148 45.8711C193.436 46.0334 193.847 46.1146 194.379 46.1146C194.974 46.1146 195.461 46.0379 195.84 45.8846C196.227 45.7313 196.575 45.5645 196.881 45.3841L196.584 47.7649C196.214 47.9543 195.794 48.1031 195.326 48.2113C194.866 48.3285 194.275 48.3872 193.553 48.3872ZM211.672 48.3872C210.355 48.3872 209.21 48.0986 208.236 47.5214C207.262 46.9443 206.505 46.1191 205.964 45.0459C205.432 43.9638 205.166 42.6697 205.166 41.1636C205.166 39.6666 205.432 38.377 205.964 37.2948C206.505 36.2127 207.262 35.3785 208.236 34.7923C209.21 34.2061 210.355 33.913 211.672 33.913C212.998 33.913 214.148 34.2016 215.122 34.7788C216.095 35.3559 216.849 36.1856 217.381 37.2678C217.913 38.35 218.179 39.6441 218.179 41.1501C218.179 42.6471 217.913 43.9367 217.381 45.0189C216.849 46.1011 216.095 46.9352 215.122 47.5214C214.148 48.0986 212.998 48.3872 211.672 48.3872ZM211.672 46.0469C212.944 46.0469 213.918 45.6096 214.594 44.7348C215.279 43.851 215.622 42.6561 215.622 41.1501C215.622 39.6441 215.288 38.4492 214.621 37.5654C213.963 36.6816 212.98 36.2397 211.672 36.2397C210.392 36.2397 209.413 36.6726 208.737 37.5383C208.06 38.4041 207.722 39.6125 207.722 41.1636C207.722 42.6606 208.06 43.851 208.737 44.7348C209.413 45.6096 210.392 46.0469 211.672 46.0469ZM229.967 48.0625L224.65 34.2377H227.288L230.656 43.3686C230.738 43.576 230.814 43.7969 230.886 44.0314C230.959 44.2568 231.031 44.5139 231.103 44.8024C231.175 44.5139 231.247 44.2568 231.319 44.0314C231.4 43.7969 231.477 43.576 231.549 43.3686L234.863 34.2377H237.461L232.144 48.0625H229.967ZM249.451 47.792V34.2377H251.954V47.792H249.451ZM245.637 48.0625V45.844H255.769V48.0625H245.637ZM245.637 36.4562V34.2377H250.939V36.4562H245.637ZM250.696 31.8569C250.263 31.8569 249.898 31.7081 249.6 31.4105C249.303 31.1039 249.154 30.7341 249.154 30.3013C249.154 29.8594 249.303 29.4896 249.6 29.192C249.898 28.8854 250.263 28.7321 250.696 28.7321C251.147 28.7321 251.517 28.8854 251.805 29.192C252.103 29.4896 252.252 29.8594 252.252 30.3013C252.252 30.7341 252.103 31.1039 251.805 31.4105C251.517 31.7081 251.147 31.8569 250.696 31.8569ZM270.086 48.3872C268.752 48.3872 267.606 48.0715 266.65 47.4402C265.694 46.8 264.959 45.9342 264.445 44.843C263.94 43.7518 263.688 42.5163 263.688 41.1366C263.688 39.6215 263.949 38.3274 264.472 37.2543C265.004 36.1721 265.748 35.3469 266.704 34.7788C267.669 34.2016 268.797 33.913 270.086 33.913C271.15 33.913 272.124 34.1475 273.008 34.6165C273.892 35.0854 274.595 35.8068 275.118 36.7808C275.65 37.7548 275.916 39.0038 275.916 40.5278C275.916 40.7172 275.912 40.9517 275.903 41.2313C275.903 41.5108 275.88 41.8129 275.835 42.1376H265.636V39.9597H273.427C273.4 38.9857 273.211 38.2192 272.859 37.6601C272.517 37.1009 272.093 36.7087 271.588 36.4832C271.083 36.2487 270.582 36.1315 270.086 36.1315C268.733 36.1315 267.74 36.5604 267.108 37.4182C266.484 38.267 266.172 39.4755 266.172 41.0435V42.1376H276.146V44.3561H266.172V44.4237C266.172 45.3536 266.316 46.0841 266.605 46.6162C266.893 47.1483 267.304 47.5225 267.837 47.7389C268.378 47.9554 268.97 48.0636 269.613 48.0636C270.162 48.0636 270.695 48.0004 271.213 47.874C271.74 47.7476 272.249 47.5367 272.74 47.2412C273.239 46.9457 273.667 46.5379 274.025 46.0178L276.563 46.6399C276.277 47.2721 275.879 47.8192 275.368 48.2812C274.857 48.7342 274.205 49.0884 273.413 49.3438C272.63 49.5903 271.643 49.7135 270.453 49.7135C269.119 49.7135 267.974 49.3979 267.017 48.7666C266.061 48.1353 265.327 47.2695 264.813 46.1784C264.308 45.0872 264.056 43.8517 264.056 42.4719C264.056 41.0922 264.308 39.8567 264.813 38.7655C265.327 37.6743 266.061 36.8085 267.017 36.1772C267.974 35.5459 269.119 35.2303 270.453 35.2303C271.769 35.2303 272.914 35.5459 273.888 36.1772C274.862 36.8085 275.619 37.6743 276.16 38.7655C276.701 39.8567 276.971 41.0922 276.971 42.4719C276.971 43.8517 276.701 45.0872 276.16 46.1784C275.619 47.2695 274.862 48.1353 273.888 48.7666C272.914 49.3979 271.769 49.7135 270.453 49.7135C269.613 49.7135 268.97 49.7135 268.97 49.7135V49.7135Z" fill="url(#paint9_linear_572_380)"/>
<defs>
<filter id="filter0_f_572_380" x="33" y="52.7344" width="26.1719" height="22.5859" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="0.5" result="effect1_foregroundBlur_572_380"/>
</filter>
<filter id="filter1_f_572_380" x="45.5625" y="27.5625" width="38.7578" height="47.7578" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="0.5" result="effect1_foregroundBlur_572_380"/>
</filter>
<linearGradient id="paint0_linear_572_380" x1="46.5859" y1="60.8359" x2="59.1719" y2="53.7344" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint1_linear_572_380" x1="46.5859" y1="60.9766" x2="34" y2="53.8047" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint2_linear_572_380" x1="46.5859" y1="75.3203" x2="34" y2="68.1484" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint3_linear_572_380" x1="65.4414" y1="49.9727" x2="84.3203" y2="39.3203" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint4_linear_572_380" x1="65.4414" y1="50.1836" x2="46.5625" y2="39.4258" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint5_linear_572_380" x1="65.4414" y1="71.6992" x2="46.5625" y2="60.9414" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint6_linear_572_380" x1="90.5312" y1="35.5469" x2="115.703" y2="21.3438" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint7_linear_572_380" x1="90.5312" y1="35.8281" x2="65.3594" y2="21.4844" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint8_linear_572_380" x1="90.5312" y1="64.5156" x2="65.3594" y2="50.1719" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint9_linear_572_380" x1="152.271" y1="7" x2="276.971" y2="49.7135" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
</defs>
</svg>
`,
  'light': `<svg width="332" height="83" viewBox="0 0 332 83" fill="none" xmlns="http://www.w3.org/2000/svg">
<g filter="url(#filter0_f_572_43)">
<path d="M58.8906 66.1416L46.3047 73.3135V58.8291L58.8906 51.7275V66.1416Z" fill="url(#paint0_linear_572_43)"/>
<path d="M46.2344 44.5557L33.7188 51.7979L46.3047 58.9697L58.8906 51.7275L46.2344 44.5557Z" fill="white"/>
<path d="M33.7891 66.1416L46.3047 73.3135V58.9697L33.7188 51.7979L33.7891 66.1416Z" fill="url(#paint1_linear_572_43)"/>
</g>
<g filter="url(#filter1_f_572_43)">
<path d="M84.0391 58.9346L65.1602 69.6924V47.9658L84.0391 37.3135V58.9346Z" fill="url(#paint2_linear_572_43)"/>
<path d="M65.0547 26.5557L46.2812 37.4189L65.1602 48.1768L84.0391 37.3135L65.0547 26.5557Z" fill="white"/>
<path d="M46.3867 58.9346L65.1602 69.6924V48.1768L46.2812 37.4189L46.3867 58.9346Z" fill="url(#paint3_linear_572_43)"/>
</g>
<path d="M115.422 48.165L90.25 62.5088V33.54L115.422 19.3369V48.165Z" fill="url(#paint4_linear_572_43)"/>
<path d="M90.1094 4.99316L65.0781 19.4775L90.25 33.8213L115.422 19.3369L90.1094 4.99316Z" fill="white"/>
<path d="M65.2188 48.165L90.25 62.5088V33.8213L65.0781 19.4775L65.2188 48.165Z" fill="url(#paint5_linear_572_43)"/>
<path d="M152.287 45.7851V32.2309H154.789V45.7851H152.287ZM148.472 46.0557V43.8372H158.604V46.0557H148.472ZM148.472 34.4493V32.2309H153.775V34.4493H148.472ZM153.531 29.8501C153.098 29.8501 152.733 29.7013 152.436 29.4037C152.138 29.097 151.989 28.7273 151.989 28.2944C151.989 27.8525 152.138 27.4828 152.436 27.1852C152.733 26.8786 153.098 26.7253 153.531 26.7253C153.982 26.7253 154.352 26.8786 154.641 27.1852C154.938 27.4828 155.087 27.8525 155.087 28.2944C155.087 28.7273 154.938 29.097 154.641 29.4037C154.352 29.7013 153.982 29.8501 153.531 29.8501ZM166.929 46.0557V32.2309H169.432V35.0445L169.066 34.4223C169.211 33.9533 169.477 33.5295 169.864 33.1507C170.261 32.7719 170.748 32.4698 171.325 32.2444C171.912 32.0189 172.556 31.9062 173.26 31.9062C174.306 31.9062 175.212 32.1091 175.979 32.5149C176.745 32.9117 177.336 33.561 177.751 34.4628C178.166 35.3556 178.373 36.537 178.373 38.007V46.0557H175.87V37.9393C175.87 36.5686 175.568 35.6081 174.964 35.058C174.36 34.5079 173.62 34.2329 172.746 34.2329C172.123 34.2329 171.56 34.3456 171.055 34.5711C170.559 34.7875 170.162 35.1617 169.864 35.6938C169.576 36.2259 169.432 36.9564 169.432 37.8852V46.0557H166.929ZM193.272 46.3803C191.965 46.3803 191.027 46.0647 190.459 45.4334C189.89 44.7931 189.606 43.9319 189.606 42.8497V34.4493H186.522V32.2309H189.606V27.7398L192.109 26.5224V32.2309H196.776V34.4493H192.109V42.1463C192.109 42.5341 192.163 42.8768 192.271 43.1744C192.379 43.472 192.578 43.7019 192.866 43.8643C193.155 44.0266 193.565 44.1077 194.097 44.1077C194.693 44.1077 195.18 44.0311 195.558 43.8778C195.946 43.7245 196.293 43.5576 196.6 43.3773L196.302 45.7581C195.933 45.9474 195.513 46.0962 195.044 46.2045C194.584 46.3217 193.994 46.3803 193.272 46.3803ZM211.391 46.3803C210.074 46.3803 208.929 46.0917 207.955 45.5146C206.981 44.9374 206.223 44.1123 205.682 43.0391C205.15 41.9569 204.884 40.6628 204.884 39.1568C204.884 37.6598 205.15 36.3702 205.682 35.288C206.223 34.2058 206.981 33.3716 207.955 32.7855C208.929 32.1993 210.074 31.9062 211.391 31.9062C212.717 31.9062 213.866 32.1948 214.84 32.7719C215.814 33.3491 216.567 34.1788 217.099 35.2609C217.631 36.3431 217.897 37.6372 217.897 39.1433C217.897 40.6403 217.631 41.9299 217.099 43.012C216.567 44.0942 215.814 44.9284 214.84 45.5146C213.866 46.0917 212.717 46.3803 211.391 46.3803ZM211.391 44.0401C212.662 44.0401 213.636 43.6027 214.313 42.728C214.998 41.8442 215.341 40.6493 215.341 39.1433C215.341 37.6372 215.007 36.4423 214.34 35.5585C213.681 34.6748 212.698 34.2329 211.391 34.2329C210.11 34.2329 209.132 34.6658 208.455 35.5315C207.779 36.3972 207.441 37.6057 207.441 39.1568C207.441 40.6538 207.779 41.8442 208.455 42.728C209.132 43.6027 210.11 44.0401 211.391 44.0401ZM229.685 46.0557L224.369 32.2309H227.007L230.375 41.3617C230.456 41.5691 230.533 41.7901 230.605 42.0246C230.677 42.25 230.749 42.507 230.822 42.7956C230.894 42.507 230.966 42.25 231.038 42.0246C231.119 41.7901 231.196 41.5691 231.268 41.3617L234.582 32.2309H237.179L231.863 46.0557H229.685ZM249.17 45.7851V32.2309H251.673V45.7851H249.17ZM245.356 46.0557V43.8372H255.487V46.0557H245.356ZM245.356 34.4493V32.2309H250.658V34.4493H245.356ZM250.415 29.8501C249.982 29.8501 249.617 29.7013 249.319 29.4037C249.021 29.097 248.873 28.7273 248.873 28.2944C248.873 27.8525 249.021 27.4828 249.319 27.1852C249.617 26.8786 249.982 26.7253 250.415 26.7253C250.866 26.7253 251.235 26.8786 251.524 27.1852C251.822 27.4828 251.97 27.8525 251.97 28.2944C251.97 28.7273 251.822 29.097 251.524 29.4037C251.235 29.7013 250.866 29.8501 250.415 29.8501ZM269.805 46.3803C268.47 46.3803 267.325 46.0647 266.369 45.4334C265.413 44.7931 264.678 43.9274 264.164 42.8362C263.659 41.745 263.407 40.5095 263.407 39.1297C263.407 37.6147 263.668 36.3206 264.191 35.2474C264.723 34.1652 265.467 33.3401 266.423 32.7719C267.388 32.1948 268.515 31.9062 269.805 31.9062C270.869 31.9062 271.843 32.1407 272.727 32.6096C273.611 33.0786 274.314 33.8 274.837 34.774C275.369 35.7479 275.635 36.9969 275.635 38.521C275.635 38.7104 275.631 38.9449 275.622 39.2244C275.622 39.504 275.599 39.8061 275.554 40.1307H265.354V37.9529H273.146C273.119 36.9789 272.93 36.2124 272.578 35.6532C272.235 35.0941 271.811 34.7018 271.306 34.4764C270.801 34.2419 270.301 34.1247 269.805 34.1247C268.452 34.1247 267.46 34.5536 266.828 35.4114C266.204 36.2601 265.892 37.4686 265.892 39.0366V40.1307H275.865V42.3491H265.892V42.4167C265.892 43.3466 266.036 44.0771 266.325 44.6092C266.613 45.1413 267.024 45.5155 267.557 45.7319C268.098 45.9484 268.69 46.0566 269.333 46.0566C269.882 46.0566 270.415 45.9934 270.933 45.867C271.46 45.7406 271.969 45.5297 272.46 45.2342C272.959 44.9387 273.387 44.5309 273.745 44.0107L276.282 44.6329C275.996 45.2651 275.598 45.8122 275.087 46.2742C274.576 46.7272 273.924 47.0814 273.132 47.3368C272.349 47.5833 271.758 47.7065 270.357 47.7065C269.023 47.7065 267.878 47.3909 266.921 46.7596C265.965 46.1283 265.231 45.2625 264.717 44.1713C264.212 43.08 263.96 41.8446 263.96 40.4648C263.96 39.0851 264.212 37.8496 264.717 36.7584C265.231 35.6672 265.965 34.8014 266.921 34.1701C267.878 33.5388 269.023 33.2231 270.357 33.2231C271.673 33.2231 272.818 33.5388 273.792 34.1701C274.766 34.8014 275.523 35.6672 276.063 36.7584C276.604 37.8496 276.875 39.0851 276.875 40.4648C276.875 41.8446 276.604 43.08 276.063 44.1713C275.523 45.2625 274.766 46.1283 273.792 46.7596C272.818 47.3909 271.673 47.7065 270.357 47.7065C269.517 47.7065 268.874 47.7065 268.874 47.7065V47.7065Z" fill="url(#paint6_linear_572_43)"/>
<defs>
<filter id="filter0_f_572_43" x="33.2188" y="51.7275" width="25.6719" height="21.5859" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="0.25" result="effect1_foregroundBlur_572_43"/>
</filter>
<filter id="filter1_f_572_43" x="45.7812" y="26.5557" width="39.2578" height="46.7578" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="0.25" result="effect1_foregroundBlur_572_43"/>
</filter>
<linearGradient id="paint0_linear_572_43" x1="46.3047" y1="58.8291" x2="58.8906" y2="51.7275" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint1_linear_572_43" x1="46.3047" y1="73.3135" x2="33.7188" y2="66.1416" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint2_linear_572_43" x1="65.1602" y1="47.9658" x2="84.0391" y2="37.3135" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint3_linear_572_43" x1="65.1602" y1="69.6924" x2="46.2812" y2="58.9346" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint4_linear_572_43" x1="90.25" y1="33.54" x2="115.422" y2="19.3369" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint5_linear_572_43" x1="90.25" y1="62.5088" x2="65.0781" y2="48.165" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
<linearGradient id="paint6_linear_572_43" x1="151.989" y1="4.99316" x2="276.875" y2="47.7065" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
</defs>
</svg>
`,
  'rose': `<svg width="332" height="83" viewBox="0 0 332 83" fill="none" xmlns="http://www.w3.org/2000/svg">
<g filter="url(#filter0_f_574_561)">
<path d="M58.9219 68.0029L46.8359 74.8896V60.9814L58.9219 54.1621V68.0029Z" fill="#FF8DA1" stroke="black" stroke-width="0.5"/>
<path d="M58.667 53.7354L46.584 60.6875L34.502 53.8027L46.5166 46.8506L58.667 53.7354Z" fill="#FF8DA1" stroke="black" stroke-width="0.5"/>
<path d="M46.3359 61.1211V74.8887L34.3193 68.0029L34.252 54.2354L46.3359 61.1211Z" fill="#FF8DA1" stroke="black" stroke-width="0.5"/>
</g>
<g filter="url(#filter1_f_574_561)">
<path d="M84.0703 60.9834L65.6914 71.4561V50.3057L84.0703 39.9355V60.9834Z" fill="#FF8DA1" stroke="black" stroke-width="0.5"/>
<path d="M83.8154 39.5088L65.4395 50.082L47.0645 39.6113L65.3369 29.0381L83.8154 39.5088Z" fill="#FF8DA1" stroke="black" stroke-width="0.5"/>
<path d="M65.1914 50.5156V71.4551L46.917 60.9834L46.8145 40.0439L65.1914 50.5156Z" fill="#FF8DA1" stroke="black" stroke-width="0.5"/>
</g>
<path d="M115.203 49.8809L91.0312 63.6553V35.8389L115.203 22.2002V49.8809Z" fill="#FF8DA1" stroke="black"/>
<path d="M114.695 21.3467L90.5293 35.252L66.3623 21.4805L90.3926 7.5752L114.695 21.3467Z" fill="#FF8DA1" stroke="black"/>
<path d="M90.0312 36.1182V63.6523L65.998 49.8809L65.8633 22.3467L90.0312 36.1182Z" fill="#FF8DA1" stroke="black"/>
<path opacity="0.33" d="M90.4375 35.7813L90.4375 7" stroke="white" stroke-width="0.375"/>
<path opacity="0.33" d="M90.438 35.7812L115.363 50.1719" stroke="white" stroke-width="0.375"/>
<path opacity="0.33" d="M90.4409 35.7813L65.5156 50.1719" stroke="white" stroke-width="0.375"/>
<path d="M152.568 47.792V34.2377H155.071V47.792H152.568ZM148.753 48.0625V45.844H158.885V48.0625H148.753ZM148.753 36.4562V34.2377H154.056V36.4562H148.753ZM153.813 31.8569C153.38 31.8569 153.015 31.7081 152.717 31.4105C152.419 31.1039 152.271 30.7341 152.271 30.3013C152.271 29.8594 152.419 29.4896 152.717 29.192C153.015 28.8854 153.38 28.7321 153.813 28.7321C154.264 28.7321 154.633 28.8854 154.922 29.192C155.219 29.4896 155.368 29.8594 155.368 30.3013C155.368 30.7341 155.219 31.1039 154.922 31.4105C154.633 31.7081 154.264 31.8569 153.813 31.8569ZM167.21 48.0625V34.2377H169.713V37.0513L169.348 36.4291C169.492 35.9602 169.758 35.5363 170.146 35.1575C170.542 34.7788 171.029 34.4767 171.607 34.2512C172.193 34.0258 172.838 33.913 173.541 33.913C174.587 33.913 175.493 34.1159 176.26 34.5218C177.027 34.9186 177.617 35.5679 178.032 36.4697C178.447 37.3625 178.654 38.5439 178.654 40.0138V48.0625H176.152V39.9462C176.152 38.5754 175.85 37.615 175.245 37.0649C174.641 36.5148 173.902 36.2397 173.027 36.2397C172.405 36.2397 171.841 36.3524 171.336 36.5779C170.84 36.7943 170.443 37.1686 170.146 37.7007C169.857 38.2327 169.713 38.9632 169.713 39.8921V48.0625H167.21ZM193.553 48.3872C192.246 48.3872 191.308 48.0715 190.74 47.4402C190.172 46.8 189.888 45.9387 189.888 44.8566V36.4562H186.803V34.2377H189.888V29.7467L192.39 28.5292V34.2377H197.057V36.4562H192.39V44.1531C192.39 44.5409 192.444 44.8836 192.552 45.1812C192.661 45.4788 192.859 45.7088 193.148 45.8711C193.436 46.0334 193.847 46.1146 194.379 46.1146C194.974 46.1146 195.461 46.0379 195.84 45.8846C196.227 45.7313 196.575 45.5645 196.881 45.3841L196.584 47.7649C196.214 47.9543 195.794 48.1031 195.326 48.2113C194.866 48.3285 194.275 48.3872 193.553 48.3872ZM211.672 48.3872C210.355 48.3872 209.21 48.0986 208.236 47.5214C207.262 46.9443 206.505 46.1191 205.964 45.0459C205.432 43.9638 205.166 42.6697 205.166 41.1636C205.166 39.6666 205.432 38.377 205.964 37.2948C206.505 36.2127 207.262 35.3785 208.236 34.7923C209.21 34.2061 210.355 33.913 211.672 33.913C212.998 33.913 214.148 34.2016 215.122 34.7788C216.095 35.3559 216.849 36.1856 217.381 37.2678C217.913 38.35 218.179 39.6441 218.179 41.1501C218.179 42.6471 217.913 43.9367 217.381 45.0189C216.849 46.1011 216.095 46.9352 215.122 47.5214C214.148 48.0986 212.998 48.3872 211.672 48.3872ZM211.672 46.0469C212.944 46.0469 213.918 45.6096 214.594 44.7348C215.279 43.851 215.622 42.6561 215.622 41.1501C215.622 39.6441 215.288 38.4492 214.621 37.5654C213.963 36.6816 212.98 36.2397 211.672 36.2397C210.392 36.2397 209.413 36.6726 208.737 37.5383C208.06 38.4041 207.722 39.6125 207.722 41.1636C207.722 42.6606 208.06 43.851 208.737 44.7348C209.413 45.6096 210.392 46.0469 211.672 46.0469ZM229.967 48.0625L224.65 34.2377H227.288L230.656 43.3686C230.738 43.576 230.814 43.7969 230.886 44.0314C230.959 44.2568 231.031 44.5139 231.103 44.8024C231.175 44.5139 231.247 44.2568 231.319 44.0314C231.4 43.7969 231.477 43.576 231.549 43.3686L234.863 34.2377H237.461L232.144 48.0625H229.967ZM249.451 47.792V34.2377H251.954V47.792H249.451ZM245.637 48.0625V45.844H255.769V48.0625H245.637ZM245.637 36.4562V34.2377H250.939V36.4562H245.637ZM250.696 31.8569C250.263 31.8569 249.898 31.7081 249.6 31.4105C249.303 31.1039 249.154 30.7341 249.154 30.3013C249.154 29.8594 249.303 29.4896 249.6 29.192C249.898 28.8854 250.263 28.7321 250.696 28.7321C251.147 28.7321 251.517 28.8854 251.805 29.192C252.103 29.4896 252.252 29.8594 252.252 30.3013C252.252 30.7341 252.103 31.1039 251.805 31.4105C251.517 31.7081 251.147 31.8569 250.696 31.8569ZM270.086 48.3872C268.752 48.3872 267.606 48.0715 266.65 47.4402C265.694 46.8 264.959 45.9342 264.445 44.843C263.94 43.7518 263.688 42.5163 263.688 41.1366C263.688 39.6215 263.949 38.3274 264.472 37.2543C265.004 36.1721 265.748 35.3469 266.704 34.7788C267.669 34.2016 268.797 33.913 270.086 33.913C271.15 33.913 272.124 34.1475 273.008 34.6165C273.892 35.0854 274.595 35.8068 275.118 36.7808C275.65 37.7548 275.916 39.0038 275.916 40.5278C275.916 40.7172 275.912 40.9517 275.903 41.2313C275.903 41.5108 275.88 41.8129 275.835 42.1376H265.636V39.9597H273.427C273.4 38.9857 273.211 38.2192 272.859 37.6601C272.517 37.1009 272.093 36.7087 271.588 36.4832C271.083 36.2487 270.582 36.1315 270.086 36.1315C268.733 36.1315 267.74 36.5604 267.108 37.4182C266.484 38.267 266.172 39.4755 266.172 41.0435V42.1376H276.146V44.3561H266.172V44.4237C266.172 45.3536 266.316 46.0841 266.605 46.6162C266.893 47.1483 267.304 47.5225 267.837 47.7389C268.378 47.9554 268.97 48.0636 269.613 48.0636C270.162 48.0636 270.695 48.0004 271.213 47.874C271.74 47.7476 272.249 47.5367 272.74 47.2412C273.239 46.9457 273.667 46.5379 274.025 46.0178L276.563 46.6399C276.277 47.2721 275.879 47.8192 275.368 48.2812C274.857 48.7342 274.205 49.0884 273.413 49.3438C272.63 49.5903 271.643 49.7135 270.453 49.7135C269.119 49.7135 267.974 49.3979 267.017 48.7666C266.061 48.1353 265.327 47.2695 264.813 46.1784C264.308 45.0872 264.056 43.8517 264.056 42.4719C264.056 41.0922 264.308 39.8567 264.813 38.7655C265.327 37.6743 266.061 36.8085 267.017 36.1772C267.974 35.5459 269.119 35.2303 270.453 35.2303C271.769 35.2303 272.914 35.5459 273.888 36.1772C274.862 36.8085 275.619 37.6743 276.16 38.7655C276.701 39.8567 276.971 41.0922 276.971 42.4719C276.971 43.8517 276.701 45.0872 276.16 46.1784C275.619 47.2695 274.862 48.1353 273.888 48.7666C272.914 49.3979 271.769 49.7135 270.453 49.7135C269.613 49.7135 268.97 49.7135 268.97 49.7135V49.7135Z" fill="url(#paint0_linear_574_561)"/>
<defs>
<filter id="filter0_f_574_561" x="33.252" y="53.1621" width="25.6699" height="21.7275" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="0.5" result="effect1_foregroundBlur_574_561"/>
</filter>
<filter id="filter1_f_574_561" x="46.252" y="28.0381" width="37.563" height="43.417" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape"/>
<feGaussianBlur stdDeviation="0.5" result="effect1_foregroundBlur_574_561"/>
</filter>
<linearGradient id="paint0_linear_574_561" x1="151.989" y1="7" x2="276.971" y2="49.7135" gradientUnits="userSpaceOnUse">
<stop stop-color="#FFED29"/>
<stop offset="1" stop-color="#FF8DA1"/>
</linearGradient>
</defs>
</svg>
`
};

// --- Data Persistence ---
function load() {
  const storedItems = localStorage.getItem('iv_items');
  const storedProviders = localStorage.getItem('iv_providers');
  if (storedItems) {
    items = JSON.parse(storedItems);
  } else {
    seedMockData(); // Use mock data if nothing is stored
  }
  if (storedProviders) {
    providers = JSON.parse(storedProviders);
  } else {
    providers = ['ChatGPT', 'Claude', 'Gemini', 'Grok', 'Copilot', 'Perplexity', 'Mistral', 'Midjourney', 'Llama Hub'];
  }
  config.filterStatus = localStorage.getItem('iv_filterStatus') || 'all';
  config.filterProvider = localStorage.getItem('iv_filterProvider') || 'all';
  config.view = localStorage.getItem('iv_view') || 'grid';
  const storedTransform = localStorage.getItem('iv_scatterTransform');
  if (storedTransform) {
    scatter.transform = JSON.parse(storedTransform);
  }
}

function seedMockData() {
  const mockData = [
    // --- FEW ACTIVE (2) ---
    {
      provider: 'ChatGPT',
      email: 'gpt_4_main@openai.com',
      status: 'active',
      resetHours: 3,
      lastUsedOffset: 0.1
    },
    {
      provider: 'Claude',
      email: 'claude_opus_pro@anthropic.ai',
      status: 'active',
      resetHours: 6,
      lastUsedOffset: 0.2
    },
    // --- SOME READY (3) ---
    {
      provider: 'Grok',
      email: 'grok_fun_mode@x.ai',
      status: 'ready',
      resetHours: 12,
      lastUsedOffset: 100
    },
    {
      provider: 'Perplexity',
      email: 'pplx_search@perplexity.ai',
      status: 'ready',
      resetHours: 24,
      lastUsedOffset: 100
    },
    {
      provider: 'Mistral',
      email: 'mistral_large@mistral.ai',
      status: 'ready',
      resetHours: 48,
      lastUsedOffset: 100
    },
    // --- SOME COOLDOWN (3) ---
    {
      provider: 'Gemini',
      email: 'gemini_advanced@google.com',
      status: 'cooldown',
      resetHours: 3,
      lastUsedOffset: 1.5
    },
    {
      provider: 'Llama Hub',
      email: 'llama3_online@meta.com',
      status: 'cooldown',
      resetHours: 6,
      lastUsedOffset: 3.5
    },
    {
      provider: 'Dalle',
      email: 'dalle_3@openai.com',
      status: 'cooldown',
      resetHours: 12,
      lastUsedOffset: 8
    },
    // --- FEW BURNT (3) ---
    {
      provider: 'Claude',
      email: 'claude_v1_legacy@anthropic.ai',
      status: 'burnt',
      resetHours: 12,
      lastUsedOffset: 200
    },
    {
      provider: 'Midjourney',
      email: 'mj_trial_expired@discord.com',
      status: 'burnt',
      resetHours: 24,
      lastUsedOffset: 50
    },
    {
      provider: 'Copilot',
      email: 'expired_enterprise@corp.com',
      status: 'burnt',
      resetHours: 6,
      lastUsedOffset: 300
    },
  ];

  items = mockData.map((data, i) => {
    const lastUsedMs = Date.now() - (data.lastUsedOffset * 60 * 60 * 1000);
    return {
      id: Date.now() + i,
      provider: data.provider,
      email: data.email,
      status: data.status,
      resetHours: data.resetHours,
      lastUsed: lastUsedMs,
      pos: {
        x: 50 + (i % 3) * 250,
        y: 100 + Math.floor(i / 3) * 180
      }
    };
  });
  save();
}

function save() {
  localStorage.setItem('iv_items', JSON.stringify(items));
  localStorage.setItem('iv_providers', JSON.stringify(providers));
  localStorage.setItem('iv_filterStatus', config.filterStatus);
  localStorage.setItem('iv_filterProvider', config.filterProvider);
  localStorage.setItem('iv_view', config.view);
  localStorage.setItem('iv_scatterTransform', JSON.stringify(scatter.transform));
}

// --- Utility Functions ---
function formatTime(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const totalMinutes = Math.floor(totalSeconds / 60);
  const totalHours = Math.floor(totalMinutes / 60);
  const hours = String(totalHours).padStart(2, '0');
  const minutes = String(totalMinutes % 60).padStart(2, '0');
  const seconds = String(totalSeconds % 60).padStart(2, '0');

  if (totalHours > 99) {
    return `${totalHours}h+`;
  }
  return `${hours}:${minutes}:${seconds}`;
}

function formatRemainingTime(ms) {
  if (ms <= 0) return '00:00:00';

  const totalSeconds = Math.floor(ms / 1000);
  const totalMinutes = Math.floor(totalSeconds / 60);
  const totalHours = Math.floor(totalMinutes / 60);

  const hours = String(totalHours).padStart(2, '0');
  const minutes = String(totalMinutes % 60).padStart(2, '0');
  const seconds = String(totalSeconds % 60).padStart(2, '0');

  if (totalHours > 99) {
    return `${totalHours}h+`;
  }
  return `${hours}:${minutes}:${seconds}`;
}

function formatLastUsed(timestamp) {
  const ms = Date.now() - timestamp;
  const minutes = Math.floor(ms / (1000 * 60));
  const hours = Math.floor(ms / (1000 * 60 * 60));

  if (hours >= 24) return `${Math.floor(hours / 24)} days ago`;
  if (hours > 0) return `${hours}h ago`;
  if (minutes > 0) return `${minutes}m ago`;
  return 'just now';
}

function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

function copyInput(id) {
  const input = document.getElementById(id);
  navigator.clipboard.writeText(input.value).then(() => {
    showToast('Copied to Clipboard');
  }).catch(err => {
    console.error('Could not copy text: ', err);
  });
}

function toggleTheme() {
  const currentTheme = document.body.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', newTheme);
  localStorage.setItem('iv_theme', newTheme);
}

function toggleAccordion(header) {
  const item = header.parentNode;
  const content = item.querySelector('.accordion-content');
  const isOpen = item.classList.contains('open');

  // Close all other open accordions
  document.querySelectorAll('.accordion-item.open').forEach(openItem => {
    if (openItem !== item) {
      openItem.classList.remove('open');
      openItem.querySelector('.accordion-content').style.maxHeight = null;
    }
  });

  if (isOpen) {
    item.classList.remove('open');
    content.style.maxHeight = null;
  } else {
    item.classList.add('open');
    content.style.maxHeight = content.scrollHeight + "px";
  }
}

// --- Filtering & View Management ---
function switchView(viewName) {
  config.view = viewName;
  localStorage.setItem('iv_view', viewName);
  document.querySelectorAll('.nav-btn[data-view]').forEach(b => b.classList.toggle('active', b.dataset.view === viewName));
  document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));

  if (viewName === 'grid') {
    document.getElementById('gridContainer').classList.add('active');
    document.getElementById('scatterControls').classList.remove('visible');
    renderGrid();
  } else {
    document.getElementById('scatterContainer').classList.add('active');
    document.getElementById('scatterControls').classList.add('visible');
    renderScatter();
  }
}

function filterItems() {
  let res = items;
  if (config.filterStatus !== 'all') {
    res = res.filter(i => i.status === config.filterStatus);
  }
  if (config.filterProvider !== 'all') {
    res = res.filter(i => i.provider === config.filterProvider);
  }
  return res;
}

function cycleStatusFilter() {
  const statuses = ['all', 'active', 'ready', 'cooldown', 'burnt'];
  let currentIndex = statuses.indexOf(config.filterStatus);
  currentIndex = (currentIndex + 1) % statuses.length;
  config.filterStatus = statuses[currentIndex];

  updateFilterPill();
  localStorage.setItem('iv_filterStatus', config.filterStatus);

  if (config.view === 'grid') {
    renderGrid();
  } else {
    renderScatter();
  }
  showToast(`Filter: ${config.filterStatus.toUpperCase()}`);
}

function updateFilterPill() {
  const pill = document.getElementById('statusPill');
  const dot = document.getElementById('filterDot');
  const label = document.getElementById('filterLabel');

  label.textContent = config.filterStatus.toUpperCase();
  dot.className = 'filter-dot';

  if (config.filterStatus === 'all') {
    dot.style.background = 'var(--ink-dim)';
    dot.style.boxShadow = '0 0 5px var(--ink-dim)';
  } else if (config.filterStatus === 'active') {
    dot.style.background = 'var(--neon-blue)';
    dot.style.boxShadow = '0 0 8px var(--neon-blue)';
  } else if (config.filterStatus === 'ready') {
    dot.style.background = 'var(--neon-green)';
    dot.style.boxShadow = '0 0 8px var(--neon-green)';
  } else if (config.filterStatus === 'cooldown') {
    dot.style.background = 'var(--neon-orange)';
    dot.style.boxShadow = '0 0 8px var(--neon-orange)';
  } else if (config.filterStatus === 'burnt') {
    dot.style.background = 'var(--neon-red)';
    dot.style.boxShadow = '0 0 8px var(--neon-red)';
  }
}

function setProviderFilter(provider) {
  config.filterProvider = provider;
  localStorage.setItem('iv_filterProvider', provider);
  renderProviderPills();
  if (config.view === 'grid') {
    renderGrid();
  } else {
    renderScatter();
  }
}

function renderAll() {
  renderProviderPills();
  renderGrid();
  renderScatter();
  updateAllTimers();
  renderProviderSelect();
  renderProviderPills();
}

// --- Rendering Functions ---

function updateAllTimers() {
  const now = Date.now();

  items.forEach(item => {
    const timerElement = document.getElementById(`timer-${item.id}`);
    const resetDot = document.getElementById(`reset-dot-${item.id}`);
    if (!timerElement) return;

    if (item.status === 'active') {
      const timeInUse = now - item.lastUsed;
      timerElement.textContent = formatTime(timeInUse);
      if (resetDot) resetDot.style.opacity = '0';
    } else if (item.status === 'cooldown') {
      const resetMs = item.resetHours * 60 * 60 * 1000;
      const remainingMs = item.lastUsed + resetMs - now;
      timerElement.textContent = formatRemainingTime(remainingMs);

      const progress = Math.min(1, (now - item.lastUsed) / resetMs);
      if (resetDot) {
        resetDot.style.opacity = '1';
        resetDot.style.transform = `scaleX(${progress})`;
      }

      if (remainingMs <= 0) {
        item.status = 'ready';
        save();
        renderAll();
        showToast(`${item.provider} Node is Ready!`);
      }
    } else if (item.status === 'ready') {
      timerElement.textContent = '00:00:00';
      if (resetDot) resetDot.style.opacity = '0';
    } else if (item.status === 'burnt') {
      timerElement.textContent = formatLastUsed(item.lastUsed);
      if (resetDot) resetDot.style.opacity = '0';
    }
  });
}

function renderProviderPills() {
  const bar = document.getElementById('providerBar');
  bar.innerHTML = '';

  // Add 'All' pill
  const allPill = document.createElement('div');
  allPill.className = `pill ${config.filterProvider === 'all' ? 'active' : ''}`;
  allPill.textContent = 'All Providers';
  allPill.onclick = () => setProviderFilter('all');
  bar.appendChild(allPill);

  providers.sort().forEach(provider => {
    const pill = document.createElement('div');
    pill.className = `pill ${config.filterProvider === provider ? 'active' : ''}`;
    pill.textContent = provider;
    pill.onclick = () => setProviderFilter(provider);
    
    // NEW: Context menu for specific providers
    pill.oncontextmenu = (e) => {
        e.preventDefault();
        showProviderContextMenu(e, provider);
    };
    
    bar.appendChild(pill);
  });

  // Add 'Add' pill - CHANGED to "+ New Provider"
  const addPill = document.createElement('div');
  addPill.className = 'pill add-btn';
  addPill.textContent = '+ New Provider';
  addPill.onclick = addNewProviderFromMenu; // Directly trigger provider creation
  bar.appendChild(addPill);
}

function renderCard(item) {
  const isCooldown = item.status === 'cooldown';
  const isBurnt = item.status === 'burnt';
  const isReady = item.status === 'ready';

  let dotClass = '';
  if (item.status === 'active') dotClass = 'text-blue';
  else if (isCooldown) dotClass = 'text-orange';
  else if (isReady) dotClass = 'text-green';
  else if (isBurnt) dotClass = 'text-red';

  const timerLabel = isCooldown ? 'TIME TO READY' : (isBurnt ? 'LAST USED' : 'TIME IN USE');

  const card = document.createElement('div');
  card.className = `card ${isBurnt ? 'burnt' : ''}`;
  card.id = `card-${item.id}`;
  card.setAttribute('data-id', item.id);
  card.onclick = (e) => {
    // Prevent modal opening when clicking action icons
    if (e.target.closest('.card-actions') || e.target.closest('.card-edit-icon')) {
      return;
    }
    openModal(item.id);
  };
  card.oncontextmenu = (e) => {
    e.preventDefault();
    showContextMenu(e, item.id);
  };

  card.innerHTML = `
    <div class="card-top">
      <div class="card-provider">${item.provider}</div>
      <div style="display: flex; align-items: center; gap:4px;">
         <div class="status-dot ${dotClass}" style="margin-right:4px;"></div>
         <div style="font-size:11px; font-weight:600; text-transform:uppercase; color: ${dotClass.replace('text-', 'var(--neon-')}">${item.status}</div>
         <button class="card-edit-icon" onclick="openModal(${item.id})">
             <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.41 1.41z"></path></svg>
         </button>
      </div>
    </div>
    <div class="card-timer" id="timer-${item.id}"></div>
    <div style="height: 4px; background: var(--glass-border); border-radius: 2px; position:relative; overflow:hidden;">
      <div id="reset-dot-${item.id}" style="position:absolute; inset:0; background: var(--accent); transform-origin: left; transform: scaleX(0); transition: transform 1s linear;"></div>
    </div>
    <div style="font-size:10px; font-weight:600; color:var(--ink-dim); text-align:center; margin-top:-10px;">${timerLabel}</div>

    ${isBurnt ? `<div class="burnt-label">BURNT</div>` : ''}

    <div class="card-meta">
      <span class="card-email">${item.email}</span>
      <div class="card-actions">
        ${item.status !== 'ready' ? `<div class="action-icon" onclick="confirmForceRestore(${item.id})" title="Reset to Ready">
           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.74 15.42 20 13.75 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 9.74C4.26 11.02 4 12.63 4 14c0 4.42 3.58 8 8 8V23l4-4-4-4v3z"></path></svg>
        </div>` : ''}
        ${item.status === 'active' || item.status === 'cooldown' ? `<div class="action-icon" onclick="confirmHitLimit(${item.id})" title="Hit Limit Now">
           <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
        </div>` : ''}
        ${item.status === 'ready' ? `<div class="action-icon text-green" onclick="openActionOverlay(${item.id})" title="Activate Node">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"></path></svg>
        </div>` : ''}
      </div>
    </div>
  `;
  return card;
}

function renderGrid() {
  const wrapper = document.getElementById('gridWrapper');
  const filteredItems = filterItems().sort((a, b) => {
    // Sort by status: Active > Ready > Cooldown > Burnt
    const statusOrder = {
      'active': 0,
      'ready': 1,
      'cooldown': 2,
      'burnt': 3
    };
    return statusOrder[a.status] - statusOrder[b.status];
  });

  wrapper.innerHTML = '';
  filteredItems.forEach(item => {
    wrapper.appendChild(renderCard(item));
  });
}

function renderScatter() {
  const canvas = document.getElementById('scatterCanvas');
  const filteredItems = filterItems();
  const existingIds = Array.from(canvas.children).map(c => c.dataset.id);

  // Create/Update all cards, dim non-filtered
  items.forEach(item => {
    let card = document.getElementById(`scatter-card-${item.id}`);

    if (!card) {
      // Create new card
      card = document.createElement('div');
      card.className = `scatter-card ${item.status === 'burnt' ? 'burnt' : ''}`;
      card.id = `scatter-card-${item.id}`;
      card.setAttribute('data-id', item.id);
      card.oncontextmenu = (e) => {
        e.preventDefault();
        showContextMenu(e, item.id);
      };
      card.onclick = () => {
        if (!isDraggingCard) { // NEW: Prevent click after drag
          openModal(item.id);
        }
      };
      card.addEventListener('pointerdown', (e) => startDrag(e, item));
      canvas.appendChild(card);
    }

    // Update card content (simplified version of renderCard)
    const isCooldown = item.status === 'cooldown';
    const isBurnt = item.status === 'burnt';
    const isReady = item.status === 'ready';
    let dotClass = '';
    if (item.status === 'active') dotClass = 'text-blue';
    else if (isCooldown) dotClass = 'text-orange';
    else if (isReady) dotClass = 'text-green';
    else if (isBurnt) dotClass = 'text-red';

    const timerLabel = isCooldown ? 'TIME TO READY' : (isBurnt ? 'LAST USED' : 'TIME IN USE');

    card.innerHTML = `
      <div class="card-top" style="width:100%;">
        <div class="card-provider">${item.provider}</div>
        <div style="display: flex; align-items: center; gap:4px;">
           <div class="status-dot ${dotClass}" style="margin-right:4px;"></div>
           <div style="font-size:11px; font-weight:600; text-transform:uppercase; color: ${dotClass.replace('text-', 'var(--neon-')}">${item.status}</div>
           <button class="card-edit-icon" onclick="openModal(${item.id})">
               <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.41 1.41z"></path></svg>
           </button>
        </div>
      </div>
      <div class="card-timer" id="timer-${item.id}"></div>
      <div style="height: 2px; background: var(--glass-border); border-radius: 2px; position:relative; overflow:hidden; width:80%;">
        <div id="reset-dot-${item.id}" style="position:absolute; inset:0; background: var(--accent); transform-origin: left; transform: scaleX(0); transition: transform 1s linear;"></div>
      </div>
      <div class="card-meta">
        <span class="card-email">${item.email}</span>
      </div>
      ${isBurnt ? `<div class="burnt-label">BURNT</div>` : ''}
    `;

    // Apply position
    card.style.left = `${item.pos.x}px`;
    card.style.top = `${item.pos.y}px`;
    card.style.zIndex = item.status === 'active' ? 5 : 1;

    // Apply dimmed class if not in filter
    if (filteredItems.some(f => f.id === item.id)) {
      card.classList.remove('dimmed');
    } else {
      card.classList.add('dimmed');
    }
  });

  // Remove cards if somehow extra (though unlikely)
  existingIds.forEach(id => {
    if (!items.find(i => i.id == id)) {
      document.getElementById(`scatter-card-${id}`).remove();
    }
  });

  applyScatterTransform();
}

function autoArrange() {
  const filteredItems = filterItems();
  const padding = 20;
  let x = 50;
  let y = 50;
  const cardWidth = 250; // Increased width for scatter view
  const cardHeight = 150; // Increased height for scatter view

  // Reset transform to 1,0,0 before calculating positions
  scatter.transform = {
    x: 0,
    y: 0,
    scale: 1
  };
  applyScatterTransform();

  filteredItems.forEach((item, index) => {
    // Simple grid layout logic
    if (index % 3 === 0 && index !== 0) {
      x = 50;
      y += cardHeight + padding;
    }

    item.pos.x = x;
    item.pos.y = y;

    x += cardWidth + padding;
  });

  save();
  renderScatter();
  showToast('Nodes Arranged!');
}

// --- Scatter Pan/Zoom Logic ---
const canvas = document.getElementById('scatterCanvas');
const scatterCanvas = document.getElementById('scatterCanvas');

function applyScatterTransform() {
  scatterCanvas.style.transform = `translate(${scatter.transform.x}px, ${scatter.transform.y}px) scale(${scatter.transform.scale})`;
}

let lastPan = {
  x: 0,
  y: 0
};
let pointers = [];

// Pan Logic (Mouse)
canvas.addEventListener('pointerdown', (e) => {
  if (e.target.closest('.scatter-card')) return; // Card drag handles itself

  if (e.button === 0) { // Left click for pan
    e.preventDefault();
    scatter.panning = true;
    lastPan.x = e.clientX;
    lastPan.y = e.clientY;
    canvas.setPointerCapture(e.pointerId);
  }
});

canvas.addEventListener('pointermove', (e) => {
  if (scatter.panning) {
    const dx = e.clientX - lastPan.x;
    const dy = e.clientY - lastPan.y;
    scatter.transform.x += dx;
    scatter.transform.y += dy;
    lastPan.x = e.clientX;
    lastPan.y = e.clientY;
    applyScatterTransform();
  }
});

canvas.addEventListener('pointerup', (e) => {
  if (scatter.panning) {
    scatter.panning = false;
    canvas.releasePointerCapture(e.pointerId);
    save();
  }
});

// Drag Logic
function startDrag(e, item) {
  if (e.button !== 0) return; // Only left mouse button

  const card = e.currentTarget;
  scatter.dragging = true;
  card.classList.add('is-dragging');
  card.setPointerCapture(e.pointerId);

  // Bring to front
  card.style.zIndex = 1000;

  const containerRect = canvas.getBoundingClientRect();
  const startItemX = item.pos.x;
  const startItemY = item.pos.y;
  const startClientX = e.clientX;
  const startClientY = e.clientY;
  const invScale = 1 / scatter.transform.scale;

  const startCanvasX = (startClientX - containerRect.left - scatter.transform.x) * invScale;
  const startCanvasY = (startClientY - containerRect.top - scatter.transform.y) * invScale;

  let distanceMoved = 0;
  isDraggingCard = false;

  function move(eMove) {
    if (eMove.pointerId !== e.pointerId) return;
    scatter.dragging = true;

    const currentClientX = eMove.clientX;
    const currentClientY = eMove.clientY;

    // Calculate total distance moved
    const dx_client = currentClientX - startClientX;
    const dy_client = currentClientY - startClientY;
    distanceMoved = Math.hypot(dx_client, dy_client);

    if (distanceMoved > 5) { // Dampening threshold (5 pixels)
      isDraggingCard = true;
    }

    const currentCanvasX = (currentClientX - containerRect.left - scatter.transform.x) * invScale;
    const currentCanvasY = (currentClientY - containerRect.top - scatter.transform.y) * invScale;

    const newX = startItemX + (currentCanvasX - startCanvasX);
    const newY = startItemY + (currentCanvasY - startCanvasY);

    // Apply a temporary transform for the drag visual effect
    card.style.transform = `translate(${newX - startItemX}px, ${newY - startItemY}px)`;
  }

  function end(eEnd) {
    if (eEnd.pointerId !== e.pointerId) return;

    // Calculate final position
    const currentClientX = eEnd.clientX;
    const currentClientY = eEnd.clientY;
    const currentCanvasX = (currentClientX - containerRect.left - scatter.transform.x) * invScale;
    const currentCanvasY = (currentClientY - containerRect.top - scatter.transform.y) * invScale;

    const finalX = startItemX + (currentCanvasX - startCanvasX);
    const finalY = startItemY + (currentCanvasY - startCanvasY);

    if (isDraggingCard) { // Only update position if a drag actually happened
      item.pos.x = finalX;
      item.pos.y = finalY;
      card.style.left = `${finalX}px`; // Apply final position
      card.style.top = `${finalY}px`; // Apply final position
      save();
    }

    // Reset card styles and state
    card.style.transform = ''; // Remove the temporary drag transform
    card.classList.remove('is-dragging');
    scatter.dragging = false;
    card.style.zIndex = item.status === 'active' ? 5 : 1; // Restore z-index
    card.removeEventListener('pointermove', move);
    card.removeEventListener('pointerup', end);

    // isDraggingCard will be checked by card.onclick on pointerup/click
    setTimeout(() => isDraggingCard = false, 100); // Reset flag after a short delay
  }

  card.addEventListener('pointermove', move);
  card.addEventListener('pointerup', end);
}

// Zoom/Pinch Logic
canvas.addEventListener('wheel', (e) => {
  e.preventDefault();
  const zoomFactor = e.deltaY * -0.001; // Scale factor based on wheel speed
  zoom(zoomFactor, e.clientX, e.clientY);
  save();
});

// Touch/Pinch Logic (kept for completeness, though pan/zoom is main focus)
canvas.addEventListener('touchstart', (e) => {
  pointers = Array.from(e.touches);
  if (pointers.length === 2) {
    const touch1 = pointers[0];
    const touch2 = pointers[1];
    scatter.pinchStart = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
  } else if (pointers.length === 1 && !e.target.closest('.scatter-card')) {
    lastPan.x = pointers[0].clientX;
    lastPan.y = pointers[0].clientY;
  }
}, {
  passive: false
});

canvas.addEventListener('touchmove', (e) => {
  e.preventDefault(); // Prevent page scroll during pan/zoom
  pointers = Array.from(e.touches);

  if (pointers.length === 2) {
    const touch1 = pointers[0];
    const touch2 = pointers[1];
    const currentDist = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
    const scaleChange = currentDist / scatter.pinchStart;

    const centerX = (touch1.clientX + touch2.clientX) / 2;
    const centerY = (touch1.clientY + touch2.clientY) / 2;

    const oldScale = scatter.transform.scale;
    let newScale = oldScale * scaleChange;

    // Clamp scale
    newScale = Math.max(0.25, Math.min(3, newScale));

    const scaleRatio = newScale / oldScale;

    scatter.transform.x = centerX - (centerX - scatter.transform.x) * scaleRatio;
    scatter.transform.y = centerY - (centerY - scatter.transform.y) * scaleRatio;
    scatter.transform.scale = newScale;
    scatter.pinchStart = currentDist; // Update pinchStart for next move

    applyScatterTransform();

  } else if (e.touches.length === 1 && !e.target.closest('.scatter-card')) {
    // Treat single touch move as pan if not dragging a card
    const touch = e.touches[0];
    const dx = touch.clientX - lastPan.x;
    const dy = touch.clientY - lastPan.y;
    scatter.transform.x += dx;
    scatter.transform.y += dy;
    lastPan.x = touch.clientX;
    lastPan.y = touch.clientY;
    applyScatterTransform();
  }
}, {
  passive: false
});

canvas.addEventListener('touchend', (e) => {
  pointers = Array.from(e.touches);
  if (e.touches.length < 2) {
    scatter.pinchStart = 0;
    save();
  }
});

// --- Context Menu Logic ---
function showContextMenu(e, nodeId) {
  closeContextMenu(); // Close any open menu
  const menu = document.getElementById('contextMenu');
  const item = items.find(i => i.id == nodeId);
  if (!item) return;

  menu.innerHTML = `
    <div class="ctx-header">${item.provider} Node</div>
    <div class="ctx-item" onclick="openModal(${item.id})">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.41 1.41z"></path></svg>
       <span>Edit Details</span>
    </div>
    ${item.status === 'ready' ? `<div class="ctx-item text-green" onclick="openActionOverlay(${item.id})">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"></path></svg>
       <span>Activate Node</span>
    </div>` : ''}
    ${item.status !== 'ready' ? `<div class="ctx-item text-blue" onclick="confirmForceRestore(${item.id})">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.74 15.42 20 13.75 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 9.74C4.26 11.02 4 12.63 4 14c0 4.42 3.58 8 8 8V23l4-4-4-4v3z"></path></svg>
       <span>Force Restore</span>
    </div>` : ''}
    ${item.status === 'active' || item.status === 'cooldown' ? `<div class="ctx-item text-red" onclick="confirmHitLimit(${item.id})">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
       <span>Hit Limit / Cooldown</span>
    </div>` : ''}
  `;

  menu.style.left = `${e.clientX}px`;
  menu.style.top = `${e.clientY}px`;
  menu.classList.add('active');

  // Hide menu on next click
  const hide = () => {
    menu.classList.remove('active');
    document.removeEventListener('click', hide);
    document.removeEventListener('contextmenu', hide);
  };
  setTimeout(() => document.addEventListener('click', hide), 10);
}

// NEW: Context menu for Providers
function showProviderContextMenu(e, providerName) {
  closeContextMenu(); // Close any open menu
  const menu = document.getElementById('contextMenu');

  menu.innerHTML = `
    <div class="ctx-header">Provider: ${providerName}</div>
    <div class="ctx-item" onclick="renameProvider('${providerName}')">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.41 1.41z"></path></svg>
       <span>Edit Name</span>
    </div>
    <div class="ctx-item text-red" onclick="deleteProvider('${providerName}')">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
       <span>Delete Provider</span>
    </div>
    <div class="ctx-item" onclick="addNewProviderFromMenu()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>New Provider...</span>
    </div>
  `;

  menu.style.left = `${e.clientX}px`;
  menu.style.top = `${e.clientY}px`;
  menu.classList.add('active');

  // Hide menu on next click
  const hide = () => {
    menu.classList.remove('active');
    document.removeEventListener('click', hide);
    document.removeEventListener('contextmenu', hide);
  };
  setTimeout(() => document.addEventListener('click', hide), 10);
}

function renameProvider(oldName) {
    const newName = prompt(`Rename ${oldName} to:`, oldName);
    if(newName && newName.trim() && newName !== oldName) {
        const trimmed = newName.trim();
        
        // Update the provider list
        const index = providers.indexOf(oldName);
        if(index !== -1) {
            providers[index] = trimmed;
        }
        
        // Update all associated items
        items.forEach(item => {
            if(item.provider === oldName) {
                item.provider = trimmed;
            }
        });
        
        // If filter was set to this provider, update it
        if(config.filterProvider === oldName) {
            config.filterProvider = trimmed;
        }
        
        providers.sort();
        save();
        renderAll();
        showToast('Provider Renamed');
    }
}

function deleteProvider(name) {
    if(confirm(`Remove "${name}" from provider list? (Associated nodes will remain but won't have a filter pill until re-added)`)) {
        providers = providers.filter(p => p !== name);
        if(config.filterProvider === name) {
            config.filterProvider = 'all';
        }
        save();
        renderAll();
        showToast('Provider Removed');
    }
}


// NEW: Grid View Context Menu
function showGridBackgroundContextMenu(e) {
  const menu = document.getElementById('contextMenu');
  menu.innerHTML = `
    <div class="ctx-header">Grid Options</div>
    <div class="ctx-item" onclick="closeContextMenu(); openModal()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>Add New Node</span>
    </div>
    <div class="ctx-item" onclick="closeContextMenu(); addNewProviderFromMenu()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>Add New Provider</span>
    </div>
  `;

  menu.style.left = `${e.clientX}px`;
  menu.style.top = `${e.clientY}px`;
  menu.classList.add('active');

  // Hide menu on next click
  const hide = () => {
    menu.classList.remove('active');
    document.removeEventListener('click', hide);
    document.removeEventListener('contextmenu', hide);
  };
  setTimeout(() => document.addEventListener('click', hide), 10);
}

// NEW: Scatter View Context Menu
function showScatterBackgroundContextMenu(e) {
  const menu = document.getElementById('contextMenu');
  menu.innerHTML = `
    <div class="ctx-header">Scatter Options</div>
    <div class="ctx-item" onclick="closeContextMenu(); openModal()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>Add New Node</span>
    </div>
    <div class="ctx-item" onclick="closeContextMenu(); addNewProviderFromMenu()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
       <span>Add New Provider</span>
    </div>
    <div class="ctx-item" onclick="closeContextMenu(); autoArrange()">
       <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4 11h7V4H4v7zm0 9h7v-7H4v7zm9 0h7v-7h-7v7zm0-16v7h7V4h-7z"></path></svg>
       <span>Auto Arrange</span>
    </div>
  `;

  menu.style.left = `${e.clientX}px`;
  menu.style.top = `${e.clientY}px`;
  menu.classList.add('active');

  // Hide menu on next click
  const hide = () => {
    menu.classList.remove('active');
    document.removeEventListener('click', hide);
    document.removeEventListener('contextmenu', hide);
  };
  setTimeout(() => document.addEventListener('click', hide), 10);
}

function closeContextMenu() {
  document.getElementById('contextMenu').classList.remove('active');
}

// Helper for context menu
function addNewProviderFromMenu() {
  const newProvider = prompt('Enter new provider name:');
  if (newProvider && newProvider.trim()) {
    const trimmedProvider = newProvider.trim();
    if (!providers.includes(trimmedProvider)) {
      providers.push(trimmedProvider);
      providers.sort();
      save();
      renderProviderSelect();
      renderProviderPills();
      showToast('Provider added!');
    }
  }
}


// Hide context menu if clicking outside of it (already handled by hide function, but just in case)
document.addEventListener('click', (e) => {
  if (!e.target.closest('#contextMenu')) {
    document.getElementById('contextMenu').classList.remove('active');
  }
});

// --- Quick Actions ---
function confirmHitLimit(nodeId) {
  closeModal();
  closeContextMenu();
  const id = nodeId || document.getElementById('nodeId').value;
  const item = items.find(i => i.id == id);
  if (!item) return;

  confirmAction(`Hit Limit: ${item.provider}`, `Mark this node as 'cooldown' and start its ${item.resetHours}h reset timer?`, () => {
    item.status = 'cooldown';
    item.lastUsed = Date.now();
    save();
    closeConfirm();
    renderAll();
    showToast(`${item.provider} Node Cooldown Initiated.`);
  });
}

function confirmForceRestore(nodeId) {
  closeModal();
  closeContextMenu();
  const id = nodeId || document.getElementById('nodeId').value;
  const item = items.find(i => i.id == id);
  if (!item) return;

  confirmAction(`Force Restore: ${item.provider}`, `Mark this node as 'ready' and reset its timer?`, () => {
    item.status = 'ready';
    // Set last used far in past to ensure ready state
    item.lastUsed = Date.now() - (item.resetHours * 60 * 60 * 1000) * 2;
    save();
    closeConfirm();
    renderAll();
    showToast(`${item.provider} Node is Force Ready.`);
  });
}

// --- Modal/Dialog Management (Provider Select Rework) ---

// Renders options for the new <select id="inpProvider">
function renderProviderSelect() {
  const select = document.getElementById('inpProvider');
  if (!select) return;

  const currentProviderValue = select.value;

  // Clear existing options
  select.innerHTML = '';

  // Add the default "Select" option
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = 'Select a Provider';
  defaultOption.disabled = true;
  defaultOption.selected = true;
  select.appendChild(defaultOption);

  // Add existing providers
  providers.sort().forEach(provider => {
    const option = document.createElement('option');
    option.value = provider;
    option.textContent = provider;
    select.appendChild(option);
  });

  // Add the "Add Custom" option
  const customOption = document.createElement('option');
  customOption.value = 'CUSTOM_ADD_NEW';
  customOption.textContent = '+ Add Custom Provider...';
  select.appendChild(customOption);

  // Attempt to re-select the previous value if it's still valid
  if (currentProviderValue && (providers.includes(currentProviderValue) || currentProviderValue === 'CUSTOM_ADD_NEW')) {
    select.value = currentProviderValue;
  }
}

// Handle selection change for custom provider
document.addEventListener('change', (e) => {
  if (e.target.id === 'inpProvider' && e.target.value === 'CUSTOM_ADD_NEW') {
    const newProvider = prompt('Enter new provider name:');
    if (newProvider && newProvider.trim()) {
      const trimmedProvider = newProvider.trim();
      if (!providers.includes(trimmedProvider)) {
        providers.push(trimmedProvider);
        providers.sort();
        save();
      }
      // Re-render and select the new provider
      renderProviderSelect();
      document.getElementById('inpProvider').value = trimmedProvider;
      renderProviderPills(); // Update pills immediately
    } else {
      // If canceled, reset the selection to the default
      document.getElementById('inpProvider').value = '';
    }
  }
});


function selectStatusButton(status) {
  document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('selected'));
  document.querySelector(`.btn-toggle[data-status="${status}"]`).classList.add('selected');
  document.getElementById('inpStatus').value = status;
}

function selectResetHours(hours) {
  document.querySelectorAll('.pill-option').forEach(p => p.classList.remove('selected'));
  document.querySelector(`.pill-option[data-hours="${hours}"]`).classList.add('selected');
  document.getElementById('inpReset').value = hours;
  document.getElementById('inpResetCustom').value = ''; // Clear custom input
}

document.getElementById('inpResetCustom').addEventListener('input', (e) => {
  document.querySelectorAll('.pill-option').forEach(p => p.classList.remove('selected'));
  const value = parseFloat(e.target.value);
  if (!isNaN(value) && value > 0) {
    document.getElementById('inpReset').value = value;
  } else if (e.target.value === '') {
    // Re-select default or current value if custom is cleared
    selectResetHours(document.getElementById('inpReset').value || 3);
  }
});

function openModal(nodeId = null) {
  const modal = document.getElementById('modalOverlay');
  const form = document.getElementById('nodeForm');
  const title = document.getElementById('modalTitle');
  const btnDelete = document.getElementById('btnDelete');
  const editActions = document.getElementById('editActions');
  const inpProvider = document.getElementById('inpProvider'); // Now the <select>

  form.reset();
  selectResetHours(3);
  selectStatusButton('ready');
  document.getElementById('nodeId').value = '';
  renderProviderSelect(); // Render/reset the options in the select
  inpProvider.value = ''; // Ensure default is selected
  title.textContent = 'New Node';
  btnDelete.style.display = 'none';
  editActions.style.display = 'none';

  if (nodeId) {
    // Edit existing node
    const item = items.find(i => i.id == nodeId);
    if (!item) return;

    title.textContent = `Edit Node: ${item.provider}`;
    document.getElementById('nodeId').value = nodeId;

    // Ensure the provider is in the list before trying to set the value
    if (!providers.includes(item.provider)) {
       providers.push(item.provider);
       providers.sort();
       save();
       renderProviderSelect();
    }
    inpProvider.value = item.provider; // SETTING THE SELECT VALUE

    document.getElementById('inpEmail').value = item.email;
    selectStatusButton(item.status);

    // Handle custom reset hours
    const option = document.querySelector(`.pill-option[data-hours="${item.resetHours}"]`);
    if (option) {
      selectResetHours(item.resetHours);
    } else {
      document.querySelectorAll('.pill-option').forEach(p => p.classList.remove('selected'));
      document.getElementById('inpResetCustom').value = item.resetHours;
      document.getElementById('inpReset').value = item.resetHours;
    }

    btnDelete.style.display = 'block';
    editActions.style.display = 'flex';
    document.getElementById('btnDelete').onclick = () => deleteNode();
    document.getElementById('btnDelete').setAttribute('data-id', nodeId); // For confirm dialog
    document.querySelector('#editActions .btn-secondary:nth-child(1)').onclick = () => confirmHitLimit(nodeId);
    document.querySelector('#editActions .btn-secondary:nth-child(2)').onclick = () => confirmForceRestore(nodeId);
  }

  modal.classList.add('active');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
}

// NEW: Function to close action overlay
function closeActionOverlay() {
  document.getElementById('actionOverlay').classList.remove('active');
}

// NEW: Function to close info modal
function closeInfoModal() {
  document.getElementById('infoOverlay').classList.remove('active');
}


const form = document.getElementById('nodeForm');
form.addEventListener('submit', (e) => {
  e.preventDefault();

  const nodeId = document.getElementById('nodeId').value;
  const provider = document.getElementById('inpProvider').value; // Get value from <select>
  const email = document.getElementById('inpEmail').value;
  const status = document.getElementById('inpStatus').value;
  const resetHours = parseFloat(document.getElementById('inpReset').value);

  // Validation for new <select>
  if (!provider || provider === 'CUSTOM_ADD_NEW') {
    showToast('Please select a valid Provider.');
    return;
  }

  const now = Date.now();

  if (nodeId) {
    // Update existing node
    const item = items.find(i => i.id == nodeId);
    if (!item) return;

    const oldStatus = item.status;
    const oldProvider = item.provider;

    item.provider = provider;
    item.email = email;
    item.status = status;

    // Only apply lastUsed = now if status changed to active/cooldown or provider changed
    if (item.status !== oldStatus || item.provider !== oldProvider) {
      item.lastUsed = now; // Reset timer on status or provider change
    }

    item.resetHours = resetHours;
    if (!providers.includes(provider)) {
      providers.push(provider);
    }
    showToast('Node Updated!');
  } else {
    // Create new node
    const newItem = {
      id: now + Math.floor(Math.random() * 1000),
      provider: provider,
      email: email,
      status: status,
      resetHours: resetHours,
      lastUsed: now,
      pos: {
        x: 50,
        y: 50
      } // Default position for scatter view
    };
    items.push(newItem);
    if (!providers.includes(provider)) {
      providers.push(provider);
    }
    showToast('New Node Added!');
  }

  save();
  closeModal();
  renderAll();
});

function deleteNode() {
  const nodeId = document.getElementById('nodeId').value;
  const item = items.find(i => i.id == nodeId);
  if (!item) return;

  confirmAction(`Delete ${item.provider}?`, 'This action cannot be undone.', () => {
    items = items.filter(i => i.id != nodeId);
    save();
    closeModal();
    renderAll();
    showToast('Node Deleted!');
  });
}

function confirmAction(title, text, callback) {
  const overlay = document.getElementById('confirmOverlay');
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmText').textContent = text;
  const btnConfirm = document.getElementById('btnConfirmAction');

  // Clone the button to remove existing listeners
  const newBtnConfirm = btnConfirm.cloneNode(true);
  btnConfirm.parentNode.replaceChild(newBtnConfirm, btnConfirm);
  newBtnConfirm.onclick = () => {
    callback();
    closeConfirm();
  };

  overlay.classList.add('active');
}

function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('active');
}

function openActionOverlay(nodeId) {
  closeModal();
  closeContextMenu();
  const item = items.find(i => i.id == nodeId);
  if (!item) return;

  // Copy email to clipboard and show toast
  navigator.clipboard.writeText(item.email).then(() => {
    showToast(`Copied ${item.provider} email.`);
  });

  document.getElementById('actionTitle').textContent = `Activate Node: ${item.provider}`;
  document.getElementById('actionEmail').value = item.email;

  const btnActivate = document.getElementById('btnActivateNode');
  const newBtnActivate = btnActivate.cloneNode(true);
  btnActivate.parentNode.replaceChild(newBtnActivate, btnActivate);

  newBtnActivate.onclick = () => {
    // Set to active and start timer
    item.status = 'active';
    item.lastUsed = Date.now();
    save();
    closeActionOverlay();
    renderAll();
    showToast(`${item.provider} Node Activated!`);
  };

  document.getElementById('actionOverlay').classList.add('active');
}

function openInfoModal() {
  document.getElementById('infoOverlay').classList.add('active');
}


// NEW: Close overlay when clicking background
document.querySelectorAll('.overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('active');
      closeContextMenu(); // Ensure context menu is also closed
    }
  });
});

// --- Initialization ---
function init() {
  load();
  const storedTheme = localStorage.getItem('iv_theme');
  if (storedTheme) {
    document.body.setAttribute('data-theme', storedTheme);
  }

  // Ensure the correct view is active on load
  switchView(config.view);

  // Start the timer loop
  timerInterval = setInterval(updateAllTimers, 1000);

  // Initial render
  renderAll();

  // NEW: Grid background context menu handler
  const gridWrapper = document.getElementById('gridWrapper');
  gridWrapper.oncontextmenu = (e) => {
    if (e.target === gridWrapper) {
      e.preventDefault();
      showGridBackgroundContextMenu(e);
    }
  };

  // Scatter background context menu handler
  const canvas = document.getElementById('scatterCanvas');
  canvas.oncontextmenu = (e) => {
    if (!e.target.closest('.scatter-card')) {
      e.preventDefault();
      showScatterBackgroundContextMenu(e);
    }
  };
}

window.addEventListener('load', init);
window.addEventListener('resize', () => {
    if (config.view === 'scatter') {
        applyScatterTransform(); // Re-center background on resize
    }
});

</script>
</body>
</html>
