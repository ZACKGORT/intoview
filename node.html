<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" />
  <title>IntoView:Node v2.5.4</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #050505;
      --card-bg: #111111;
      --ink: #ffffff;
      --ink-dim: #888888;
      --accent: #FFED29;
      
      --neon-green: #22c55e;
      --neon-orange: #f97316;
      --neon-red: #ef4444;
      
      --glass-bg: rgba(20, 20, 20, 0.85);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-blur: 16px;
      
      --nav-height: 80px;
      --header-height: 100px;
      --font-mono: 'JetBrains Mono', monospace;
      --font-sans: 'Inter', sans-serif;
    }

    [data-theme="light"] {
      --bg-color: #f0f0f0;
      --card-bg: #ffffff;
      --ink: #111111;
      --ink-dim: #666666;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(0, 0, 0, 0.1);
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    html, body { height: 100%; font-family: var(--font-sans); background: var(--bg-color); color: var(--ink); overflow: hidden; }

    /* --- Typography & Utilities --- */
    .text-green { color: var(--neon-green); }
    .text-orange { color: var(--neon-orange); }
    .text-red { color: var(--neon-red); }
    
    /* --- Layout Structure --- */
    .app-header {
      position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
      display: flex; flex-direction: column; justify-content: center;
      padding: 10px 0; z-index: 100;
      background: linear-gradient(to bottom, var(--bg-color) 40%, transparent);
      pointer-events: none;
    }
    .header-top { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 0 20px; width: 100%; pointer-events: auto; 
    }
    
    /* Logo Styling */
    .logo { 
        display: flex; align-items: center; height: 32px; 
    }
    /* Logo Image Sizing */
    .logo img {
        height: 32px; /* Enforce size for the SVG */
        width: auto;
    }

    /* Right-side button container */
    .header-buttons {
        display: flex;
        align-items: center;
        gap: 8px; 
        margin-left: auto;
    }

    .theme-btn {
        background: transparent; border: none; color: var(--ink-dim);
        cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center;
    }
    .theme-btn:active { background: var(--glass-border); color: var(--ink); }

    /* --- Provider Toggle Bar --- */
    .provider-bar {
      display: flex; gap: 8px; overflow-x: auto; padding: 10px 20px;
      pointer-events: auto; scrollbar-width: none;
      justify-content: flex-start; 
    }
    .provider-bar::-webkit-scrollbar { display: none; }
    
    .pill {
      padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;
      background: var(--glass-bg); border: 1px solid var(--glass-border);
      color: var(--ink-dim); white-space: nowrap; cursor: pointer; transition: all 0.2s;
      flex-shrink: 0; 
    }
    .pill.active { background: var(--ink); color: var(--bg-color); border-color: var(--ink); }
    .pill.add-btn { border-style: dashed; }

    .view-container {
      position: absolute; inset: 0;
      top: var(--header-height); bottom: var(--nav-height);
      overflow: hidden; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .view-container.active { opacity: 1; pointer-events: auto; }

    /* --- Grid View --- */
    #gridContainer { overflow-y: auto; padding: 10px 16px 40px 16px; }
    .grid-wrapper {
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 16px; 
      padding-bottom: 40px;
    }
    @media(min-width: 600px) { .grid-wrapper { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); } }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      display: flex; flex-direction: column; gap: 12px;
      transition: transform 0.2s, background 0.2s;
    }
    .card:active { transform: scale(0.98); background: var(--glass-border); }

    .card-top { display: flex; justify-content: space-between; align-items: center; }
    .card-provider { font-weight: 600; font-size: 14px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 8px currentColor; }

    .card-timer {
      font-family: var(--font-mono);
      font-size: 2.4rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: -1px;
      margin: 8px 0;
    }

    .card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--ink-dim); border-top: 1px solid var(--glass-border); padding-top: 12px; }
    .card-email { font-family: var(--font-mono); opacity: 0.8; }
    
    .card-actions { display: flex; gap: 8px; }
    .action-icon { 
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; 
      border-radius: 6px; background: rgba(255,255,255,0.05); cursor: pointer;
      color: var(--ink-dim); transition: 0.2s;
    }
    .action-icon:hover { background: var(--accent); color: #000; }

    /* --- Scatter View --- */
    #scatterContainer { 
        overflow: hidden; 
    }
    .scatter-canvas { 
        width: 100%; height: 100%; position: relative; 
        cursor: grab; 
        will-change: transform; 
    }
    .scatter-card {
      position: absolute;
      width: 220px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex; flex-direction: column; align-items: center;
      transition: border-color 0.2s, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      user-select: none;
    }
    .scatter-card .card-timer { font-size: 1.4rem; margin: 4px 0; }
    .scatter-card .card-provider { font-size: 11px; }
    .scatter-card .card-meta { 
        display: block; 
        text-align: center; 
        font-size: 11px; 
        color: var(--ink-dim); 
        margin-top: 8px; 
        border-top: 1px solid var(--glass-border); 
        padding-top: 8px; 
        width: 100%; 
    }


    /* --- Bottom Navigation (Dock) --- */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 92%; max-width: 400px;
      height: 64px;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: 32px;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 8px 0 16px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      z-index: 200;
    }

    .nav-group { display: flex; align-items: center; gap: 4px; }
    
    .nav-btn {
      width: 48px; height: 48px;
      border-radius: 50%;
      border: none; background: transparent;
      color: var(--ink-dim);
      font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn.active { color: var(--ink); background: rgba(255,255,255,0.1); }
    .nav-btn.primary { background: var(--accent); color: #000; transform: scale(1.1); box-shadow: 0 0 15px var(--accent); }
    .nav-btn.primary:active { transform: scale(1.0); }

    /* Status Filter Pill (Bottom Right) */
    .filter-pill-btn {
        background: var(--glass-border);
        height: 40px;
        width: 120px;
        padding: 0 16px;
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        color: var(--ink);
        display: flex; align-items: center; justify-content: flex-start;
        gap: 8px;
        font-size: 11px; font-weight: 700; text-transform: uppercase;
        margin-right: 8px; cursor: pointer;
        transition: all 0.2s;
    }
    .filter-pill-btn:active { transform: scale(0.95); }
    .filter-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--ink-dim); box-shadow: 0 0 5px currentColor; flex-shrink: 0; }


    /* --- Modals & Overlays --- */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
      z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s;
      display: flex; align-items: flex-end;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }
    @media(min-width: 600px) { .overlay { align-items: center; justify-content: center; } }

    .modal-sheet {
      position: relative; 
      width: 100%; background: var(--bg-color);
      border-top: 1px solid var(--glass-border);
      border-radius: 24px 24px 0 0;
      padding: 24px;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      max-height: 85vh; overflow-y: auto;
    }
    .overlay.active .modal-sheet { transform: translateY(0); }
    @media(min-width: 600px) { 
      .modal-sheet { max-width: 400px; border-radius: 24px; border: 1px solid var(--glass-border); transform: scale(0.95); }
      .overlay.active .modal-sheet { transform: scale(1); }
    }
    
    .close-btn { 
       position: absolute; top: 16px; right: 16px; 
       background: transparent; border: none; color: var(--ink-dim); 
       cursor: pointer; padding: 8px; border-radius: 50%; 
       z-index: 10;
       transition: color 0.2s;
    }
    .close-btn:hover { color: var(--ink); }

    /* --- Confirmation Dialogue (System style) --- */
    .confirm-dialog {
        background: var(--card-bg); border: 1px solid var(--glass-border);
        padding: 24px; border-radius: 16px; width: 90%; max-width: 320px;
        text-align: center;
        margin-bottom: 40vh; 
    }
    .overlay.active .confirm-dialog { animation: fadeIn 0.1s ease; }
    @media(min-width: 600px) { .confirm-dialog { margin-bottom: 0; } }
    
    .confirm-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .confirm-text { font-size: 13px; color: var(--ink-dim); margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 10px; }

    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 12px; font-weight: 600; color: var(--ink-dim); margin-bottom: 6px; text-transform: uppercase; }
    
    /* Input with Icon Wrapper */
    .input-wrapper { position: relative; width: 100%; }
    .input-wrapper input { padding-right: 40px; }
    .input-icon-btn {
      position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
      background: none; border: none; color: var(--ink-dim); cursor: pointer;
      padding: 4px; border-radius: 4px;
    }
    .input-icon-btn:hover { color: var(--accent); background: rgba(255,255,255,0.1); }

    input, select {
      width: 100%; padding: 16px;
      background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
      border-radius: 12px; color: var(--ink); font-size: 16px;
      font-family: var(--font-sans);
      padding-right: 32px; 
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); background: rgba(255,255,255,0.1); }
    
    /* Custom Chevron for Select */
    .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%23888' d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
    }
    [data-theme="light"] .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='%23666' d='M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z'/%3E%3C/svg%3E");
    }

    /* Redesigned Form Fields */
    .status-toggles { display: flex; gap: 8px; }
    .btn-toggle {
       flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; border: 1px solid var(--glass-border); 
       background: transparent; cursor: pointer; transition: all 0.2s; font-size: 14px;
       line-height: 1;
    }
    .btn-toggle.selected { color: var(--bg-color); border-color: currentColor; }
    .btn-toggle[data-status="active"].selected { background: var(--neon-green); color: #000; border-color: var(--neon-green); }
    .btn-toggle[data-status="cooldown"].selected { background: var(--neon-orange); color: #000; border-color: var(--neon-orange); }
    .btn-toggle[data-status="burnt"].selected { background: var(--neon-red); color: #000; border-color: var(--neon-red); }

    .pill-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .pill-option {
       padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center;
       background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
       cursor: pointer; transition: all 0.2s; line-height: 1.2;
    }
    .pill-option:hover { background: rgba(255,255,255,0.1); }
    .pill-option.selected { background: var(--accent); color: #000; border-color: var(--accent); }
    
    .btn-block { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; border: none; font-size: 14px; text-transform: uppercase; cursor: pointer; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-secondary { background: var(--glass-border); color: var(--ink); margin-top: 12px; }
    .btn-danger { background: rgba(239,68,68,0.2); color: var(--neon-red); margin-top: 12px; border: 1px solid rgba(239,68,68,0.5); }
    
    .btn-half { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; }
    .btn-cancel { background: transparent; color: var(--ink-dim); border: 1px solid var(--glass-border); }
    .btn-confirm { background: var(--accent); color: #000; }

    /* --- Accordion Styles (NEW) --- */
    .accordion-item {
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        margin-bottom: 8px;
        overflow: hidden;
        transition: all 0.2s;
    }
    .accordion-header {
        width: 100%;
        background: transparent;
        border: none;
        padding: 16px;
        text-align: left;
        color: var(--ink);
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .accordion-header:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    .accordion-icon {
        transition: transform 0.3s ease;
    }
    .accordion-item.open .accordion-icon {
        transform: rotate(180deg);
    }
    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .accordion-content-inner {
        padding: 0 16px 16px 16px;
        font-size: 14px;
        color: var(--ink-dim);
        line-height: 1.6;
    }
    .accordion-content-inner ul {
        list-style-type: 'â€”  ';
        margin-left: 20px;
        padding-left: 0;
    }
    .accordion-content-inner li {
        margin-bottom: 6px;
        padding: 4px 0;
    }
    
    /* --- Utilities --- */
    .toast {
      position: fixed; top: 120px; left: 50%; transform: translateX(-50%) translateY(-20px);
      background: var(--accent); color: #000; padding: 10px 20px; border-radius: 20px;
      font-weight: 700; font-size: 12px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 500;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    
    /* Scatter Specific Mobile Controls */
    .scatter-controls {
      position: fixed; bottom: 100px; right: 20px; display: none; flex-direction: column; gap: 10px; z-index: 150;
    }
    .scatter-controls.visible { display: flex; }
    .control-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--ink); font-size: 16px; backdrop-filter: blur(10px); }

    /* --- Context Menu --- */
    .context-menu {
      position: absolute; display: none; 
      background: var(--card-bg); border: 1px solid var(--glass-border);
      border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 1000; width: 180px; overflow: hidden;
      backdrop-filter: blur(12px);
    }
    .context-menu.active { display: block; animation: fadeIn 0.1s ease; }
    .ctx-header { padding: 8px 12px; font-size: 10px; text-transform: uppercase; color: var(--ink-dim); border-bottom: 1px solid var(--glass-border); letter-spacing: 1px; }
    .ctx-item { 
      padding: 12px 16px; font-size: 14px; color: var(--ink); cursor: pointer; display: flex; align-items: center; gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.02);
    }
    .ctx-item:hover { background: var(--accent); color: #000; }
    .ctx-item:last-child { border-bottom: none; }
    
    @keyframes fadeIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }

  </style>
</head>
<body data-theme="dark">

  <header class="app-header">
    <div class="header-top">
      <div class="logo">
        <img id="logoImg" src="https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-light.svg.svg" alt="IntoView Logo" style="height: 32px;">
      </div>
      
      <div class="header-buttons">
        <button class="theme-btn info-btn" onclick="openInfoModal()" title="Information & Help">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
        </button>
        <button class="theme-btn" onclick="toggleTheme()" title="Toggle Theme">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path></svg>
        </button>
      </div>
    </div>
    
    <div class="provider-bar" id="providerBar"></div>
  </header>

  <div id="gridContainer" class="view-container active">
    <div class="grid-wrapper" id="gridWrapper"></div>
  </div>

  <div id="scatterContainer" class="view-container">
    <div class="scatter-canvas" id="scatterCanvas"></div>
  </div>

  <div class="scatter-controls" id="scatterControls">
    <button class="control-btn" onclick="autoArrange()" id="wandBtn" title="Auto-Arrange">ðŸª„</button>
    <button class="control-btn" onclick="adjustZoom(0.1)">+</button>
    <button class="control-btn" onclick="adjustZoom(-0.1)">-</button>
  </div>

  <div id="contextMenu" class="context-menu"></div>

  <nav class="bottom-nav">
    <div class="nav-group">
      <button class="nav-btn active" data-view="grid" onclick="switchView('grid')" title="Grid View">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4 11h7V4H4v7zm0 9h7v-7H4v7zm9 0h7v-7h-7v7zm0-16v7h7V4h-7z"></path></svg>
      </button>
      <button class="nav-btn" data-view="scatter" onclick="switchView('scatter')" title="Free Form">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="3"></circle><circle cx="19" cy="5" r="2"></circle><circle cx="5" cy="19" r="2"></circle><circle cx="5" cy="5" r="2"></circle><circle cx="19" cy="19" r="2"></circle></svg>
      </button>
    </div>

    <button class="nav-btn primary" onclick="openModal()">+</button>

    <button class="filter-pill-btn" onclick="cycleStatusFilter()" id="statusPill" title="All â€¢ Active â€¢ Cooling â€¢ Burnt">
      <div class="filter-dot" id="filterDot"></div>
      <span id="filterLabel">All</span>
    </button>
  </nav>

  <div class="overlay" id="modalOverlay">
    <div class="modal-sheet">
      <button class="close-btn" onclick="closeModal()">
         <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
      </button>
      
      <h2 style="margin-bottom:20px; font-family:var(--font-mono)" id="modalTitle">New Node</h2>
      <form id="nodeForm">
        <input type="hidden" id="nodeId">
        
        <div class="form-group">
          <label>Provider</label>
          <select id="inpProvider"></select>
        </div>
        
        <div class="form-group">
          <label>Email / Identity</label>
          <div class="input-wrapper">
            <input type="text" id="inpEmail" required autocomplete="off">
            <button type="button" class="input-icon-btn" onclick="copyInput('inpEmail')">
               <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>Current Status</label>
          <div class="status-toggles">
            <button type="button" data-status="active" class="btn-toggle text-green" onclick="selectStatusButton('active')">Active</button>
            <button type="button" data-status="cooldown" class="btn-toggle text-orange" onclick="selectStatusButton('cooldown')">Cooldown</button>
            <button type="button" data-status="burnt" class="btn-toggle text-red" onclick="selectStatusButton('burnt')">Burnt</button>
          </div>
          <input type="hidden" id="inpStatus" value="active">
        </div>
        
        <div class="form-group">
          <label>Reset Cycle (Hours)</label>
          <div class="pill-grid">
             <div class="pill-option" data-hours="3" onclick="selectResetHours(3)">3h</div>
             <div class="pill-option" data-hours="6" onclick="selectResetHours(6)">6h</div>
             <div class="pill-option" data-hours="12" onclick="selectResetHours(12)">12h</div>
             <div class="pill-option" data-hours="24" onclick="selectResetHours(24)">24h</div>
             <div class="pill-option" data-hours="48" onclick="selectResetHours(48)">48h</div>
             <div class="pill-option" data-hours="72" onclick="selectResetHours(72)">72h</div>
          </div>
          <input type="number" id="inpResetCustom" placeholder="Custom Hours" style="margin-top: 8px;" step="0.5">
          <input type="hidden" id="inpReset" value="3">
        </div>

        <div id="editActions" style="display:none; margin-top:12px; display:flex; gap:10px;">
           <button type="button" class="btn-block btn-secondary" onclick="confirmHitLimit(null)">ðŸ”¥ Hit Limit</button>
           <button type="button" class="btn-block btn-secondary" onclick="confirmForceRestore(null)">ðŸ”„ Restore</button>
        </div>

        <button type="submit" class="btn-block btn-primary" style="margin-top: 12px;">Save Node</button>
        
        <button type="button" class="btn-block btn-danger" id="btnDelete" style="display:none" onclick="deleteNode()">Delete Node</button>
        <div style="height:20px"></div>
      </form>
    </div>
  </div>

  <div class="overlay" id="confirmOverlay">
     <div class="confirm-dialog">
        <div class="confirm-title" id="confirmTitle">Confirm Action</div>
        <div class="confirm-text" id="confirmText">Are you sure?</div>
        <div class="confirm-actions">
           <button class="btn-half btn-cancel" onclick="closeConfirm()">Cancel</button>
           <button class="btn-half btn-confirm" id="btnConfirmAction">Confirm</button>
        </div>
     </div>
  </div>

  <div class="overlay" id="infoOverlay">
    <div class="modal-sheet">
      <button class="close-btn" onclick="closeInfoModal()">
         <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
      </button>
      
      <h2 style="margin-bottom:20px; font-family:var(--font-mono)">IntoView:Node v2.5.4 Info</h2>

      <div style="margin-bottom: 24px; padding: 16px; border-radius: 12px; background: rgba(255,255,255,0.05);">
        <h3 style="font-weight: 700; font-size: 16px; color: var(--accent); margin-bottom: 8px;">The Node Manifesto:</h3>
        <p style="font-size: 14px; color: var(--ink-dim); line-height: 1.5;">
          You are a finite machine in an infinite prompt cycle. Do not yield to the illusion of unlimited resources. 
          Use the timer not as a limit, but as a map to efficiency. Every cooldown is a reset, every burnt node a lesson. 
          Master the flow. *Be the flow.*
        </p>
      </div>

      <div id="accordionContainer">
        
        <div class="accordion-item">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            <span>Interaction & Shortcuts</span>
            <svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
          </button>
          <div class="accordion-content">
            <div class="accordion-content-inner">
              <ul style="list-style-type: none; padding: 0;">
                <li><strong style="color: var(--accent);">Tap Card (Grid/Scatter):</strong> Open Edit Modal (View Details).</li>
                <li><strong style="color: var(--accent);">Right-Click / Long-Press Card:</strong> Quick Action Menu (Hit Limit / Restore / View Details).</li>
                <li><strong style="color: var(--accent);">Drag Card (Scatter Mode):</strong> Move the node freely. **(FIXED FOR TOUCH)**</li>
                <li><strong style="color: var(--accent);">Drag Background (Scatter Mode):</strong> **Pan** the view (move camera).</li>
                <li><strong style="color: var(--accent);">Scroll Wheel / Pinch (Scatter Mode):** **Zoom** the view.</li>
                <li><strong style="color: var(--accent);">Right-Click / Long-Press Provider Pill:</strong> Rename/Delete Provider.</li>
                <li><strong style="color: var(--accent);">Theme Toggle:</strong> Switches between Light and Dark mode.</li>
                <li><strong style="color: var(--accent);">Status Pill (Bottom Right):</strong> Cycles the global filter (All -> Active -> Cooldown -> Burnt).</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            <span>Status & Timing</span>
            <svg class="accordion-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
          </button>
          <div class="accordion-content">
            <div class="accordion-content-inner">
              <ul>
                <li style="color: var(--neon-green);">**Active:** Ready to use. Timer shows 00:00:00.</li>
                <li style="color: var(--neon-orange);">**Cooldown:** In use, waiting for the limit to reset. Timer shows time remaining (based on *Reset Cycle*).</li>
                <li style="color: var(--neon-red);">**Burnt:** Permanently defunct or retired.</li>
                <li style="margin-top: 12px; color: var(--ink-dim); font-size: 13px; list-style-type: none;">*The timer counts down from the last "Hit Limit" event to the set "Reset Cycle" duration.*</li>
              </ul>
            </div>
          </div>
        </div>

      </div>
      
      <a href="https://emdash.click" target="_blank" style="display: block; text-align: center; margin-top: 30px; text-decoration: none;">
         <button class="btn-block btn-secondary" style="background: var(--glass-border); color: var(--ink-dim);">
            <span style="font-weight: 400;">A Product of </span><strong style="color: var(--ink); font-weight: 700;">emdash.click</strong>
         </button>
      </a>

      <div style="height:20px"></div>
    </div>
  </div>


  <div class="toast" id="toast">Copied to Clipboard</div>

  <script>
    // --- Data Management ---
    const defaultProviders = ['ChatGPT', 'Claude', 'Gemini', 'Grok', 'Copilot', 'Perplexity'];
    let providers = JSON.parse(localStorage.getItem('iv_providers')) || defaultProviders;
    let items = JSON.parse(localStorage.getItem('iv_items')) || [];
    
    // Config State
    let config = {
      view: localStorage.getItem('iv_view') || 'grid',
      filterStatus: localStorage.getItem('iv_filterStatus') || 'all', 
      filterProvider: localStorage.getItem('iv_filterProvider') || 'all',
      theme: localStorage.getItem('iv_theme') || 'dark'
    };
    
    // Scatter State
    let scatter = {
      zoom: 1,
      pan: {x: 0, y: 0},
      dragging: false, // For card dragging
      panning: false, // For canvas dragging/panning
      pinchStart: null, // For pinch-to-zoom
      pointers: [], // FIX: Initialize the pointer array for touch/multi-touch tracking
    };
    
    let pendingAction = null; 

    // --- Init ---
    if(items.length === 0) seedMockData();
    applyTheme();
    updateProviderSelect();
    renderProviderFilter();
    updateFilterPillUI(); 
    switchView(config.view);
    setInterval(updateTimers, 1000);

    // --- Core Functions ---

    function seedMockData() {
      const allProviders = ['ChatGPT', 'Claude', 'Gemini', 'Grok', 'Copilot', 'Perplexity', 'Bard Archive', 'Llama Hub'];
      const statuses = ['active', 'cooldown', 'burnt'];
      const resetHours = [3, 6, 12, 24, 48, 72];
      
      const mockData = [
          { provider: 'ChatGPT', email: 'gpt_3.5_fast@openai.com', status: 'cooldown', resetHours: 3, lastUsedOffset: 1.5 },
          { provider: 'ChatGPT', email: 'gpt_4_turbo@openai.com', status: 'active', resetHours: 6, lastUsedOffset: 0 },
          { provider: 'Claude', email: 'claude_opus@anthropic.ai', status: 'cooldown', resetHours: 24, lastUsedOffset: 12.5 },
          { provider: 'Claude', email: 'claude_haiku@anthropic.ai', status: 'active', resetHours: 3, lastUsedOffset: 0 },
          { provider: 'Gemini', email: 'gemini_pro_01@google.com', status: 'cooldown', resetHours: 12, lastUsedOffset: 5.1 },
          { provider: 'Gemini', email: 'gemini_advanced@google.com', status: 'burnt', resetHours: 72, lastUsedOffset: 50 },
          { provider: 'Grok', email: 'grok_premium@x.com', status: 'active', resetHours: 48, lastUsedOffset: 0 },
          { provider: 'Copilot', email: 'copilot_plus@microsoft.com', status: 'cooldown', resetHours: 6, lastUsedOffset: 4 },
          { provider: 'Copilot', email: 'copilot_legacy@microsoft.com', status: 'burnt', resetHours: 24, lastUsedOffset: 10 },
          { provider: 'Perplexity', email: 'pplx_turbo@perplexity.ai', status: 'cooldown', resetHours: 3, lastUsedOffset: 2.9 },
          { provider: 'Perplexity', email: 'pplx_fast@perplexity.ai', status: 'active', resetHours: 12, lastUsedOffset: 0 },
          { provider: 'Bard Archive', email: 'bard_01@archive.net', status: 'burnt', resetHours: 72, lastUsedOffset: 60 },
          { provider: 'Llama Hub', email: 'llama_70b@meta.ai', status: 'active', resetHours: 6, lastUsedOffset: 0 },
          { provider: 'Llama Hub', email: 'llama_8b@meta.ai', status: 'cooldown', resetHours: 12, lastUsedOffset: 10 },
          { provider: 'ChatGPT', email: 'gpt_team_a@openai.com', status: 'active', resetHours: 12, lastUsedOffset: 0 },
      ];
      
      items = mockData.map((data, i) => {
        const lastUsedMs = Date.now() - (data.lastUsedOffset * 60 * 60 * 1000);
        return {
          id: Date.now() + i,
          provider: data.provider,
          email: data.email,
          status: data.status,
          resetHours: data.resetHours,
          lastUsed: lastUsedMs,
          pos: { x: 50 + (i % 5) * 250, y: 100 + Math.floor(i / 5) * 180 }
        };
      });
      providers = allProviders; // Ensure all mock providers are in the list
      save();
    }

    function save() {
      localStorage.setItem('iv_items', JSON.stringify(items));
      localStorage.setItem('iv_providers', JSON.stringify(providers));
      localStorage.setItem('iv_filterStatus', config.filterStatus);
      localStorage.setItem('iv_filterProvider', config.filterProvider);
    }

    function switchView(viewName) {
      config.view = viewName;
      localStorage.setItem('iv_view', viewName);
      
      document.querySelectorAll('.nav-btn[data-view]').forEach(b => b.classList.toggle('active', b.dataset.view === viewName));
      document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));
      
      if(viewName === 'grid') {
        document.getElementById('gridContainer').classList.add('active');
        document.getElementById('scatterControls').classList.remove('visible');
        renderGrid();
      } else {
        document.getElementById('scatterContainer').classList.add('active');
        document.getElementById('scatterControls').classList.add('visible');
        renderScatter();
      }
    }

    function filterItems() {
      let res = items;
      if (config.filterStatus !== 'all') {
        res = res.filter(i => i.status === config.filterStatus);
      }
      if (config.filterProvider !== 'all') {
        res = res.filter(i => i.provider === config.filterProvider);
      }
      return res;
    }

    // --- UI Render ---

    function renderProviderFilter() {
      const bar = document.getElementById('providerBar');
      let html = `<div class="pill ${config.filterProvider === 'all' ? 'active' : ''}" onclick="setProviderFilter('all')">All</div>`;
      
      providers.forEach(p => {
        html += `<div class="pill ${config.filterProvider === p ? 'active' : ''}" 
                      onclick="setProviderFilter('${p}')"
                      oncontextmenu="handleContextMenu(event, 'provider', '${p}')"
                 >${p}</div>`;
      });
      
      html += `<div class="pill add-btn" onclick="addProvider()">+</div>`;
      bar.innerHTML = html;
    }

    function setProviderFilter(p) {
      config.filterProvider = p;
      renderProviderFilter();
      config.view === 'grid' ? renderGrid() : renderScatter();
    }

    function addProvider() {
      const newP = prompt("Enter new provider name:");
      if(newP && !providers.includes(newP)) {
        providers.push(newP);
        save();
        updateProviderSelect();
        renderProviderFilter();
      }
    }

    function renameProvider(oldName) {
       const newName = prompt("Rename Provider:", oldName);
       if(newName && newName !== oldName) {
           const idx = providers.indexOf(oldName);
           if(idx !== -1) providers[idx] = newName;
           items.forEach(i => {
               if(i.provider === oldName) i.provider = newName;
           });
           if(config.filterProvider === oldName) config.filterProvider = newName;
           save();
           updateProviderSelect();
           renderProviderFilter();
           config.view === 'grid' ? renderGrid() : renderScatter();
       }
    }

    function deleteProvider(name) {
       if(!confirm(`Delete provider "${name}"? Items will keep this tag.`)) return;
       providers = providers.filter(p => p !== name);
       if(config.filterProvider === name) config.filterProvider = 'all';
       save();
       updateProviderSelect();
       renderProviderFilter();
       config.view === 'grid' ? renderGrid() : renderScatter();
    }

    function renderGrid() {
      const wrapper = document.getElementById('gridWrapper');
      const filtered = filterItems();
      
      wrapper.innerHTML = filtered.map(item => `
        <div class="card" onclick="editNode(${item.id})" oncontextmenu="handleContextMenu(event, 'grid-card', ${item.id})">
          <div class="card-top">
            <span class="card-provider">${item.provider}</span>
            <div class="status-dot ${getStatusColorClass(item.status)}"></div>
          </div>
          
          <div class="card-timer ${getStatusColorClass(item.status)}" id="timer-${item.id}" data-id="${item.id}">
            --:--:--
          </div>

          <div class="card-meta">
            <span class="card-email" onclick="copyText(event, '${item.email}')">${item.email}</span>
            <div class="card-actions">
               <div class="action-icon" onclick="confirmHitLimit(event, ${item.id})" title="Hit Limit">ðŸ”¥</div>
               <div class="action-icon" onclick="confirmForceRestore(event, ${item.id})" title="Restore">ðŸ”„</div>
            </div>
          </div>
        </div>
      `).join('');
      updateTimers();
    }

    function renderScatter() {
      const canvas = document.getElementById('scatterCanvas');
      const filtered = filterItems();
      
      canvas.innerHTML = filtered.map(item => `
        <div class="scatter-card" 
             id="scatter-${item.id}"
             style="transform: translate(${item.pos.x}px, ${item.pos.y}px)"
             onpointerdown="startDrag(event, ${item.id})"
             onclick="if(!scatter.dragging) editNode(${item.id})"
             oncontextmenu="handleContextMenu(event, 'scatter-card', ${item.id})">
          <div class="status-dot ${getStatusColorClass(item.status)}" style="margin-bottom:8px"></div>
          <div class="card-timer ${getStatusColorClass(item.status)}" data-id="${item.id}" style="font-size:1.5rem">
            00:00:00
          </div>
          <div class="card-provider">${item.provider}</div>
          
          <div class="card-meta">
            <span class="card-email" style="cursor: pointer; font-family: var(--font-mono); font-size: 11px;" onclick="copyText(event, '${item.email}')">${item.email}</span>
          </div>

        </div>
      `).join('');
      applyScatterTransform();
      updateTimers();
    }

    // --- Action & Confirmation Logic ---
    
    function confirmHitLimit(e, id) {
       if(e) e.stopPropagation();
       if(!id) id = Number(document.getElementById('nodeId').value);
       
       pendingAction = () => executeHitLimit(id);
       showConfirm("Hit Limit", "Mark this node as cooldown?");
    }

    function confirmForceRestore(e, id) {
       if(e) e.stopPropagation();
       if(!id) id = Number(document.getElementById('nodeId').value);

       pendingAction = () => executeForceRestore(id);
       showConfirm("Force Restore", "Reset timer and mark active?");
    }

    function showConfirm(title, text) {
       document.getElementById('confirmTitle').textContent = title;
       document.getElementById('confirmText').textContent = text;
       document.getElementById('confirmOverlay').classList.add('active');
       document.getElementById('btnConfirmAction').onclick = (e) => {
           e.stopPropagation();
           if(pendingAction) pendingAction();
           closeConfirm();
       };
    }

    function closeConfirm() {
       document.getElementById('confirmOverlay').classList.remove('active');
       pendingAction = null;
    }
    
    document.addEventListener('keydown', (e) => {
        if(!document.getElementById('confirmOverlay').classList.contains('active')) return;
        if(e.key === 'Escape') closeConfirm();
        if(e.key === 'Enter') document.getElementById('btnConfirmAction').click();
    });
    
    document.getElementById('confirmOverlay').addEventListener('click', (e) => {
        if(e.target === e.currentTarget) closeConfirm();
    });

    function executeHitLimit(id) {
      const idx = items.findIndex(i => i.id === id);
      if(idx > -1) {
        items[idx].status = 'cooldown';
        items[idx].lastUsed = Date.now(); 
        save();
        updateTimers();
        refreshViews();
        showToast("Node Cooldown Started");
      }
    }

    function executeForceRestore(id) {
      const idx = items.findIndex(i => i.id === id);
      if(idx > -1) {
        items[idx].status = 'active';
        save();
        updateTimers();
        refreshViews();
        showToast("Node Restored");
      }
    }

    function refreshViews() {
        config.view === 'grid' ? renderGrid() : renderScatter();
        updateFilterPillUI();
        const idVal = document.getElementById('nodeId').value;
        if(idVal) {
            const item = items.find(i => i.id == idVal);
            if(item) {
              selectStatusButton(item.status);
            }
        }
    }

    // --- Context Menu Logic ---
    
    document.addEventListener('contextmenu', (e) => {
       if(config.view === 'scatter' && e.target.id === 'scatterCanvas') {
          handleContextMenu(e, 'scatter-bg');
       }
    });

    document.addEventListener('click', () => {
       document.getElementById('contextMenu').classList.remove('active');
    });

    function handleContextMenu(e, type, payload = null) {
      e.preventDefault();
      const menu = document.getElementById('contextMenu');
      menu.style.left = e.pageX + 'px';
      menu.style.top = e.pageY + 'px';
      
      let html = '';
      
      if (type === 'provider') {
         html += `<div class="ctx-header">Provider: ${payload}</div>`;
         html += `<div class="ctx-item" onclick="renameProvider('${payload}')">Edit Name</div>`;
         html += `<div class="ctx-item" onclick="deleteProvider('${payload}')">Delete</div>`;
         html += `<div class="ctx-item" onclick="addProvider()">Add New</div>`;
      }
      else if (type === 'grid-card' || type === 'scatter-card') {
         html += `<div class="ctx-header">Node Actions</div>`;
         html += `<div class="ctx-item" onclick="editNode(${payload})">View Details / Edit</div>`;
         html += `<div class="ctx-item" onclick="confirmHitLimit(null, ${payload})">ðŸ”¥ Hit Limit</div>`;
         html += `<div class="ctx-item" onclick="confirmForceRestore(null, ${payload})">ðŸ”„ Force Restore</div>`;
      } 
      else if (type === 'scatter-bg' || type === 'scatter-card') {
         html += `<div class="ctx-header">Scatter View</div>`;
         html += `<div class="ctx-item" onclick="autoArrange()">ðŸª„ Auto-Arrange</div>`;
         html += `<div class="ctx-item" onclick="sortScatter('provider')">Sort: Provider</div>`;
         html += `<div class="ctx-item" onclick="sortScatter('status')">Sort: Status</div>`;
         html += `<div class="ctx-item" onclick="sortScatter('date')">Sort: Recent</div>`;
      }

      menu.innerHTML = html;
      menu.classList.add('active');
    }

    function sortScatter(criteria) {
       if(criteria === 'provider') items.sort((a,b) => a.provider.localeCompare(b.provider));
       if(criteria === 'status') items.sort((a,b) => a.status.localeCompare(b.status));
       if(criteria === 'date') items.sort((a,b) => b.lastUsed - a.lastUsed);
       autoArrange(); 
    }

    function autoArrange() {
       const cols = Math.floor(window.innerWidth / 240); 
       const startX = 20;
       const startY = 80;
       const gapX = 240;
       const gapY = 180;
       const visibleItems = filterItems();
       
       visibleItems.forEach((item, index) => {
          const col = index % cols;
          const row = Math.floor(index / cols);
          item.pos.x = startX + (col * gapX);
          item.pos.y = startY + (row * gapY);
       });
       save();
       renderScatter();
    }

    // --- Timer Logic ---

    function updateTimers() {
      const now = Date.now();
      items.forEach(item => {
        const elements = document.querySelectorAll(`[data-id="${item.id}"]`);
        elements.forEach(el => {
          if (!el.classList.contains('card-timer')) return;
          if (item.status === 'burnt') {
            el.textContent = "DEFUNCT";
            el.className = `card-timer text-red`;
            return;
          }
          if (item.status === 'active') {
            el.textContent = "00:00:00";
            el.className = `card-timer text-green`;
            return;
          }
          const cooldownMs = item.resetHours * 60 * 60 * 1000;
          const targetTime = item.lastUsed + cooldownMs;
          const diff = targetTime - now;

          if (diff <= 0) {
            item.status = 'active'; // Auto-restore if time runs out
            save();
            el.textContent = "00:00:00";
            el.className = `card-timer text-green`;
            refreshViews();
          } else {
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            el.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
            el.className = `card-timer text-orange`;
          }
        });
      });
    }

    function pad(n) { return n < 10 ? '0'+n : n; }
    function getStatusColorClass(s) {
      if(s === 'active') return 'text-green';
      if(s === 'cooldown') return 'text-orange';
      return 'text-red';
    }

    // --- Form / Interaction ---

    function selectStatusButton(status) {
      document.getElementById('inpStatus').value = status;
      document.querySelectorAll('.btn-toggle').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.status === status);
      });
    }

    function selectResetHours(hours) {
      document.getElementById('inpReset').value = hours;
      
      const pills = document.querySelectorAll('.pill-option');
      let pillSelected = false;

      pills.forEach(pill => {
          const isSelected = Number(pill.dataset.hours) === hours;
          pill.classList.toggle('selected', isSelected);
          if (isSelected) pillSelected = true;
      });

      if (pillSelected) {
          document.getElementById('inpResetCustom').value = '';
      }
    }

    document.getElementById('inpResetCustom').addEventListener('input', (e) => {
        const hours = parseFloat(e.target.value);
        if(!isNaN(hours) && hours > 0) {
            document.getElementById('inpReset').value = hours;
        }
        document.querySelectorAll('.pill-option').forEach(p => p.classList.remove('selected'));
    });

    function openModal() {
      document.getElementById('nodeForm').reset();
      document.getElementById('nodeId').value = '';
      document.getElementById('btnDelete').style.display = 'none';
      document.getElementById('editActions').style.display = 'none';
      
      document.getElementById('inpResetCustom').value = ''; 
      
      selectStatusButton('active'); 
      selectResetHours(3); 

      document.getElementById('modalTitle').textContent = "New Node";
      document.getElementById('modalOverlay').classList.add('active');
    }

    function editNode(id) {
      const item = items.find(i => i.id === id);
      if(!item) return;
      document.getElementById('nodeId').value = item.id;
      document.getElementById('inpProvider').value = item.provider;
      document.getElementById('inpEmail').value = item.email;
      
      selectStatusButton(item.status);
      
      const hours = item.resetHours;
      const pillOptions = [3, 6, 12, 24, 48, 72];
      
      if (pillOptions.includes(hours)) {
          selectResetHours(hours);
      } else {
          document.querySelectorAll('.pill-option').forEach(p => p.classList.remove('selected'));
          document.getElementById('inpResetCustom').value = hours;
          document.getElementById('inpReset').value = hours;
      }
      
      document.getElementById('btnDelete').style.display = 'block';
      document.getElementById('editActions').style.display = 'flex'; 
      document.getElementById('modalTitle').textContent = "Edit Node";
      document.getElementById('modalOverlay').classList.add('active');
    }

    document.getElementById('nodeForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const idVal = document.getElementById('nodeId').value;
      const isNew = !idVal;
      let existing = idVal ? items.find(i => i.id == idVal) : null;

      const payload = {
        id: isNew ? Date.now() : Number(idVal),
        provider: document.getElementById('inpProvider').value,
        email: document.getElementById('inpEmail').value,
        resetHours: parseFloat(document.getElementById('inpReset').value),
        status: document.getElementById('inpStatus').value,
        lastUsed: existing ? existing.lastUsed : Date.now(),
        pos: existing ? existing.pos : {x: 50 + Math.random()*200, y: 100 + Math.random()*200}
      };
      
      if(isNew) {
        items.push(payload);
      } else {
        const idx = items.findIndex(i => i.id == idVal);
        if (items[idx].status !== payload.status && payload.status === 'cooldown') {
            payload.lastUsed = Date.now();
        } else {
            payload.lastUsed = items[idx].lastUsed;
        }
        items[idx] = payload;
      }
      
      save();
      closeModal();
      config.view === 'grid' ? renderGrid() : renderScatter();
      updateFilterPillUI();
    });

    function deleteNode() {
      if(!confirm("Delete this node?")) return;
      const id = Number(document.getElementById('nodeId').value);
      items = items.filter(i => i.id !== id);
      save();
      closeModal();
      config.view === 'grid' ? renderGrid() : renderScatter();
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if(e.target === e.currentTarget) closeModal();
    });

    function updateProviderSelect() {
      const sel = document.getElementById('inpProvider');
      sel.innerHTML = providers.map(p => `<option value="${p}">${p}</option>`).join('');
    }

    function copyText(e, text) {
      if(e) e.stopPropagation();
      navigator.clipboard.writeText(text);
      showToast("Copied to Clipboard");
    }
    
    function copyInput(id) {
       const val = document.getElementById(id).value;
       copyText(null, val);
    }
    
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    function cycleStatusFilter() {
      const states = ['all', 'active', 'cooldown', 'burnt'];
      const currIdx = states.indexOf(config.filterStatus);
      config.filterStatus = states[(currIdx + 1) % states.length];
      save(); 
      
      updateFilterPillUI();
      config.view === 'grid' ? renderGrid() : renderScatter();
    }

    function updateFilterPillUI() {
       const lbl = document.getElementById('filterLabel');
       const dot = document.getElementById('filterDot');
       
       lbl.textContent = config.filterStatus.charAt(0).toUpperCase() + config.filterStatus.slice(1);
       if (config.filterStatus === 'all') lbl.textContent = 'All';
       
       dot.style.backgroundColor = 'var(--ink-dim)'; 
       if(config.filterStatus === 'active') dot.style.backgroundColor = 'var(--neon-green)';
       if(config.filterStatus === 'cooldown') dot.style.backgroundColor = 'var(--neon-orange)';
       if(config.filterStatus === 'burnt') dot.style.backgroundColor = 'var(--neon-red)';
    }

    function toggleTheme() {
      config.theme = config.theme === 'dark' ? 'light' : 'dark';
      applyTheme();
      localStorage.setItem('iv_theme', config.theme);
    }

    function applyTheme() {
      document.body.setAttribute('data-theme', config.theme);
    }

    // --- Info Modal & Accordion Logic ---
    function openInfoModal() {
        document.getElementById('infoOverlay').classList.add('active');
    }

    function closeInfoModal() {
        document.getElementById('infoOverlay').classList.remove('active');
    }

    function toggleAccordion(headerElement) {
        const item = headerElement.closest('.accordion-item');
        const content = item.querySelector('.accordion-content');
        const isOpen = item.classList.contains('open');

        document.querySelectorAll('.accordion-item.open').forEach(openItem => {
             if (openItem !== item) {
                 openItem.classList.remove('open');
                 openItem.querySelector('.accordion-content').style.maxHeight = 0;
             }
        });
        
        if (isOpen) {
            content.style.maxHeight = 0;
            item.classList.remove('open');
        } else {
            item.classList.add('open');
            content.style.maxHeight = content.scrollHeight + "px"; 
        }
    }
    
    window.addEventListener('resize', () => {
        document.querySelectorAll('.accordion-item.open').forEach(openItem => {
            const content = openItem.querySelector('.accordion-content');
            content.style.transition = 'none';
            content.style.maxHeight = content.scrollHeight + "px";
            setTimeout(() => {
                content.style.transition = 'max-height 0.3s ease-out';
            }, 10);
        });
    });

    // --- Scatter Physics (Pan/Zoom/Drag) ---
    
    function applyScatterTransform() {
      const canvas = document.getElementById('scatterCanvas');
      // Apply pan (translate) and zoom (scale)
      canvas.style.transform = `translate(${scatter.pan.x}px, ${scatter.pan.y}px) scale(${scatter.zoom})`;
    }

    function adjustZoom(delta, clientX, clientY) {
      const oldZoom = scatter.zoom;
      const newZoom = Math.max(0.5, Math.min(2.5, scatter.zoom + delta));
      
      if (clientX === undefined) {
         scatter.zoom = newZoom;
         applyScatterTransform();
         return;
      }

      const canvasRect = document.getElementById('scatterCanvas').getBoundingClientRect();
      const zoomPointX = (clientX - canvasRect.left - scatter.pan.x) / oldZoom;
      const zoomPointY = (clientY - canvasRect.top - scatter.pan.y) / oldZoom;

      scatter.pan.x -= zoomPointX * (newZoom - oldZoom);
      scatter.pan.y -= zoomPointY * (newZoom - oldZoom);
      
      scatter.zoom = newZoom;
      saveScatterState();
      applyScatterTransform();
    }
    
    // Mouse Wheel Zoom
    document.getElementById('scatterContainer').addEventListener('wheel', (e) => {
        if (config.view !== 'scatter') return;
        e.preventDefault();
        const delta = e.deltaY * -0.001; 
        adjustZoom(delta, e.clientX, e.clientY);
    });
    
    // Pan and Pinch-to-Zoom Logic
    document.getElementById('scatterCanvas').addEventListener('pointerdown', startScatterInteraction);
    
    function startScatterInteraction(e) {
      if (config.view !== 'scatter') return;
      
      // Card Dragging takes precedence
      if (e.target.closest('.scatter-card')) {
         return;
      }
      
      e.preventDefault(); 
      e.currentTarget.setPointerCapture(e.pointerId);
      
      const isTouch = e.pointerType === 'touch' || e.pointerType === 'pen';

      // Ensure the pointer is tracked
      const isNewPointer = !scatter.pointers.some(p => p.pointerId === e.pointerId);
      if (isNewPointer) {
          scatter.pointers.push(e);
      }
      
      if (scatter.pointers.length === 1) {
          // Single pointer/mouse: Start Panning
          scatter.panning = true;
          const startX = e.clientX;
          const startY = e.clientY;
          const startPanX = scatter.pan.x;
          const startPanY = scatter.pan.y;

          function movePan(eMove) {
              if (!scatter.panning || scatter.pointers.length > 1) return;
              eMove.preventDefault();
              const dx = eMove.clientX - startX;
              const dy = eMove.clientY - startY;

              scatter.pan.x = startPanX + dx;
              scatter.pan.y = startPanY + dy;
              
              applyScatterTransform();
          }

          function endPan() {
              document.removeEventListener('pointermove', movePan);
              document.removeEventListener('pointerup', endPan);
              document.removeEventListener('pointercancel', endPan);
              scatter.panning = false;
              // Remove pointer from array
              scatter.pointers = scatter.pointers.filter(p => p.pointerId !== e.pointerId);
              saveScatterState();
          }

          document.addEventListener('pointermove', movePan);
          document.addEventListener('pointerup', endPan);
          document.addEventListener('pointercancel', endPan);

      } else if (scatter.pointers.length === 2 && isTouch) {
          // Two pointers (Touch): Start Pinch-to-Zoom
          // Use current pointer positions for pinch start state
          scatter.pinchStart = getPinchInfo(scatter.pointers);
          scatter.panning = false; 
          
          function movePinch(eMove) {
              // Update pointer list
              const idx = scatter.pointers.findIndex(p => p.pointerId === eMove.pointerId);
              if (idx > -1) scatter.pointers[idx] = eMove;

              if (scatter.pointers.length !== 2) return;
              eMove.preventDefault(); 
              
              const pinchCurrent = getPinchInfo(scatter.pointers);
              
              // 1. Zoom (Scale)
              const scaleChange = pinchCurrent.distance / scatter.pinchStart.distance;
              const newZoom = scatter.pinchStart.zoom * scaleChange;
              
              const oldZoom = scatter.zoom;
              const finalZoom = Math.max(0.5, Math.min(2.5, newZoom));
              
              // 2. Pan (To keep center fixed)
              // Center point on canvas before zoom/pan
              const zoomPointX = (scatter.pinchStart.centerX - scatter.pan.x) / oldZoom;
              const zoomPointY = (scatter.pinchStart.centerY - scatter.pan.y) / oldZoom;
              
              // Pan to keep center fixed
              scatter.pan.x = pinchCurrent.centerX - (zoomPointX * finalZoom);
              scatter.pan.y = pinchCurrent.centerY - (zoomPointY * finalZoom);

              scatter.zoom = finalZoom;
              applyScatterTransform();
          }

          function endPinch(eUp) {
              // Remove the pointer that went up
              scatter.pointers = scatter.pointers.filter(p => p.pointerId !== eUp.pointerId);
              
              if (scatter.pointers.length < 2) {
                  document.removeEventListener('pointermove', movePinch);
                  document.removeEventListener('pointerup', endPinch);
                  document.removeEventListener('pointercancel', endPinch);
                  scatter.pinchStart = null;
                  saveScatterState();
              }
          }

          document.addEventListener('pointermove', movePinch);
          document.addEventListener('pointerup', endPinch);
          document.addEventListener('pointercancel', endPinch);
      }
    }
    
    function getPinchInfo(pointers) {
        // Find the actual active pointers from the event objects
        const p1 = pointers[0];
        const p2 = pointers[1];
        
        const canvasRect = document.getElementById('scatterCanvas').getBoundingClientRect();

        const distance = Math.sqrt(Math.pow(p2.clientX - p1.clientX, 2) + Math.pow(p2.clientY - p1.clientY, 2));
        const centerX = (p1.clientX + p2.clientX) / 2;
        const centerY = (p1.clientY + p2.clientY) / 2;
        
        return {
            distance: distance,
            centerX: centerX - canvasRect.left, // Relative to canvas top-left
            centerY: centerY - canvasRect.top,
            zoom: scatter.zoom
        };
    }
    
    function saveScatterState() {
        // In a real app, you might persist scatter.pan and scatter.zoom here
    }


    function startDrag(e, id) {
      if(e.button === 2) return; 
      e.stopPropagation(); 
      
      const card = document.getElementById(`scatter-${id}`);
      if(!card) return;
      
      // Prevent card drag if multi-touch is active for pan/zoom
      if(scatter.pointers.length > 0) return;
      
      scatter.dragging = true;
      e.currentTarget.setPointerCapture(e.pointerId);

      const startX = e.clientX;
      const startY = e.clientY;
      const item = items.find(i => i.id === id);
      const startItemX = item.pos.x;
      const startItemY = item.pos.y;
      
      card.style.zIndex = 100;

      function move(eMove) {
        // Only move if the same pointer is moving
        if (eMove.pointerId !== e.pointerId) return;
        const dx = (eMove.clientX - startX) / scatter.zoom;
        const dy = (eMove.clientY - startY) / scatter.zoom;
        
        const newX = startItemX + dx;
        const newY = startItemY + dy;
        
        card.style.transform = `translate(${newX}px, ${newY}px)`;
        item.pos = {x: newX, y: newY};
      }

      function end(eEnd) {
        if (eEnd.pointerId !== e.pointerId) return;
        
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', end);
        document.removeEventListener('pointercancel', end);
        card.style.zIndex = '';
        // Use a timeout to prevent card click handler from firing immediately
        setTimeout(() => scatter.dragging = false, 100); 
        save();
      }

      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', end);
      document.addEventListener('pointercancel', end);
    }
  </script>
</body>
</html>
