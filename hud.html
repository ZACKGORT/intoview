<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5.0,user-scalable=yes" />
  <title>intoview:NODE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #0f1014;
      --ink: #ffffff;
      --ink-2: #a1a1aa;
      --ink-3: #52525b;
      --accent: #FFED29;
      --corner-pad: clamp(16px, 3vw, 32px);
      --fab-size: 64px;
      --info-fab-size: 40px;
      --glass-bg: rgba(20, 20, 25, 0.7);
      --glass-bg-hover: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.12);
      --glass-blur: 20px;
      --shadow-soft: 0 8px 32px -8px rgba(0,0,0,0.4);
      --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
      --z-ui: 220;
      --z-overlay: 250;
      --z-menu: 300;
      --neon-green: #39FF14;
      --neon-red: #FF1447;
      --neon-orange: #FF8D14;
      --btn-height: 40px;
      --mobile-nav-height: 60px;
    }

    [data-theme="light"] {
      --bg-color: #f4f4f5;
      --ink: #18181b;
      --ink-2: #52525b;
      --ink-3: #a1a1aa;
      --accent: #FF296D;
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-bg-hover: rgba(0, 0, 0, 0.06);
      --glass-border: rgba(0, 0, 0, 0.1);
      --shadow-soft: 0 4px 24px -4px rgba(0,0,0,0.12);
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{height:100%; font-family:'Inter',sans-serif; font-size:14px; background:var(--bg-color); color:var(--ink); transition: background 0.3s var(--ease-out), color 0.3s var(--ease-out);}
    body{overflow:hidden}

    /* --- Desktop Layout Defaults --- */
    .logo { position: fixed; top: calc(var(--corner-pad) + 4px); left: var(--corner-pad); z-index: var(--z-ui); pointer-events: none; }
    .logo img { height: 28px; width: auto; display: block; transition: opacity 0.2s ease; }

    .top-nav,.right-nav,.left-nav{position:fixed;z-index:calc(var(--z-ui) + 2);background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);border-radius:12px;display:flex;gap:6px;padding:6px;box-shadow:var(--shadow-soft);transition:all 0.3s var(--ease-out);}
    .top-nav{top:var(--corner-pad);left:50%;transform:translateX(-50%); max-width: 80vw; overflow-x: auto;}
    .left-nav{left:var(--corner-pad);top:50%;transform:translateY(-50%);flex-direction:column}
    .right-nav{right:var(--corner-pad);top:50%;transform:translateY(-50%);flex-direction:column}
    
    .nav-btn{
      padding:0 16px;
      background:transparent;
      border:0;
      color:var(--ink-2);
      cursor:pointer;
      border-radius:8px;
      font-weight:600;
      white-space:nowrap;
      font-size:13px;
      transition:all 0.2s var(--ease-out);
      height: var(--btn-height);
      line-height: var(--btn-height);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .nav-btn:hover{background:var(--glass-bg-hover);color:var(--ink);}
    .nav-btn.active{background:var(--accent);color:#000;font-weight:700;}

    /* --- Theme & Info --- */
    .theme-toggle{position:fixed;top:var(--corner-pad);right:var(--corner-pad);z-index:calc(var(--z-ui) + 10);background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);border-radius:12px;padding:6px;display:flex;gap:4px;box-shadow:var(--shadow-soft);transition:all 0.3s var(--ease-out);}
    .theme-btn{width:40px;height:40px;border-radius:8px;background:transparent;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:all 0.2s var(--ease-out);color:var(--ink-2);}
    .theme-btn:hover{background:var(--glass-bg-hover);transform:scale(1.05);color:var(--ink);}
    .theme-btn.active{background:var(--accent);color:#000;}

    .info-fab {
      position: fixed;
      top: var(--corner-pad);
      right: calc(var(--corner-pad) + 108px);
      width: var(--info-fab-size);
      height: var(--info-fab-size);
      border-radius: 50%;
      background: var(--neon-green);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: #000;
      box-shadow: 0 4px 16px rgba(57, 255, 20, 0.3);
      transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: calc(var(--z-ui) + 5);
      pointer-events: auto;
    }
    .info-fab:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 6px 24px rgba(57, 255, 20, 0.5); }
    .info-fab.active { transform: rotate(45deg); }

    /* --- FAB --- */
    .fab-wrap{position:fixed;bottom:var(--corner-pad);right:var(--corner-pad);z-index:calc(var(--z-ui) + 5);display:flex;align-items:center;gap:14px;pointer-events:none;}
    .fab{pointer-events:auto;width:var(--fab-size);height:var(--fab-size);border-radius:50%;background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow-soft);transition:all 0.25s var(--ease-out);}
    .fab:hover{transform:scale(1.1);background:var(--glass-bg-hover);border-color:var(--accent);}
    .fab:active{transform:scale(1.05);}
    .fab svg{width:calc(var(--fab-size) * 0.35);height:calc(var(--fab-size) * 0.35);fill:var(--accent);transition:fill 0.3s var(--ease-out);}
    .fab-label{pointer-events:none;font-weight:600;color:var(--ink-2);font-size:13px;opacity:0;transform:translateX(8px);transition:opacity .2s,transform .2s;white-space:nowrap;}
    @media (min-width:900px){ .fab-label{opacity:1;transform:translateX(0);} }

    /* --- Magnet Toggle (Mobile Only) --- */
    .mobile-magnet-toggle {
      position: fixed;
      bottom: 100px; /* Above nav bar */
      left: 20px;
      width: 44px; height: 44px;
      border-radius: 50%;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      color: var(--ink-2);
      display: none; /* Hidden on desktop */
      align-items: center; justify-content: center;
      font-size: 20px;
      z-index: var(--z-ui);
      box-shadow: var(--shadow-soft);
      transition: all 0.2s;
    }
    .mobile-magnet-toggle.active { background: var(--accent); color: #000; border-color: var(--accent); transform: scale(1.1); }
    .mobile-magnet-toggle.visible { display: flex; }

    /* --- Content --- */
    .grid-container{position:absolute;inset:80px 20px 20px 20px;overflow-y:auto;overflow-x:hidden;opacity:0;pointer-events:none;transition:opacity 0.3s var(--ease-out);}
    .grid-container.active{opacity:1;pointer-events:auto;}
    .grid-wrapper{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;padding:20px;max-width:1600px;margin:0 auto; padding-bottom: 100px;}

    .card{background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:14px;padding:22px;cursor:pointer;transition:all 0.25s var(--ease-out);min-height:180px;display:flex;flex-direction:column;box-shadow:var(--shadow-soft);backdrop-filter:blur(var(--glass-blur));position:relative; overflow:hidden;}
    .card:active { transform: scale(0.98); }
    .card:hover{transform:translateY(-2px);box-shadow:0 16px 48px -8px rgba(0,0,0,0.3);border-color:var(--accent);}
    
    .card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:16px}
    .card-provider{font-size:19px;font-weight:700;color:var(--accent);letter-spacing:-0.2px;}
    .card-status{padding:6px 12px;border-radius:6px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;border:1px solid var(--glass-border);background:var(--glass-bg);}
    .card-info{flex:1;display:flex;flex-direction:column;gap:8px}
    .card-footer{margin-top:auto;padding-top:16px;border-top:1px solid var(--glass-border)}
    .card-label{font-size:12px;color:var(--ink-2);display:flex;align-items:center;gap:8px;line-height:1.5;}
    .card-label strong{color:var(--ink);font-weight:600}

    .copy-feedback { position: absolute; inset: 0; background: var(--accent); color: #000; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 18px; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 10; }
    .copy-feedback.show { opacity: 0.95; }

    .status-active .card-status{background:rgba(34,197,94,0.12);color:#22c55e;border-color:rgba(34,197,94,0.3);}
    .status-cooldown .card-status{background:rgba(251,146,60,0.12);color:#fb923c;border-color:rgba(251,146,60,0.3);}
    .status-burnt .card-status{background:rgba(239,68,68,0.12);color:#ef4444;border-color:rgba(239,68,68,0.3);}

    .scatter-container{position:absolute;inset:0;opacity:0;pointer-events:none;transition:opacity .3s;overflow:hidden}
    .scatter-container.active{opacity:1;pointer-events:auto}
    .scatter-canvas{width:100%;height:100%;position:relative;transform-origin:0 0; cursor: grab;}
    .scatter-canvas.panning { cursor: grabbing; }
    .scatter-card{position:absolute;background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);border-radius:14px;padding:18px;cursor:grab;transition:box-shadow .2s,border-color .2s;width:240px;user-select:none;touch-action:none;box-shadow:var(--shadow-soft);}
    .scatter-card:active{cursor:grabbing}
    .scatter-card.dragging{box-shadow:0 16px 48px rgba(0,0,0,.5);border-color:var(--accent);z-index:2000}
    .scatter-card.magnetic{transition:transform .15s cubic-bezier(.2,.9,.3,1);}
    .scatter-card.sorting { transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .scatter-card.filtered-out { opacity: 0.3; pointer-events: none; }
    .reset-badge { font-family: 'JetBrains Mono'; font-size: 0.65rem; padding: 4px 8px; background: rgba(255,255,255,0.08); border-radius: 5px; opacity: 0.75; }

    /* --- Modals & Overlays --- */
    .modal-overlay, .info-fab-overlay, .details-overlay, .provider-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.88); backdrop-filter: blur(10px); z-index: var(--z-overlay); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal-overlay.active, .info-fab-overlay.active, .details-overlay.active, .provider-overlay.active { opacity: 1; pointer-events: auto; }
    
    .modal, .info-fab-panel, .details-panel {
      background: var(--bg-color); border: 1px solid var(--glass-border); border-radius: 16px; padding: 32px; max-width: 480px; width: 92%; max-height: 90vh; overflow-y: auto; transform: scale(.96); transition: transform .25s; box-shadow: 0 20px 60px -12px rgba(0,0,0,0.6); position: relative;
    }
    .modal-overlay.active .modal, .info-fab-overlay.active .info-fab-panel, .details-overlay.active .details-panel { transform: scale(1); }
    
    .modal h2, .info-fab-panel h2 { color: var(--accent); margin-bottom: 24px; font-family:'JetBrains Mono',monospace; font-size: 20px; }
    .form-group{margin-bottom:20px}
    label{display:block;margin-bottom:10px;font-size:13px;color:var(--ink-2);font-weight:600;}
    input,select{width:100%;padding:14px 16px;background:var(--glass-bg);border:1px solid var(--glass-border);color:var(--ink);border-radius:10px;font-size:14px;}
    input:focus,select:focus{outline:none;border-color:var(--accent);background:var(--glass-bg-hover);}
    .btn-submit{width:100%;padding:16px;background:var(--accent);color:#000;border:none;border-radius:10px;cursor:pointer;font-weight:700;text-transform:uppercase;}
    .close-modal, .btn-secondary { cursor: pointer; }
    .btn-secondary { width: 100%; padding: 14px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--ink); border-radius: 10px; font-weight: 600; margin-top: 10px; }
    .close-modal { position: absolute; top: 20px; right: 20px; background: transparent; border: 0; color: var(--ink-2); font-size: 28px; }

    /* --- Context Menu & Toast --- */
    .context-menu { position: fixed; background: var(--bg-color); border: 1px solid var(--glass-border); border-radius: 10px; padding: 6px; min-width: 180px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); z-index: var(--z-menu); opacity: 0; pointer-events: none; transform: scale(0.95); transition: opacity 0.15s, transform 0.15s; display: flex; flex-direction: column; gap: 2px; }
    .context-menu.active { opacity: 1; pointer-events: auto; transform: scale(1); }
    .ctx-item { padding: 10px 14px; border-radius: 7px; cursor: pointer; color: var(--ink); font-size: 13px; font-weight: 500; display: flex; justify-content: space-between; align-items: center; position: relative; }
    .ctx-item:hover { background: var(--glass-bg-hover); color: var(--accent); }
    .ctx-submenu { position: absolute; left: 100%; top: -4px; background: var(--bg-color); border: 1px solid var(--glass-border); border-radius: 10px; padding: 6px; min-width: 160px; opacity: 0; pointer-events: none; transition: all 0.2s; }
    .ctx-item:hover .ctx-submenu { opacity: 1; pointer-events: auto; transform: translateX(0); }

    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--accent); color: #000; font-weight: 700; padding: 12px 28px; border-radius: 24px; opacity: 0; transition: all 0.3s; z-index: var(--z-overlay); pointer-events: none; box-shadow: 0 8px 24px rgba(0,0,0,0.25); font-size: 13px; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    
    .magnet-indicator{position:fixed;width:120px;height:120px;border:3px solid var(--accent);border-radius:50%;pointer-events:none;z-index:calc(var(--z-ui) + 5);opacity:0;display:flex;align-items:center;justify-content:center;transition:opacity 0.15s;box-shadow:0 0 32px var(--accent);}
    .magnet-indicator.active{opacity:.75;animation:magnetPulse 1.5s ease-in-out infinite;}
    @keyframes magnetPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    .magnet-indicator::before{content:'üß≤';font-size:44px}
    
    .keyboard-indicator{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:2px solid var(--accent);padding:32px 48px;border-radius:16px;z-index:var(--z-overlay);pointer-events:none;transition:transform .2s,opacity .2s;opacity:0;box-shadow:var(--shadow-soft);}
    .keyboard-indicator.show{transform:translate(-50%,-50%) scale(1);opacity:1}
    .keyboard-indicator .key{font-family:'JetBrains Mono',monospace;font-size:52px;font-weight:700;color:var(--accent);text-align:center;margin-bottom:12px}

    /* --- MOBILE OPTIMIZATION --- */
    @media (max-width: 768px) {
      .logo { display: none; }
      .top-nav { display: none; }
      
      /* Mobile Header */
      .header-bar {
        position: fixed; top: 0; left: 0; right: 0; height: 60px;
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 16px; z-index: var(--z-ui);
        background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        pointer-events: none; /* Let clicks pass through empty space */
      }
      .header-bar > * { pointer-events: auto; }
      
      #providerBtn {
        display: flex; align-items: center; gap: 8px;
        background: var(--glass-bg); backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border); border-radius: 20px;
        padding: 8px 16px; color: var(--ink); font-weight: 600; font-size: 13px;
        cursor: pointer; box-shadow: var(--shadow-soft);
      }
      #providerBtn::after { content: '‚ñæ'; opacity: 0.5; margin-left: 4px; }


            /* Nav Buttons Mobile Styling */
      .nav-btn { font-size: 0; width: 44px; height: 44px; border-radius: 12px; }
      .nav-btn::before { font-size: 20px; }
      
      /* Icons for Left Nav */
      .left-nav .nav-btn[data-view="grid"]::before { content: "‚ñ£"; }
      .left-nav .nav-btn[data-view="scatter"]::before { content: "‚òä"; } /* Node icon approx */
      
      /* Icons for Right Nav */
      .right-nav .nav-btn[data-status="all"]::before { content: "‚àû"; }
      .right-nav .nav-btn[data-status="active"]::before { content: "‚óè"; color: var(--neon-green); }
      .right-nav .nav-btn[data-status="cooldown"]::before { content: "‚óè"; color: var(--neon-orange); }
      .right-nav .nav-btn[data-status="burnt"]::before { content: "‚óè"; color: var(--neon-red); }
        
  </style>
</head>
<body data-theme="dark">
  <div class="header-bar">
    <div class="header-bar">
      <div id="providerBtn">All Providers</div>
      <div style="display:flex;align-items:center;">
        <div class="theme-toggle">
          <button class="theme-btn active" data-theme="dark">üåô</button>
          <button class="theme-btn" data-theme="light">‚òÄÔ∏è</button>
        </div>
        <button class="info-fab" id="infoFabBtn">?</button>
      </div>
    </div>
  </div>

  <div class="logo">
    <img id="logoImg" src="https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-light.svg" alt="IntoView Logo">
  </div>

  <div id="keyboardIndicator" class="keyboard-indicator" aria-hidden="true">
    <div class="key" id="indicatorKey">N</div>
    <div class="label" id="indicatorLabel">New Item</div>
  </div>

  <div id="toast" class="toast">Action Complete</div>

  <div class="top-nav" id="topNav" role="toolbar" aria-label="Provider filter"></div>

  <div class="provider-overlay" id="providerOverlay">
    <!-- Providers will be added here -->
  </div>

  <div class="left-nav" role="tablist" aria-label="View switch">
    <button class="nav-btn active" data-view="grid">Grid</button>
    <button class="nav-btn" data-view="scatter">Scatter</button>
  </div>

  <div class="right-nav" role="toolbar" aria-label="Status filter">
    <button class="nav-btn active" data-status="all">All</button>
    <button class="nav-btn" data-status="active">Active</button>
    <button class="nav-btn" data-status="cooldown">Cooldown</button>
    <button class="nav-btn" data-status="burnt">Burnt</button>
  </div>

  <div class="fab-wrap">
    <button class="fab" id="fabBtn" title="New Item (N)" aria-label="Create new item">
      <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"></path></svg>
    </button>
    <div class="fab-label">Add Contact</div>
  </div>

  <div class="magnetic-label">shift key = magnetic mode</div>

  <div class="info-fab-overlay" id="infoFabOverlay">
    <div class="info-fab-panel">
      <h2>Information</h2>
      <p>This is a management tool for LLM accounts. Use the FAB to add new nodes, right-click for context menus, and switch views as needed.</p>
      <button class="btn-secondary" id="infoCloseBtn">Close</button>
    </div>
  </div>

  <div class="container">
    <div class="grid-container active" id="gridContainer">
      <div class="grid-wrapper" id="gridWrapper"></div>
    </div>

    <div class="scatter-container" id="scatterContainer">
      <div class="scatter-canvas" id="scatterCanvas"></div>
    </div>
  </div>

  <div class="magnet-indicator" id="magnetIndicator"></div>

  <div id="contextMenu" class="context-menu"></div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <button class="close-modal" id="closeModal">√ó</button>
      <h2 id="modalTitle">Add New Contact</h2>
      <form id="addForm">
        <input type="hidden" id="formId">
        <div class="form-group">
          <label for="formProvider">Provider / Group</label>
          <select id="formProvider" required></select>
        </div>
        <div class="form-group">
          <label for="formEmail">Email / Username</label>
          <input id="formEmail" type="email" required>
        </div>
        <div class="form-group">
          <label for="formPassword">Password (Notes)</label>
          <input id="formPassword" type="text" required>
        </div>
        <div class="form-group">
          <label for="formResetHours">Reset Hours</label>
          <input id="formResetHours" type="number" value="3" min="0.5" step="0.5" required>
        </div>
        <div class="form-group">
          <label for="formStatus">Status</label>
          <select id="formStatus" required>
            <option value="active">Active</option>
            <option value="cooldown">Cooldown</option>
            <option value="burnt">Burnt/Expired</option>
          </select>
        </div>
        <button type="submit" class="btn-submit" id="submitBtn">Save Contact</button>
      </form>
    </div>
  </div>

  <div class="details-overlay" id="detailsOverlay">
    <div class="details-panel">
      <button class="close-modal" id="closeDetails">√ó</button>
      <h3 id="detailsTitle">Contact Details</h3>
      <div class="detail-item"><strong>Provider:</strong> <span id="detailProvider"></span></div>
      <div class="detail-item"><strong>Email:</strong> <span id="detailEmail"></span></div>
      <div class="detail-item"><strong>Password:</strong> <span id="detailPassword"></span></div>
      <div class="detail-item"><strong>Reset Hours:</strong> <span id="detailReset"></span></div>
      <div class="detail-item"><strong>Status:</strong> <span id="detailStatus"></span></div>
    </div>
  </div>

  <div class="keyboard-hints">Hold Space to drag cards</div>

  <script>
let providers = JSON.parse(localStorage.getItem('nodeProviders')) || ['ChatGPT', 'Claude', 'Gemini', 'Grok', 'Copilot'];
let items = JSON.parse(localStorage.getItem('nodeItems')) || [];
let currentView = localStorage.getItem('preferred-view') || 'grid';
let currentProviderFilter = localStorage.getItem('currentProviderFilter') || 'all';
let currentStatusFilter = localStorage.getItem('currentStatusFilter') || 'all';
let currentTheme = localStorage.getItem('preferred-theme') || 'dark';
let scatterZoom = 1;
let panX = Number(localStorage.getItem('panX')) || 0;
let panY = Number(localStorage.getItem('panY')) || 0;
let isDragging = false;
let isPanning = false;
let draggedCard = null;
let dragOffset = { x: 0, y: 0 };
let panOffset = { x: 0, y: 0 };
let isMagnetic = false;
let magnetPos = { x: 0, y: 0 };
let magneticAnimationFrame = null;
let contextTargetId = null;
let isSpaceDown = false;
let pinchDistance = 0;

if (items.length === 0) {
  items = generateMockData();
  saveData();
}

function generateMockData() {
  const statuses = ['active', 'cooldown', 'burnt'];
  const centerX = window.innerWidth / 2;
  const centerY = window.innerHeight / 2;
  return Array.from({ length: 15 }, (_, i) => ({
    id: Date.now() + i,
    provider: providers[i % providers.length],
    email: `user${i + 1}@example.com`,
    password: `password${i + 1}`,
    resetHours: 3 + (i % 4),
    status: statuses[i % statuses.length],
    position: {
      x: centerX - 400 + Math.random() * 800,
      y: centerY - 300 + Math.random() * 600
    }
  }));
}

function saveData() {
  localStorage.setItem('nodeItems', JSON.stringify(items));
  localStorage.setItem('nodeProviders', JSON.stringify(providers));
}

function saveViewState() {
  localStorage.setItem('panX', panX);
  localStorage.setItem('panY', panY);
}

function fitToView() {
  if (currentView !== 'scatter' || items.length === 0) return;
  
  // Calculate bounding box of all visible cards
  let minX = Infinity, maxX = -Infinity;
  let minY = Infinity, maxY = -Infinity;
  
  items.forEach(item => {
    const pos = item.position || { x: 0, y: 0 };
    minX = Math.min(minX, pos.x);
    maxX = Math.max(maxX, pos.x + 240);
    minY = Math.min(minY, pos.y);
    maxY = Math.max(maxY, pos.y + 160);
  });
  
  if (!isFinite(minX) || !isFinite(maxX)) return;
  
  const padding = 100;
  minX -= padding;
  minY -= padding;
  maxX += padding;
  maxY += padding;
  
  const contentWidth = maxX - minX;
  const contentHeight = maxY - minY;
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  const zoomX = viewportWidth / contentWidth;
  const zoomY = viewportHeight / contentHeight;
  scatterZoom = Math.min(Math.max(Math.min(zoomX, zoomY), 0.3), 1.5);
  
  const contentCenterX = (minX + maxX) / 2;
  const contentCenterY = (minY + maxY) / 2;
  
  panX = (viewportWidth / 2) - (contentCenterX * scatterZoom);
  panY = (viewportHeight / 2) - (contentCenterY * scatterZoom);
  
  updateCanvasTransform();
  saveViewState();
}

function renderTopNav() {
  const nav = document.getElementById('topNav');
  let html = `<button class="nav-btn ${currentProviderFilter === 'all' ? 'active' : ''}" onclick="setProviderFilter('all')">All</button>`;
  providers.forEach(p => {
    const isActive = currentProviderFilter === p ? 'active' : '';
    html += `<button class="nav-btn ${isActive}" onclick="setProviderFilter('${escapeHtml(p)}')" oncontextmenu="handleProviderContext(event, '${escapeHtml(p)}')">${escapeHtml(p)}</button>`;
  });
  html += `<button class="nav-btn" onclick="handleAddProvider()">+ Add Provider</button>`;
  nav.innerHTML = html;
  updateModalProviders();
  renderProviderOverlay();
}

function renderProviderOverlay() {
  const overlay = document.getElementById('providerOverlay');
  let html = `<button onclick="setProviderFilter('all'); closeProviderOverlay()">All</button>`;
  providers.forEach(p => {
    html += `<button onclick="setProviderFilter('${escapeHtml(p)}'); closeProviderOverlay()">${escapeHtml(p)}</button>`;
  });
  html += `<button onclick="handleAddProvider(); closeProviderOverlay()">+ Add Provider</button>`;
  overlay.innerHTML = html;
}

function openProviderOverlay() {
  document.getElementById('providerOverlay').classList.add('active');
}

function closeProviderOverlay() {
  document.getElementById('providerOverlay').classList.remove('active');
}

function updateModalProviders() {
  const select = document.getElementById('formProvider');
  select.innerHTML = providers.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
}

function setProviderFilter(p) {
  currentProviderFilter = p;
  localStorage.setItem('currentProviderFilter', p);
  renderTopNav();
  renderView();
  if (window.innerWidth <= 768) {
    document.getElementById('providerBtn').textContent = p;
  }
}

function setStatusFilter(s) {
  currentStatusFilter = s;
  localStorage.setItem('currentStatusFilter', s);
  document.querySelectorAll('.right-nav .nav-btn').forEach(b => b.classList.toggle('active', b.dataset.status === s));
  renderView();
}

function setTheme(theme) {
  currentTheme = theme;
  document.body.setAttribute('data-theme', theme);
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.theme === theme);
  });
  localStorage.setItem('preferred-theme', theme);
}
setTheme(currentTheme);

document.querySelectorAll('.theme-btn').forEach(btn => {
  btn.addEventListener('click', () => setTheme(currentTheme === 'dark' ? 'light' : 'dark'));
});

function showKeyboardIndicator(key, label) {
  const indicator = document.getElementById('keyboardIndicator');
  document.getElementById('indicatorKey').textContent = key;
  document.getElementById('indicatorLabel').textContent = label;
  indicator.classList.add('show');
  setTimeout(() => indicator.classList.remove('show'), 800);
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function isSelected(item) {
  const p = currentProviderFilter === 'all' || item.provider === currentProviderFilter;
  const s = currentStatusFilter === 'all' || item.status === currentStatusFilter;
  return p && s;
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, m => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[m]));
}

function renderGrid() {
  const wrapper = document.getElementById('gridWrapper');
  let displayed = items.filter(isSelected);
  displayed.sort((a, b) => a.provider.localeCompare(b.provider) || a.email.localeCompare(b.email));

  wrapper.innerHTML = displayed.map(item => `
    <div class="card status-${item.status}" data-id="${item.id}" oncontextmenu="handleCardContext(event, ${item.id})">
      <div class="copy-feedback">@ Copied!</div>
      <div class="card-header">
        <div class="card-provider">${escapeHtml(item.provider)}</div>
        <div class="card-status">${escapeHtml(item.status)}</div>
      </div>
      <div class="card-info">
        <div style="color:var(--ink-2);font-size:14px;margin-bottom:10px">Reset: ${item.resetHours}h</div>
      </div>
      <div class="card-footer">
        <div class="card-label"><strong>Provider:</strong> ${escapeHtml(item.provider)}</div>
        <div class="card-label"><strong>Email:</strong> ${escapeHtml(item.email)}</div>
      </div>
    </div>
  `).join('');

  wrapper.querySelectorAll('.card').forEach(card => {
    card.addEventListener('click', (e) => {
      const id = card.dataset.id;
      const item = items.find(i => i.id == id);
      if (item) {
        navigator.clipboard.writeText(item.email).then(() => {
          const feedback = card.querySelector('.copy-feedback');
          feedback.classList.add('show');
          setTimeout(() => feedback.classList.remove('show'), 800);
          showToast("Email Copied");
        });
      }
    });
  });
}

function renderScatter() {
  const canvas = document.getElementById('scatterCanvas');
  const existing = Array.from(canvas.querySelectorAll('.scatter-card'));
  const posMap = new Map();
  
  existing.forEach(card => {
    const id = Number(card.dataset.id);
    const match = card.style.transform.match(/translate3d\(([^p]+)px,\s*([^p]+)px/);
    if (match) posMap.set(id, { x: parseFloat(match[1]), y: parseFloat(match[2]) });
  });

  canvas.innerHTML = items.map(item => {
    const pos = posMap.get(item.id) || item.position || {x: 200, y: 200};
    const selectedClass = isSelected(item) ? '' : 'filtered-out';
    return `
      <div class="scatter-card status-${item.status} ${selectedClass}" 
           data-id="${item.id}" 
           style="transform:translate3d(${pos.x}px,${pos.y}px,0)"
           oncontextmenu="handleCardContext(event, ${item.id})">
        <div class="card-header">
          <div class="card-provider">${escapeHtml(item.provider)}</div>
          <div class="card-status">${escapeHtml(item.status)}</div>
        </div>
        <div class="card-footer" style="border:none;padding-top:10px">
          <div class="card-label"><strong>${escapeHtml(item.provider)}</strong></div>
          <div class="card-label" style="font-size:11px">${escapeHtml(item.email)}</div>
        </div>
        <div class="reset-badge">${item.resetHours}h reset</div>
      </div>
    `;
  }).join('');

  attachScatterHandlers();
  fitToView();
  updateCanvasTransform();
}

function attachScatterHandlers() {
  document.querySelectorAll('.scatter-card').forEach(card => {
    card.addEventListener('pointerdown', (e) => {
      if (isSpaceDown) {
        startCardDrag(e);
      }
    });
    card.addEventListener('touchstart', (e) => {
      if (isSpaceDown) {
        startCardDrag(e);
      }
    }, { passive: false });
  });
  const canvas = document.getElementById('scatterCanvas');
  canvas.addEventListener('pointerdown', (e) => {
    startPan(e);
  });
  canvas.addEventListener('touchstart', (e) => {
    if (isSpaceDown) {
      handleTouchStart(e);
    }
  }, { passive: false });
}

function handleTouchStart(e) {
  if (e.touches.length === 2) {
    e.preventDefault();
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    pinchDistance = Math.sqrt(dx * dx + dy * dy);
  } else if (e.target === document.getElementById('scatterCanvas')) {
    startPan(e);
  }
}

function startCardDrag(e) {
  e.preventDefault();
  if (e.button === 2) return;
  
  draggedCard = e.currentTarget;
  isDragging = true;
  draggedCard.classList.add('dragging');
  const rect = draggedCard.getBoundingClientRect();
  const clientX = e.clientX || e.touches[0].clientX;
  const clientY = e.clientY || e.touches[0].clientY;
  dragOffset.x = clientX - rect.left;
  dragOffset.y = clientY - rect.top;
  e.stopPropagation();
}

function startPan(e) {
  e.preventDefault();
  if (e.button === 2 || isDragging) return;
  if (e.target.closest('.scatter-card')) return;
  
  isPanning = true;
  const canvas = document.getElementById('scatterCanvas');
  canvas.classList.add('panning');
  const clientX = e.clientX || e.touches[0].clientX;
  const clientY = e.clientY || e.touches[0].clientY;
  panOffset.x = clientX - panX;
  panOffset.y = clientY - panY;
  e.stopPropagation();
}

const contextMenu = document.getElementById('contextMenu');

document.addEventListener('click', (e) => {
  if (!contextMenu.contains(e.target)) hideContextMenu();
});

function handleCardContext(e, id) {
  e.preventDefault();
  e.stopPropagation();
  contextTargetId = id;
  showContextMenu(e.clientX, e.clientY, 'card');
}

function handleProviderContext(e, providerName) {
  e.preventDefault();
  e.stopPropagation();
  contextTargetId = providerName;
  showContextMenu(e.clientX, e.clientY, 'provider');
}

function handleNavContext(e) {
  e.preventDefault();
  e.stopPropagation();
  contextTargetId = null;
  showContextMenu(e.clientX, e.clientY, 'nav');
}

function handleBackgroundContext(e) {
  if(e.target !== e.currentTarget) return;
  e.preventDefault();
  contextTargetId = null;
  showContextMenu(e.clientX, e.clientY, 'background');
}

function showContextMenu(x, y, type) {
  const isGrid = currentView === 'grid';
  let html = '';

  if (type === 'card') {
    if (!isGrid) {
      html += `
        <div class="ctx-item" onclick="triggerCopyEmail()">Copy Email</div>
        <div class="ctx-item" onclick="triggerViewDetails()">View Details</div>
        <div class="ctx-item">
          <span>Sort by...</span>
          <span>‚ñ∏</span>
          <div class="ctx-submenu">
            <div class="ctx-item" onclick="handleSort('provider')">Name (Provider)</div>
            <div class="ctx-item" onclick="handleSort('status')">Status</div>
            <div class="ctx-item" onclick="handleSort('reset')">Group by Category</div>
          </div>
        </div>
        <div class="ctx-divider"></div>
      `;
    }
    html += `
      <div class="ctx-item" onclick="triggerEdit()">Edit Contact</div>
      <div class="ctx-item" onclick="triggerDelete()" style="color:#ef4444">Delete Contact</div>
    `;
  } else if (type === 'provider') {
    html += `<div class="ctx-item" onclick="triggerEditProvider()">Edit Provider</div>`;
    html += `<div class="ctx-item" onclick="triggerDeleteProvider()" style="color:#ef4444">Delete Provider</div>`;
  } else if (type === 'nav') {
    html += `<div class="ctx-item" onclick="handleAddProvider()">Add Provider +</div>`;
  } else {
    html += `<div class="ctx-item" onclick="handleAddProvider()">Add Provider +</div>`;
    html += `<div class="ctx-item" onclick="openModal()">Add Contact (N)</div>`;
    
    if (!isGrid) {
      html += `<div class="ctx-divider"></div>`;
      html += `
        <div class="ctx-item">
          <span>Sort by...</span>
          <span>‚ñ∏</span>
          <div class="ctx-submenu">
            <div class="ctx-item" onclick="handleSort('provider')">Name (Provider)</div>
            <div class="ctx-item" onclick="handleSort('status')">Status</div>
            <div class="ctx-item" onclick="handleSort('reset')">Group by Category</div>
          </div>
        </div>
      `;
    }
  }

  contextMenu.innerHTML = html;
  contextMenu.style.left = `${Math.min(x, window.innerWidth - 200)}px`;
  contextMenu.style.top = `${Math.min(y, window.innerHeight - 200)}px`;
  contextMenu.classList.add('active');
}

function hideContextMenu() {
  contextMenu.classList.remove('active');
  contextTargetId = null;
}

function triggerViewDetails() {
  if (contextTargetId) {
    const item = items.find(i => i.id === contextTargetId);
    if (item) {
      document.getElementById('detailsTitle').textContent = `${item.provider} Details`;
      document.getElementById('detailProvider').textContent = item.provider;
      document.getElementById('detailEmail').textContent = item.email;
      document.getElementById('detailPassword').textContent = item.password;
      document.getElementById('detailReset').textContent = item.resetHours;
      document.getElementById('detailStatus').textContent = item.status;
      document.getElementById('detailsOverlay').classList.add('active');
    }
  }
  hideContextMenu();
}

function triggerEdit() {
  if (contextTargetId) openModal(contextTargetId);
  hideContextMenu();
}

function triggerDelete() {
  if (contextTargetId) {
    if(confirm("Are you sure you want to delete this contact?")) {
      items = items.filter(i => i.id !== contextTargetId);
      saveData();
      renderView();
      showToast("Contact Deleted");
    }
  }
  hideContextMenu();
}

function triggerCopyEmail() {
  if (contextTargetId) {
    const item = items.find(i => i.id === contextTargetId);
    if (item) {
      navigator.clipboard.writeText(item.email).then(() => {
        showToast("Email Copied to Clipboard");
      });
    }
  }
  hideContextMenu();
}

function triggerEditProvider() {
  const oldName = contextTargetId;
  const newName = prompt("Rename Provider:", oldName);
  if (newName && newName.trim() !== "" && newName !== oldName) {
     if (providers.includes(newName.trim())) {
       showToast("Provider name already exists");
       hideContextMenu();
       return;
     }
     const idx = providers.indexOf(oldName);
     if (idx !== -1) providers[idx] = newName.trim();
     
     items.forEach(item => {
       if (item.provider === oldName) item.provider = newName.trim();
     });
     
     if (currentProviderFilter === oldName) currentProviderFilter = newName.trim();

     saveData();
     renderTopNav();
     renderView();
     showToast("Provider Renamed");
  }
  hideContextMenu();
}

function triggerDeleteProvider() {
  const pName = contextTargetId;
  if (confirm(`Delete provider category "${pName}"? Contacts will remain but the category will be removed.`)) {
     providers = providers.filter(p => p !== pName);
     if (currentProviderFilter === pName) currentProviderFilter = 'all';
     saveData();
     renderTopNav();
     renderView();
     showToast("Provider Category Deleted");
  }
  hideContextMenu();
}

function handleAddProvider() {
  hideContextMenu();
  const name = prompt("Enter new Provider name:");
  if (name && name.trim()) {
    if (!providers.includes(name.trim())) {
      providers.push(name.trim());
      saveData();
      renderTopNav();
      showToast(`Provider "${name}" Added`);
    } else {
      showToast("Provider already exists");
    }
  }
}

function handleSort(criteria) {
  hideContextMenu();
  if (currentView !== 'scatter') return;

  const canvasWidth = window.innerWidth;
  
  let sorted = [...items];
  if (criteria === 'provider') {
    sorted.sort((a, b) => a.provider.localeCompare(b.provider));
  } else if (criteria === 'status') {
    sorted.sort((a, b) => a.status.localeCompare(b.status));
  } else if (criteria === 'reset') {
    const groups = {};
    items.forEach(item => {
      if (!groups[item.provider]) groups[item.provider] = [];
      groups[item.provider].push(item);
    });
    const sortedProviders = [...providers].sort();
    const numCols = sortedProviders.length;
    const colWidth = canvasWidth / numCols;

    sortedProviders.forEach((p, col) => {
      const group = groups[p] || [];
      group.sort((a, b) => a.id - b.id);
      const startX = col * colWidth + colWidth / 2 - 120;
      group.forEach((item, row) => {
        const newX = startX;
        const newY = 140 + row * 100;
        item.position = { x: newX, y: newY };
        const card = document.querySelector(`.scatter-card[data-id="${item.id}"]`);
        if (card) {
          card.classList.add('sorting');
          card.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
          setTimeout(() => card.classList.remove('sorting'), 500);
        }
      });
    });
    saveData();
    fitToView();
    return;
  }

  const cols = Math.floor(canvasWidth / 260);
  const startX = 50;
  const startY = 140; 
  const gapX = 260;
  const gapY = 200;

  sorted.forEach((item, index) => {
    const col = index % cols;
    const row = Math.floor(index / cols);
    const newX = startX + (col * gapX);
    const newY = startY + (row * gapY);

    item.position = { x: newX, y: newY };

    const card = document.querySelector(`.scatter-card[data-id="${item.id}"]`);
    if (card) {
      card.classList.add('sorting');
      card.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
      setTimeout(() => card.classList.remove('sorting'), 500);
    }
  });
  saveData();
  fitToView();
}

document.addEventListener('pointermove', handlePointerMove);
document.addEventListener('touchmove', handlePointerMove, { passive: false });

function handlePointerMove(e) {
  e.preventDefault();
  const touches = e.touches || [];
  const clientX = e.clientX || (touches[0] ? touches[0].clientX : 0);
  const clientY = e.clientY || (touches[0] ? touches[0].clientY : 0);

  if (touches.length === 2) {
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    const currentDistance = Math.sqrt(dx * dx + dy * dy);
    if (pinchDistance > 0) {
      const delta = (currentDistance - pinchDistance) / 1000;
      scatterZoom = Math.max(0.5, Math.min(3, scatterZoom + delta));
      updateCanvasTransform();
    }
    pinchDistance = currentDistance;
    return;
  }

  if (isDragging && draggedCard) {
    const canvas = document.getElementById('scatterCanvas');
    const canvasRect = canvas.getBoundingClientRect();
    let x = (clientX - canvasRect.left) / scatterZoom - panX - dragOffset.x;
    let y = (clientY - canvasRect.top) / scatterZoom - panY - dragOffset.y;

    draggedCard.style.transform = `translate3d(${x}px,${y}px,0)`;
    const id = Number(draggedCard.dataset.id);
    const item = items.find(i => i.id === id);
    if (item) item.position = { x, y };
    e.stopPropagation();
  }

  if (isPanning) {
    panX = clientX - panOffset.x;
    panY = clientY - panOffset.y;
    updateCanvasTransform();
    e.stopPropagation();
  }

  magnetPos = { x: clientX, y: clientY };
  
  if (currentView === 'scatter') {
    if (e.shiftKey || (touches.length === 1 && isMagnetic)) {
      if (!isMagnetic) startMagneticEffect();
      const indicator = document.getElementById('magnetIndicator');
      indicator.style.left = `${clientX - 60}px`;
      indicator.style.top = `${clientY - 60}px`;
    } else {
      if (isMagnetic) stopMagneticEffect();
    }
  }
}

document.addEventListener('pointerup', handlePointerUp);
document.addEventListener('touchend', handlePointerUp);

function handlePointerUp(e) {
  pinchDistance = 0;
  if (draggedCard) {
    draggedCard.classList.remove('dragging');
    saveData();
    fitToView();
  }
  isDragging = false;
  draggedCard = null;

  if (isPanning) {
    const canvas = document.getElementById('scatterCanvas');
    canvas.classList.remove('panning');
    isPanning = false;
    saveViewState();
  }
}

document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  
  if (e.key === ' ') {
    e.preventDefault();
    if (currentView === 'scatter' && !isSpaceDown) {
      isSpaceDown = true;
      document.body.classList.add('panning-mode');
    }
  } else if (e.key === 'n' || e.key === 'N') {
    e.preventDefault();
    showKeyboardIndicator('N', 'New Item');
    openModal();
  }
});

document.addEventListener('keyup', (e) => {
  if (e.key === ' ') {
    isSpaceDown = false;
    document.body.classList.remove('panning-mode');
    isPanning = false;
  } else if (e.key === 'Shift') {
    stopMagneticEffect();
    arrangeIntoRow();
  }
});

function toggleFilters() {
  const statuses = ['all', 'active', 'cooldown', 'burnt'];
  const idx = statuses.indexOf(currentStatusFilter);
  currentStatusFilter = statuses[(idx + 1) % statuses.length];
  setStatusFilter(currentStatusFilter);
}

function startMagneticEffect() {
  if (isMagnetic) return;
  isMagnetic = true;
  document.getElementById('magnetIndicator').classList.add('active');
  magnetLoop();
}

function stopMagneticEffect() {
  isMagnetic = false;
  document.getElementById('magnetIndicator').classList.remove('active');
  document.querySelectorAll('.scatter-card').forEach(c => c.classList.remove('magnetic'));
  if (magneticAnimationFrame) {
    cancelAnimationFrame(magneticAnimationFrame);
    magneticAnimationFrame = null;
  }
}

function magnetLoop() {
  if (!isMagnetic) return;
  
  const canvas = document.getElementById('scatterCanvas');
  const canvasRect = canvas.getBoundingClientRect();
  const logicalMagnetX = (magnetPos.x - canvasRect.left) / scatterZoom - panX;
  const logicalMagnetY = (magnetPos.y - canvasRect.top) / scatterZoom - panY;

  const cards = document.querySelectorAll('.scatter-card');
  const attracted = [];
  cards.forEach(card => {
    if (card.classList.contains('dragging')) return;

    const transform = card.style.transform;
    const match = transform.match(/translate3d\(([^p]+)px,\s*([^p]+)px/);
    if (match) {
      const currentX = parseFloat(match[1]);
      const currentY = parseFloat(match[2]);
      const logicalCardX = currentX + 120;
      const logicalCardY = currentY + 80;
      const dx = logicalMagnetX - logicalCardX;
      const dy = logicalMagnetY - logicalCardY;
      const dist = Math.hypot(dx, dy);
      if (dist > 30 && dist < 400) {
        const id = Number(card.dataset.id);
        const item = items.find(i => i.id === id);
        if (item && isSelected(item)) {
          attracted.push({card, currentX, currentY, id, provider: item.provider});
        }
      }
    }
  });

  if (attracted.length > 0) {
    attracted.sort((a, b) => a.provider.localeCompare(b.provider) || a.id - b.id);
    const perRing = 8;
    const rings = [100, 150, 200, 250];
    attracted.forEach((obj, idx) => {
      const {card, currentX, currentY} = obj;
      const ringIdx = Math.floor(idx / perRing);
      const radius = rings[Math.min(ringIdx, rings.length - 1)];
      const angle = (idx % perRing) * (2 * Math.PI / perRing);
      const targetLogicalX = logicalMagnetX + radius * Math.cos(angle);
      const targetLogicalY = logicalMagnetY + radius * Math.sin(angle);
      const targetX = targetLogicalX - 120;
      const targetY = targetLogicalY - 80;
      const dx_t = targetX - currentX;
      const dy_t = targetY - currentY;
      const dist_t = Math.hypot(dx_t, dy_t);
      if (dist_t > 1) {
        const pull = Math.min(0.2, dist_t / 10);
        const newX = currentX + dx_t * pull;
        const newY = currentY + dy_t * pull;
        card.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
        const item = items.find(i => i.id === obj.id);
        if (item) item.position = { x: newX, y: newY };
        card.classList.add('magnetic');
      }
    });
  }
  
  magneticAnimationFrame = requestAnimationFrame(magnetLoop);
}

function arrangeIntoRow() {
  const attractedCards = document.querySelectorAll('.scatter-card.magnetic');
  if (attractedCards.length === 0) return;

  const isPortrait = window.innerHeight > window.innerWidth;
  const startX = 50;
  const startY = magnetPos.y / scatterZoom - panY - 80;
  const gap = isPortrait ? 140 : 260;

  attractedCards.forEach((card, index) => {
    const newX = isPortrait ? startX : startX + index * gap;
    const newY = isPortrait ? startY + index * gap : startY;
    card.classList.add('sorting');
    card.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
    const id = Number(card.dataset.id);
    const item = items.find(i => i.id === id);
    if (item) item.position = { x: newX, y: newY };
    setTimeout(() => card.classList.remove('sorting', 'magnetic'), 500);
  });
  saveData();
  fitToView();
}

function updateCanvasTransform() {
  const canvas = document.getElementById('scatterCanvas');
  canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${scatterZoom})`;
}

document.getElementById('scatterContainer').addEventListener('wheel', (e) => {
  if (currentView === 'scatter') {
    e.preventDefault();
    const delta = e.deltaY * -0.001;
    const newZoom = Math.max(0.3, Math.min(3, scatterZoom * (1 - delta)));
    const rect = document.getElementById('scatterContainer').getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    const lx = (mouseX - panX) / scatterZoom;
    const ly = (mouseY - panY) / scatterZoom;
    panX = mouseX - lx * newZoom;
    panY = mouseY - ly * newZoom;
    scatterZoom = newZoom;
    updateCanvasTransform();
    saveViewState();
  }
}, { passive: false });

function switchView(view) {
  currentView = view;
  localStorage.setItem('preferred-view', view);
  const grid = document.getElementById('gridContainer');
  const scatter = document.getElementById('scatterContainer');
  
  stopMagneticEffect();
  hideContextMenu();

  if (view === 'grid') {
    grid.classList.add('active');
    scatter.classList.remove('active');
  } else {
    grid.classList.remove('active');
    scatter.classList.add('active');
  }
  renderView();
}

function renderView() {
  if (currentView === 'grid') renderGrid();
  else renderScatter();
}

document.querySelectorAll('.left-nav .nav-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.left-nav .nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    switchView(btn.dataset.view);
  });
});

document.querySelectorAll('.right-nav .nav-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    setStatusFilter(btn.dataset.status);
  });
});

document.getElementById('providerBtn').addEventListener('click', openProviderOverlay);

function openModal(itemId = null) {
  const modalTitle = document.getElementById('modalTitle');
  const submitBtn = document.getElementById('submitBtn');
  const form = document.getElementById('addForm');
  
  if (itemId) {
    const item = items.find(i => i.id === Number(itemId));
    if (item) {
      modalTitle.textContent = "Edit Contact";
      submitBtn.textContent = "Update Contact";
      document.getElementById('formId').value = item.id;
      document.getElementById('formProvider').value = item.provider;
      document.getElementById('formEmail').value = item.email;
      document.getElementById('formPassword').value = item.password;
      document.getElementById('formResetHours').value = item.resetHours;
      document.getElementById('formStatus').value = item.status;
    }
  } else {
    modalTitle.textContent = "Add New Contact";
    submitBtn.textContent = "Create Contact";
    form.reset();
    document.getElementById('formId').value = "";
  }

  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
  hideContextMenu();
}

document.getElementById('closeDetails').addEventListener('click', () => {
  document.getElementById('detailsOverlay').classList.remove('active');
});

document.getElementById('detailsOverlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) document.getElementById('detailsOverlay').classList.remove('active');
});

function toggleInfoFab() {
  const overlay = document.getElementById('infoFabOverlay');
  const fab = document.getElementById('infoFabBtn');
  overlay.classList.toggle('active');
  fab.classList.toggle('active');
}

document.getElementById('fabBtn').addEventListener('click', () => openModal());
document.getElementById('closeModal').addEventListener('click', closeModal);
document.getElementById('infoFabBtn').addEventListener('click', toggleInfoFab);
document.getElementById('infoCloseBtn').addEventListener('click', toggleInfoFab);
document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal();
});
document.getElementById('infoFabOverlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) toggleInfoFab();
});

document.getElementById('addForm').addEventListener('submit', (e) => {
  e.preventDefault();
  
  const idVal = document.getElementById('formId').value;
  const isEdit = idVal !== "";

  const newItem = {
    id: isEdit ? Number(idVal) : Date.now(),
    provider: document.getElementById('formProvider').value,
    email: document.getElementById('formEmail').value,
    password: document.getElementById('formPassword').value,
    resetHours: parseFloat(document.getElementById('formResetHours').value),
    status: document.getElementById('formStatus').value,
    position: {
      x: (window.innerWidth / 2) - 130 + Math.random() * 260,
      y: (window.innerHeight / 2) - 100 + Math.random() * 200
    }
  };

  if (isEdit) {
    const idx = items.findIndex(i => i.id === newItem.id);
    if (idx > -1) {
      newItem.position = items[idx].position; 
      items[idx] = newItem;
      showToast("Contact Updated");
    }
  } else {
    items.push(newItem);
    showToast("Contact Created");
  }

  closeModal();
  e.target.reset();
  saveData();
  renderView();
});

// Initialize````
renderTopNav();
if (window.innerWidth <= 768) {
  document.getElementById('providerBtn').textContent = currentProviderFilter;
}
if (currentView === 'scatter') {
  handleSort('status');
}
renderView();
document.getElementById('scatterContainer').addEventListener('contextmenu', handleBackgroundContext);
window.addEventListener('resize', () => {
  if (currentView === 'grid') renderGrid();
  else fitToView();
});
  </script>
</body>
</html>
