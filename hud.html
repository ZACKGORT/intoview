<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5.0,user-scalable=yes" />
  <title>intoview:NODE</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #0f1014;
      --ink: #ffffff;
      --ink-2: #a1a1aa;
      --ink-3: #52525b;
      --accent: #FFED29;
      --corner-pad: clamp(16px, 3vw, 32px);
      --fab-size: 80px;
      --info-fab-size: 40px;
      --glass-bg: rgba(20, 20, 25, 0.6);
      --glass-bg-hover: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-blur: 16px;
      --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.5);
      --ease-out: cubic-bezier(0.215, 0.61, 0.355, 1);
      --z-ui: 220;
      --z-overlay: 250;
      --z-menu: 300;
      --neon-green: #39FF14;
      --neon-red: #FF1447;
      --neon-orange: #FF8D14;
    }

    [data-theme="light"] {
      --bg-color: #f4f4f5;
      --ink: #18181b;
      --ink-2: #52525b;
      --ink-3: #a1a1aa;
      --accent: #FF296D;
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-bg-hover: rgba(0, 0, 0, 0.04);
      --glass-border: rgba(0, 0, 0, 0.08);
      --shadow-soft: 0 10px 30px -10px rgba(0,0,0,0.1);
    }

    .logo { position: fixed; top: var(--corner-top, 2em); left: var(--corner-pad); z-index: var(--z-ui); pointer-events: none; }
    .logo img { height: 32px; width: auto; display: block; transition: opacity 0.2s ease; }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{height:100%; font-family:'Inter',sans-serif; font-size:14px; background:var(--bg-color); color:var(--ink); transition: background 0.3s var(--ease-out), color 0.3s var(--ease-out);}
    body{overflow:hidden}

    .keyboard-indicator{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:2px solid var(--accent);padding:30px 40px;border-radius:12px;z-index:var(--z-overlay);pointer-events:none;transition:transform .18s,opacity .18s;opacity:0;box-shadow:var(--shadow-soft);}
    .keyboard-indicator.show{transform:translate(-50%,-50%) scale(1);opacity:1}
    .keyboard-indicator .key{font-family:'JetBrains Mono',monospace;font-size:48px;font-weight:700;color:var(--accent);text-align:center;margin-bottom:10px}
    .keyboard-indicator .label{font-size:14px;color:var(--ink-2);text-transform:uppercase;letter-spacing:1px;text-align:center}

    .top-nav,.right-nav,.left-nav{position:fixed;z-index:calc(var(--z-ui) + 2);background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);border-radius:12px;display:flex;gap:8px;padding:8px;box-shadow:var(--shadow-soft);transition:all 0.3s var(--ease-out);}
    .top-nav{top:var(--corner-pad);left:50%;transform:translateX(-50%); max-width: 80vw; overflow-x: auto;}
    .left-nav{left:var(--corner-pad);top:50%;transform:translateY(-50%);flex-direction:column}
    .right-nav{right:var(--corner-pad);top:50%;transform:translateY(-50%);flex-direction:column}
    .nav-btn{padding:10px 18px;background:transparent;border:0;color:var(--ink);cursor:pointer;border-radius:8px;font-weight:600;white-space:nowrap;font-size:14px;transition:all 0.2s var(--ease-out);}
    .nav-btn:hover{background:var(--glass-bg-hover)}
    .nav-btn.active{background:var(--accent);color:#000;font-weight:700;}

    .theme-toggle{position:fixed;top:var(--corner-pad);right:var(--corner-pad);z-index:calc(var(--z-ui) + 10);background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);border-radius:12px;padding:8px;display:flex;gap:6px;box-shadow:var(--shadow-soft);transition:all 0.3s var(--ease-out);}
    .theme-btn{width:40px;height:40px;border-radius:8px;background:transparent;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.2s var(--ease-out);}
    .theme-btn:hover{background:var(--glass-bg-hover);transform:scale(1.05);}
    .theme-btn.active{background:var(--accent);}

    .zoom-controls{position:fixed;bottom:var(--corner-pad);left:var(--corner-pad);z-index:calc(var(--z-ui) + 10);display:flex;gap:8px;opacity:0;pointer-events:none;transition:opacity 0.3s var(--ease-out);}
    .zoom-controls.active{opacity:1;pointer-events:auto;}
    .zoom-btn{width:48px;height:48px;border-radius:12px;background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:700;font-size:20px;color:var(--ink);box-shadow:var(--shadow-soft);transition:all 0.2s var(--ease-out);}
    .zoom-btn:hover{transform:translateY(-3px);background:var(--glass-bg-hover);}

    .fab-wrap{position:fixed;bottom:var(--corner-pad);right:var(--corner-pad);z-index:calc(var(--z-ui) + 5);display:flex;align-items:center;gap:14px;pointer-events:none;}
    .fab{pointer-events:auto;width:var(--fab-size);height:var(--fab-size);border-radius:50%;background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow-soft);transition:all 0.2s var(--ease-out);}
    .fab:hover{transform:scale(1.08);background:var(--glass-bg-hover);}
    .fab svg{width:calc(var(--fab-size) * 0.4);height:calc(var(--fab-size) * 0.4);fill:var(--accent);transition:fill 0.3s var(--ease-out);}
    .fab-label{pointer-events:none;font-weight:700;color:var(--ink);font-size:14px;opacity:0;transform:translateY(6px);transition:opacity .18s,transform .18s;white-space:nowrap;}
    @media (min-width:900px){
      .fab-label{opacity:1;transform:none;}
    }

    .magnetic-label {
      position: fixed;
      bottom: calc(var(--corner-pad) + var(--fab-size) + 10px);
      right: var(--corner-pad);
      color: var(--ink-2);
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
    }
    .scatter-container.active ~ .magnetic-label {
      opacity: 1;
    }

    .info-fab {
      position: fixed;
      top: var(--corner-pad);
      right: calc(var(--corner-pad) + 120px);
      width: var(--info-fab-size);
      height: var(--info-fab-size);
      border-radius: 50%;
      background: var(--neon-green);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #000;
      box-shadow: 0 4px 20px rgba(57, 255, 20, 0.4);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: calc(var(--z-ui) + 5);
      pointer-events: auto;
    }
    .info-fab:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 6px 30px rgba(57, 255, 20, 0.6);
    }
    .info-fab.active {
      transform: rotate(45deg);
    }

    .info-fab-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: var(--z-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .info-fab-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .info-fab-panel {
      background: var(--bg-color);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .info-fab-overlay.active .info-fab-panel {
      transform: scale(1);
    }

    .info-fab-panel h2 {
      margin-top: 0;
      color: var(--neon-green);
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    .info-fab-panel p {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 20px;
    }

    .btn-secondary {
      width: 100%;
      padding: 12px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: var(--ink);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s var(--ease-out);
    }
    .btn-secondary:hover {
      background: var(--glass-bg-hover);
      transform: translateY(-2px);
    }

    .grid-container{position:absolute;inset:80px 20px 20px 20px;overflow-y:auto;overflow-x:hidden;opacity:0;pointer-events:none;transition:opacity 0.3s var(--ease-out);}
    .grid-container.active{opacity:1;pointer-events:auto;}
    .grid-wrapper{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;padding:20px;max-width:1600px;margin:0 auto;}

    .card{background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.25s var(--ease-out);min-height:180px;display:flex;flex-direction:column;box-shadow:var(--shadow-soft);backdrop-filter:blur(var(--glass-blur));position:relative; overflow:hidden;}
    .card:active { transform: scale(0.98); }
    .card:hover{transform:translateY(-4px);box-shadow:0 20px 60px -10px rgba(0,0,0,0.4);border-color:var(--accent);}
    .grid-container .card:hover { background: #fff; color: #000; border-color: #000; }
    .grid-container .card:hover .card-provider { color: #000; }
    .grid-container .card:hover .card-label { color: #666; }
    .grid-container .card:hover .card-label strong { color: #000; }

    .card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:15px}
    .card-provider{font-size:20px;font-weight:700;color:var(--accent)}
    .card-status{padding:6px 14px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;border:1px solid var(--glass-border);background:var(--glass-bg);}
    .card-info{flex:1;display:flex;flex-direction:column;gap:8px}
    .card-footer{margin-top:auto;padding-top:15px;border-top:1px solid var(--glass-border)}
    .card-label{font-size:12px;color:var(--ink-2);display:flex;align-items:center;gap:8px}
    .card-label strong{color:var(--ink);font-weight:600}

    .status-dot { 
      width: 12px; 
      height: 12px; 
      border-radius: 50%; 
      box-shadow: 0 0 10px currentColor;
      animation: statusPulse 2s ease-in-out infinite;
    }
    .status-active { background: var(--neon-green); }
    .status-cooldown { background: var(--neon-orange); }
    .status-burnt { background: var(--neon-red); }

    @keyframes statusPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }

    .reset-badge {
      font-family: 'JetBrains Mono';
      font-size: 0.7rem;
      padding: 4px 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      opacity: 0.7;
    }

    .copy-feedback {
      position: absolute; inset: 0; background: var(--accent); color: #000;
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 18px; opacity: 0; pointer-events: none;
      transition: opacity 0.2s; z-index: 10;
    }
    .copy-feedback.show { opacity: 0.9; }

    .status-active .card-status{background:rgba(34,197,94,0.15);color:#22c55e;border-color:#22c55e;}
    .status-cooldown .card-status{background:rgba(251,146,60,0.15);color:#fb923c;border-color:#fb923c;}
    .status-burnt .card-status{background:rgba(239,68,68,0.15);color:#ef4444;border-color:#ef4444;}

    .scatter-container{position:absolute;inset:0;opacity:0;pointer-events:none;transition:opacity .3s;overflow:hidden}
    .scatter-container.active{opacity:1;pointer-events:auto}
    .scatter-canvas{width:100%;height:100%;position:relative;transform-origin:center center;transition:transform .12s ease-out; cursor: grab;}
    .scatter-canvas.panning { cursor: grabbing; }
    .scatter-card{position:absolute;background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);border-radius:12px;padding:16px;cursor:grab;transition:box-shadow .18s,border-color .18s;width:240px;user-select:none;touch-action:none;box-shadow:var(--shadow-soft);}
    .scatter-card:active{cursor:grabbing}
    .scatter-card.dragging{box-shadow:0 16px 48px rgba(0,0,0,.6);border-color:var(--accent);z-index:2000}
    .scatter-card.magnetic{transition:transform .15s cubic-bezier(.2,.9,.3,1);}
    .scatter-card.sorting { transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .scatter-card.filtered-out { opacity: 0.35; pointer-events: none; }

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:var(--z-overlay);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
    .modal-overlay.active{opacity:1;pointer-events:auto}
    .modal{background:var(--bg-color);border:1px solid var(--glass-border);border-radius:16px;padding:40px;max-width:560px;width:92%;max-height:90vh;overflow-y:auto;transform:scale(.96);transition:transform .22s;box-shadow:0 25px 50px -12px rgba(0,0,0,0.7);position:relative;}
    .modal-overlay.active .modal{transform:scale(1)}
    .modal h2{color:var(--accent);margin-bottom:24px;font-family:'JetBrains Mono',monospace;font-size:24px;}
    .form-group{margin-bottom:20px}
    label{display:block;margin-bottom:8px;font-size:14px;color:var(--ink-2);font-weight:600}
    input,select{width:100%;padding:14px;background:var(--glass-bg);border:1px solid var(--glass-border);color:var(--ink);border-radius:8px;font-size:14px;transition:border-color 0.2s var(--ease-out);}
    input:focus,select:focus{outline:none;border-color:var(--accent);}
    .btn-submit{width:100%;padding:16px;background:var(--accent);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;font-size:14px;transition:all 0.2s var(--ease-out);}
    .btn-submit:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.3);}
    .close-modal{position:absolute;top:20px;right:20px;background:transparent;border:0;color:var(--ink);font-size:32px;cursor:pointer;opacity:.7;transition:opacity 0.2s;}
    .close-modal:hover{opacity:1;}

    .context-menu {
      position: fixed;
      background: var(--bg-color);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 6px;
      min-width: 180px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: var(--z-menu);
      opacity: 0; pointer-events: none;
      transform: scale(0.95);
      transition: opacity 0.1s, transform 0.1s;
      display: flex; flex-direction: column; gap: 2px;
    }
    .context-menu.active { opacity: 1; pointer-events: auto; transform: scale(1); }

    .ctx-item {
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--ink);
      font-size: 13px;
      font-weight: 500;
      display: flex; justify-content: space-between; align-items: center;
      position: relative;
    }
    .ctx-item:hover { background: var(--glass-bg-hover); color: var(--accent); }
    .ctx-divider { height: 1px; background: var(--glass-border); margin: 4px 0; }

    .ctx-submenu {
      position: absolute; left: 100%; top: -4px;
      background: var(--bg-color);
      border: 1px solid var(--glass-border);
      border-radius: 8px; padding: 6px; min-width: 160px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      opacity: 0; pointer-events: none; transform: translateX(-10px);
      transition: all 0.2s;
    }
    .ctx-item:hover .ctx-submenu { opacity: 1; pointer-events: auto; transform: translateX(0); }

    .magnet-indicator{position:fixed;width:120px;height:120px;border:3px solid var(--accent);border-radius:50%;pointer-events:none;z-index:calc(var(--z-ui) + 5);opacity:0;display:flex;align-items:center;justify-content:center;transition:opacity 0.15s;box-shadow:0 0 30px var(--accent);}
    .magnet-indicator.active{opacity:.7;animation:magnetPulse 1.5s ease-in-out infinite;}
    @keyframes magnetPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
    .magnet-indicator::before{content:'üß≤';font-size:48px}

    .toast {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--accent); color: #000; font-weight: 700;
      padding: 12px 24px; border-radius: 30px;
      opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: var(--z-overlay); pointer-events: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    ::-webkit-scrollbar{width:8px}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.16);border-radius:4px}
    ::-webkit-scrollbar-track{background:transparent}

    @media (prefers-reduced-motion:reduce){*{transition:none!important;animation:none!important}}
  </style>
</head>
<body data-theme="dark">
  <div class="logo">
    <img id="logoImg" src="https://raw.githubusercontent.com/ZACKGORT/intoview/main/intoview-logo-light.svg.svg" alt="IntoView Logo">
  </div>

  <div id="keyboardIndicator" class="keyboard-indicator" aria-hidden="true">
    <div class="key" id="indicatorKey">N</div>
    <div class="label" id="indicatorLabel">New Item</div>
  </div>

  <div id="toast" class="toast">Action Complete</div>

  <div class="theme-toggle" role="toolbar" aria-label="Theme selector">
    <button class="theme-btn active" data-theme="dark" title="Dark Theme">üåô</button>
    <button class="theme-btn" data-theme="light" title="Light Theme">‚òÄÔ∏è</button>
  </div>

  <div class="top-nav" id="topNav" role="toolbar" aria-label="Provider filter"></div>

  <div class="left-nav" role="tablist" aria-label="View switch">
    <button class="nav-btn active" data-view="grid">Grid</button>
    <button class="nav-btn" data-view="scatter">List/Scatter</button>
  </div>

  <div class="right-nav" role="toolbar" aria-label="Status filter">
    <button class="nav-btn active" data-status="all">All</button>
    <button class="nav-btn" data-status="active">Active</button>
    <button class="nav-btn" data-status="cooldown">Cooldown</button>
    <button class="nav-btn" data-status="burnt">Burnt</button>
  </div>

  <div class="zoom-controls" id="zoomControls">
    <button class="zoom-btn" id="zoomIn" aria-label="Zoom in">+</button>
    <button class="zoom-btn" id="zoomReset" aria-label="Reset zoom">‚ü≤</button>
    <button class="zoom-btn" id="zoomOut" aria-label="Zoom out">‚àí</button>
  </div>

  <div class="fab-wrap">
    <button class="fab" id="fabBtn" title="New Item (N)" aria-label="Create new item">
      <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"></path></svg>
    </button>
    <div class="fab-label">Add Contact</div>
  </div>

  <div class="magnetic-label">shift key = magnetic mode</div>

  <button class="info-fab" id="infoFabBtn">?</button>

  <div class="info-fab-overlay" id="infoFabOverlay">
    <div class="info-fab-panel">
      <h2>Information</h2>
      <p>This is a management tool for LLM accounts. Use the FAB to add new nodes, right-click for context menus, and switch views as needed.</p>
      <button class="btn-secondary" id="infoCloseBtn">Close</button>
    </div>
  </div>

  <div class="container">
    <div class="grid-container active" id="gridContainer">
      <div class="grid-wrapper" id="gridWrapper"></div>
    </div>

    <div class="scatter-container" id="scatterContainer">
      <div class="scatter-canvas" id="scatterCanvas"></div>
    </div>
  </div>

  <div class="magnet-indicator" id="magnetIndicator"></div>

  <div id="contextMenu" class="context-menu"></div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <button class="close-modal" id="closeModal">√ó</button>
      <h2 id="modalTitle">Add New Contact</h2>
      <form id="addForm">
        <input type="hidden" id="formId">
        <div class="form-group">
          <label for="formProvider">Provider / Group</label>
          <select id="formProvider" required></select>
        </div>
        <div class="form-group">
          <label for="formEmail">Email / Username</label>
          <input id="formEmail" type="email" required>
        </div>
        <div class="form-group">
          <label for="formPassword">Password (Notes)</label>
          <input id="formPassword" type="text" required>
        </div>
        <div class="form-group">
          <label for="formResetHours">Reset Hours</label>
          <input id="formResetHours" type="number" value="3" min="0.5" step="0.5" required>
        </div>
        <div class="form-group">
          <label for="formStatus">Status</label>
          <select id="formStatus" required>
            <option value="active">Active</option>
            <option value="cooldown">Cooldown</option>
            <option value="burnt">Burnt/Expired</option>
          </select>
        </div>
        <button type="submit" class="btn-submit" id="submitBtn">Save Contact</button>
      </form>
    </div>
  </div>

  <script>
    let providers = JSON.parse(localStorage.getItem('nodeProviders')) || ['ChatGPT', 'Claude', 'Gemini', 'Grok', 'Copilot'];
    let items = JSON.parse(localStorage.getItem('nodeItems')) || [];
    let currentView = localStorage.getItem('preferred-view') || 'grid';
    let currentProviderFilter = localStorage.getItem('currentProviderFilter') || 'all';
    let currentStatusFilter = localStorage.getItem('currentStatusFilter') || 'all';
    let currentTheme = localStorage.getItem('preferred-theme') || 'dark';
    let scatterZoom = Number(localStorage.getItem('scatterZoom')) || 1;
    let panX = Number(localStorage.getItem('panX')) || 0;
    let panY = Number(localStorage.getItem('panY')) || 0;
    let isDragging = false;
    let isPanning = false;
    let draggedCard = null;
    let dragOffset = { x: 0, y: 0 };
    let panOffset = { x: 0, y: 0 };
    let isMagnetic = false;
    let magnetPos = { x: 0, y: 0 };
    let magneticAnimationFrame = null;
    let contextTargetId = null;
    let selectedFilter = null;

    if (items.length === 0) {
      items = generateMockData();
      saveData();
    }

    function generateMockData() {
      const statuses = ['active', 'cooldown', 'burnt'];
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      return Array.from({ length: 15 }, (_, i) => ({
        id: Date.now() + i,
        provider: providers[i % providers.length],
        email: `user${i + 1}@example.com`,
        password: `password${i + 1}`,
        resetHours: 3 + (i % 4),
        status: statuses[i % statuses.length],
        position: {
          x: centerX - 400 + Math.random() * 800,
          y: centerY - 300 + Math.random() * 600
        }
      }));
    }


    function saveData() {
      localStorage.setItem('nodeItems', JSON.stringify(items));
      localStorage.setItem('nodeProviders', JSON.stringify(providers));
    }

    function saveViewState() {
      localStorage.setItem('scatterZoom', scatterZoom);
      localStorage.setItem('panX', panX);
      localStorage.setItem('panY', panY);
    }

    function renderTopNav() {
      const nav = document.getElementById('topNav');
      let html = `<button class="nav-btn ${currentProviderFilter === 'all' ? 'active' : ''}" onclick="setProviderFilter('all')">All</button>`;
      providers.forEach(p => {
        const isActive = currentProviderFilter === p ? 'active' : '';
        html += `<button class="nav-btn ${isActive}" onclick="setProviderFilter('${escapeHtml(p)}')" oncontextmenu="handleProviderContext(event, '${escapeHtml(p)}')">${escapeHtml(p)}</button>`;
      });
      html += `<button class="nav-btn" onclick="handleAddProvider()">+ Add Provider</button>`;
      nav.innerHTML = html;
      updateModalProviders();
    }

    function updateModalProviders() {
      const select = document.getElementById('formProvider');
      select.innerHTML = providers.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
    }

    function setProviderFilter(p) {
      currentProviderFilter = p;
      localStorage.setItem('currentProviderFilter', p);
      renderTopNav();
      renderView();
    }

    function setStatusFilter(s) {
      currentStatusFilter = s;
      localStorage.setItem('currentStatusFilter', s);
      document.querySelectorAll('.right-nav .nav-btn').forEach(b => b.classList.toggle('active', b.dataset.status === s));
      renderView();
    }

    function setTheme(theme) {
      currentTheme = theme;
      document.body.setAttribute('data-theme', theme);
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
      });
      localStorage.setItem('preferred-theme', theme);
    }
    setTheme(currentTheme);

    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => setTheme(btn.dataset.theme));
    });

    function showKeyboardIndicator(key, label) {
      const indicator = document.getElementById('keyboardIndicator');
      document.getElementById('indicatorKey').textContent = key;
      document.getElementById('indicatorLabel').textContent = label;
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 800);
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function isSelected(item) {
      const p = currentProviderFilter === 'all' || item.provider === currentProviderFilter;
      const s = currentStatusFilter === 'all' || item.status === currentStatusFilter;
      return p && s;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    function renderGrid() {
      const wrapper = document.getElementById('gridWrapper');
      let displayed = items.filter(isSelected);
      displayed.sort((a, b) => a.provider.localeCompare(b.provider) || a.email.localeCompare(b.email));

      wrapper.innerHTML = displayed.map(item => `
        <div class="card status-${item.status}" data-id="${item.id}" oncontextmenu="handleCardContext(event, ${item.id})">
          <div class="copy-feedback">@ Copied!</div>
          <div class="card-header">
            <div class="card-provider">${escapeHtml(item.provider)}</div>
            <div class="card-status">${escapeHtml(item.status)}</div>
          </div>
          <div class="card-info">
            <div style="color:var(--ink-2);font-size:14px;margin-bottom:10px">Reset: ${item.resetHours}h</div>
          </div>
          <div class="card-footer">
            <div class="card-label"><strong>Provider:</strong> ${escapeHtml(item.provider)}</div>
            <div class="card-label"><strong>Email:</strong> ${escapeHtml(item.email)}</div>
          </div>
        </div>
      `).join('');

      wrapper.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', (e) => {
          const id = card.dataset.id;
          const item = items.find(i => i.id == id);
          if (item) {
            navigator.clipboard.writeText(item.email).then(() => {
              const feedback = card.querySelector('.copy-feedback');
              feedback.classList.add('show');
              setTimeout(() => feedback.classList.remove('show'), 800);
              showToast("Email Copied");
            });
          }
        });
      });
    }

    function renderScatter() {
      const canvas = document.getElementById('scatterCanvas');
      const existing = Array.from(canvas.querySelectorAll('.scatter-card'));
      const posMap = new Map();
      
      existing.forEach(card => {
        const id = Number(card.dataset.id);
        const match = card.style.transform.match(/translate3d\(([^p]+)px,\s*([^p]+)px/);
        if (match) posMap.set(id, { x: parseFloat(match[1]), y: parseFloat(match[2]) });
      });

      canvas.innerHTML = items.map(item => {
        const pos = posMap.get(item.id) || item.position || {x: 200, y: 200};
        const selectedClass = isSelected(item) ? '' : 'filtered-out';
        return `
          <div class="scatter-card status-${item.status} ${selectedClass}" 
               data-id="${item.id}" 
               style="transform:translate3d(${pos.x}px,${pos.y}px,0)"
               oncontextmenu="handleCardContext(event, ${item.id})">
            <div class="card-header">
              <div class="card-provider">${escapeHtml(item.provider)}</div>
              <div class="card-status">${escapeHtml(item.status)}</div>
            </div>
            <div class="card-footer" style="border:none;padding-top:10px">
              <div class="card-label"><strong>${escapeHtml(item.provider)}</strong></div>
              <div class="card-label" style="font-size:11px">${escapeHtml(item.email)}</div>
            </div>
            <div class="reset-badge">${item.resetHours}h reset</div>
          </div>
        `;
      }).join('');

      attachScatterHandlers();
      updateCanvasTransform();
    }

    function attachScatterHandlers() {
      document.querySelectorAll('.scatter-card').forEach(card => {
        card.addEventListener('pointerdown', startCardDrag);
        card.addEventListener('touchstart', startCardDrag, { passive: false });
      });
      const canvas = document.getElementById('scatterCanvas');
      canvas.addEventListener('pointerdown', startPan);
      canvas.addEventListener('touchstart', startPan, { passive: false });
    }

    function startCardDrag(e) {
      e.preventDefault();
      if (e.button === 2) return;
      
      draggedCard = e.currentTarget;
      isDragging = true;
      draggedCard.classList.add('dragging');
      const rect = draggedCard.getBoundingClientRect();
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      dragOffset.x = clientX - rect.left;
      dragOffset.y = clientY - rect.top;
      e.stopPropagation();
    }

    function startPan(e) {
      e.preventDefault();
      if (e.button === 2 || isDragging) return;
      if (e.target.closest('.scatter-card')) return;
      
      isPanning = true;
      const canvas = document.getElementById('scatterCanvas');
      canvas.classList.add('panning');
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      panOffset.x = clientX - panX;
      panOffset.y = clientY - panY;
      e.stopPropagation();
    }

    const contextMenu = document.getElementById('contextMenu');

    document.addEventListener('click', (e) => {
      if (!contextMenu.contains(e.target)) hideContextMenu();
    });

    function handleCardContext(e, id) {
      e.preventDefault();
      e.stopPropagation();
      contextTargetId = id;
      showContextMenu(e.clientX, e.clientY, 'card');
    }

    function handleProviderContext(e, providerName) {
      e.preventDefault();
      e.stopPropagation();
      contextTargetId = providerName;
      showContextMenu(e.clientX, e.clientY, 'provider');
    }

    function handleNavContext(e) {
      e.preventDefault();
      e.stopPropagation();
      contextTargetId = null;
      showContextMenu(e.clientX, e.clientY, 'nav');
    }

    function handleBackgroundContext(e) {
      if(e.target !== e.currentTarget) return;
      e.preventDefault();
      contextTargetId = null;
      showContextMenu(e.clientX, e.clientY, 'background');
    }

    function showContextMenu(x, y, type) {
      const isGrid = currentView === 'grid';
      let html = '';

      if (type === 'card') {
        if (!isGrid) {
          html += `
            <div class="ctx-item" onclick="triggerCopyEmail()">Copy Email</div>
            <div class="ctx-item">
              <span>Sort by...</span>
              <span>‚ñ∏</span>
              <div class="ctx-submenu">
                <div class="ctx-item" onclick="handleSort('provider')">Name (Provider)</div>
                <div class="ctx-item" onclick="handleSort('status')">Status</div>
                <div class="ctx-item" onclick="handleSort('reset')">Group by Category</div>
              </div>
            </div>
            <div class="ctx-divider"></div>
          `;
        }
        html += `
          <div class="ctx-item" onclick="triggerEdit()">Edit Contact</div>
          <div class="ctx-item" onclick="triggerDelete()" style="color:#ef4444">Delete Contact</div>
        `;
      } else if (type === 'provider') {
        html += `<div class="ctx-item" onclick="triggerEditProvider()">Edit Provider</div>`;
        html += `<div class="ctx-item" onclick="triggerDeleteProvider()" style="color:#ef4444">Delete Provider</div>`;
      } else if (type === 'nav') {
        html += `<div class="ctx-item" onclick="handleAddProvider()">Add Provider +</div>`;
      } else {
        html += `<div class="ctx-item" onclick="handleAddProvider()">Add Provider +</div>`;
        html += `<div class="ctx-item" onclick="openModal()">Add Contact (N)</div>`;
        
        if (!isGrid) {
          html += `<div class="ctx-divider"></div>`;
          html += `
            <div class="ctx-item">
              <span>Sort by...</span>
              <span>‚ñ∏</span>
              <div class="ctx-submenu">
                <div class="ctx-item" onclick="handleSort('provider')">Name (Provider)</div>
                <div class="ctx-item" onclick="handleSort('status')">Status</div>
                <div class="ctx-item" onclick="handleSort('reset')">Group by Category</div>
              </div>
            </div>
          `;
        }
      }

      contextMenu.innerHTML = html;
      contextMenu.style.left = `${Math.min(x, window.innerWidth - 200)}px`;
      contextMenu.style.top = `${Math.min(y, window.innerHeight - 200)}px`;
      contextMenu.classList.add('active');
    }

    function hideContextMenu() {
      contextMenu.classList.remove('active');
      contextTargetId = null;
    }

    function triggerEdit() {
      if (contextTargetId) openModal(contextTargetId);
      hideContextMenu();
    }

    function triggerDelete() {
      if (contextTargetId) {
        if(confirm("Are you sure you want to delete this contact?")) {
          items = items.filter(i => i.id !== contextTargetId);
          saveData();
          renderView();
          showToast("Contact Deleted");
        }
      }
      hideContextMenu();
    }

    function triggerCopyEmail() {
      if (contextTargetId) {
        const item = items.find(i => i.id === contextTargetId);
        if (item) {
          navigator.clipboard.writeText(item.email).then(() => {
            showToast("Email Copied to Clipboard");
          });
        }
      }
      hideContextMenu();
    }

    function triggerEditProvider() {
      const oldName = contextTargetId;
      const newName = prompt("Rename Provider:", oldName);
      if (newName && newName.trim() !== "" && newName !== oldName) {
         if (providers.includes(newName.trim())) {
           showToast("Provider name already exists");
           hideContextMenu();
           return;
         }
         const idx = providers.indexOf(oldName);
         if (idx !== -1) providers[idx] = newName.trim();
         
         items.forEach(item => {
           if (item.provider === oldName) item.provider = newName.trim();
         });
         
         if (currentProviderFilter === oldName) currentProviderFilter = newName.trim();

         saveData();
         renderTopNav();
         renderView();
         showToast("Provider Renamed");
      }
      hideContextMenu();
    }

    function triggerDeleteProvider() {
      const pName = contextTargetId;
      if (confirm(`Delete provider category "${pName}"? Contacts will remain but the category will be removed.`)) {
         providers = providers.filter(p => p !== pName);
         if (currentProviderFilter === pName) currentProviderFilter = 'all';
         saveData();
         renderTopNav();
         renderView();
         showToast("Provider Category Deleted");
      }
      hideContextMenu();
    }

    function handleAddProvider() {
      hideContextMenu();
      const name = prompt("Enter new Provider name:");
      if (name && name.trim()) {
        if (!providers.includes(name.trim())) {
          providers.push(name.trim());
          saveData();
          renderTopNav();
          showToast(`Provider "${name}" Added`);
        } else {
          showToast("Provider already exists");
        }
      }
    }

    function handleSort(criteria) {
      hideContextMenu();
      if (currentView !== 'scatter') return;

      const canvasWidth = window.innerWidth;
      
      let sorted = [...items];
      if (criteria === 'provider') {
        sorted.sort((a, b) => a.provider.localeCompare(b.provider));
      } else if (criteria === 'status') {
        sorted.sort((a, b) => a.status.localeCompare(b.status));
      } else if (criteria === 'reset') {
        const groups = {};
        items.forEach(item => {
          if (!groups[item.provider]) groups[item.provider] = [];
          groups[item.provider].push(item);
        });
        const sortedProviders = [...providers].sort();
        const numCols = sortedProviders.length;
        const colWidth = canvasWidth / numCols;

        sortedProviders.forEach((p, col) => {
          const group = groups[p] || [];
          group.sort((a, b) => a.id - b.id);
          const startX = col * colWidth + colWidth / 2 - 120;
          group.forEach((item, row) => {
            const newX = startX;
            const newY = 140 + row * 100;
            item.position = { x: newX, y: newY };
            const card = document.querySelector(`.scatter-card[data-id="${item.id}"]`);
            if (card) {
              card.classList.add('sorting');
              card.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
              setTimeout(() => card.classList.remove('sorting'), 500);
            }
          });
        });
        saveData();
        return;
      }

      const cols = Math.floor(canvasWidth / 260);
      const startX = 50;
      const startY = 140; 
      const gapX = 260;
      const gapY = 200;

      sorted.forEach((item, index) => {
        const col = index % cols;
        const row = Math.floor(index / cols);
        const newX = startX + (col * gapX);
        const newY = startY + (row * gapY);

        item.position = { x: newX, y: newY };

        const card = document.querySelector(`.scatter-card[data-id="${item.id}"]`);
        if (card) {
          card.classList.add('sorting');
          card.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
          setTimeout(() => card.classList.remove('sorting'), 500);
        }
      });
      saveData();
    }

    document.addEventListener('pointermove', handlePointerMove);
    document.addEventListener('touchmove', handlePointerMove, { passive: false });

    function handlePointerMove(e) {
      e.preventDefault();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);

      if (isDragging && draggedCard) {
        const canvas = document.getElementById('scatterCanvas');
        const canvasRect = canvas.getBoundingClientRect();
        let x = (clientX - canvasRect.left) / scatterZoom - panX - dragOffset.x;
        let y = (clientY - canvasRect.top) / scatterZoom - panY - dragOffset.y;

        draggedCard.style.transform = `translate3d(${x}px,${y}px,0)`;
        const id = Number(draggedCard.dataset.id);
        const item = items.find(i => i.id === id);
        if (item) item.position = { x, y };
        e.stopPropagation();
      }

      if (isPanning) {
        panX = clientX - panOffset.x;
        panY = clientY - panOffset.y;
        updateCanvasTransform();
        e.stopPropagation();
      }

      magnetPos = { x: clientX, y: clientY };
      
      if (currentView === 'scatter') {
        if (e.shiftKey) {
          if (!isMagnetic) startMagneticEffect();
          const indicator = document.getElementById('magnetIndicator');
          indicator.style.left = `${clientX - 60}px`;
          indicator.style.top = `${clientY - 60}px`;
        } else {
          if (isMagnetic) stopMagneticEffect();
        }
      }
    }

    document.addEventListener('pointerup', handlePointerUp);
    document.addEventListener('touchend', handlePointerUp);

    function handlePointerUp(e) {
      if (draggedCard) {
        draggedCard.classList.remove('dragging');
        saveData();
      }
      isDragging = false;
      draggedCard = null;

      if (isPanning) {
        const canvas = document.getElementById('scatterCanvas');
        canvas.classList.remove('panning');
        isPanning = false;
        saveViewState();
      }
    }

    document.addEventListener('keyup', (e) => {
      if (e.key === 'Shift') {
        stopMagneticEffect();
        if (selectedFilter) {
          arrangeIntoRow();
        }
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
      
      if (e.key === 'n' || e.key === 'N') {
        e.preventDefault();
        showKeyboardIndicator('N', 'New Item');
        openModal();
      } else if (e.key === ' ') {
        e.preventDefault();
        showKeyboardIndicator('SPACE', 'Toggle Filters');
        toggleFilters();
      }
    });

    function toggleFilters() {
      const statuses = ['all', 'active', 'cooldown', 'burnt'];
      const idx = statuses.indexOf(currentStatusFilter);
      currentStatusFilter = statuses[(idx + 1) % statuses.length];
      setStatusFilter(currentStatusFilter);
    }

    function startMagneticEffect() {
      if (isMagnetic) return;
      isMagnetic = true;
      document.getElementById('magnetIndicator').classList.add('active');
      magnetLoop();
    }

    function stopMagneticEffect() {
      isMagnetic = false;
      document.getElementById('magnetIndicator').classList.remove('active');
      document.querySelectorAll('.scatter-card').forEach(c => c.classList.remove('magnetic'));
      if (magneticAnimationFrame) {
        cancelAnimationFrame(magneticAnimationFrame);
        magneticAnimationFrame = null;
      }
    }

    function magnetLoop() {
      if (!isMagnetic) return;
      
      const canvas = document.getElementById('scatterCanvas');
      const canvasRect = canvas.getBoundingClientRect();
      const logicalMagnetX = (magnetPos.x - canvasRect.left) / scatterZoom - panX;
      const logicalMagnetY = (magnetPos.y - canvasRect.top) / scatterZoom - panY;

      const cards = document.querySelectorAll('.scatter-card');
      const attracted = [];
      cards.forEach(card => {
        if (card.classList.contains('dragging')) return;

        const transform = card.style.transform;
        const match = transform.match(/translate3d\(([^p]+)px,\s*([^p]+)px/);
        if (match) {
          const currentX = parseFloat(match[1]);
          const currentY = parseFloat(match[2]);
          const logicalCardX = currentX + 120;
          const logicalCardY = currentY + 80;
          const dx = logicalMagnetX - logicalCardX;
          const dy = logicalMagnetY - logicalCardY;
          const dist = Math.hypot(dx, dy);
          if (dist > 30 && dist < 400) {
            const id = Number(card.dataset.id);
            const item = items.find(i => i.id === id);
            if (item && (selectedFilter === null || item.status === selectedFilter || item.provider === selectedFilter)) {
              attracted.push({card, currentX, currentY, id, provider: item.provider});
            }
          }
        }
      });

      if (attracted.length > 0) {
        attracted.sort((a, b) => a.provider.localeCompare(b.provider) || a.id - b.id);
        const perRing = 8;
        const rings = [100, 150, 200, 250];
        attracted.forEach((obj, idx) => {
          const {card, currentX, currentY} = obj;
          const ringIdx = Math.floor(idx / perRing);
          const radius = rings[Math.min(ringIdx, rings.length - 1)];
          const angle = (idx % perRing) * (2 * Math.PI / perRing);
          const targetLogicalX = logicalMagnetX + radius * Math.cos(angle);
          const targetLogicalY = logicalMagnetY + radius * Math.sin(angle);
          const targetX = targetLogicalX - 120;
          const targetY = targetLogicalY - 80;
          const dx_t = targetX - currentX;
          const dy_t = targetY - currentY;
          const dist_t = Math.hypot(dx_t, dy_t);
          if (dist_t > 1) {
            const pull = Math.min(0.2, dist_t / 10);
            const newX = currentX + dx_t * pull;
            const newY = currentY + dy_t * pull;
            card.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
            const item = items.find(i => i.id === obj.id);
            if (item) item.position = { x: newX, y: newY };
            card.classList.add('magnetic');
          }
        });
      }
      
      magneticAnimationFrame = requestAnimationFrame(magnetLoop);
    }

    function arrangeIntoRow() {
      const attractedCards = document.querySelectorAll('.scatter-card.magnetic');
      if (attractedCards.length === 0) return;

      const canvasWidth = window.innerWidth;
      const startX = 50;
      const startY = magnetPos.y / scatterZoom - panY; // Align row at magnet's y position
      const gapX = 260;

      attractedCards.forEach((card, index) => {
        const newX = startX + index * gapX;
        const newY = startY;
        card.classList.add('sorting');
        card.style.transform = `translate3d(${newX}px, ${newY}px, 0)`;
        const id = Number(card.dataset.id);
        const item = items.find(i => i.id === id);
        if (item) item.position = { x: newX, y: newY };
        setTimeout(() => card.classList.remove('sorting', 'magnetic'), 500);
      });
      saveData();
      selectedFilter = null;
    }

    function updateCanvasTransform() {
      const canvas = document.getElementById('scatterCanvas');
      canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${scatterZoom})`;
    }

    function updateZoom(delta) {
      scatterZoom = Math.max(0.5, Math.min(3, scatterZoom + delta));
      updateCanvasTransform();
      saveViewState();
    }

    document.getElementById('zoomIn').addEventListener('click', () => updateZoom(0.2));
    document.getElementById('zoomOut').addEventListener('click', () => updateZoom(-0.2));
    document.getElementById('zoomReset').addEventListener('click', () => {
      scatterZoom = 1;
      panX = 0;
      panY = 0;
      updateCanvasTransform();
      saveViewState();
    });

    document.getElementById('scatterContainer').addEventListener('wheel', (e) => {
      if (currentView === 'scatter') {
        e.preventDefault();
        updateZoom(e.deltaY > 0 ? -0.1 : 0.1);
      }
    }, { passive: false });

    function switchView(view) {
      currentView = view;
      localStorage.setItem('preferred-view', view);
      const grid = document.getElementById('gridContainer');
      const scatter = document.getElementById('scatterContainer');
      const zoom = document.getElementById('zoomControls');
      
      stopMagneticEffect();
      hideContextMenu();

      if (view === 'grid') {
        grid.classList.add('active');
        scatter.classList.remove('active');
        zoom.classList.remove('active');
      } else {
        grid.classList.remove('active');
        scatter.classList.add('active');
        zoom.classList.add('active');
      }
      renderView();
    }

    function renderView() {
      if (currentView === 'grid') renderGrid();
      else renderScatter();
    }

    document.querySelectorAll('.left-nav .nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.left-nav .nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        switchView(btn.dataset.view);
      });
    });

    document.querySelectorAll('.right-nav .nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        setStatusFilter(btn.dataset.status);
        if (isMagnetic && btn.dataset.status !== 'all') {
          selectedFilter = btn.dataset.status;
        }
      });
    });

    document.querySelectorAll('.top-nav .nav-btn').forEach(btn => {
      if (btn.dataset.provider && isMagnetic && btn.dataset.provider !== 'all') {
        selectedFilter = btn.textContent;
      }
    });

    function openModal(itemId = null) {
      const modalTitle = document.getElementById('modalTitle');
      const submitBtn = document.getElementById('submitBtn');
      const form = document.getElementById('addForm');
      
      if (itemId) {
        const item = items.find(i => i.id === Number(itemId));
        if (item) {
          modalTitle.textContent = "Edit Contact";
          submitBtn.textContent = "Update Contact";
          document.getElementById('formId').value = item.id;
          document.getElementById('formProvider').value = item.provider;
          document.getElementById('formEmail').value = item.email;
          document.getElementById('formPassword').value = item.password;
          document.getElementById('formResetHours').value = item.resetHours;
          document.getElementById('formStatus').value = item.status;
        }
      } else {
        modalTitle.textContent = "Add New Contact";
        submitBtn.textContent = "Create Contact";
        form.reset();
        document.getElementById('formId').value = "";
      }

      document.getElementById('modalOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      document.body.style.overflow = '';
      hideContextMenu();
    }

    function toggleInfoFab() {
      const overlay = document.getElementById('infoFabOverlay');
      const fab = document.getElementById('infoFabBtn');
      overlay.classList.toggle('active');
      fab.classList.toggle('active');
    }

    document.getElementById('fabBtn').addEventListener('click', () => openModal());
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('infoFabBtn').addEventListener('click', toggleInfoFab);
    document.getElementById('infoCloseBtn').addEventListener('click', toggleInfoFab);
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });
    document.getElementById('infoFabOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) toggleInfoFab();
    });

    document.getElementById('addForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const idVal = document.getElementById('formId').value;
      const isEdit = idVal !== "";

      const newItem = {
        id: isEdit ? Number(idVal) : Date.now(),
        provider: document.getElementById('formProvider').value,
        email: document.getElementById('formEmail').value,
        password: document.getElementById('formPassword').value,
        resetHours: parseFloat(document.getElementById('formResetHours').value),
        status: document.getElementById('formStatus').value,
        position: {
          x: (window.innerWidth / 2) - 130 + Math.random() * 260,
          y: (window.innerHeight / 2) - 100 + Math.random() * 200
        }
      };

      if (isEdit) {
        // Update existing
        const idx = items.findIndex(i => i.id === newItem.id);
        if (idx > -1) {
          // Preserve position if editing
          newItem.position = items[idx].position; 
          items[idx] = newItem;
          showToast("Contact Updated");
        }
      } else {
        // Create new
        items.push(newItem);
        showToast("Contact Created");
      }

      closeModal();
      e.target.reset();
      renderView();
    });

    // Initialize
    renderTopNav(); // Initial render for nav
    if (currentView === 'scatter') {
      handleSort('status');
    }
    renderView();
    document.getElementById('scatterContainer').addEventListener('contextmenu', handleBackgroundContext);
    window.addEventListener('resize', () => {
      if (currentView === 'grid') renderGrid();
      else renderScatter();
    });
  </script>
</body>
</html>
